<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>XML Kontrol</title>
    <link rel="icon" type="image/png" href="GMMLogo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7323802237011820" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f6f6f6;
            margin: 0;
            padding: 0;
            /* overflow-y: hidden;  <-- KALDIRILDI */
            /* Scrollbar genişliği sıfır, sadece görünümü gizle */
            scrollbar-width: none;
            /* Firefox için */
        }

        html {
            overflow-y: scroll;
            box-sizing: border-box;
        }

        body::-webkit-scrollbar {
            width: 0 !important;
            display: none;
        }

        /* Reklam Alanları */
        .ad-container {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ad-top-banner {
            max-width: 1100px;
            margin: 20px auto;
            min-height: 90px;
        }

        .ad-sidebar {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 160px;
            min-height: 600px;
            z-index: 1000;
        }

        .ad-bottom-banner {
            max-width: 1100px;
            margin: 20px auto;
            min-height: 90px;
        }

        .ad-placeholder {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }

        @media (max-width: 1400px) {
            .ad-sidebar {
                display: none;
            }
        }

        main {
            max-width: 1100px;
            margin: 30px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 30px 40px 40px 40px;
        }

        .file-upload {
            margin-bottom: 25px;
        }

        .file-upload label {
            background: #2980b9;
            color: #fff;
            padding: 10px 18px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .info {
            margin-bottom: 20px;
            color: #555;
        }

        /* Bildirim Sistemi */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .notification {
            background: #fff;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            padding: 16px 20px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
        }

        .notification.success {
            border-left-color: #27ae60;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        .notification.error {
            border-left-color: #e74c3c;
        }

        .notification.info {
            border-left-color: #3498db;
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #2c3e50;
        }

        .notification-message {
            color: #555;
        }

        .notification-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #bdc3c7;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .notification-close:hover {
            color: #7f8c8d;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .notification.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }

        .accordion {
            margin-top: 30px;
        }

        .accordion-item {
            border-bottom: 1px solid #e0e0e0;
            transition: box-shadow 0.3s;
        }

        .accordion-title {
            background: #ecf0f1;
            padding: 14px 18px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .accordion-title:hover {
            background: #d0e6f7;
        }

        .accordion-content {
            display: none;
        }

        .accordion-item.active .accordion-content {
            display: block;
        }

        .highlighted {
            animation: highlightAnim 1.2s;
            box-shadow: 0 0 0 4px #ffe066;
        }

        @keyframes highlightAnim {
            0% {
                background: #ffe066;
            }

            70% {
                background: #fffbe6;
            }

            100% {
                background: #fff;
            }
        }

        .check-ok {
            color: #27ae60;
            font-weight: bold;
        }

        .check-fail {
            color: #c0392b;
            font-weight: bold;
        }

        .mismatch-list {
            color: #c0392b;
            font-weight: bold;
            margin: 20px 0 10px 0;
        }

        .desc-missing-list {
            color: #e67e22;
            font-weight: bold;
            margin: 20px 0 10px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #bbb;
            padding: 6px 8px;
            font-size: 13px;
        }

        th {
            background: #2563eb;
            color: #fff;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: #1d4ed8;
        }

        th.sort-asc::after {
            content: " ↑";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        th.sort-desc::after {
            content: " ↓";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        th:hover {
            background: #1d4ed8;
        }

        th.sortable::after {
            content: "";
            display: none;
        }

        th.sort-asc::after {
            content: "";
            display: none;
        }

        th.sort-desc::after {
            content: "";
            display: none;
        }

        .goto-back-btn {
            display: inline-block;
            margin: 12px 0 0 0;
            padding: 7px 18px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 15px;
            animation: fadeInBtn 0.3s;
        }

        @keyframes fadeInBtn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #floating-back-btn {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 9999;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2563eb;
            color: #fff;
            border: none;
            box-shadow: 0 4px 16px #0002;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            pointer-events: none;
        }

        #floating-back-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: none;
        }

        .kopya-popup {
            position: fixed;
            z-index: 99999;
            background: #27ae60;
            color: #fff;
            padding: 5px 14px;
            border-radius: 6px;
            font-size: 13px;
            box-shadow: 0 2px 8px #0002;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.18s;
        }

        .kopya-popup.show {
            opacity: 1;
        }

        .buton-grup {
            display: flex;
            gap: 10px;
            margin-bottom: 18px;
            align-items: center;
            flex-wrap: wrap;
        }

        .buton-grup button {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 9px 18px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .buton-grup button.active {
            background: #1741a6;
        }

        #malzemeFiltrePaneli {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        #malzemeFiltrePaneli select {
            padding: 7px 10px;
            border-radius: 4px;
            border: 1px solid #bbb;
            font-size: 14px;
        }

        .strikeout {
            text-decoration: line-through;
            opacity: 0.6;
        }

        #extraListArea select,
        #extraListArea label {
            font-size: 15px;
            font-weight: bold;
            color: #2563eb;
        }

        #extraListArea select {
            padding: 4px 7px;
            border-radius: 6px;
            border: 1.5px solid #b3b3b3;
            background: #fff;
            color: #222;
            min-width: 120px;
            margin-right: 8px;
            box-shadow: 0 1px 4px #0001;
            transition: border-color 0.2s;
        }

        #extraListArea select:focus {
            border-color: #2563eb;
            outline: none;
        }

        #extraListArea option {
            font-size: 15px;
            padding: 3px 5px;
        }

        #extraListArea .filtre-panel {
            background: #f8fafc;
            border-radius: 8px;
            padding: 7px 9px 5px 9px;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px #0001;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Yüklenen XML dosyaları paneli için özel stil */
        #xmlDosyaListesi ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #xmlDosyaListesi li {
            background: #f4f8ff;
            border-radius: 7px;
            box-shadow: 0 1px 4px #0001;
            margin-bottom: 8px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background 0.2s;
        }

        #xmlDosyaListesi li:hover {
            background: #e8f0fe;
        }

        #xmlDosyaListesi .xml-dosya-sil-btn {
            background: #c0392b;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 5px 14px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        #xmlDosyaListesi .xml-dosya-sil-btn:hover {
            background: #a93226;
        }

        #xmlDosyaListesi .xml-dosya-ikon {
            font-size: 20px;
            color: #2980b9;
            margin-right: 6px;
        }

        #xmlDosyaListesi .xml-dosya-ad {
            font-weight: bold;
            color: #2563eb;
            font-size: 15px;
            flex: 1;
            word-break: break-all;
        }

        .xml-radio-group {
            display: inline-flex;
            align-items: center;
            gap: 18px;
            margin-left: 18px;
            margin-bottom: 12px;
        }

        .xml-radio-option {
            position: relative;
            display: flex;
            align-items: center;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 14px 4px 28px;
            border-radius: 20px;
            transition: background 0.18s;
            background: #f3f6ff;
        }

        .xml-radio-option input[type="radio"] {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            accent-color: #2980b9;
            width: 18px;
            height: 18px;
            margin: 0;
        }

        .xml-radio-option input[type="radio"]:checked+span {
            font-weight: bold;
            color: #2563eb;
        }

        .xml-radio-option input[type="radio"]:checked~.xml-radio-option {
            background: #eaf3ff;
        }

        .xml-radio-option input[type="radio"]:focus+span {
            outline: none;
        }

        .xml-radio-option:hover {
            background: #eaf3ff;
        }

        .file-upload {
            display: flex;
            align-items: flex-start;
            gap: 18px;
            position: relative;
        }

        #filename {
            position: static;
            top: auto;
            right: auto;
            left: auto;
            margin-top: 45px;
            margin-left: -200px;
            margin-bottom: -15px;
            min-width: 260px;
            max-width: 420px;
            font-size: 15px;
            font-weight: bold;
            color: #111;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 0 0 16px 0;
            box-shadow: 0 2px 8px #0001;
            padding: 10px 22px 10px 20px;
            line-height: 1.5;
            white-space: pre-line;
            text-align: left;
            z-index: 1;
            display: inline-block;
            vertical-align: top;
        }

        @media (max-width: 700px) {
            .file-upload {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            #filename {
                margin-left: 0;
                margin-top: 8px;
                max-width: 100vw;
                min-width: 0;
                padding: 8px 8px 8px 16px;
                font-size: 14px;
            }
        }

        /* ========== REKLAM ALANLARI ========== */
        .ad-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ad-top-banner {
            max-width: 1100px;
            margin: 20px auto;
            min-height: 90px;
        }

        .ad-sidebar {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 160px;
            min-height: 600px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ad-in-content {
            max-width: 1100px;
            margin: 30px auto;
            min-height: 250px;
        }

        .ad-placeholder {
            color: #3498db;
            font-size: 13px;
            font-weight: 600;
        }

        .ad-placeholder p {
            margin: 5px 0;
        }

        @media (max-width: 1400px) {
            .ad-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .ad-top-banner {
                min-height: 50px;
            }
        }
    </style>
</head>

<body>
    <!-- Üست BANNER REKLAM (728x90 veya 970x90 Leaderboard) -->
    <div class="ad-container ad-top-banner">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-7323802237011820"
             data-ad-slot="AUTO"
             data-ad-format="horizontal"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- YAN PANEL REKLAM (160x600 Skyscraper) -->
    <div class="ad-container ad-sidebar">
        <ins class="adsbygoogle"
             style="display:inline-block;width:160px;height:600px"
             data-ad-client="ca-pub-7323802237011820"
             data-ad-slot="AUTO"
             data-ad-format="vertical"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- Bildirim Container'ı -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <main>
        <div class="file-upload">
            <label for="xmlfile">XML Dosyası Yükle</label>
            <input type="file" id="xmlfile" accept=".xml" multiple>
            <span id="filename"></span>
        </div>
        <div style="display: none;" class="xml-radio-group">
            <label class="xml-radio-option">
                <input type="radio" name="xmlYuklemeModu" value="reset" checked>
                <span>Sıfırla</span>
            </label>
            <label class="xml-radio-option">
                <input type="radio" name="xmlYuklemeModu" value="append">
                <span>Üstüne Ekle</span>
            </label>
        </div>
        <div id="xmlDosyaListesiPaneli" style="display:none; margin-bottom:10px;">
            <button id="btnXmlDosyaListesi"
                style="background:#2980b9; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;">
                Yüklenen XML Dosyaları
            </button>
            <div id="xmlDosyaListesi"
                style="display:none; margin-top:8px; background:#f8fafc; border-radius:8px; box-shadow:0 2px 8px #0001; padding:12px 18px;">
            </div>
        </div>
        <div style="margin-bottom: 12px;">
            <button id="btnXmlKarsilastir"
                style="background:#8e44ad; display: none; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;">
                XML Karşılaştır
            </button>

            <input type="file" id="xmlfileEski" accept=".xml" style="display:none;">
        </div>

        <div id="pdfCompareResult"></div>

        <div class="buton-grup">

            <button id="btnSiparisDisi" type="button">Sipariş Dışı Parçalar</button>
            <button style="padding: 9px 27px;" id="btnMalzemeIhtiyaci" type="button">Malzeme İhtiyacı Listesi</button>
            <button id="btnStdParca" type="button">Standart Parçalar</button>
            <button id="btnLevhaParcaFiyat" type="button">Levha Parça Fiyatlama</button>
        </div>
        <div style="display: none;" id="malzemeFiltrePaneli">
            <select id="anaFiltre">
                <option value="">Tümü</option>
                <option value="levha">Levha</option>
                <option value="profil">Profil</option>
                <option value="std">İşlenen Standart Parça</option>
                <option value="diger">Diğer</option>
            </select>
            <select style="max-width:320px; width:auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                id="olcuFiltre">
                <option value="">Ölçü: Tümü</option>
            </select>
            <select id="hammaddeFiltre">
                <option value="">Hammadde: Tümü</option>
            </select>
            <select id="malzemeFiltre">
                <option value="">Malzeme: Tümü</option>
            </select>
            <select id="operasyonFiltre">
                <option value="">Operasyon: Tümü</option>
            </select>
        </div>
        <button id="xmlBirleştirBtn"
            style="background:#2563eb; color:#fff; border:none; border-radius:4px; padding:8px 15px; font-size:15px; font-weight:bold; cursor:pointer; margin-bottom:18px;">
            XML dosyası birleştir
        </button>
        <button id="btnKesimKarsilastir"
            style="background:#2980b9; color:#fff; border:none; border-radius:4px; padding:8px 15px; font-size:15px; font-weight:bold; cursor:pointer; margin-left: 5px;">
            Kesim Listesi Karşılaştırma
        </button>
        <button id="btnRevizyonKarsilastir"
            style="display: none; background:#8e44ad; color:#fff; border:none; border-radius:4px; padding:8px 15px; font-size:15px; font-weight:bold; cursor:pointer; margin-left: 5px;">
            Revizyon Karşılaştırma
        </button>
        <div style="margin-bottom: 12px;">
            <button id="btnTumunuAc"
                style="background:#2563eb; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer; margin-right:8px;">
                Tümünü Aç
            </button>
            <button id="btnTumunuKapat"
                style="background:#c0392b; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;">
                Tümünü Kapat
            </button>
        </div>
        <div id="malzemeFiltrePaneli"
            style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
            <!-- ...diğer filtreler... -->
            <label id="setadedilabel" for="setAdedi" style="margin-left:10px;">Set:</label>
            <input type="number" id="setAdedi" value="1" min="1"
                style="width:60px; padding:6px 8px; border-radius:4px; border:1px solid #bbb; font-size:14px;">
            <button id="setUygulaBtn" type="button"
                style="padding:7px 14px; border-radius:4px; border:1px solid #bbb; background:#f5f5f5; font-size:14px; cursor:pointer;">
                Uygula
            </button>
        </div>
        <div id="malzemeAramaPaneli"
            style="margin-bottom:12px; position:relative; display:inline-block; vertical-align:middle;">
            <input type="text" id="malzemeArama" placeholder="Parça kodu, ölçü, hammadde vb. ara..."
                style="padding:7px 64px 7px 12px; border-radius:4px; border:1px solid #bbb; width:320px; font-size:15px; vertical-align:middle;">
            <button id="malzemeAramaClearBtn" title="Temizle"
                style="position:absolute; right:36px; top:50%; transform:translateY(-50%); background:none; border:none; color:#888; font-size:20px; cursor:pointer; display:none; padding:0; line-height:1;">&#10006;</button>
            <button id="malzemeAramaGotoBtn" title="Accordiona Git"
                style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#2563eb; font-size:22px; cursor:pointer; display:none; padding:0; line-height:1;">&#8595;</button>
        </div>
        <div id="hataYokDiv" style="margin:18px 0 10px 0; font-size:18px; font-weight:bold; color:#27ae60;"></div>
        <div id="excelExportArea" style="display:none; margin-bottom:10px;">
            <button id="btnExcelExport"
                style="background:#27ae60; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;">
                Excel'e Aktar
            </button>
        </div>

        <div id="yeniliklerPopup"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.22); z-index:999999;">
            <div
                style="background:#fff; max-height: 65vh; max-width:520px; margin:80px auto; border-radius:12px; box-shadow:0 2px 24px #0005; padding:38px 38px 28px 38px; position:relative;">
                <button onclick="hideYeniliklerPopup()"
                    style="position:absolute; top:18px; right:18px; background:#c0392b; color:#fff; border:none; border-radius:8px; padding:8px 22px; font-size:17px; cursor:pointer;">Kapat</button>
                <h2 style="margin-top:0; color:#2563eb;">Yenilikler</h2>
                <div id="yeniliklerIcerik" style="font-size:16px; color:#222;">
                    <ul style="padding-left:18px; max-height: 55vh; overflow: auto;">
                        <li>Birden fazla XML dosyası sürüklediğinizde açılan popuptan her dosya için set adetlerini
                            girerek malzeme listesinde tamamının birleşimini görebilirsiniz. "Yüklenen XML Dosyaları"
                            butonuna tıklayarak istediğiniz dosyayı silebilirsiniz. Birden fazla XML dosyası yüklüyken
                            hatalar görünmez.
                        </li>
                        <br>
                        <li>Kesim listelerini karşılaştırabilmek için XML dosyalarınızı set adetleri ile birlikte
                            yükledikten sonra <span style="font-weight: bold;">"Kesim Listesi Karşılaştır"</span>
                            butonuna
                            tıklayıp PDF dosyalarını bir seferde seçebilir veya birden fazla kez alan içerisine
                            sürükleyip bırakabilirsiniz. Set adetlerini XML dosyası ve kesim listesine göre
                            ayarlayabilirsiniz.
                        </li>
                        <br>
                        <li>Yüklediğiniz kesim listeleri en üstte listelenir. Burada istediğinizi silebilir veya üzerine
                            tıklayarak önizlemesini görebilirsiniz. Kesim listesi karşılaştırma ekranını sıfırla
                            butonuna
                            basmadığınız sürece kapatıp tekrar açtığınızda listeler sıfırlanmaz.</li>
                        <br>
                        <li>Aynı kesim listesini iki kere yüklemek isterseniz ikinci kez yüklenmez.</li>
                        <br>
                        <li>Kesim listenizi karşılaştırabilmek için DWG dosyanızı PDF'ye çevirirken
                            <span style="font-weight: bold;"> "DWG to PDF.pc5"</span> seçeneğini seçmeniz gerekmektedir.
                        </li>
                        <br>
                        <li>Kesim listelerinde şimdilik sabit bir şablon olmadığından dolayı hata çıkabilmektedir. Şu an
                            için en çok kullanılan şablonlara göre düzenlenmiştir. Hata yaşadığınız XML ve PDF
                            dosyalarını mail olarak gönderebilirsiniz.</li>
                    </ul>
                </div>
                <div id="ozelliklerAccordion"
                    style="margin-top:18px; display: none; border-top:1px solid #eee; padding-top:14px;">
                    <div id="ozelliklerBaslik"
                        style="cursor:pointer; font-weight:bold; color:#2563eb; font-size:16px; display:flex; align-items:center; gap:8px;">
                        <span>Program Özellikleri</span>
                        <span id="ozelliklerArrow" style="font-size:18px; transition:transform 0.2s;">&#9660;</span>
                    </div>
                    <div id="ozelliklerIcerik" style="display:none; margin-top:10px; font-size:15px; color:#222;">
                        <ul style="padding-left:18px;">
                            <li>Birden fazla XML dosyasını aynı anda yükleyip set adetlerini ayrı ayrı girebilirsiniz.
                            </li>
                            <li>Yüklenen XML dosyalarını panelden görebilir ve silebilirsiniz.</li>
                            <li>Malzeme ihtiyacı, sipariş dışı parça, standart parça ve operasyon listelerini tablo
                                olarak
                                alabilirsiniz.</li>
                            <li>Kesim listesi karşılaştırması ile PDF dosyalarını XML ile karşılaştırabilirsiniz.</li>
                            <li>Hata listeleri ve uyarılar detaylı olarak tablo şeklinde gösterilir.</li>
                            <li>Excel'e aktarma, filtreleme ve arama özellikleri mevcuttur.</li>
                            <li>Boy malzeme hesaplama ve görselleştirme fonksiyonu ile kesim optimizasyonu
                                yapabilirsiniz.
                            </li>
                            <li>Programda yapılan tüm işlemler tarayıcıda çalışır, dosyalarınız sunucuya yüklenmez.</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>

        <div id="extraListArea"></div>
        <div id="parentCommaDesc"></div>
        <div id="specialOps"></div>
        <div id="mismatch"></div>
        <div id="descMissing"></div>
        <div id="multiRev"></div>
        <div id="levhaLazerPlazmaKontrol"></div>
        <div id="accordion" class="accordion"></div>

        <!-- Revizyon Karşılaştırma Popup -->
        <div id="revizyonKarsilastirPopup"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:99999;">
            <div
                style="background:#fff; max-width:900px; max-height:90vh; margin:20px auto; border-radius:8px; box-shadow:0 4px 20px #0003; overflow:hidden;">
                <div
                    style="background:#8e44ad; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size:18px;">Revizyon Karşılaştırma</h3>
                    <button id="btnCloseRevizyonPopup"
                        style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:20px; overflow-y:auto; max-height:calc(90vh - 80px);">
                    <div style="display:flex; gap:20px; margin-bottom:20px;">
                        <div style="flex:1;">
                            <label style="display:block; margin-bottom:8px; font-weight:bold;">Eski XML Dosyası:</label>
                            <input type="file" id="eskiXmlFile" accept=".xml"
                                style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                        </div>
                        <div style="flex:1;">
                            <label style="display:block; margin-bottom:8px; font-weight:bold;">Yeni XML Dosyası:</label>
                            <input type="file" id="yeniXmlFile" accept=".xml"
                                style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button id="btnKarsilastir"
                            style="background:#27ae60; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;"
                            disabled>
                            Karşılaştır
                        </button>
                        <button id="btnResetRevizyon"
                            style="background:#c0392b; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">
                            Temizle
                        </button>
                    </div>
                    <div id="revizyonSonuclar" style="border-top:1px solid #eee; padding-top:20px;">
                        <p style="color:#666;">İki XML dosyası seçin ve karşılaştır butonuna tıklayın.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- İÇERİK İÇİ REKLAM (İsteğe bağlı - 336x280 veya 300x250 Rectangle) -->
    <div class="ad-container ad-in-content">
        <ins class="adsbygoogle"
             style="display:inline-block;width:336px;height:280px"
             data-ad-client="ca-pub-7323802237011820"
             data-ad-slot="AUTO"
             data-ad-format="rectangle"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <script>
        // Bildirim Sistemi
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = new Map();
                this.nextId = 1;
            }

            show(title, message, type = 'info', duration = null) {
                const id = this.nextId++;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.setAttribute('data-id', id);
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="notifications.close(${id})">&times;</button>
                `;
                
                this.container.appendChild(notification);
                this.notifications.set(id, notification);
                
                // Eğer süre belirtilmişse otomatik kapat
                if (duration && duration > 0) {
                    setTimeout(() => this.close(id), duration);
                }
                
                return id;
            }

            close(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.classList.add('slide-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 300);
                }
            }

            // Kolay kullanım için yardımcı metodlar
            success(title, message, duration = 5000) {
                return this.show(title, message, 'success', duration);
            }

            warning(title, message, duration = 8000) {
                return this.show(title, message, 'warning', duration);
            }

            error(title, message, duration = 0) { // Hata bildirimleri manuel kapatılsın
                return this.show(title, message, 'error', duration);
            }

            info(title, message, duration = 4000) {
                return this.show(title, message, 'info', duration);
            }

            // Tüm bildirimleri temizle
            clearAll() {
                this.notifications.forEach((notification, id) => {
                    this.close(id);
                });
            }
        }

        // Global bildirim sistemi instance'ı
        const notifications = new NotificationSystem();

        function toggleSpecialOps() {
            const specialOpsDiv = document.getElementById('specialOps');
            if (specialOpsDiv) {
                const currentDisplay = specialOpsDiv.style.display;
                specialOpsDiv.style.display = (currentDisplay === 'none') ? '' : 'none';
            }
        }

        function toggleImalatTipiBos() {
            const imalatDiv = document.getElementById('imalatTipiBosDiv');
            if (imalatDiv) {
                const currentDisplay = imalatDiv.style.display;
                imalatDiv.style.display = (currentDisplay === 'none') ? '' : 'none';
            }
        }

        function toggleHamO2Uzun() {
            const hamO2Container = document.getElementById('hamO2Container');
            if (hamO2Container) {
                const currentDisplay = hamO2Container.style.display;
                hamO2Container.style.display = (currentDisplay === 'none') ? '' : 'none';
            }
        }

        function toggleProfilUzunlukHatalari() {
            const profilDiv = document.getElementById('profilUzunlukHatalariDiv');
            if (profilDiv) {
                profilDiv.style.display = 'none';
                // Hata yok div'ini güncelle
                guncelleHataYokDiv();
            }
        }

        function showYeniliklerPopup() {
            document.getElementById('yeniliklerPopup').style.display = "block";
        }
        function hideYeniliklerPopup() {
            document.getElementById('yeniliklerPopup').style.display = "none";
        }

        // Açılışta otomatik göster
        window.addEventListener("DOMContentLoaded", function () {
            showYeniliklerPopup();
        });

        let currentXmlFileName = "liste";

        // Dosya input ile yükleme (çoklu dosya desteği)
        document.getElementById('xmlfile').addEventListener('change', function (e) {
            if (document.getElementById('xmlBirlestiriciPopup')) return;
            const files = Array.from(e.target.files);
            const yuklemeModu = document.querySelector('input[name="xmlYuklemeModu"]:checked').value;

            if (yuklemeModu === "reset") {
                // Sıfırla: Önceki dosyaları ve ekranı temizle, sadece yeni yüklenenleri işle
                multiXmlFiles = [];
                document.getElementById('filename').textContent = "";
                document.getElementById('accordion').innerHTML = "";
                document.getElementById('extraListArea').innerHTML = "";
                ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol', 'hataYokDiv'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });
                document.querySelectorAll('.mismatch-list').forEach(div => div.remove());
            }
            if (files.length === 0) return;
            currentXmlFileName = files[0].name.replace(/\.[^.]+$/, ""); // uzantısız

            if (files.length === 1) {
                // Tek dosya: klasik davranış
                handleXmlFile(files[0]);
                guncelleXmlDosyaListesiPaneli();
            } else {
                // Çoklu dosya: hata listesi yok, accordion ve malzeme listesi birleştirilecek
                handleMultipleXmlFiles(files);
            }
        });

        // Sürükle-bırak ile yükleme (çoklu dosya desteği)
        window.addEventListener('drop', function (e) {
            if (document.getElementById('xmlBirlestiriciPopup')) return;
            e.preventDefault();
            e.stopPropagation();
            document.body.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.xml'));
            if (files.length === 0) return;
            currentXmlFileName = files[0].name.replace(/\.[^.]+$/, "");
            document.getElementById('xmlfile').files = e.dataTransfer.files; // input'u da güncelle

            const yuklemeModu = document.querySelector('input[name="xmlYuklemeModu"]:checked').value;

            // --- Hata listeleri ve accordion her durumda temizlenmeli ---
            document.getElementById('filename').textContent = "";
            document.getElementById('accordion').innerHTML = "";
            document.getElementById('extraListArea').innerHTML = "";
            ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol', 'hataYokDiv'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = "";
            });
            document.querySelectorAll('.mismatch-list').forEach(div => div.remove());

            // --- Sıfırla modunda eski dosyaları temizle ---
            if (yuklemeModu === "reset") {
                multiXmlFiles = [];
            }

            // --- Üstüne ekle modunda tek dosya yüklüyken yeni dosya gelirse çoklu XML'e çevir ---
            if (yuklemeModu === "append" && multiXmlFiles.length === 0 && window.loadedXmlDoc) {
                // Gerçek File nesnesini bul
                let eskiFile = null;
                const xmlInput = document.getElementById('xmlfile');
                if (xmlInput && xmlInput.files && xmlInput.files.length === 1) {
                    eskiFile = xmlInput.files[0];
                }
                // Eğer input'tan alınamıyorsa, ekranda görünen dosya adını kullanarak sahte bir File nesnesi oluştur
                if (!eskiFile) {
                    const dosyaAdi = document.getElementById('filename').textContent || "YüklüDosya.xml";
                    eskiFile = new File([""], dosyaAdi);
                }
                multiXmlFiles = [{
                    file: eskiFile,
                    xmlDoc: window.loadedXmlDoc,
                    setAdet: parseInt(document.getElementById('setAdedi').value, 10) || 1
                }];
            }

            if (yuklemeModu === "append" || files.length > 1 || multiXmlFiles.length > 0) {
                // Çoklu XML mantığı
                handleMultipleXmlFiles(files);
            } else if (files.length === 1) {
                setAdedi = 1;
                document.getElementById('setAdedi').value = 1;
                handleXmlFile(files[0]);
                guncelleXmlDosyaListesiPaneli();
            }
        });

        // Çoklu XML dosyası işleme fonksiyonu
        function handleMultipleXmlFiles(files) {
            if (document.getElementById('xmlBirlestiriciPopup')) {
                // Sadece birleştirici popup aktif kalsın, adet popup'ı açılmasın
                return;
            }
            const yuklemeModu = document.querySelector('input[name="xmlYuklemeModu"]:checked').value;
            let eskiDosyalar = [];
            if (yuklemeModu === "append" && multiXmlFiles && multiXmlFiles.length > 0) {
                // Eski dosyaları sakla
                eskiDosyalar = multiXmlFiles.map(x => ({
                    name: x.file.name,
                    setAdet: x.setAdet
                }));
                files = [...multiXmlFiles.map(x => x.file), ...files];
            }
            document.getElementById('setAdedi').style.display = "none";
            document.getElementById('setUygulaBtn').style.display = "none";
            document.getElementById('setadedilabel').style.display = "none";
            // Her dosya için set adedi sorulacak popup
            let popupHtml = `<div id="multiSetPopup" style="position:fixed;top:0;left:0;overflow:auto;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999999;">
    <div style="background:#fff;max-width:520px;margin:40px auto;padding:32px 28px 24px 28px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">Her XML için Set Adedi Girin</h3>
        <form id="multiSetForm">
            ${files.map((f, i) => {
                // Eski dosya mı?
                const eski = eskiDosyalar.find(x => x.name === f.name);
                const isYeni = !eski;
                const renk = isYeni ? "#e8fbe8" : "#f3f3f3";
                const border = isYeni ? "2px solid #27ae60" : "1px solid #bbb";
                const value = eski ? eski.setAdet : 1;
                return `
                <div style="margin-bottom:12px; background:${renk}; border:${border}; border-radius:6px; padding:8px 10px; display:flex; align-items:center; gap:10px;">
                    <b>${f.name}</b>
                    <input type="number" min="1" value="${value}" style="width:70px;margin-left:12px;" id="setAdet_${i}">
                    ${isYeni ? '<span style="color:#27ae60; font-weight:bold; margin-left:8px;">(yeni)</span>' : ''}
                </div>
                `;
            }).join("")}
            <button type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:4px;padding:8px 18px;font-size:15px;font-weight:bold;cursor:pointer;">Uygula</button>
        </form>
    </div>
</div>`;
            document.body.insertAdjacentHTML("beforeend", popupHtml);

            // Form ve buton event listener'larını ekle
            const multiSetForm = document.getElementById('multiSetForm');
            const submitButton = multiSetForm.querySelector('button[type="submit"]');

            function handleSubmit(e) {
                e.preventDefault();
                e.stopPropagation();

                // Set adetlerini oku
                let setAdetList = files.map((f, i) => parseInt(document.getElementById(`setAdet_${i}`).value, 10) || 1);
                document.getElementById('multiSetPopup').remove();
                let xmlList = [];
                let loadedCount = 0;

                // Alanları temizle
                document.getElementById('extraListArea').innerHTML = "";
                document.getElementById('accordion').innerHTML = "";
                ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol', 'hataYokDiv'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });
                document.querySelectorAll('.mismatch-list').forEach(div => div.remove());

                // Tüm dosyaları oku
                files.forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(evt.target.result, "text/xml");
                        xmlList[idx] = { file, xmlDoc, setAdet: setAdetList[idx] };
                        loadedCount++;
                        if (loadedCount === files.length) {
                            // Malzeme listelerini birleştir
                            const mergedXmlDoc = document.implementation.createDocument("", "", null);
                            const root = mergedXmlDoc.createElement("merged");
                            mergedXmlDoc.appendChild(root);

                            xmlList.forEach(item => {
                                Array.from(item.xmlDoc.querySelectorAll("document")).forEach(docNode => {
                                    root.appendChild(mergedXmlDoc.importNode(docNode, true));
                                });
                            });

                            // window.loadedXmlDoc'u güncelle (filtreler ve tablo için)
                            window.loadedXmlDoc = mergedXmlDoc;
                            multiXmlFiles = xmlList;
                            guncelleXmlDosyaListesiPaneli();

                            // Filtre kutularını güncelleyin
                            doldurFiltreKutular();


                            // Accordionları alt alta ekle
                            const accordion = document.getElementById('accordion');
                            accordion.innerHTML = "";
                            xmlList.forEach((item, idx) => {
                                // Her dosya için bir grup div oluştur
                                const groupDiv = document.createElement('div');
                                groupDiv.className = 'accordion-group';
                                groupDiv.setAttribute('data-group', 'group_' + idx);

                                // Başlık ekle
                                const baslik = document.createElement('div');
                                baslik.className = 'accordion-title';
                                baslik.style = "background:#ecf0f1; font-size:17px; font-weight:bold; margin-top:18px; border-radius:6px;";
                                baslik.textContent = `XML Dosyası: ${item.file.name} (Set Adedi: ${item.setAdet})`;
                                groupDiv.appendChild(baslik);

                                // Her dosya için hiyerarşik accordion ekle
                                const documents = item.xmlDoc.querySelectorAll("document");
                                const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                                rootDocs.forEach((doc, docIdx) => {
                                    listPartsRecursiveMulti(doc, (docIdx + 1).toString(), 0, item.setAdet, groupDiv);
                                });

                                accordion.appendChild(groupDiv);
                            });
                            if (multiXmlFiles.length > 1) {
                                // Hata listesi seçim panelini ekle
                                let hataPanel = document.getElementById('multiXmlHataPanel');
                                if (!hataPanel) {
                                    hataPanel = document.createElement('div');
                                    hataPanel.id = 'multiXmlHataPanel';
                                    hataPanel.style = "margin-bottom:18px; display:none; gap:14px; align-items:center;";
                                    hataPanel.innerHTML = `
            <label for="multiXmlHataSelect" style="font-weight:bold; color:#2563eb;">Hata Listesi Görünümü:</label>
            <select id="multiXmlHataSelect" style="padding:7px 12px; border-radius:6px; border:1.5px solid #b3b3b3; font-size:15px;">
                <option value="tum">Tümü (hata listesi gizli)</option>
                ${multiXmlFiles.map((item, idx) => `<option value="${idx}">${item.file.name}</option>`).join("")}
            </select>
        `;
                                    document.querySelector('main').insertBefore(hataPanel, document.getElementById('accordion'));
                                }

                                // Seçim değiştiğinde hata listelerini güncelle
                                const hataSelect = document.getElementById('multiXmlHataSelect');
                                hataSelect.value = "tum"; // Tümü seçili gelsin

                                hataSelect.onchange = function () {
                                    if (this.value === "tum") {
                                        // Hata listelerini gizle
                                        document.querySelectorAll('.mismatch-list, #parentCommaDesc, #specialOps, #mismatch, #descMissing, #multiRev, #levhaLazerPlazmaKontrol').forEach(el => {
                                            el.style.display = "none";
                                        });
                                        // Accordionları tekrar oluştur
                                        const accordion = document.getElementById('accordion');
                                        accordion.innerHTML = "";
                                        multiXmlFiles.forEach((item, idx) => {
                                            const groupDiv = document.createElement('div');
                                            groupDiv.className = 'accordion-group';
                                            groupDiv.setAttribute('data-group', 'group_' + idx);

                                            const baslik = document.createElement('div');
                                            baslik.className = 'accordion-title';
                                            baslik.style = "background:#ecf0f1; font-size:17px; font-weight:bold; margin-top:18px; border-radius:6px;";
                                            baslik.textContent = `XML Dosyası: ${item.file.name} (Set Adedi: ${item.setAdet})`;
                                            groupDiv.appendChild(baslik);

                                            const documents = item.xmlDoc.querySelectorAll("document");
                                            const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                                            rootDocs.forEach((doc, docIdx) => {
                                                listPartsRecursiveMulti(doc, (docIdx + 1).toString(), 0, item.setAdet, groupDiv);
                                            });

                                            accordion.appendChild(groupDiv);
                                        });
                                    } else {
                                        // Önce tüm hata listelerini gizle
                                        document.querySelectorAll('.mismatch-list, #parentCommaDesc, #specialOps, #mismatch, #descMissing, #multiRev, #levhaLazerPlazmaKontrol').forEach(el => {
                                            el.style.display = "none";
                                        });
                                        // Seçilen dosya için hata listelerini yeniden oluştur/göster
                                        const idx = parseInt(this.value, 10);
                                        if (!isNaN(idx) && multiXmlFiles[idx]) {
                                            // Hata listesi divlerini sil
                                            document.querySelectorAll('.mismatch-list').forEach(div => div.remove());
                                            // Alanları temizle
                                            ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol'].forEach(id => {
                                                const el = document.getElementById(id);
                                                if (el) el.innerHTML = "";
                                            });
                                            // Sadece seçilen dosyanın hata listelerini render et
                                            renderAll(multiXmlFiles[idx].xmlDoc);
                                        }
                                    }
                                };

                                // Tümü seçili ise hata listelerini gizle
                                hataSelect.dispatchEvent(new Event('change'));
                            }

                            // Kesim listesi karşılaştırma popup'ı açıksa karşılaştırmayı tekrar yap
                            const kesimPopup = document.getElementById('kesimKarsilastirPopup');
                            if (kesimPopup && window.kesimPdfFilesList && window.kesimPdfFilesList.length > 0) {
                                setTimeout(() => {
                                    if (typeof window.tryCompareKesim === 'function') {
                                        window.tryCompareKesim();
                                    }
                                }, 100);
                            }
                        }
                    };
                    reader.readAsText(file);
                });
            }

            // Event listener'ları ekle
            multiSetForm.addEventListener('submit', handleSubmit);
            submitButton.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                handleSubmit(e);
            });

            // Popup üzerine tıklanınca kapanmasını önle
            const popupDiv = document.getElementById('multiSetPopup');
            const innerDiv = popupDiv.querySelector('div');
            popupDiv.addEventListener('click', function (e) {
                if (e.target === popupDiv) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            innerDiv.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            guncelleXmlDosyaListesiPaneli();
        }

        // Hiyerarşik accordion ekleme fonksiyonu (çoklu dosya için)
        function listPartsRecursiveMulti(docNode, yol, depth, parentMultiplier, accordion) {
            const conf = docNode.querySelector('configuration');
            if (!conf) return;
            const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
            const desc = (getAttributeValue(conf, "Description") || "").trim(); // <-- EKLENDİ
            const name = (getAttributeValue(conf, "Name") || "").trim();        // <-- EKLENDİ
            const adet = parseInt(conf.getAttribute("quantity")) || 1;
            const toplamAdet = adet * parentMultiplier;
            const attributes = conf
                ? Array.from(conf.children)
                    .filter(child => child.tagName === "attribute")
                    .map(attr => ({
                        name: attr.getAttribute("name"),
                        value: attr.getAttribute("value")
                    }))
                : [];
            const visibleChildDocs = Array.from(docNode.querySelectorAll(':scope > configuration > references > document'));
            const hasVisibleChildren = visibleChildDocs.length > 0;

            let infoRows = attributes
                .filter(attr => attr.value && attr.value.trim() !== "")
                .map(attr => `<tr><td>${attr.name}</td><td>${attr.value}</td></tr>`)
                .join("");

            const item = document.createElement('div');
            item.className = 'accordion-item';
            item.id = `parca_${partCode.replace(/[^a-zA-Z0-9]/g, "")}_${yol.replace(/\./g, '_')}`;
            item.setAttribute('data-yol', yol);

            const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();
            let extraInfo = "";
            if (siparisDisiBirak === "1") {
                extraInfo = `<span style="color:#c0392b;"> (Sipariş Dışı)</span>`;
            }

            const cleanName = name.replace(/\.(SLDPRT|SLDASM)$/i, "");

            function temizleUzantiyi(name) {
                return (name || "").replace(/\.(SLDPRT|SLDASM)$/i, "").trim();
            }

            let stdEk = "";
            if (/^[A-Z0-9]{6}$/.test(partCode)) {
                const cleanDesc = (desc || "").trim();
                const cleanName = temizleUzantiyi(name);
                // Eğer description ve name birebir aynıysa sadece birini yaz
                if (cleanDesc && cleanName && cleanDesc === cleanName) {
                    stdEk = `<span style="font-size:12px; color:#444; font-weight:normal; margin-left:8px;">- ${cleanDesc}</span>`;
                } else if (cleanDesc || cleanName) {
                    stdEk = `<span style="font-size:12px; color:#444; font-weight:normal; margin-left:8px;">- ${cleanDesc}${cleanDesc && cleanName ? " | " : ""}${cleanName}</span>`;
                }
            }

            item.innerHTML = `
<div class="accordion-title" style="padding-left:${depth * 32 + 18}px; display: flex; justify-content: space-between; align-items: center;">
    <span style="display:flex; align-items:center; gap:8px;">
        ${hasVisibleChildren ? `<span class="accordion-arrow" style="display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; color:#bbb; font-size:17px; transition:transform 0.2s; user-select:none; margin-right:4px;">&#9654;</span>` : `<span style="display:inline-block; width:20px;"></span>`}
        ${yol}. Parça: <b class="parca-kodu-click">${partCode}</b>${stdEk}${extraInfo}
    </span>
    <span style="min-width:120px; text-align:right; color:#2563eb; font-size:14px; display:flex; align-items:center; gap:8px;">
        Adet: <b>${adet}</b> <span style="color:#888;">|</span> Toplam: <b>${toplamAdet}</b>
        <button class="info-btn" style="background:#eee; color:#888; border:none; border-radius:50%; width:26px; height:26px; font-size:16px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;" title="Özellikleri Göster/Gizle">&#8505;</button>
    </span>
</div>
<div class="accordion-content">
    <table>
        <thead>
            <tr>
                <th>Alan</th>
                <th>Değer</th>
            </tr>
        </thead>
        <tbody>
            ${infoRows}
        </tbody>
    </table>
    <div class="goto-back-btn-container"></div>
</div>
`;
            accordion.appendChild(item);

            const arrow = item.querySelector('.accordion-arrow');
            const content = item.querySelector('.accordion-content');
            const title = item.querySelector('.accordion-title');
            const infoBtn = item.querySelector('.info-btn');

            // Alt parça aç/kapa
            if (title) {
                title.addEventListener('click', function (e) {
                    if (e.target.classList.contains('info-btn')) return;
                    const myYol = item.getAttribute('data-yol');
                    const isOpen = item.classList.toggle('ac-open');
                    if (arrow) arrow.style.transform = isOpen ? "rotate(90deg)" : "rotate(0deg)";
                    // Sadece kendi grubundaki bir seviye altındaki çocukları aç/kapat
                    const groupDiv = item.closest('.accordion-group');
                    groupDiv.querySelectorAll('.accordion-item').forEach(child => {
                        const childYol = child.getAttribute('data-yol');
                        if (childYol && childYol.startsWith(myYol + '.') && childYol.split('.').length === myYol.split('.').length + 1) {
                            child.style.display = isOpen ? "" : "none";
                            if (!isOpen) {
                                child.classList.remove('ac-open');
                                const childContent = child.querySelector('.accordion-content');
                                if (childContent) childContent.style.display = "none";
                            }
                        }
                    });
                    if (!isOpen) {
                        if (content) content.style.display = "none";
                    }
                });
            }
            if (infoBtn) {
                infoBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    content.style.display = (content.style.display === "block") ? "none" : "block";
                });
            }
            content.style.display = "none";
            if (depth > 0) item.style.display = "none";

            // Alt montajları sırayla gez
            const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
            childDocs.forEach((childDoc, idx) => {
                listPartsRecursiveMulti(childDoc, yol + '.' + (idx + 1), depth + 1, toplamAdet, accordion);
            });
        }

        window.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            document.body.classList.add('dragover');
        });
        window.addEventListener('dragleave', function (e) {
            document.body.classList.remove('dragover');
        });

        let floatingBtn = null;
        function setupFloatingBackBtn() {
            if (!floatingBtn) {
                floatingBtn = document.createElement('button');
                floatingBtn.id = 'floating-back-btn';
                floatingBtn.innerHTML = '↑';
                document.body.appendChild(floatingBtn);
                floatingBtn.onclick = function () {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                };
            }
            window.addEventListener('scroll', function () {
                if (window.scrollY > 10) {
                    floatingBtn.classList.add('show');
                } else {
                    floatingBtn.classList.remove('show');
                }
            });
        }
        setupFloatingBackBtn();

        function getProjeNoBilgisi(xmlDoc) {
            // En üst montajın ilk configuration içindeki Proje_no, Mak_Cinsi ve Description attribute'larını bul
            const firstDoc = xmlDoc.querySelector("document");
            if (!firstDoc) return { value: "", hata: true, mesaj: "Proje kodu yok" };
            const conf = firstDoc.querySelector("configuration");
            if (!conf) return { value: "", hata: true, mesaj: "Proje kodu yok" };
            const attr = conf.querySelector('attribute[name="Proje_no"]');
            const makAttr = conf.querySelector('attribute[name="Mak_Cinsi"]');
            const descAttr = conf.querySelector('attribute[name="Description"]');
            const val = (attr && attr.getAttribute("value")) || "";
            const makVal = (makAttr && makAttr.getAttribute("value")) || "";
            const descVal = (descAttr && descAttr.getAttribute("value")) || "";

            // Proje kodu yoksa
            if (!val.trim()) return { value: "", hata: true, mesaj: "Proje kodu yok" };

            // Başında, sonunda veya içinde boşluk varsa hata
            if (/^\s|\s$/.test(val) || /\s/.test(val.trim().slice(1, -1))) {
                return { value: val, hata: true, mesaj: "Proje kodunda başta/sonda veya ortada boşluk var!" };
            }

            // Ek alanları birleştir
            let ekler = [];
            if (makVal.trim()) ekler.push(makVal.trim());
            if (descVal.trim()) ekler.push(descVal.trim());
            let fullValue = val;
            if (ekler.length) fullValue += " - " + ekler.join(" - ");

            return { value: fullValue, hata: false, mesaj: "" };
        }

        function handleXmlFile(file) {
            document.getElementById('setAdedi').style.display = "";
            document.getElementById('setUygulaBtn').style.display = "";
            document.getElementById('setadedilabel').style.display = "";
            const reader = new FileReader();
            reader.onload = function (evt) {
                const xmlText = evt.target.result;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                loadedXmlDoc = xmlDoc;
                window.loadedXmlDoc = xmlDoc;

                // --- Proje kodu kontrolü ve gösterimi ---
                const firstDoc = xmlDoc.querySelector("document");
                const conf = firstDoc && firstDoc.querySelector("configuration");
                const projeNo = conf ? (conf.querySelector('attribute[name="Proje_no"]')?.getAttribute("value") || "") : "";
                const makCinsi = conf ? (conf.querySelector('attribute[name="Mak_Cinsi"]')?.getAttribute("value") || "") : "";
                const desc = conf ? (conf.querySelector('attribute[name="Description"]')?.getAttribute("value") || "") : "";

                let infoHtml = "";
                // --- BOŞLUK KONTROLÜ EKLENDİ ---
                if (!projeNo.trim()) {
                    infoHtml = `<span style="color:#c0392b; font-weight:bold;">Proje kodu yok!</span><br>` +
                        (makCinsi ? `Makina Cinsi: ${makCinsi}<br>` : "") +
                        (desc ? `Açıklama: ${desc}` : "");
                } else if (/^\s|\s$/.test(projeNo) || /\s/.test(projeNo.trim().slice(1, -1))) {
                    infoHtml = `<span style="color:#c0392b; font-weight:bold;">Proje kodunda başta/sonda veya ortada boşluk var!</span><br>` +
                        `Proje Kodu: <span style="color:#c0392b;">${projeNo}</span><br>` +
                        (makCinsi ? `Makina Cinsi: ${makCinsi}<br>` : "") +
                        (desc ? `Açıklama: ${desc}` : "");
                } else {
                    infoHtml =
                        `Proje Kodu: ${projeNo}<br>` +
                        (makCinsi ? `Makina Cinsi: ${makCinsi}<br>` : "") +
                        (desc ? `Açıklama: ${desc}` : "");
                }
                document.getElementById('filename').innerHTML = `<span style="font-weight:bold;">${file.name}</span><br>${infoHtml}`;

                // ...devamı aynı...
                const bosSatirlar = checkXmlEmptyLineError(xmlDoc, xmlText);
                if (bosSatirlar.length > 0) {
                    const div = document.createElement('div');
                    div.className = 'mismatch-list';
                    div.innerHTML = `<b>XML dosyasında <span style="color:#c0392b;">boş satır</span> bulundu! Yapı bozulabilir.<br>
Boş satır(lar): ${bosSatirlar.map(s => `<b>${s}</b>`).join(", ")}
<br><span style="color:#c0392b;">Lütfen XML dosyasındaki boş satırları kaldırın!</span></b>`;
                    document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                }

                renderAll(xmlDoc);
                let val = parseInt(document.getElementById('setAdedi').value, 10);
                if (!val || val < 1) val = 1;
                setAdedi = val;
                tabloyuGuncelle();
                document.getElementById('extraListArea').innerHTML = "";
                acikListe = "";
                document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
                showExcelExport(false);

                // Kesim listesi karşılaştırma popup'ı açıksa karşılaştırmayı tekrar yap
                const kesimPopup = document.getElementById('kesimKarsilastirPopup');
                if (kesimPopup && window.kesimPdfFilesList && window.kesimPdfFilesList.length > 0) {
                    // tryCompare fonksiyonunu çağır - popup içindeki fonksiyon
                    setTimeout(() => {
                        const tryCompareBtn = kesimPopup.querySelector('#btnResetKesimPopup');
                        if (tryCompareBtn && typeof window.tryCompareKesim === 'function') {
                            window.tryCompareKesim();
                        }
                    }, 100);
                }
            };
            reader.readAsText(file);
        }

        function renderAll(xmlDoc) {
            // --- Montaj yollarını çıkar ---
            const montajYollari = buildMontajYollari(xmlDoc);
            document.getElementById('accordion').innerHTML = "";
            document.getElementById('parentCommaDesc').innerHTML = "";
            document.getElementById('specialOps').innerHTML = "";
            document.getElementById('mismatch').innerHTML = "";
            document.getElementById('descMissing').innerHTML = "";
            document.getElementById('multiRev').innerHTML = "";
            document.getElementById('levhaLazerPlazmaKontrol').innerHTML = "";


            // --- Hata listeleri ---
            const mismatches = findMismatchedChildParts(xmlDoc);
            const descMissings = findChildWithEmptyDescription(xmlDoc);
            const specialOps = findSpecialOperations(xmlDoc);
            const multiRevParts = findMultipleRevisionParts(xmlDoc);
            const parentsWithCommaDesc = findParentsWithChildrenCommaDesc(xmlDoc);
            const imalatIssues = findImalatTipiIssues(xmlDoc);
            const invalidERP = findInvalidMaterialERPCode(xmlDoc);
            const invalidMaterials = findPartsWithInvalidMaterial(xmlDoc);
            const stdMaterialWarnings = findProcessedStdPartsWithInvalidMaterial(xmlDoc);

            const hataliProfilAnaList = findProfileMainPartsWithInvalidDisardaBirakChild(xmlDoc);
            if (hataliProfilAnaList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil ana parça için hatalı dışarda bırakılmış alt kırılım parçası:</b>
<ul>
    ${hataliProfilAnaList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="hataliProfilAnaCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.hammadde} - ${m.ham_o1}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const profilTanimiVarAmaAltCocukYokList = findProfileTanimiVarAmaAltCocukYok(xmlDoc);
            if (profilTanimiVarAmaAltCocukYokList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil tanım boyu dolu, ham_o1, ham_o2, hammadde, sipariş dışı bırak, profil dışarda bırak boş ve alt çocuğu olmayan parçalar:</b>
<ul>
    ${profilTanimiVarAmaAltCocukYokList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profilTanimiVarAmaAltCocukYokCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.profilTanimBoy}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const mngPartErrorGroups = findMngPartErrors(xmlDoc);

            if (mngPartErrorGroups.errors1.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>MNG Parça Hatası: Dördü aynı anda dolu</b>
<ul>
    ${mngPartErrorGroups.errors1.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="mngPartError1Check_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            if (mngPartErrorGroups.errors2.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>MNG Parça Hatası: Parça kodu -0001/-0002 ile bitiyor</b>
<ul>
    ${mngPartErrorGroups.errors2.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="mngPartError2Check_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            if (mngPartErrorGroups.errors3.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>MNG Parça Hatası: Name alanı .SLDPRT ile bitiyor</b>
<ul>
    ${mngPartErrorGroups.errors3.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="mngPartError3Check_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const mngMontajKaynakHatalari = findMNGMontajKaynakHatalari(xmlDoc);
            if (mngMontajKaynakHatalari.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>MNG Montaj/Kaynak Hataları:</b>
<ul>
    ${mngMontajKaynakHatalari.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="mngMontajKaynakCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            // renderAll fonksiyonunda hata listelerine ekleyin:
            const stdAltParcasiOlanlar = findStdAltParcasiOlanlar(xmlDoc);
            if (stdAltParcasiOlanlar.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Malzemesi STD olup alt parçası olanlar:</b>
<ul>
    ${stdAltParcasiOlanlar.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="stdAltParcaCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; Alt Parça Sayısı: <span style="color:#c0392b">${m.childCount}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const erpMismatchList = findERPCodeMaterialMismatch(xmlDoc);
            if (erpMismatchList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>ERP Kodu ile Malzeme Uyumsuzluğu:</b>
<ul>
    ${erpMismatchList.map((x, i) => {
                    // 55 SI 7 için özel uyarı
                    let malzemeUyari = "";
                    if (x.malzeme.replace(/\s+/g, "").toUpperCase() === "55SI7" || x.malzeme.replace(/\s+/g, "").toUpperCase() === "55SI7") {
                        malzemeUyari = `<span style="color:#e67e22;"> (Doğru yazımı: <b>55Si7</b>)</span>`;
                    }
                    // 55 SI 7 yanlış yazılmışsa uyarı ekle
                    if (x.malzeme.replace(/\s+/g, "").toUpperCase() === "55SI7" || x.malzeme.replace(/\s+/g, "") === "55SI7") {
                        malzemeUyari = `<span style="color:#e67e22;"> (Doğru yazımı: <b>55Si7</b>)</span>`;
                    }
                    if (x.malzeme.replace(/\s+/g, "").toUpperCase() === "55SI7" || x.malzeme.replace(/\s+/g, "") === "55SI7" || x.malzeme.replace(/\s+/g, "") === "55 SI 7") {
                        malzemeUyari = `<span style="color:#e67e22;"> (Doğru yazımı: <b>55Si7</b>)</span>`;
                    }
                    return `
        <li>
            <input type="checkbox" class="strike-checkbox" id="erpMismatchCheck_${i}">
            <span class="parca-kodu-span" data-parca="${x.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${x.partCode}</b></span>
            → Malzeme: <span style="color:#c0392b;">${x.malzeme}</span>${malzemeUyari}
            | ERP Kodu: <span style="color:#e67e22;">${x.erpCode}</span>
            <span style="color:#c0392b;"></span>
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const stdDescBosList = findStdPartsWithEmptyDescription(xmlDoc);
            if (stdDescBosList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Description bilgisi boş olan 6 haneli standart parçalar:</b>
<ul>
    ${stdDescBosList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="stdDescBosCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode}"><b>${m.partCode}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const profileChildrenEmptyProfilTipi = findProfileChildrenWithEmptyProfilTipi(xmlDoc);
            if (profileChildrenEmptyProfilTipi.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil çocuk parçalarda "Profil_Tipi" alanı boş olanlar:</b>
<ul>
    ${profileChildrenEmptyProfilTipi.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profileChildrenEmptyProfilTipiCheck_${i}">
            Çocuk Parça: <span class="parca-kodu-span" data-parca="${m.child.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.child}</b></span>
            &rarr; Ana Parça: <span class="parca-kodu-span" data-parca="${m.parent.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.parent}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            const emptyProfilTanimBoyList = findPartsWithEmptyProfilTanimBoyAndHammaddeHamO1(xmlDoc);
            if (emptyProfilTanimBoyList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil tanım boyu, Hammadde ve Ham_o1 değeri boş olan IML parçalar:</b>
<ul>
    ${emptyProfilTanimBoyList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="emptyProfilTanimBoyCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            const hammaddeDoluHamO1BosList = findPartsWithHammaddeDoluHamO1Bos(xmlDoc);
            if (hammaddeDoluHamO1BosList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Hammadde dolu olup Ham_o1 değeri boş olan IML parçalar:</b>
<ul>
    ${hammaddeDoluHamO1BosList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="hammaddeDoluHamO1BosCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            // Malzeme ERP Kodu hataları
            if (invalidERP.length > 0) {
                const erpDiv = document.createElement('div');
                erpDiv.className = 'mismatch-list';
                erpDiv.innerHTML = `<b>Malzeme ERP Kodu boş veya hatalı olan parçalar:</b>
<ul>
    ${invalidERP.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidERPCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.erpCode}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(erpDiv, document.getElementById('accordion'));
                setTimeout(() => {
                    erpDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            renderInvalidMngPartCodes(xmlDoc);

            renderInvalidPartCodePairs(xmlDoc);
            const invalidPairs = findInvalidPartCodePairs(xmlDoc);
            if (invalidPairs.length > 0) {
                invalidPairs.forEach(pair => {
                    console.error(pair.message);
                });
            }

            const fasonKesimHatalari = findPartsWithFasonAndKesim(xmlDoc);
            if (fasonKesimHatalari.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Hem FASON İŞLEM hem de PLAZMA KESİM, LAZER KESİM veya SU JETİ rotası girilmiş parçalar:</b>
<ul>
    ${fasonKesimHatalari.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="fasonKesimHataCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const kosebentProfilTipiHatalari = findKosebentProfilTipiHatalari(xmlDoc);
            if (kosebentProfilTipiHatalari.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Malzeme ERP kodu 01, malzeme ST37, Description'da KOSEBENT/ olup Profil Tipi "Kosebent Profil" olmayanlar:</b>
<ul>
    ${kosebentProfilTipiHatalari.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="kosebentProfilTipiHata_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; Profil Tipi: <span style="color:#c0392b">${m.profilTipi || "(boş)"}</span>
            &rarr; Description: <span style="color:#e67e22">${m.desc}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            if (imalatIssues.emptyList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>İmalat Tipi boş olan parçalar:</b>
<ul>
    ${imalatIssues.emptyList.map((m, i) => {
                    // Sipariş dışı kontrolü
                    const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === m.partCode;
                    });
                    let siparisDisi = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf && getAttributeValue(conf, "Siparis_Disi_Birak").trim() === "1") {
                            siparisDisi = ' <span style="color:#e67e22;">(Sipariş Dışı)</span>';
                        }
                    }
                    return `<li>
            <input type="checkbox" class="strike-checkbox" id="imalatTipiBosCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>${siparisDisi}
        </li>`;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            if (imalatIssues.anaImalatList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Parça kodu -0000 ile bitip İmalat Tipi IML olan parçalar:</b>
<ul>
    ${imalatIssues.anaImalatList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="anaImalatCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            if (imalatIssues.multiTypeList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Aynı parça kodu ile iki farklı imalat tipi ile düşen parçalar:</b>
        <ul>
            ${imalatIssues.multiTypeList.map(m => `<li>
                <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
                &rarr; Tipler: <b>${m.types}</b>
            </li>`).join("")}
        </ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            if (imalatIssues.wrongTypeList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>İmalat tipi yanlış olan parçalar:</b>
        <ul>
            ${imalatIssues.wrongTypeList.map(m => `<li>
                <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
                &rarr; <span style="color:#c0392b">${m.imalatTipi}</span>
            </li>`).join("")}
        </ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            const invalidProfileChildDescs = findProfileChildrenWithInvalidDescription(xmlDoc);
            if (invalidProfileChildDescs.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil alt kırılım parçalarda Description bilgisinde hatalı karakter/kod bulunanlar:</b>
<ul>
    ${invalidProfileChildDescs.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidProfileChildDescCheck_${i}">
            Çocuk Parça: <span class="parca-kodu-span" data-parca="${m.child.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.child}</b></span>
            &rarr; Ana Parça: <span class="parca-kodu-span" data-parca="${m.parent.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.parent}</b></span>
            <br><span style="color:#c0392b">${m.desc}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const profileChildrenNotDisardaBirak = findProfileChildrenNotDisardaBirak(xmlDoc);
            if (profileChildrenNotDisardaBirak.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil çocuk parçalarda "Profil_Disarda_Birak" alanı "DIŞARDA BIRAK" olmayanlar:</b>
<ul>
    ${profileChildrenNotDisardaBirak.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profileChildrenNotDisardaBirakCheck_${i}">
            Çocuk Parça: <span class="parca-kodu-span" data-parca="${m.child.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.child}</b></span>
            &rarr; Ana Parça: <span class="parca-kodu-span" data-parca="${m.parent.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.parent}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const stdDisardaUyarilar = findDisardaBirakilmisImalatlikParcaUyarilari(window.loadedXmlDoc);
            if (stdDisardaUyarilar.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Dışarda bırakılmış imalatlık parça (reçetede çıkabilir):</b>
<ul>
    ${stdDisardaUyarilar.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="stdDisardaUyariCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span>${m.parentCode || "(Montaj bulunamadı)"}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            // Profil ölçüsü ,00 içerenler
            const parentCommaDescDiv = document.getElementById('parentCommaDesc');
            if (parentsWithCommaDesc.length > 0) {
                parentCommaDescDiv.innerHTML = `<div class="desc-missing-list">
    <b>Profil ölçüsü ,00 içeren parçalar:</b>
    <ul>
        ${parentsWithCommaDesc.map((item, i) => `
            <li>
                <input type="checkbox" class="strike-checkbox" id="parentCommaDescCheck_${i}">
                <span class="parca-kodu-span" data-parca="${item.parentCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${item.parentCode}</b></span>
                &rarr; <span style="color:#c0392b">${item.childDesc}</span>
            </li>
        `).join("")}
    </ul>
    </div>`;
                setTimeout(() => {
                    parentCommaDescDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            } else {
                parentCommaDescDiv.innerHTML = "";
            }

            const multiConfigDocs = findDocumentsWithMultipleConfigurations(xmlDoc);
            if (multiConfigDocs.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Birden fazla configuration içeren document etiketleri (hatalı):</b>
<ul>
    ${multiConfigDocs.map((x, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="multiConfigCheck_${i}">
            <span>
                <b>Document</b> içinde <b>${x.partCodes.length}</b> configuration var: 
                ${x.partCodes.map(pc => `<span style="color:#c0392b">${pc}</span>`).join(", ")}
            </span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const profilePartsWithoutProfileKeyword = findProfilePartsWithoutProfileKeyword(xmlDoc);
            if (profilePartsWithoutProfileKeyword.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil tanım boyunda PROFIL/KOSEBENT/NPU geçmeyen profil benzeri parçalar:</b>
<ul>
    ${profilePartsWithoutProfileKeyword.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profileKeywordCheck_${i}">
            <span class="parca-kodu-span" data-kod="${m.partCode}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.profilTanimBoy}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const hamO1Errors = validateHamO1ForPipes(xmlDoc);
            if (hamO1Errors.length > 0) {
                const hamO1Div = document.createElement('div');
                hamO1Div.className = 'mismatch-list';
                hamO1Div.innerHTML = `<b>Ham_o1 ile ilgili hatalar:</b>
<ul>
    ${hamO1Errors.map(err => `
        <li>
            <span class="parca-kodu-span" data-parca="${err.partCode}"><b>${err.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${err.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(hamO1Div, document.getElementById('accordion'));
            }

            const sipDisiMngSldasmList = findSiparisDisiMngSldasmMontajlar(window.loadedXmlDoc);
            const mngSldasmDiv = document.createElement('div');
            mngSldasmDiv.id = "sipDisiMngSldasmUyari";
            if (sipDisiMngSldasmList.length > 0) {
                mngSldasmDiv.innerHTML = `<div class="mismatch-list">
        <b>Sipariş dışı bırakılmış montajlar:</b>
        <ul>
            ${sipDisiMngSldasmList.map((m, i) => `
                <li>
                    <input type="checkbox" class="strike-checkbox" id="sipDisiMngSldasmCheck_${i}">
                    <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
                </li>
            `).join("")}
        </ul>
    </div>`;
                setTimeout(() => {
                    mngSldasmDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            } else {
                mngSldasmDiv.innerHTML = "";
            }

            document.querySelector('main').insertBefore(mngSldasmDiv, document.getElementById('accordion'));

            document.getElementById('malzemeArama').addEventListener('input', function () {
                const val = this.value.trim().toLowerCase();
                
                // .karsilastir yazılırsa karşılaştırmayı çalıştır
                if (val === ".karşılaştır") {
                    this.value = ""; // Input'u temizle
                    malzemeAccordionKarsilastir();
                    return;
                }
                
                // Sadece .operasyon yazılmadıysa parça kodu araması yap
                if (val && !val.startsWith(".")) {
                    if (typeof filtreAccordionListesi === "function") filtreAccordionListesi();
                }
            });

            // Özel operasyon uyarı listesi
            const specialOpsDiv = document.getElementById('specialOps');
            if (specialOps.length > 0) {
                specialOpsDiv.innerHTML = `<div class="mismatch-list" data-warning="true">
<b>DÖKÜM, KALİTE, BOYA, BÜKÜM veya TESVİYE rotası girilmiş parçalar: <span onclick="toggleSpecialOps()" style="color:#888; font-size:12px; font-weight:normal; cursor:pointer;" ...>(Buraya tıklayarak gizleyebilirsiniz.)</span></b>
<ul id="specialOpsList">
    ${specialOps.map((item, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="specialOpsCheck_${i}">
            <span class="parca-kodu-span" data-parca="${item.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${item.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${item.operation}</span>
        </li>
    `).join("")}
</ul>
</div>`;
                // Varsayılan olarak görünür
                specialOpsDiv.style.display = "";

                // Checkbox event listener'larını ekle
                setTimeout(() => {
                    specialOpsDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            } else {
                specialOpsDiv.innerHTML = "";
            }

            const invalidPartCodes = findInvalidPartCodes(xmlDoc);
            if (invalidPartCodes.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Parça kodu formatı hatalı olanlar:</b>
<ul>
    ${invalidPartCodes.map((code, i) => {
                    // Kod ve açıklamayı ayır
                    const match = code.match(/^([A-Za-z0-9\-]+)\s*(\(.*\))?$/);
                    const kod = match ? match[1] : code;
                    const aciklama = match && match[2] ? match[2] : "";

                    // Sipariş dışı kontrolü
                    const doc = Array.from(xmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return partCode === kod;
                    });
                    let siparisDisi = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf && getAttributeValue(conf, "Siparis_Disi_Birak").trim() === "1") {
                            siparisDisi = ' <span style="color:#e67e22;">(Sipariş Dışı)</span>';
                        }
                    }

                    return `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidPartCodeCheck_${i}">
            <span class="parca-kodu-span" data-kod="${kod}"><b>${kod}</b></span>
            ${aciklama ? `<span style="color:#c0392b;">${aciklama}</span>` : ""}${siparisDisi}
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const profilesWithEmptyLength = findProfilesWithEmptyLength(xmlDoc);
            if (profilesWithEmptyLength.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Uzunluk alanı boş olan profiller:</b>
<ul>
    ${profilesWithEmptyLength.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="emptyLengthCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            <span style="color:#c0392b;">(${m.tip})</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            // UYARI LİSTESİ
            const mismatchDiv = document.getElementById('mismatch');
            if (mismatches.length > 0) {
                mismatchDiv.innerHTML = `<div class="mismatch-list">
        <b>Ana parça kodu ile çocuk parça kodları farklı düşen parçalar:</b>
        <ul>
            ${mismatches.map((m, i) => `
                <li>
                    <input type="checkbox" class="strike-checkbox" id="mismatchCheck_${i}">
                    Ana Parça: <span class="parca-kodu-span" data-parca="${m.parent.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.parent}</b></span>${m.parentFason ? ' <span style="color:#e67e22;">(FASON İŞLEM)</span>' : ''} &rarr; Çocuk: <span class="parca-kodu-span" data-parca="${m.child.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.child}</b></span>
                </li>
            `).join("")}
        </ul>
    </div>`;
                // Sadece checkbox'a tıklanınca satır üstü çizili olsun
                setTimeout(() => {
                    mismatchDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('click', function (e) {
                            if (e.target !== cb) return;
                            const li = cb.closest('li');
                            if (li) li.classList.toggle('strikeout', cb.checked);
                        });
                    });
                    mismatchDiv.querySelectorAll('.parca-kodu-span').forEach(span => {
                        span.onclick = null;
                        span.style.cursor = "default";
                    });
                }, 0);
            } else {
                mismatchDiv.innerHTML = "";
            }

            const invalidRevs = findPartsWithInvalidRevision(xmlDoc).filter(part => {
                return !part.partCode.endsWith('-R00') && part.rev && part.rev.length !== 3;
            });

            if (invalidRevs.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Revizyonu boş, "-" veya REV00 olan 6 haneli olmayan parçalar:</b>
<ul>
    ${invalidRevs.map((x, i) => {
                    // Sipariş dışı kontrolü
                    const doc = Array.from(xmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return partCode === x.partCode;
                    });
                    let siparisDisi = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf && getAttributeValue(conf, "Siparis_Disi_Birak").trim() === "1") {
                            siparisDisi = ' <span style="color:#e67e22;">(Sipariş Dışı)</span>';
                        }
                    }

                    return `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidRevCheck_${i}">
            <span class="parca-kodu-span"><b>${x.partCode}</b></span>
            &rarr; <span style="color:#c0392b;">Revizyon: ${x.rev || "(boş)"}</span>${siparisDisi}
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const emptyHamO2List = findPartsWithEmptyHamO2(xmlDoc);
            if (emptyHamO2List.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Ham_o2 (uzunluk/miktar) alanı boş olan ve miktarı hesaplanamayan parçalar:</b>
<ul>
    ${emptyHamO2List.map(m => `<li>
        <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
        &rarr; <span style="color:#c0392b">${m.hammadde} - ${m.ham_o1}</span>
    </li>`).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            const olcuButEmptyHammadde = findPartsWithOlcuButEmptyHammadde(xmlDoc);
            if (olcuButEmptyHammadde.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Ölçüsü dolu olup hammadde bilgisi boş olan parçalar:</b>
<ul>
    ${olcuButEmptyHammadde.map(m => `<li>
        <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
        &rarr; <span style="color:#c0392b;">Ölçü: ${m.olcu}</span>
    </li>`).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            validateProfileParentParts(loadedXmlDoc);

            const multiRevDiv = document.getElementById('multiRev');
            if (multiRevParts.length > 0) {
                multiRevDiv.innerHTML = `<div class="mismatch-list">
                <b>İki farklı revizyon kodu ile düşen parçalar:</b>
                <ul>
                    ${multiRevParts.map(m => `<li>
                        Parça Kodu: <span class="parca-kodu-span" data-parca="${m.base.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.base}</b></span> &rarr; Versiyonlar: <b>${m.revisions.join(", ")}</b>
                    </li>`).join("")}
                </ul>
            </div>`;
            } else {
                multiRevDiv.innerHTML = "";
            }

            // Dosya yüklendiğinde veya tabloyu güncellediğiniz yerde çağırın:
            const kontrolSonuc = kontrolLevhaLazerPlazma(window.loadedXmlDoc);
            const levhaLazerDiv = document.getElementById('levhaLazerPlazmaKontrol');
            let html = "";

            if (kontrolSonuc.levhaAmaLazerPlazmaDegil.length > 0) {
                html += `
    <div class="mismatch-list">
        <b>LEVHA olup ilk operasyonu LAZER KESİM/PLAZMA KESİM OLMAYANLAR:</b>
        <ul>
            ${kontrolSonuc.levhaAmaLazerPlazmaDegil.map((x, i) => `
                <li>
                    <input type="checkbox" class="strike-checkbox" id="levhaLazerCheck_${i}">
                    <span class="parca-kodu-span" data-parca="${x.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${x.partCode}</b></span>
                    &rarr; İlk Operasyon: <span style="color:#c0392b">${x.ilkOp}</span>
                </li>
            `).join("")}
        </ul>
    </div>
    `;
            }
            if (kontrolSonuc.levhaDegilAmaLazerPlazma.length > 0) {
                html += `
    <div class="mismatch-list">
        <b>LEVHA OLMAYIP ilk operasyonu LAZER KESİM/PLAZMA KESİM OLANLAR:</b>
        <ul>
            ${kontrolSonuc.levhaDegilAmaLazerPlazma.map((x, i) => `
                <li>
                    <input type="checkbox" class="strike-checkbox" id="levhaLazerCheck2_${i}">
                    <span class="parca-kodu-span" data-parca="${x.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${x.partCode}</b></span>
                    &rarr; İlk Operasyon: <span style="color:#c0392b">${x.ilkOp}</span>
                </li>
            `).join("")}
        </ul>
    </div>
    `;
            }
            levhaLazerDiv.innerHTML = html;

            setTimeout(() => {
                levhaLazerDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                    cb.addEventListener('change', function () {
                        const li = this.closest('li');
                        if (li) li.classList.toggle('strikeout', this.checked);
                    });
                });
            }, 0);



            const sameCodeDiffMainList = findSameCodeWithDifferentMainInfos(xmlDoc);
            if (sameCodeDiffMainList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Parça kodu aynı olup Ham_o1, Ham_o2, Hammadde veya Malzeme bilgileri farklı olanlar:</b>
<ul>
    ${sameCodeDiffMainList.map(x => {
                    // Sipariş dışı kontrolü
                    // x.code ile eşleşen document'larda Siparis_Disi_Birak = 1 ise belirt
                    const docs = Array.from(xmlDoc.querySelectorAll("document"));
                    const isSiparisDisi = docs.some(doc => {
                        const conf = doc.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                        return code === x.code && getAttributeValue(conf, "Siparis_Disi_Birak").trim() === "1";
                    });
                    return `
        <li>
            <span class="parca-kodu-span" data-parca="${x.code.replace(/[^a-zA-Z0-9]/g, "")}"><b>${x.code}</b></span>
            ${isSiparisDisi ? ' <span style="color:#e67e22;">(Sipariş Dışı)</span>' : ''}
            &rarr; ${x.names.map(n => `<span>${n}</span>`).join(" , ")}
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            }

            // Description eksik olanlar
            // Çocuk parça kodu hem ana hem de çocuk olarak listeleniyorsa, ana parça kodu ile olanı gizle
            function normalizeCode(code) {
                return (code || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
            }

            const parentCodes = new Set(descMissings.map(x => normalizeCode(x.parent)));
            const filteredDescMissings = descMissings.filter(x => {
                // Eğer hem ana hem çocuk aynıysa (ör: ACH-0695-1600003-R00 → ACH-0695-1600003-R00) göster
                if (normalizeCode(x.parent) === normalizeCode(x.child)) return true;
                // Eğer çocuk kodu başka bir satırda ana parça kodu olarak da varsa, ana parça kodu ile olanı gizle
                if (parentCodes.has(normalizeCode(x.child))) {
                    // Yani hem parent hem child olarak geçiyorsa, sadece child olanı göster
                    return false;
                }
                return true;
            });

            // ...hata listesi oluşturma kısmında filteredDescMissings kullanın...
            const descMissingDiv = document.getElementById('descMissing');
            if (filteredDescMissings.length > 0) {
                descMissingDiv.innerHTML = `<div class="desc-missing-list">
<b><span class="copy-hata-listesi" style="cursor:pointer;">Profil ölçüsü boş parçalar:</span></b>
<ul>
    ${filteredDescMissings.map((m, i) => `
        <li>
    <input type="checkbox" class="strike-checkbox" id="descMissingCheck_${i}">
    Ana Parça: <span class="parca-kodu-span" data-parca="${m.parent.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.parent}</b></span>${m.parentFason ? ' <span style="color:#e67e22;">(FASON İŞLEM)</span>' : ''} &rarr; Çocuk: <span class="parca-kodu-span" data-parca="${m.child.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.child}</b></span>
</li>
    `).join("")}
</ul>
</div>`;

                // Checkbox ile satır üzeri çizili yap
                setTimeout(() => {
                    document.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('click', function (e) {
                            // Sadece checkbox'a tıklanınca çalışsın
                            if (e.target !== cb) return;
                            const li = cb.closest('li');
                            if (li) li.classList.toggle('strikeout', cb.checked);
                        });
                    });
                    // parca-kodu-span için onclick veya event eklenmişse kaldırın!
                    document.querySelectorAll('.parca-kodu-span').forEach(span => {
                        span.onclick = null;
                        span.style.cursor = "default";
                    });
                }, 0);
            } else {
                descMissingDiv.innerHTML = "";
            }

            const profilUzunlukHatalari = findProfileLengthMismatch(xmlDoc);
            if (profilUzunlukHatalari.length > 0) {
                // Gizlenebilir mi kontrolü: Tüm hataların eşleşen profilleri var mı?
                const tumHatalardaEslesenVar = profilUzunlukHatalari.every(m => m.eslesenler.length > 0);
                
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.id = 'profilUzunlukHatalariDiv';
                
                let gizlemeButonaHtml = "";
                if (tumHatalardaEslesenVar) {
                    gizlemeButonaHtml = ` <span onclick="toggleProfilUzunlukHatalari()" style="color:#888; font-size:12px; font-weight:normal; cursor:pointer;" title="Tıklayarak gizle">(Buraya tıklayarak gizleyebilirsiniz.)</span>`;
                }
                
                div.innerHTML = `<b>Profil tanımında L= miktarı ile çocukların toplam uzunluğu uyuşmayanlar:${gizlemeButonaHtml}</b>
<ul>
    ${profilUzunlukHatalari.map((m, i) => {
                    // FASON İŞLEM ve Sipariş Dışı kontrolü
                    let fason = "";
                    let sipDisi = "";
                    // İlgili document'ı bul
                    const doc = Array.from(xmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === m.partCode;
                    });
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        // Fason kontrolü
                        for (let j = 1; j <= 8; j++) {
                            const op = (getAttributeValue(conf, `OP${j}_Tanim`) || "").toUpperCase();
                            if (op === "FASON İŞLEM") {
                                fason = " (FASON İŞLEM)";
                                break;
                            }
                        }
                        // Sipariş dışı kontrolü
                        if ((getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim() === "1") {
                            sipDisi = " (Sipariş Dışı)";
                        }
                    }
                    return `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profilUzunlukHataCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            ${fason}${sipDisi}
            <ul>
                ${m.eslesmeyenler.map(e => `
                    <li>
                        <span style="color:#c0392b">${e.profilTanimBoy}</span>
                        <br>L= <b>${e.lMiktar}</b> &nbsp; | &nbsp; Çocuk Toplam: <b>${e.toplamUzunluk}</b>
                    </li>
                `).join("")}
                ${m.eslesenler.length > 0 ? `
                    <li>
                        <span style="color:#27ae60">
                            Çocuk parçalar ile eşleşen tanım: (${m.eslesenler.map(e => `${e.profilTanimBoy} [L=${e.lMiktar}]`).join(", ")})
                        </span>
                    </li>
                ` : ""}
            </ul>
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            // Hata yok div'ini ilk yükleme sırasında da kontrol et
            guncelleHataYokDiv();

            const partsList = findHamO2Over6000Parts(xmlDoc);
            renderPartsList(partsList);

            const profilTanimBoyHatalari = findProfileMainPartsWithInvalidProfilTanimBoy(xmlDoc);
            if (profilTanimBoyHatalari.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil tanım boyunda hatalı karakter olup çocuk parça ile eşleşmeyenler:</b>
<ul>
    ${profilTanimBoyHatalari.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profilTanimBoyHataCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.profilTanimBoy}</span>
            ${m.toplamUzunlukHtml || ""}
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const invalidProfileMainParts = findInvalidProfileMainParts(xmlDoc);
            if (invalidProfileMainParts.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Bilgileri doğru olmayan profil ana parçaları:</b>
<ul>
    ${invalidProfileMainParts.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidProfileMainCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.tip}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            // Malzeme hataları
            // Malzeme hataları
            if (invalidMaterials.length > 0) {
                const filteredInvalidMaterials = invalidMaterials.filter(m => {
                    const doc = Array.from(xmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === m.partCode;
                    });
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        const siparisDisiBirak = conf && getAttributeValue(conf, "Siparis_Disi_Birak").trim();
                        return siparisDisiBirak !== "1"; // Sipariş Dışı olanları hariç tut
                    }
                    return true; // Eğer doküman bulunamazsa listeye dahil et
                });

                if (filteredInvalidMaterials.length > 0) {
                    const matDiv = document.createElement('div');
                    matDiv.className = 'mismatch-list';
                    matDiv.innerHTML = `<b>Malzeme bilgisi yanlış olan parçalar:</b>
<ul>
    ${filteredInvalidMaterials.map((m, i) => {
                        let malzemeUyari = "";
                        if (
                            m.material &&
                            m.material.replace(/\s+/g, "").toUpperCase() === "55SI7" ||
                            m.material.replace(/\s+/g, "") === "55 SI 7"
                        ) {
                            malzemeUyari = `<span style="color:#e67e22;"> (Doğru yazımı: <b>55Si7</b>)</span>`;
                        }
                        return `<li>
            <input type="checkbox" class="strike-checkbox" id="invalidMatCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.material}</span>${malzemeUyari}
        </li>`;
                    }).join("")}
</ul>`;
                    document.querySelector('main').insertBefore(matDiv, document.getElementById('accordion'));
                    setTimeout(() => {
                        matDiv.querySelectorAll('.strike-checkbox').forEach(cb => {
                            cb.addEventListener('click', function (e) {
                                if (e.target !== cb) return;
                                const li = cb.closest('li');
                                if (li) li.classList.toggle('strikeout', cb.checked);
                            });
                        });
                        matDiv.querySelectorAll('.parca-kodu-span').forEach(span => {
                            span.onclick = null;
                            span.style.cursor = "default";
                        });
                    }, 0);
                }
            }

            // Ham_o2/Uzunluk > 6000 mm olanlar kesinlikle hata sayılmasın
            const hamO2List = findHamO2Over6000Parts(xmlDoc);
            // Ham_o2/Uzunluk > 6000 mm ve özel operasyonlar kesinlikle hata sayılmasın
            const tumHataListeleri = [
                mismatches,
                descMissings,
                multiRevParts,
                parentsWithCommaDesc,
                imalatIssues.emptyList,
                imalatIssues.anaImalatList,
                imalatIssues.multiTypeList,
                imalatIssues.wrongTypeList,
                invalidERP,
                invalidMaterials,
                stdMaterialWarnings,
                findDisardaBirakilmisImalatlikParcaUyarilari(window.loadedXmlDoc),
                findProfilesWithEmptyLength(xmlDoc),
                findPartsWithOlcuButEmptyHammadde(xmlDoc),
                findDisardaBirakilmisProfilOlmayanParcaUyarilari(window.loadedXmlDoc),
                findSiparisDisiMngSldasmMontajlar(window.loadedXmlDoc),
                findDocumentsWithMultipleConfigurations(xmlDoc),
                kontrolLevhaLazerPlazma(window.loadedXmlDoc).levhaAmaLazerPlazmaDegil,
                kontrolLevhaLazerPlazma(window.loadedXmlDoc).levhaDegilAmaLazerPlazma,
                findProfileLengthMismatch(xmlDoc),
                findProfileMainPartsWithInvalidProfilTanimBoy(xmlDoc),
                findInvalidProfileMainParts(xmlDoc),
                findProfileChildrenWithInvalidDescription(xmlDoc),
                findProfilePartsWithoutProfileKeyword(xmlDoc),
                findPartsWithCodeNotInName(xmlDoc),
                findKaplamaRotasiBosKaplama(xmlDoc),
                findDerlinPartsWithoutSiparisNotu(xmlDoc),
                findPartsWithInvalidRevision(xmlDoc),
                findPartsWithEmptyHamO2(xmlDoc),
                findSameCodeWithDifferentMainInfos(xmlDoc),
                findProfileChildrenWithEmptyProfilTipi(xmlDoc),
                findInvalidPartCodes(xmlDoc)
            ];

            // En az birinde hata varsa hataYok = false
            const hataYok = tumHataListeleri.every(list => Array.isArray(list) ? list.length === 0 : true);

            let hataYokDiv = document.getElementById('hataYokDiv');
            if (!hataYokDiv) {
                hataYokDiv = document.createElement('div');
                hataYokDiv.id = 'hataYokDiv';
                hataYokDiv.style = "margin:18px 0 10px 0; font-size:18px; font-weight:bold; color:#27ae60;";
                document.querySelector('main').insertBefore(hataYokDiv, document.querySelector('main').firstChild);
            }
            hataYokDiv.textContent = hataYok ? "Hata yok." : "";

            guncelleHataYokDiv();

            // Accordion alan kontrolü
            const accordion = document.getElementById('accordion');
            accordion.innerHTML = "";

            // Parçaları tekrar etmeden, hiyerarşik ve girintili şekilde ekle
            function listPartsRecursive(docNode, yol, depth, parentMultiplier) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const desc = (getAttributeValue(conf, "Description") || "").trim();
                const name = (getAttributeValue(conf, "Name") || "").trim();
                const parentPartCode = arguments[4] || partCode;

                // --- GÜNCEL KONTROL ---
                // Eğer çocuk parça kodu, ana parça kodu ile aynı başlıyorsa (ör: ACH-0695-1600003 ve ACH-0695-1600003-R00 gibi)
                // veya tamamen aynıysa, sheet/kesim listesi/cut-list-item kontrolünü atla ve göster
                if (
                    partCode !== parentPartCode &&
                    !(
                        partCode === parentPartCode ||
                        partCode.startsWith(parentPartCode + "-R")
                    ) && (
                        desc.includes("SHEET") ||
                        desc.includes("KESIM LISTESI") ||
                        desc.includes("CUT-LIST-ITEM") ||
                        name.includes("SHEET") ||
                        name.includes("KESIM LISTESI") ||
                        name.includes("CUT-LIST-ITEM")
                    )
                ) {
                    return;
                }


                // quantity özniteliğini oku, yoksa 1 al
                const adet = parseInt(conf.getAttribute("quantity")) || 1;
                const toplamAdet = adet * parentMultiplier;

                const attributes = conf
                    ? Array.from(conf.children)
                        .filter(child => child.tagName === "attribute")
                        .map(attr => ({
                            name: attr.getAttribute("name"),
                            value: attr.getAttribute("value")
                        }))
                    : [];

                const visibleChildDocs = Array.from(docNode.querySelectorAll(':scope > configuration > references > document'));
                const hasVisibleChildren = visibleChildDocs.some(childDoc => {
                    const childConf = childDoc.querySelector('configuration');
                    if (!childConf) return false;
                    const childPartCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childDoc, "Parca_Kodu") || getAttributeValue(childDoc, "Name") || "";
                    // Ana parça kodu ile aynıysa veya -R ile başlıyorsa her zaman görünür kabul et
                    if (
                        childPartCode === partCode ||
                        childPartCode.startsWith(partCode + "-R")
                    ) return true;
                    const desc = (getAttributeValue(childConf, "Description") || "").toUpperCase();
                    const name = (getAttributeValue(childConf, "Name") || "").toUpperCase();
                    if (
                        desc.includes("SHEET") ||
                        desc.includes("KESIM LISTESI") ||
                        name.includes("SHEET") ||
                        name.includes("KESIM LISTESI") ||
                        desc.includes("CUT-LIST-ITEM") ||
                        name.includes("CUT-LIST-ITEM")
                    ) return false;
                    return true;
                });

                const originalPartCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();
                let extraInfo = "";
                if (siparisDisiBirak === "1") {
                    extraInfo = `<span style="color:#c0392b;"> (Sipariş Dışı)</span>`;
                }

                let infoRows = attributes
                    .filter(attr => attr.value && attr.value.trim() !== "")
                    .map(attr => `<tr><td>${attr.name}</td><td>${attr.value}</td></tr>`)
                    .join("");

                const item = document.createElement('div');
                item.className = 'accordion-item';
                item.id = `parca_${originalPartCode.replace(/[^a-zA-Z0-9]/g, "")}_${yol.replace(/\./g, '_')}`;
                item.setAttribute('data-yol', yol); // <--- BURAYA EKLE

                const cleanName = name.replace(/\.(SLDPRT|SLDASM)$/i, "");

                function temizleUzantiyi(name) {
                    return (name || "").replace(/\.(SLDPRT|SLDASM)$/i, "").trim();
                }

                let stdEk = "";
                if (/^[A-Z0-9]{6}$/.test(partCode)) {
                    const cleanDesc = (desc || "").trim();
                    const cleanName = temizleUzantiyi(name);
                    // Eğer description ve name birebir aynıysa sadece birini yaz
                    if (cleanDesc && cleanName && cleanDesc === cleanName) {
                        stdEk = `<span style="font-size:12px; color:#444; font-weight:normal; margin-left:8px;">- ${cleanDesc}</span>`;
                    } else if (cleanDesc || cleanName) {
                        stdEk = `<span style="font-size:12px; color:#444; font-weight:normal; margin-left:8px;">- ${cleanDesc}${cleanDesc && cleanName ? " | " : ""}${cleanName}</span>`;
                    }
                }

                item.innerHTML = `
<div class="accordion-title" style="padding-left:${depth * 32 + 18}px; display: flex; justify-content: space-between; align-items: center;">
    <span style="display:flex; align-items:center; gap:8px;">
        ${hasVisibleChildren ? `<span class="accordion-arrow" style="display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; color:#bbb; font-size:17px; transition:transform 0.2s; user-select:none; margin-right:4px;">&#9654;</span>` : `<span style="display:inline-block; width:20px;"></span>`}
        ${yol}. Parça: <b class="parca-kodu-click">${partCode}</b>${stdEk}${extraInfo}
    </span>
    <span style="min-width:120px; text-align:right; color:#2563eb; font-size:14px; display:flex; align-items:center; gap:8px;">
        Adet: <b>${adet}</b> <span style="color:#888;">|</span> Toplam: <b>${toplamAdet}</b>
        <button class="info-btn" style="background:#eee; color:#888; border:none; border-radius:50%; width:26px; height:26px; font-size:16px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;" title="Özellikleri Göster/Gizle">&#8505;</button>
    </span>
</div>
<div class="accordion-content">
    <table>
        <thead>
            <tr>
                <th>Alan</th>
                <th>Değer</th>
            </tr>
        </thead>
        <tbody>
            ${infoRows}
        </tbody>
    </table>
    <div class="goto-back-btn-container"></div>
</div>
`;

                accordion.appendChild(item);

                const arrow = item.querySelector('.accordion-arrow');
                const content = item.querySelector('.accordion-content');
                const title = item.querySelector('.accordion-title');
                const infoBtn = item.querySelector('.info-btn');

                // Parça başlığına tıklayınca alt parçaları aç/kapa
                if (title) {
                    title.addEventListener('click', function (e) {
                        // Eğer bilgi butonuna tıklandıysa alt parça açma!
                        if (e.target.classList.contains('info-btn')) return;
                        const myYol = item.getAttribute('data-yol');
                        const isOpen = item.classList.toggle('ac-open');
                        if (arrow) arrow.style.transform = isOpen ? "rotate(90deg)" : "rotate(0deg)";
                        document.querySelectorAll('.accordion-item').forEach(child => {
                            const childYol = child.getAttribute('data-yol');
                            if (childYol && childYol.startsWith(myYol + '.') && childYol.split('.').length === myYol.split('.').length + 1) {
                                child.style.display = isOpen ? "" : "none";
                                if (!isOpen) {
                                    child.classList.remove('ac-open');
                                    // Alt montajlar ve bilgiler otomatik kapansın
                                    document.querySelectorAll('.accordion-item').forEach(grandChild => {
                                        const grandChildYol = grandChild.getAttribute('data-yol');
                                        if (grandChildYol && grandChildYol.startsWith(childYol + '.')) {
                                            grandChild.style.display = "none";
                                            grandChild.classList.remove('ac-open');
                                            // Bilgi panelini de kapat
                                            const grandContent = grandChild.querySelector('.accordion-content');
                                            if (grandContent) grandContent.style.display = "none";
                                        }
                                    });
                                    // Bilgi panelini de kapat
                                    const childContent = child.querySelector('.accordion-content');
                                    if (childContent) childContent.style.display = "none";
                                }
                            }
                        });
                        // Kendi bilgi panelini de kapat
                        if (!isOpen) {
                            if (content) content.style.display = "none";
                        }
                    });
                }

                // Sağdaki gri bilgi butonuna tıklayınca özellikleri aç/kapa
                if (infoBtn) {
                    infoBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        content.style.display = (content.style.display === "block") ? "none" : "block";
                    });
                }
                content.style.display = "none";
                if (depth > 0) item.style.display = "none";

                // Alt montajları sırayla gez
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                childDocs.forEach((childDoc, idx) => {
                    // parentPartCode bilgisini çocuklara aktar
                    listPartsRecursive(childDoc, yol + '.' + (idx + 1), depth + 1, toplamAdet, partCode);
                });
            }

            //             const profilesWithEmptyLValue = findProfilesWithEmptyLValue(xmlDoc);
            //             if (profilesWithEmptyLValue.length > 0) {
            //                 const div = document.createElement('div');
            //                 div.className = 'mismatch-list';
            //                 div.innerHTML = `<b>Profil tanımında L= değeri boş olanlar:</b>
            // <ul>
            //     ${profilesWithEmptyLValue.map((m, i) => `
            //         <li>
            //             <input type="checkbox" class="strike-checkbox" id="profilEmptyLCheck_${i}">
            //             <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            //             &rarr; <span style="color:#c0392b">${m.profilTanimBoy}</span>
            //         </li>
            //     `).join("")}
            // </ul>`;
            //                 document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
            //                 setTimeout(() => {
            //                     div.querySelectorAll('.strike-checkbox').forEach(cb => {
            //                         cb.addEventListener('change', function () {
            //                             const li = this.closest('li');
            //                             if (li) li.classList.toggle('strikeout', this.checked);
            //                         });
            //                     });
            //                 }, 0);
            //             }

            const kaplamaBosList = findKaplamaRotasiBosKaplama(xmlDoc);
            if (kaplamaBosList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Rotasında KAPLAMA olup Kaplama değeri boş olan parçalar:</b>
<ul>
    ${kaplamaBosList.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="kaplamaBosCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const derlinSiparisNotuHatalari = findDerlinPartsWithoutSiparisNotu(xmlDoc);
            if (derlinSiparisNotuHatalari.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Malzemesi DERLIN olup Sipariş Notu alanı boş olan parçalar:</b>
<ul>
    ${derlinSiparisNotuHatalari.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="derlinSiparisCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const codeNotInNameList = findPartsWithCodeNotInName(xmlDoc);
            if (codeNotInNameList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Parça kodu, Name alanında geçmeyen ana parçalar veya montajlar:</b>
<ul>
    ${codeNotInNameList.map((x, i) => {
                    // Sipariş dışı kontrolü
                    const doc = Array.from(xmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === x.partCode;
                    });
                    let siparisDisi = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf && getAttributeValue(conf, "Siparis_Disi_Birak").trim() === "1") {
                            siparisDisi = ' <span style="color:#e67e22;">(Sipariş Dışı)</span>';
                        }
                    }
                    return `
        <li>
            <input type="checkbox" class="strike-checkbox" id="nameCheck_${i}">
            Ana Parça: <span class="parca-kodu-span" data-parca="${x.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${x.partCode}</b></span>
            ${siparisDisi}
            &rarr; <span style="color:#c0392b">${x.name}</span>
        </li>
        `;
                }).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                // Sadece checkbox'a tıklanınca satır üstü çizili olsun
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('click', function (e) {
                            if (e.target !== cb) return;
                            const li = cb.closest('li');
                            if (li) li.classList.toggle('strikeout', cb.checked);
                        });
                    });
                    div.querySelectorAll('.parca-kodu-span').forEach(span => {
                        span.onclick = null;
                        span.style.cursor = "default";
                    });
                }, 0);
            }

            const profilDisardaUyarilar = findDisardaBirakilmisProfilOlmayanParcaUyarilari(window.loadedXmlDoc);
            if (profilDisardaUyarilar.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Profil dışarıda bırakıldığı için dışarıda kalmış ve montaj reçetesine çekilmiş (profil olmayanlar):</b>
<ul>
    ${profilDisardaUyarilar.map((m, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="profilDisardaUyariCheck_${i}">
            <span class="parca-kodu-span" data-parca="${m.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${m.partCode}</b></span>
            &rarr; <span style="color:#c0392b">${m.parentPartCode ? m.parentPartCode : "-"}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }

            const documents = xmlDoc.querySelectorAll("document");

            // Kökten başlat (sadece kök montajlar için)
            const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
            rootDocs.forEach((doc, idx) => {
                listPartsRecursive(doc, (idx + 1).toString(), 0, setAdedi); // parentMultiplier = setAdedi
            });

            // Yukarı çıkma butonu için
            let floatingBtn = null;
            let scrollListener = null;
            function showFloatingBackBtn(targetSpan) {
                if (!floatingBtn) {
                    floatingBtn = document.createElement('button');
                    floatingBtn.id = 'floating-back-btn';
                    floatingBtn.innerHTML = '↑';
                    document.body.appendChild(floatingBtn);
                }
                floatingBtn.classList.remove('hide');
                floatingBtn.onclick = function () {
                    if (targetSpan) {
                        targetSpan.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                    floatingBtn.classList.add('hide');
                };

                if (scrollListener) window.removeEventListener('scroll', scrollListener);
                let initialScroll = window.scrollY;
                scrollListener = function () {
                    if (Math.abs(window.scrollY - initialScroll) > 120) {
                        floatingBtn.classList.add('hide');
                        window.removeEventListener('scroll', scrollListener);
                    }
                };
                setTimeout(() => {
                    window.addEventListener('scroll', scrollListener);
                }, 1000);
            }
            guncelleHataYokDiv();
            
            // Otomatik malzeme karşılaştırması (bildirim için)
            setTimeout(() => {
                otomatikMalzemeKarsilastirma();
            }, 500);
        }

        function guncelleHataYokDiv() {
            // Tüm potansiyel hata/u yarı bloklarını al
            const allHataDivs = Array.from(document.querySelectorAll('.mismatch-list, .desc-missing-list'));

            // Gerçek hata olarak sayılacakları filtrele:
            const realErrorDivs = allHataDivs.filter(div => {
                // 1) Eğer explicit olarak uyarı (warning) olarak işaretlenmişse hariç tut
                if (div.dataset && div.dataset.warning === "true") return false;

                // 2) Eğer bu div specialOps kapsayıcısı içindeyse hariç tut (önlem)
                if (div.closest && div.closest('#specialOps')) return false;

                // 3) Eğer id hamO2Container ise hariç tut (ek güvenlik)
                if (div.id === 'hamO2Container') return false;

                // 4) Görünürlük kontrolü: display:none / visibility:hidden / opacity:0 ise sayma
                const cs = window.getComputedStyle(div);
                if (cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity) === 0) return false;

                // 5) Aksi halde gerçek bir hata bloğu say
                return true;
            });

            let hataYokDiv = document.getElementById('hataYokDiv');
            if (!hataYokDiv) {
                hataYokDiv = document.createElement('div');
                hataYokDiv.id = 'hataYokDiv';
                hataYokDiv.style = "margin:18px 0 10px 0; font-size:18px; font-weight:bold; color:#27ae60;";
                document.querySelector('main').insertBefore(hataYokDiv, document.querySelector('main').firstChild);
            }

            // Sadece gerçek hata yoksa göster
            hataYokDiv.textContent = (realErrorDivs.length === 0) ? "Hata yok." : "";
        }

        function checkXmlEmptyLineError(xmlDoc, xmlText) {
            // XML metninde boş satır var mı kontrol et
            const lines = xmlText.split(/\r?\n/);
            // Eğer toplam satır sayısı 2 ise ve ikinci satır tamamen boşsa, kontrolü atla
            if (lines.length === 2 && lines[1].trim() === "") {
                return [];
            }
            let hataSatirlar = [];
            lines.forEach((line, idx) => {
                // Sadece <document> veya <configuration> içeren bloklarda, tamamen boş satır varsa
                if (
                    line.trim() === "" &&
                    (
                        (lines[idx - 1] && (lines[idx - 1].includes("<attribute") || lines[idx - 1].includes("<configuration") || lines[idx - 1].includes("<document"))) ||
                        (lines[idx + 1] && (lines[idx + 1].includes("<attribute") || lines[idx + 1].includes("<configuration") || lines[idx + 1].includes("<document")))
                    )
                ) {
                    hataSatirlar.push(idx + 1); // Satır numarası
                }
            });
            return hataSatirlar;
        }

        function findPartsWithCodeNotInName(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();
                const desc = (getAttributeValue(conf, "Description") || "").toUpperCase();

                // Sadece ana parça veya montaj: name .SLDPRT veya .SLDASM ile bitmeli
                if (!(name.endsWith(".SLDPRT") || name.endsWith(".SLDASM"))) return;

                // PROFIL/ NPU/ KOSEBENT/ IPE geçen profil çocuklarını hariç tut
                if (
                    desc.includes("PROFIL/") ||
                    desc.includes("PROFİL/") ||
                    desc.includes("NPU/") ||
                    desc.includes("KOSEBENT/") ||
                    desc.includes("IPE")
                ) return;

                // 6 haneli standart parça kodlarını atla
                if (/^[A-Z0-9]{6}$/.test(partCode)) return;

                // Parça kodu, name içinde geçmiyorsa uyarı ver
                if (partCode && name && !name.includes(partCode)) {
                    result.push({ partCode, name });
                }
            });
            return result;
        }

        function findKaplamaRotasiBosKaplama(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                let rotaKaplamaVar = false;
                for (let i = 1; i <= 8; i++) {
                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").toUpperCase();
                    if (op.includes("KAPLAMA")) {
                        rotaKaplamaVar = true;
                        break;
                    }
                }
                const kaplama = (getAttributeValue(conf, "Kaplama") || "").trim();
                if (rotaKaplamaVar && !kaplama) {
                    const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                    result.push({ partCode });
                }
            });
            return result;
        }

        function findDerlinPartsWithoutSiparisNotu(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim().toUpperCase();
                const siparisNotu = (getAttributeValue(conf, "Siparis_Notu") || "").trim();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                if (malzeme === "DERLIN" && !siparisNotu) {
                    result.push({ partCode });
                }
            });
            return result;
        }

        function validateHamO1ForPipes(xmlDoc) {
            const materialsWithErrors = [];

            const documents = Array.from(xmlDoc.querySelectorAll("document"));
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu");
                const hammadde = getAttributeValue(conf, "Hammadde");
                const ham_o1 = getAttributeValue(conf, "Ham_o1");

                // Sadece "Boru" veya "Temiz Ölçülü Boru" için kontrol yap
                if (["Boru", "Temiz Ölçülü Boru"].includes(hammadde)) {
                    if (!ham_o1) {
                        materialsWithErrors.push({
                            partCode: partCode || "Belirsiz",
                            message: `Ham_o1 değeri eksik.`
                        });
                        return;
                    }

                    const dimensions = ham_o1.match(/Ø\s*(\d+(\.\d+)?)\s*[-x]\s*Ø?\s*(\d+(\.\d+)?)/i);
                    if (!dimensions) {
                        materialsWithErrors.push({
                            partCode: partCode || "Belirsiz",
                            message: `Ham_o1 değeri doğru formatta değil, örnek: Ø198.5 - Ø140 veya Ø 198.5 - Ø 140. Girilen: ${ham_o1}.`
                        });
                        return;
                    }
                    const first = parseFloat(dimensions[1]);
                    const second = parseFloat(dimensions[3]);
                    if (first < second) {
                        materialsWithErrors.push({
                            partCode: partCode || "Belirsiz",
                            message: `Ham_o1 değeri küçük ölçü önce, büyük ölçü sonra yazılmış: ${ham_o1}.`
                        });
                    }
                }
            });

            return materialsWithErrors;
        }

        function findDisardaBirakilmisImalatlikParcaUyarilari(xmlDoc) {
            const acceptedMaterials = [
                "HARDOX400", "PPRC", "BAKIR", "MDF", "ST52_SOGUK CEKIM", "ALUDUR PLUS", "MIKA", "SOLID", "16MNCR5",
                "CK45_INDUKSIYONLU KROM KAPLI", "AL2017", "YAY CELIGI", "55SI7", "NAYLON 6/10", "ALPOLEN1000", "ETIAL 160",
                "1050 H14", "1054 H14", "PA6", "ALUMINYUMKOMPOZIT", "CUZN25AL5", "45CR2", "34CRALNI7-10", "PPE", "DIN 17223"
            ].map(m => m.trim().toUpperCase());

            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();
                const hammadde = getAttributeValue(conf, "Hammadde").trim().toUpperCase();
                const hammaddeOlcusu = getAttributeValue(conf, "Hammadde_Olcusu").trim().toUpperCase();
                const ham_o1 = getAttributeValue(conf, "Ham_o1").trim();
                const malzeme = getAttributeValue(conf, "Malzeme").trim().toUpperCase();
                const imalatTipi = getAttributeValue(conf, "İmalat_Tipi").trim().toUpperCase();
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                // Üst montajı bul
                let parentDoc = doc.parentElement;
                let parentConf = null;
                let parentSiparisDisi = "";
                while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() !== "document") {
                    parentDoc = parentDoc.parentElement;
                }
                if (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() === "document") {
                    parentConf = parentDoc.querySelector("configuration");
                    parentSiparisDisi = parentConf ? getAttributeValue(parentConf, "Siparis_Disi_Birak").trim() : "";
                }

                // Sipariş dışı bırakılmış ve hammadde ile hammadde ölçüsü STD olan parçaları kontrol et
                if (
                    siparisDisiBirak === "1" &&
                    hammadde === "STD" &&
                    hammaddeOlcusu === "STD"
                ) {
                    // Tüm üst montaj zincirini kontrol et
                    let parentDoc = doc.parentElement;
                    let anyParentNotDis = false;
                    let parentCode = "";
                    while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() !== "document") {
                        parentDoc = parentDoc.parentElement;
                    }
                    while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() === "document") {
                        const parentConf = parentDoc.querySelector("configuration");
                        const parentSiparisDisi = parentConf ? getAttributeValue(parentConf, "Siparis_Disi_Birak").trim() : "";
                        if (parentSiparisDisi !== "1") {
                            anyParentNotDis = true;
                            parentCode = getAttributeValue(parentConf, "Parca_Kodu") || getAttributeValue(parentDoc, "Parca_Kodu") || getAttributeValue(parentDoc, "Name") || "";
                            break;
                        }
                        // Bir üst montaja çık
                        parentDoc = parentDoc.parentElement;
                        while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() !== "document") {
                            parentDoc = parentDoc.parentElement;
                        }
                    }
                    // Eğer zincirde sipariş dışı olmayan bir üst montaj varsa hata ver
                    if (anyParentNotDis) {
                        result.push({
                            partCode,
                            parentCode,
                            message: "Sipariş dışı bırakılmış ve hammadde STD olan parça montaj reçetesine çekilmiş."
                        });
                    }
                    return;
                }

                if (
                    siparisDisiBirak === "1" &&
                    ham_o1 !== "" &&
                    hammadde !== "" &&
                    hammaddeOlcusu !== "" &&
                    acceptedMaterials.includes(malzeme) &&
                    imalatTipi === "IML" &&
                    name.endsWith(".SLDPRT")
                ) {
                    // Hangi montajda geçtiğini bul
                    let parentDoc = doc.parentElement;
                    let parentConf = null;
                    while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() !== "document") {
                        parentDoc = parentDoc.parentElement;
                    }
                    let parentCode = "";
                    let parentName = "";
                    if (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() === "document") {
                        parentConf = parentDoc.querySelector("configuration");
                        parentCode = getAttributeValue(parentConf, "Parca_Kodu") || getAttributeValue(parentDoc, "Parca_Kodu") || getAttributeValue(parentDoc, "Name") || "";
                        parentName = getAttributeValue(parentConf, "Name") || "";
                    }
                    result.push({
                        partCode,
                        parentCode,
                        parentName,
                        malzeme,
                    });
                }
            });
            return result;
        }

        function findPartsWithFasonAndKesim(xmlDoc) {
            const result = [];
            const kesimOps = ["PLAZMA KESİM", "LAZER KESİM", "SU JETİ"];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                let hasFason = false;
                let hasKesim = false;
                let kesimTipi = "";
                for (let i = 1; i <= 8; i++) {
                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").toUpperCase();
                    if (op === "FASON İŞLEM") hasFason = true;
                    if (kesimOps.some(k => op === k)) {
                        hasKesim = true;
                        kesimTipi = op;
                    }
                }
                if (hasFason && hasKesim) {
                    result.push({
                        partCode,
                        message: `Hem FASON İŞLEM hem de ${kesimTipi} rotası girilmiş!`
                    });
                }
            });
            return result;
        }



        function findInvalidMngPartCodes(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");

            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();
                const siparisDisiBirak = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim().toUpperCase();

                // Sipariş dışı bırakılan parçaları kontrol etme
                if (siparisDisiBirak === "1") return;
                
                // Parça kodunda harf içermeyen, sadece sayı ile 6 karakterden oluşan ve malzeme bilgisi STD olan parçalar için kontrol yapma
                if (malzeme === "STD" && /^\d{6}$/.test(partCode)) return;

                // MAK olanları hatada gösterme, ancak kontrol et
                if (imalatTipi === "MAK") {
                    const lastSevenDigits = partCode.slice(-7);
                    if (lastSevenDigits !== "0000000") {
                        result.push({
                            partCode,
                            message: "İmalat tipi MAK ve son yedi hanesi 0000000 değil."
                        });
                    }
                    return; // MAK olanları diğer kontrollerden çıkar
                }
                if (imalatTipi === "MNG" && partCode.endsWith("-0000000")) {
                    result.push({
                        partCode,
                        message: "-0000000 montajlarının imalat tipi MAK olmalıdır."
                    });
                }

                // Varyant kontrolü: Son beş hanenin başında "-" varsa varyantlıdır
                const isVariant = /-\d{4}$/.test(partCode) || /-\d{4}$/.test(partCode.slice(-5));

                if (isVariant) {
                    // Varyantlı parçalarda son sekiz hanenin ilk üç hanesi "000" ise hatalı
                    const lastEight = partCode.slice(-8);
                    const firstThreeOfLastEight = lastEight.slice(0, 3);
                    if (firstThreeOfLastEight === "000") {
                        result.push({
                            partCode,
                            message: "Varyantlı ancak son sekiz hanenin ilk üç hanesi 000."
                        });
                    }
                } else {
                    // Varyantlı değilse
                    const lastThree = partCode.slice(-3);
                    if (imalatTipi === "MNG") {
                        // İmalat tipi MNG ise son üç hanesi 000 olmalıdır
                        if (lastThree !== "000") {
                            result.push({
                                partCode,
                                message: "Varyantlı değil ve son üç hanesi 000 değil."
                            });
                        }
                    } else {
                        // İmalat tipi MNG değilse ve son üç hanesi 000 ise hatalı
                        if (lastThree === "000") {
                            result.push({
                                partCode,
                                message: "İmalat tipi MNG değil ancak son üç hanesi 000."
                            });
                        }
                    }
                }
            });

            return result;
        }

        function findMngPartErrors(xmlDoc) {
            const errors1 = []; // Dördü aynı anda dolu
            const errors2 = []; // Varyantlı ve -0000 ile bitmeyenler
            const errors3 = []; // Name .SLDPRT ile bitiyor

            const seen1 = new Set();
            const seen2 = new Set();
            const seen3 = new Set();

            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim();
                const ham_o1 = (getAttributeValue(conf, "Ham_o1") || "").trim();
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim();
                const erpCode = (getAttributeValue(conf, "Malzeme_ERP_Code") || "").trim();
                const name = (getAttributeValue(conf, "Name") || "").trim();

                if (imalatTipi === "MNG") {
                    // 1. Dördü aynı anda doluysa ve daha önce eklenmediyse
                    if (hammadde && ham_o1 && malzeme && erpCode && !seen1.has(partCode)) {
                        errors1.push({
                            partCode,
                            message: "MNG tipi parçada Hammadde, Ham_o1, Malzeme ve Malzeme_ERP_Code alanları dördü aynı anda dolu!"
                        });
                        seen1.add(partCode);
                    }
                    // 2. Varyantlı ve -0000 ile bitmeyenler (ör: -0001, -0002, -0003, ... -0009, -0010, -0011, ...)
                    const varyantMatch = partCode.match(/-\d{4}$/);
                    if (varyantMatch && !partCode.endsWith("-0000") && !seen2.has(partCode)) {
                        errors2.push({
                            partCode,
                            message: "MNG tipi varyantlı parça kodu -0000 ile bitmiyorsa hatalı!"
                        });
                        seen2.add(partCode);
                    }
                    // 3. Name alanı .SLDPRT ile bitiyorsa ve daha önce eklenmediyse
                    if (name.toUpperCase().endsWith(".SLDPRT") && !seen3.has(partCode)) {
                        errors3.push({
                            partCode,
                            message: "MNG tipi parçada Name alanı .SLDASM ile bitmeli, .SLDPRT olamaz!"
                        });
                        seen3.add(partCode);
                    }
                }
            });
            return { errors1, errors2, errors3 };
        }

        function findERPCodeMaterialMismatch(xmlDoc) {
            const erpMalzemeMap = {
                "01": [ // ÇELİK
                    "C1010", "C1040", "C1050", "C1060", "C2083", "C2316", "C2344", "C2379", "C8620", "CK45", "CK75", "ST37", "ST44", "ST52",
                    "C4140", "C5140", "ST37_C", "ST44_C", "ST52_C", "ST37_H", "ST44_H", "ST52_H", "HRP", "DKP", "CK45_KR_KP", "TRANSMISYON",
                    "C1040_H", "C1040_C", "ST37-2", "ST52", "C1040",
                    "ST37_SOGUK CEKIM", "ST37_SICAK CEKIM", "ST52_SICAK CEKIM", "ST52_SOGUK CEKIM",
                    "ST44_SICAK CEKIM", "ST44_SOGUK CEKIM", "C1040_SICAK CEKIM", "C1040_SOGUK CEKIM",
                    "C4140_ISLAHLI", "HARDOX400", "YAY CELIGI", "55SI7", "16MNCR5", "45CR2", "34CRALNI7-10", "DIN 17223", "CK45_KROM KAPLI",
                    "CK45_INDUKSIYONLU KROM KAPLI", "C4140_ISLAHLI", "GALVANIZLI SAC"
                ],
                "02": [ // ALÜMİNYUM
                    "AL2007", "AL2024", "AL5083", "AL5083 TASLANMIS", "AL5754", "AL6013", "AL6061", "AL6063", "AL6082", "AL6083", "AL7000",
                    "AL7075", "AL8000", "AL6061_O", "AL6061_T4", "AL6061_T6", "AL6063_T1", "AL6063_T4", "AL6063_T5", "AL6063_T6", "AL6063_T83", "AL6082_T6",
                    "AL7075_T6", "ALUDUR PLUS", "AL2017", "1050 H14", "1054 H14", "ALUMINYUMKOMPOZIT"
                ],
                "03": [ // KROM
                    "KR_303", "KR_304", "KR_309", "KR_310", "KR_316"
                ],
                "04": [ // PLASTİK
                    "DERLIN", "KESTAMIT", "POLIETILEN", "POLIPROPILEN", "POLYAMID", "ULPOLEN1000", "FIBER", "TEFLON", "VULKOLON", "POLIURETAN",
                    "PLEXIGLASS", "KAUCUK", "MIKA", "SOLID", "ALPOLEN1000", "PA6", "PPE", "NAYLON 6/10", "HDPE", "PP", "PPRC", "PET"
                ],
                "05": [ // BRONZ/PİRİNÇ
                    "PIRINC", "ALUMINYUM_BRONZ", "CUZN25AL5", "RG05", "RG07", "RG10", "RG12", "RG14"
                ],
                "06": [ // DÖKÜM
                    "GGG60", "GG30", "GGG50", "GGG40", "GG60", "GG25", "GG20", "GS60", "ETIAL 160"
                ],
                "07": [ // BAKIR
                    "BAKIR"
                ],
                "08": [ // AHŞAP
                    "MDF", "ThornelVCB-20KarbonKumas"
                ]
            };

            const hataliList = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim().toUpperCase();
                const erpCode = (getAttributeValue(conf, "Malzeme_ERP_Code") || "").trim();
                const siparisDisiBirak = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();

                // Sadece 01-08 arası ERP kodları için ve sipariş dışı olmayanlar için kontrol et
                if (!erpMalzemeMap[erpCode]) return;
                if (siparisDisiBirak === "1") return;
                
                // Parça kodunda harf içermeyen, sadece sayı ile 6 karakterden oluşan ve malzeme bilgisi STD olan parçalar için kontrol yapma
                if (malzeme === "STD" && /^\d{6}$/.test(partCode)) return;

                // Malzeme, kendi ERP kodunun listesinde yoksa hata ver
                const izinliMalzemeler = erpMalzemeMap[erpCode].map(m => m.trim().toUpperCase());
                if (malzeme && !izinliMalzemeler.includes(malzeme)) {
                    hataliList.push({
                        partCode,
                        malzeme,
                        erpCode,
                        izinVerilen: erpMalzemeMap[erpCode].join(", ")
                    });
                }
            });
            return hataliList;
        }


        function renderInvalidMngPartCodes(xmlDoc) {
            const invalidMngParts = findInvalidMngPartCodes(xmlDoc)
                // COKLUXML parçasını hariç tut
                .filter(part => !part.partCode || !part.partCode.toUpperCase().includes("COKLUXML"));

            if (invalidMngParts.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Hatalı MNG Parça Kodları:</b>
<ul>
    ${invalidMngParts.map((part, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidMngPartCheck_${i}">
            <b>${part.partCode}</b>: <span style="color:#c0392b;">${part.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }
        }

        function findPartsWithSameRootCode(xmlDoc) {
            const result = [];
            const codeMap = {};
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                // Kök kodu: ilk 13 karakter veya ilk '-' işaretine kadar
                const match = partCode.match(/^(.+?)(-\d{4,})?$/);
                const root = match ? match[1] : partCode;
                if (!codeMap[root]) codeMap[root] = [];
                codeMap[root].push(partCode);
            });
            Object.values(codeMap).forEach(list => {
                // Aynı kökten birden fazla farklı kod varsa ve biri kök kod ise uyarı ver
                if (list.length > 1) {
                    // Sadece kök kod ve kök+ekli kodlar varsa göster
                    const hasRoot = list.some(code => !/-\d{4,}$/.test(code));
                    const hasDash = list.some(code => /-\d{4,}$/.test(code));
                    if (hasRoot && hasDash) {
                        result.push(list);
                    }
                }
            });
            return result;
        }

        function buildMontajYollari(xmlDoc) {
            const montajYollari = {}; // { parcaKodu: [ "1", "1.1", ... ] }

            function normalize(code) {
                return (code || "").replace(/[^a-zA-Z0-9]/g, "");
            }

            function gez(docNode, yol) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return;
                const partCodeRaw = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const partCode = normalize(partCodeRaw);
                if (!montajYollari[partCode]) montajYollari[partCode] = [];
                montajYollari[partCode].push(yol);

                // Alt montajları sırayla gez
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                childDocs.forEach((childDoc, idx) => {
                    gez(childDoc, yol + '.' + (idx + 1));
                });
            }

            const rootDocs = xmlDoc.querySelectorAll('document');
            rootDocs.forEach((doc, idx) => {
                gez(doc, (idx + 1).toString());
            });

            return montajYollari;
        }

        function getAttributeValue(doc, name) {
            const attr = doc.querySelector(`attribute[name="${name}"]`);
            return attr ? attr.getAttribute("value") : "";
        }


        function isProfilePart(doc) {
            function hasProfileWord(val) {
                if (!val) return false;
                val = val.toUpperCase();
                // PROFIL, PROFİL, PRF, KOSEBENT, NPU için hem "/"-li hem de tam kelime kontrolü
                if (
                    val.includes("PROFIL/") || /\bPROFIL\b/.test(val) ||
                    val.includes("PROFİL/") || /\bPROFİL\b/.test(val) ||
                    val.includes("PRF/") || /\bPRF\b/.test(val) ||
                    val.includes("KOSEBENT/") || /\bKOSEBENT\b/.test(val) ||
                    val.includes("NPU/") || /\bNPU\b/.test(val)
                ) return true;
                // IPE için sadece tam kelime olarak kontrol
                if (/\bIPE\b/.test(val)) return true;
                return false;
            }
            return (
                hasProfileWord(getAttributeValue(doc, "Profil_Tipi")) ||
                hasProfileWord(getAttributeValue(doc, "Profil_Tanim_Boy")) ||
                hasProfileWord(getAttributeValue(doc, "Description"))
            );
        }

        function hasFasonIslemOperation(conf) {
            for (let i = 1; i <= 8; i++) {
                const op = getAttributeValue(conf, `OP${i}_Tanim`);
                if (op && op.trim().toUpperCase() === "FASON İŞLEM") return true;
            }
            return false;
        }

        function findSpecialOperations(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");

            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                // Operasyon alanlarını kontrol et (OP1-OP8)
                for (let i = 1; i <= 8; i++) {
                    const opValue = getAttributeValue(conf, `OP${i}_Tanim`);
                    if (opValue && opValue.trim()) {
                        const opUpper = opValue.toUpperCase();
                        // Özel operasyonları kontrol et
                        // BOYA için tam kelime eşleştirmesi yap (statik boya gibi ifadeleri hariç tut)
                        const boyaRegex = /\bBOYA\b/;
                        if (opUpper.includes('DÖKÜM') ||
                            opUpper.includes('KALİTE') ||
                            (boyaRegex.test(opUpper) && !opUpper.includes('STATİK')) ||
                            opUpper.includes('BÜKÜM') ||
                            opUpper.includes('TESVİYE')) {
                            result.push({
                                partCode: partCode,
                                operation: opValue.trim(),
                                operationField: `OP${i}_Tanim`
                            });
                        }
                    }
                }
            });

            return result;
        }

        function findMismatchedChildParts(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const parentCode = getAttributeValue(conf, "Parca_Kodu");
                const parentName = getAttributeValue(conf, "Name") || "";
                if (!parentCode) return;
                if (parentCode.endsWith("-0000")) return;
                // Ana parça SLDASM ise asla profil olarak bakma
                if (parentName.toUpperCase().endsWith(".SLDASM")) return;

                // Sadece birinci seviye çocukları kontrol et!
                const parentBase = parentCode.replace(/-R\d+$/i, "");
                const parentHasFason = hasFasonIslemOperation(conf);
                // SADECE doğrudan alt montajlar:
                const childConfs = doc.querySelectorAll(":scope > configuration > references > document > configuration");
                childConfs.forEach(childConf => {
                    if (hasFasonIslemOperation(childConf)) return;
                    const childCode = getAttributeValue(childConf, "Parca_Kodu");
                    const childDesc = (getAttributeValue(childConf, "Description") || "").toUpperCase();
                    // Sadece gerçek profil çocukları
                    if (
                        childDesc.includes("PROFIL/") ||
                        childDesc.includes("PROFİL/") ||
                        childDesc.includes("NPU/") ||
                        childDesc.includes("KOSEBENT/") ||
                        childDesc.includes("IPE")
                    ) {
                        if (childCode) {
                            const childBase = childCode.replace(/-R\d+$/i, "");
                            if (childBase && childBase !== parentBase) {
                                result.push({
                                    parent: parentCode,
                                    child: childCode,
                                    parentFason: parentHasFason
                                });
                            }
                        }
                    }
                });
            });
            return result;
        }

        function findInvalidPartCodes(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const up = partCode.toUpperCase();
                // Sheet, Kesim Listesi, Cut-List-Item geçenleri atla
                if (
                    up.includes("SHEET") ||
                    up.includes("KESIM LISTESI") ||
                    up.includes("CUT-LIST-ITEM") ||
                    up.includes("COKLUXML") // <-- COKLUXML parçasını hariç tut
                ) return;

                // Sadece harf, rakam ve - izin ver, - hariç özel karakter varsa yanlış
                if (!/^[A-Za-z0-9\-]+$/.test(partCode)) {
                    result.push(partCode + " (özel karakter hatası)");
                    return;
                }
                // Hane sayısı için sadece harf ve rakamları say (- hariç)
                const codeOnly = (partCode || "").replace(/[^A-Za-z0-9]/g, "");
                const len = codeOnly.length;
                // 6 haneli ve hepsi rakam ise doğru, harf varsa yanlış
                if (len === 6) {
                    if (!/^[0-9]{6}$/.test(codeOnly)) result.push(partCode + " (6 haneli, harf olmamalı)");
                    return;
                }
                // 7-12 hane arası ise direkt yanlış
                if (len >= 7 && len <= 12) {
                    result.push(partCode + " (7-12 hane arası, geçersiz)");
                    return;
                }
                // 13+ hane ise harf ile başlamıyorsa yanlış
                if (len >= 13 && !/^[A-Za-z]/.test(codeOnly)) {
                    result.push(partCode + " (13+ hane, harf ile başlamıyor)");
                    return;
                }
            });
            return result;
        }

        function findHamO2Over6000Parts(xmlDoc) {
            const result = []; // Tüm parçaları aynı listede toplayacağız

            const documents = xmlDoc.querySelectorAll("document");

            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim();
                const description = (getAttributeValue(conf, "Description") || "").trim();
                const ham_o1 = (getAttributeValue(conf, "Ham_o1") || "").trim();
                const ham_o2 = (getAttributeValue(conf, "Ham_o2") || "").replace(",", ".").trim();

                // Profil olup olmadığını kontrol et
                const isProfile = isProfilePart(doc);

                // Ana parçalar için ham_o2 kontrolü
                if (
                    malzeme &&
                    ham_o2 && !isNaN(Number(ham_o2)) && Number(ham_o2) > 6000
                ) {
                    result.push({
                        partCode,
                        malzeme,
                        description: isProfile ? description : ham_o1, // Profil olmayanlar için ham_o1 kullanılıyor
                        value: ham_o2,
                        type: "Ham_o2" // Türü belirtiyoruz
                    });
                }

                // Profil çocuk parçalarının uzunluk kontrolü
                const childConfs = doc.querySelectorAll(":scope > configuration > references > document > configuration");
                childConfs.forEach(childConf => {
                    const childPartCode = getAttributeValue(childConf, "Parca_Kodu") || "Belirsiz";
                    const childMalzeme = (getAttributeValue(childConf, "Malzeme") || "").trim();
                    const childDescription = (getAttributeValue(childConf, "Description") || "").trim();
                    const childLength = (getAttributeValue(childConf, "Uzunluk") || "").replace(",", ".").trim();

                    if (
                        childMalzeme &&
                        childLength && !isNaN(Number(childLength)) && Number(childLength) > 6000
                    ) {
                        result.push({
                            partCode: childPartCode,
                            malzeme: childMalzeme,
                            description: childDescription, // Profil çocukları için mevcut description kullanılıyor
                            value: childLength,
                            type: "Uzunluk" // Türü belirtiyoruz
                        });
                    }
                });
            });

            return result; // Tek bir liste döndürülüyor
        }

        function renderPartsList(partsList) {
            if (partsList.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.id = 'hamO2Container';
                // Bu listeyi sadece uyarı olarak işaretle (hata sayılmasın)
                div.dataset.warning = "true";
                div.innerHTML = `<b>Ham_o2 veya Uzunluk değeri 6000 mm üzeri olup kontrol edilmesi gereken parçalar: <span onclick="toggleHamO2Uzun()" style="color:#888; font-size:12px; font-weight:normal; cursor:pointer;" title="Tıklayarak gizle">(Buraya tıklayarak gizleyebilirsiniz.)</span></b>
<ul>
    ${partsList.map((part, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="hamO2UzunCheck_${i}">
            Parça Kodu: <span class="parca-kodu-span" data-parca="${part.partCode.replace(/[^a-zA-Z0-9]/g, "")}"><b>${part.partCode}</b></span>, 
            Malzeme: ${part.malzeme}, 
            Ölçü: ${part.description}, 
            ${part.type}: ${part.value} mm
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));

                // Checkbox event listener'larını ekle
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }
        }

        function validateProfileParentParts(xmlDoc) {
            const profileParents = Array.from(xmlDoc.querySelectorAll('document > configuration'));
            const errors = [];

            function normalizePartCode(partCode) {
                return (partCode || "").replace(/-R\d+$/i, "");
            }

            function hasFirstOperationFason(conf) {
                const op1 = getAttributeValue(conf, "OP1_Tanim");
                return op1 && op1.trim().toUpperCase() === "FASON İŞLEM";
            }

            profileParents.forEach(conf => {
                const parentDoc = conf.closest('document'); // <-- önemli fark
                const parentCode = normalizePartCode(getAttributeValue(conf, "Parca_Kodu"));
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim().toUpperCase();
                const hammaddeOlcusu = (getAttributeValue(conf, "Hammadde_Olcusu") || "").trim().toUpperCase();

                // Eğer Hammadde ve Hammadde Ölçüsü STD değilse kontrol etme
                if (hammadde !== "STD" || hammaddeOlcusu !== "STD") {
                    return;
                }

                // Aynı document altındaki references içinde çocuk parçaları bul
                const childConfs = Array.from(parentDoc.querySelectorAll('references > document > configuration'));

                const hasProfileChild = childConfs.some(childConf => {
                    const childCode = normalizePartCode(getAttributeValue(childConf, "Parca_Kodu"));
                    const childDesc = (getAttributeValue(childConf, "Description") || "").toUpperCase();

                    return (
                        childCode === parentCode &&
                        (childDesc.includes("PROFIL/") ||
                            childDesc.includes("NPU/") ||
                            childDesc.includes("KOSEBENT/") ||
                            childDesc.includes("IPE"))
                    );
                });

                if (hasProfileChild) {
                    const isFason = hasFirstOperationFason(conf);
                    errors.push({
                        partCode: parentCode,
                        isFason: isFason
                    });
                }
            });

            if (errors.length > 0) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mismatch-list';
                errorDiv.innerHTML = `<b>Profil ana parçalarda Hammadde ve Hammadde Ölçüsü STD olanlar:</b>
<ul>
    ${errors.map(error => `<li><b>${error.partCode}</b>${error.isFason ? ' <span style="color:#e67e22;">(FASON İŞLEM)</span>' : ''}</li>`).join('')}
</ul>`;
                document.querySelector('main').insertBefore(errorDiv, document.getElementById('accordion'));
            }
        }


        function findKosebentProfilTipiHatalari(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const erpCode = getAttributeValue(conf, "Malzeme_ERP_Code").trim();
                const malzeme = getAttributeValue(conf, "Malzeme").trim().toUpperCase();
                const desc = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const profilTipi = (getAttributeValue(conf, "Profil_Tipi") || "").toUpperCase();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";

                if (
                    erpCode === "01" &&
                    malzeme === "ST37" &&
                    desc.includes("KOSEBENT/") &&
                    profilTipi !== "KOSEBENT PROFIL"
                ) {
                    result.push({ partCode, profilTipi, desc });
                }
            });
            return result;
        }

        function findProfilePartsWithoutProfileKeyword(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu");
                if (!partCode) return;
                if (partCode.endsWith("-0000")) return;

                const profilTanimBoy = getAttributeValue(conf, "Profil_Tanim_Boy") || "";
                if (profilTanimBoy.trim() === "") return;

                // PROFIL, KOSEBENT, NPU kelimeleri geçmiyorsa uyarı ver
                const upper = profilTanimBoy.toUpperCase();
                if (
                    !upper.includes("PROFIL") &&
                    !upper.includes("PROFİL") &&
                    !upper.includes("KOSEBENT") &&
                    !upper.includes("IPE") &&
                    !upper.includes("HEA") &&
                    !upper.includes("NPU") &&
                    !upper.includes("IPN") // <-- IPN de profil olarak kabul edilsin
                ) {
                    // --- YENİ KONTROL: Alt çocuk parçası var mı? ---
                    // Sadece kendi kodu ile aynı veya -R00 ile biten bir alt çocuk varsa hata ver
                    const childDocs = doc.querySelectorAll(':scope > configuration > references > document');
                    let hasChild = false;
                    childDocs.forEach(childDoc => {
                        const chConf = childDoc.querySelector('configuration');
                        if (!chConf) return;
                        const childCode = getAttributeValue(chConf, "Parca_Kodu") || getAttributeValue(chConf, "Name") || "";
                        if (childCode === partCode || childCode === partCode + "-R00") {
                            hasChild = true;
                        }
                    });
                    if (hasChild) {
                        result.push({
                            partCode,
                            profilTanimBoy
                        });
                    }
                }
            });
            return result;
        }

        function findInvalidProfileMainParts(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                if (partCode.endsWith("-0000")) return;

                // --- YENİ: Gerçekten profil ana parçası mı? ---
                const profilTipi = (getAttributeValue(conf, "Profil_Tipi") || "").toUpperCase();
                const desc = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const profilTanimBoy = getAttributeValue(conf, "Profil_Tanim_Boy");
                const profilAci1 = getAttributeValue(conf, "Profil_Aci_1");
                const ham_o1 = getAttributeValue(conf, "Ham_o1");
                const hammadde = getAttributeValue(conf, "Hammadde");

                // Sadece PROFIL/PROFİL/NPU/KOSEBENT/IPE geçenler profil ana parçası kabul edilsin
                const isProfileMain =
                    (profilTipi.includes("PROFIL") || profilTipi.includes("PROFİL") ||
                        profilTipi.includes("NPU") || profilTipi.includes("KOSEBENT") || profilTipi.includes("IPE") ||
                        desc.includes("PROFIL/") || desc.includes("PROFİL/") ||
                        desc.includes("NPU/") || desc.includes("KOSEBENT/") || desc.includes("IPE")) &&
                    profilTanimBoy && profilAci1;

                if (
                    isProfileMain &&
                    (
                        (hammadde && hammadde.trim() !== "") ||
                        (ham_o1 && ham_o1.trim() !== "")
                    )
                ) {
                    result.push({
                        partCode,
                        tip: "Profil ana parça için Hammadde veya Ham_o1 dolu olmamalı!"
                    });
                }
            });
            return result;
        }

        // function findChildWithEmptyDescription(xmlDoc) {
        //     const result = [];
        //     const documents = xmlDoc.querySelectorAll("document");
        //     documents.forEach(doc => {
        //         if (!isProfilePart(doc)) return;
        //         const parentCode = getAttributeValue(doc, "Parca_Kodu");
        //         if (!parentCode) return;
        //         if (parentCode.endsWith("-0000")) return;
        //         const parentBase = parentCode.replace(/-R\d+$/i, "");
        //         const parentFason = hasFasonIslemOperation(doc.querySelector('configuration'));
        //         const childConfs = doc.querySelectorAll("references > document > configuration");
        //         childConfs.forEach(childConf => {
        //             if (hasFasonIslemOperation(childConf)) return;
        //             const childCode = getAttributeValue(childConf, "Parca_Kodu");
        //             if (childCode) {
        //                 const childBase = childCode.replace(/-R\d+$/i, "");
        //                 if (childBase === parentBase) {
        //                     const childDesc = getAttributeValue(childConf, "Description");
        //                     if (!childDesc || childDesc.trim() === "") {
        //                         // Sadece bir kez ekle
        //                         if (!result.some(x => x.parent === parentCode && x.child === childCode)) {
        //                             result.push({
        //                                 parent: parentCode,
        //                                 child: childCode,
        //                                 parentFason
        //                             });
        //                         }
        //                     }
        //                 }
        //             }
        //         });
        //     });
        //     return result;
        // }

        function findChildWithEmptyDescription(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                if (!isProfilePart(doc)) return;
                const parentCode = getAttributeValue(doc, "Parca_Kodu");
                if (!parentCode) return;
                if (parentCode.endsWith("-0000")) return;
                const parentBase = parentCode.replace(/-R\d+$/i, "");
                const parentFason = hasFasonIslemOperation(doc.querySelector('configuration'));
                const parentProfilTanimBoy = getAttributeValue(doc, "Profil_Tanim_Boy") || "";
                const childConfs = doc.querySelectorAll("references > document > configuration");
                childConfs.forEach(childConf => {
                    if (hasFasonIslemOperation(childConf)) return;
                    const childCode = getAttributeValue(childConf, "Parca_Kodu");
                    if (childCode) {
                        const childBase = childCode.replace(/-R\d+$/i, "");
                        if (childBase === parentBase) {
                            const childDesc = getAttributeValue(childConf, "Description");
                            // --- DÜZELTME: Eğer ana parçada Profil_Tanim_Boy doluysa ve çocukta Description boşsa HATA VERME ---
                            if ((!childDesc || childDesc.trim() === "") && !parentProfilTanimBoy) {
                                // Sadece bir kez ekle
                                if (!result.some(x => x.parent === parentCode && x.child === childCode)) {
                                    result.push({
                                        parent: parentCode,
                                        child: childCode,
                                        parentFason
                                    });
                                }
                            }
                        }
                    }
                });
            });
            return result;
        }

        function findStdPartsWithEmptyDescription(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const description = (getAttributeValue(conf, "Description") || "").trim();
                const siparisDisiBirak = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();

                // Eğer parça 6 haneli standart bir kodsa ve Description boşsa
                if (/^[A-Z0-9]{6}$/.test(partCode) && !description) {
                    // Sipariş dışı bırakılmışsa listeye ekleme
                    if (siparisDisiBirak === "1") return;

                    result.push({ partCode });
                }
            });
            return result;
        }

        function findSiparisDisiMngSldasmMontajlar(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const siparisDisiBirak = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                if (
                    siparisDisiBirak === "1" &&
                    imalatTipi === "MNG" &&
                    name.endsWith(".SLDASM") &&
                    partCode.length > 6
                ) {
                    result.push({ partCode });
                }
            });
            return result;
        }

        function findMultipleRevisionParts(xmlDoc) {
            const codeMap = {};
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const code = getAttributeValue(doc, "Parca_Kodu");
                const rev = getAttributeValue(doc, "Revision").toUpperCase() || "R00";
                if (!code) return;
                if (!codeMap[code]) codeMap[code] = new Set();
                codeMap[code].add(rev);
            });
            const result = [];
            Object.entries(codeMap).forEach(([code, revSet]) => {
                if (revSet.has("R00") && revSet.size > 1) {
                    result.push({
                        base: code,
                        revisions: Array.from(revSet).sort()
                    });
                }
            });
            return result;
        }

        function findParentsWithChildrenCommaDesc(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                if (!isProfilePart(doc)) return;
                const parentCode = getAttributeValue(doc, "Parca_Kodu");
                if (!parentCode) return;
                if (parentCode.endsWith("-0000")) return;

                const parentDesc = getAttributeValue(doc, "Description") || "";
                const hasProfileMeasure = /profil.*\d+[,.]\d+/i.test(parentDesc);

                if (!hasProfileMeasure) {
                    let foundDesc = null;
                    function checkChildren(node) {
                        const childConfs = node.querySelectorAll("configuration");
                        for (let i = 0; i < childConfs.length; i++) {
                            const childDesc = getAttributeValue(childConfs[i], "Description");
                            if (childDesc && childDesc.includes(",00")) {
                                foundDesc = childDesc;
                                break;
                            }
                        }
                        const childDocs = node.querySelectorAll(":scope > references > document");
                        for (let i = 0; i < childDocs.length; i++) {
                            if (!foundDesc) checkChildren(childDocs[i]);
                        }
                    }
                    checkChildren(doc);
                    if (foundDesc) {
                        result.push({ parentCode, childDesc: foundDesc });
                    }
                }
            });
            return result;
        }

        function findProfileTanimiVarAmaAltCocukYok(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const ham_o1 = (getAttributeValue(conf, "Ham_o1") || "").trim();
                const ham_o2 = (getAttributeValue(conf, "Ham_o2") || "").trim();
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim();
                const sipDisi = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();
                const profilDisarda = (getAttributeValue(conf, "Profil_Disarda_Birak") || "").trim();
                const profilTanimBoy = (getAttributeValue(conf, "Profil_Tanim_Boy") || "").trim();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                // Alt çocuk var mı?
                const childDocs = doc.querySelectorAll(":scope > configuration > references > document");
                const hasChild = childDocs.length > 0;

                if (
                    profilTanimBoy &&
                    !ham_o1 && !ham_o2 && !hammadde && !sipDisi && !profilDisarda &&
                    !hasChild
                ) {
                    result.push({
                        partCode,
                        profilTanimBoy
                    });
                }
            });
            return result;
        }

        function findPartsWithOlcuButEmptyHammadde(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCodeRaw = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const partCode = partCodeRaw.replace(/-R\d+$/i, ""); // revizyonu kaldır
                const olcu = getAttributeValue(conf, "Ham_o1") || "";
                const hammadde = getAttributeValue(conf, "Hammadde") || "";

                if (olcu.trim() !== "" && hammadde.trim() === "") {
                    let hatali = true;
                    const childDocs = doc.querySelectorAll("references > document");
                    childDocs.forEach(childDoc => {
                        const childConf = childDoc.querySelector("configuration");
                        if (!childConf) return;
                        const childCodeRaw = getAttributeValue(childConf, "Parca_Kodu") || "";
                        const childCode = childCodeRaw.replace(/-R\d+$/i, ""); // revizyonu kaldır
                        const childDesc = (getAttributeValue(childConf, "Description") || "").toUpperCase();
                        if (
                            childCode === partCode &&
                            (
                                childDesc.includes("PROFIL/") ||
                                childDesc.includes("PROFİL/") ||
                                childDesc.includes("NPU/") ||
                                childDesc.includes("KOSEBENT/") ||
                                childDesc.includes("IPE")
                            )
                        ) {
                            hatali = false;
                        }
                    });
                    if (hatali) {
                        result.push({ partCode: partCodeRaw, olcu });
                    }
                }
            });
            return result;
        }

        function findPartsWithHammaddeDoluHamO1Bos(xmlDoc) {
            const result = [];
            const unwantedKeywords = ["SHEET", "KESIM LISTESI", "CUT-LIST-ITEM"];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const siparisDisi = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();
                const ham_o1 = (getAttributeValue(conf, "Ham_o1") || "").trim();
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim();
                const hammaddeOlcusu = (getAttributeValue(conf, "Hammadde_Olcusu") || "").trim().toUpperCase();

                // İstenmeyen kelime içeren parça kodları hariç
                if (unwantedKeywords.some(k => partCode.toUpperCase().includes(k))) return;
                if (siparisDisi === "1") return;
                if (imalatTipi !== "IML") return;

                // Hammadde ve hammadde ölçüsü STD ise hariç
                const hammaddeOlcusuUp = hammaddeOlcusu.toUpperCase();
                if (
                    hammadde.toUpperCase() === "STD" &&
                    (
                        hammaddeOlcusuUp === "STD" ||
                        hammaddeOlcusuUp.startsWith("STD - L:") // STD - L:mm ile başlıyorsa
                    )
                ) return;

                // Hammadde dolu ve ham_o1 boşsa
                if (hammadde && !ham_o1) {
                    result.push({
                        partCode,
                        message: "Hammadde dolu, Ham_o1 boş olamaz!"
                    });
                }
            });
            return result;
        }


        function findPartsWithEmptyProfilTanimBoyAndHammaddeHamO1(xmlDoc) {
            const result = [];
            const unwantedKeywords = ["SHEET", "KESIM LISTESI", "CUT-LIST-ITEM"];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const siparisDisi = (getAttributeValue(conf, "Siparis_Disi_Birak") || "").trim();
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();
                const profilTanimBoy = (getAttributeValue(conf, "Profil_Tanim_Boy") || "").trim();
                const ham_o1 = (getAttributeValue(conf, "Ham_o1") || "").trim();
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim();
                const hammaddeOlcusu = (getAttributeValue(conf, "Hammadde_Olcusu") || "").trim().toUpperCase();
                const profilTipi = (getAttributeValue(conf, "Profil_Tipi") || "").trim();

                // İstenmeyen kelime içeren parça kodları hariç
                if (unwantedKeywords.some(k => partCode.toUpperCase().includes(k))) return;
                if (siparisDisi === "1") return;
                if (imalatTipi !== "IML") return;

                // Hammadde ve hammadde ölçüsü STD ise hariç
                if (hammadde.toUpperCase() === "STD" && hammaddeOlcusu === "STD") return;

                // Profil_Tanim_Boy boş, Hammadde ve Ham_o1 de boşsa
                if (!profilTanimBoy && !hammadde && !ham_o1 && !profilTipi) {
                    result.push({
                        partCode,
                        message: "Profil tanım boyu, Hammadde ve Ham_o1 boş olamaz!"
                    });
                }
            });
            return result;
        }

        function findPartsWithInvalidMaterial(xmlDoc) {
            const acceptedMaterials = [
                "C1010", "C1040", "C1050", "C1060", "C2083", "C2316", "C2344", "C2379", "C8620", "CK45", "CK75", "ST37", "ST44", "ST52",
                "C4140", "C5140", "ST37_C", "ST44_C", "ST52_C", "ST37_H", "ST44_H", "ST52_H", "HRP", "DKP", "CK45_KR_KP", "TRANSMISYON",
                "C1040_H", "C1040_C", "AL2007", "AL2024", "AL5083", "AL5754", "AL6013", "AL6061", "AL6063", "AL6082", "AL6083", "AL7000",
                "AL7075", "AL8000", "KR_303", "KR_304", "KR_309", "KR_310", "KR_316", "DERLIN", "KESTAMIT", "POLIETILEN", "POLIPROPILEN",
                "POLYAMID", "ULPOLEN1000", "FIBER", "TEFLON", "VULKOLON", "POLIURETAN", "RG05", "RG07", "RG10", "RG12", "RG14", "PIRINC",
                "GGG60", "GG30", "GGG50", "GGG40", "GG60", "GG25", "GG20", "ST37-2", "ST52", "C1040", "GS60", "PLEXIGLASS", "KAUCUK", "AL5083",
                "AL6061_O", "AL6061_T4", "AL6061_T6", "AL6063_T1", "AL6063_T4", "AL6063_T5", "AL6063_T6", "AL6063_T83", "AL6082_T6",
                "AL7075_T6", "ALUMINYUM_BRONZ", "GALVANIZLI SAC", "CK45_KROM KAPLI", "ST37_SOGUK CEKIM", "ST37_SICAK CEKIM",
                "ST52_SICAK CEKIM", "C4140_ISLAHLI", "ST44_SICAK CEKIM", "C1040_SICAK CEKIM", "C1040_SOGUK CEKIM", "ST44_SOGUK CEKIM",
                "HARDOX400", "PPRC", "BAKIR", "MDF", "ST52_SOGUK CEKIM", "ALUDUR PLUS", "MIKA", "SOLID", "16MNCR5",
                "CK45_INDUKSIYONLU KROM KAPLI", "AL2017", "YAY CELIGI", "55SI7", "NAYLON 6/10", "ALPOLEN1000", "ETIAL 160",
                "1050 H14", "1054 H14", "PA6", "ALUMINYUMKOMPOZIT", "CUZN25AL5", "45CR2", "34CRALNI7-10", "PPE", "DIN 17223", "AL5083 TASLANMIS", "HDPE", "PP", "PET",
                "ThornelVCB-20KarbonKumas"
            ].map(m => m.trim().toUpperCase());

            const result = [];
            const seen = new Set(); // Tekrarları önlemek için
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const name = getAttributeValue(conf, "Name") || "";
                const material = getAttributeValue(conf, "Malzeme").trim().toUpperCase();
                const hammadde = getAttributeValue(conf, "Hammadde").trim().toUpperCase();

                // ...mevcut kontroller...

                // 6 haneli parça kodu ise name'in sonuna bakmadan kontrol et
                if (/^[A-Z0-9]{6}$/.test(partCode)) {
                    if (!material || material === "") {
                        const key = partCode + "|" + material;
                        if (!seen.has(key)) {
                            result.push({ partCode, material: "(boş)" });
                            seen.add(key);
                        }
                        return;
                    }
                    if (material !== "STD") {
                        const key = partCode + "|" + material;
                        if (!seen.has(key)) {
                            result.push({ partCode, material });
                            seen.add(key);
                        }
                    }
                    return;
                }

                // 6 haneden büyükse ve name .SLDPRT ile bitmiyorsa kontrol etme
                if (partCode.length > 6 && !name.toUpperCase().endsWith(".SLDPRT")) return;

                // 6 haneden büyük parça kodlarında da malzeme boşsa hata ver
                if (partCode.length > 6 && (!material || material === "")) {
                    const key = partCode + "|" + material;
                    if (!seen.has(key)) {
                        result.push({ partCode, material: "(boş)" });
                        seen.add(key);
                    }
                    return;
                }

                if (partCode.length > 6 && material === "STD") {
                    const key = partCode + "|" + material;
                    if (!seen.has(key)) {
                        result.push({ partCode, material: "STD (6 haneden büyük parça kodu ile kullanılamaz)" });
                        seen.add(key);
                    }
                    return;
                }
                if (material && !acceptedMaterials.includes(material)) {
                    const key = partCode + "|" + material;
                    if (!seen.has(key)) {
                        result.push({ partCode, material });
                        seen.add(key);
                    }
                }
            });
            return result;
        }

        // function findProfilesWithEmptyLValue(xmlDoc) {
        //     const result = [];
        //     const seen = new Set(); // Tekrarları önlemek için
        //     const documents = xmlDoc.querySelectorAll("document");
        //     documents.forEach(doc => {
        //         const conf = doc.querySelector("configuration");
        //         if (!conf) return;
        //         const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
        //         const profilTanimBoy = getAttributeValue(conf, "Profil_Tanim_Boy") || "";
        //         // Sadece PROFIL/NPU/KOSEBENT/IPE geçenler için kontrol et
        //         const upper = profilTanimBoy.toUpperCase();
        //         if (
        //             upper.includes("PROFIL/") ||
        //             upper.includes("PROFİL/") ||
        //             upper.includes("NPU/") ||
        //             upper.includes("KOSEBENT/") ||
        //             upper.includes("IPE")
        //         ) {
        //             // KARE PROFIL/60x60x3 -  L= ... formatında L= değeri boşsa hata ver
        //             const lValueMatch = profilTanimBoy.match(/L=\s*([\d.,]+)/i);
        //             if (profilTanimBoy.includes("L=") && !lValueMatch) {
        //                 // Tekrarı önle
        //                 const uniqueKey = partCode + "|" + profilTanimBoy;
        //                 if (seen.has(uniqueKey)) return;
        //                 seen.add(uniqueKey);

        //                 result.push({
        //                     partCode,
        //                     profilTanimBoy
        //                 });
        //             }
        //         }
        //     });
        //     return result;
        // }

        function findPartsWithInvalidRevision(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const rev = (getAttributeValue(conf, "Revision") || "").trim().toUpperCase();

                if (/^[A-Z0-9]{6}$/.test(partCode)) return;

                if (!rev) {
                    result.push({ partCode, rev: "(boş)" });
                    return;
                }

                // İstenmeyen parça kodlarını hariç tut
                if (
                    partCode.toUpperCase().includes("SHEET") ||
                    partCode.toUpperCase().includes("KESIM LISTESI") ||
                    partCode.toUpperCase().includes("CUT-LIST-ITEM")
                ) return;

                // Eğer parça kodu -R00 ile bitmiyorsa ve revizyon aşağıdaki kurallara uymuyorsa hata ekle
                if (!partCode.endsWith('-R00')) {
                    if (!/^R\d{2}$/.test(rev)) {
                        result.push({ partCode, rev });
                        return;
                    }
                }
            });
            return result;
        }

        function findDisardaBirakilmisProfilOlmayanParcaUyarilari(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();
                const description = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const profilDisardaBirak = (getAttributeValue(conf, "Profil_Disarda_Birak") || "").toUpperCase();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                if (
                    name.endsWith(".SLDPRT") &&
                    profilDisardaBirak === "DIŞARDA BIRAK" &&
                    !description.includes("PROFIL/") &&
                    !description.includes("NPU/") &&
                    !description.includes("KOSEBENT/")
                ) {
                    // Üst montajın parça kodunu bul
                    let parentDoc = doc.parentElement;
                    let parentConf = null;
                    while (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() !== "document") {
                        parentDoc = parentDoc.parentElement;
                    }
                    let parentPartCode = "";
                    if (parentDoc && parentDoc.tagName && parentDoc.tagName.toLowerCase() === "document") {
                        parentConf = parentDoc.querySelector("configuration");
                        parentPartCode = getAttributeValue(parentConf, "Parca_Kodu") || getAttributeValue(parentDoc, "Parca_Kodu") || getAttributeValue(parentDoc, "Name") || "";
                    }
                    result.push({ partCode, parentPartCode });
                }
            });
            return result;
        }

        function findProcessedStdPartsWithInvalidMaterial(xmlDoc) {
            const acceptedMaterials = [
                "C1010", "C1040", "C1050", "C1060", "C2083", "C2316", "C2344", "C2379", "C8620", "CK45", "CK75", "ST37", "ST44", "ST52",
                "C4140", "C5140", "ST37_C", "ST44_C", "ST52_C", "ST37_H", "ST44_H", "ST52_H", "HRP", "DKP", "CK45_KR_KP", "TRANSMISYON",
                "C1040_H", "C1040_C", "AL2007", "AL2024", "AL5083", "AL5754", "AL6013", "AL6061", "AL6063", "AL6082", "AL6083", "AL7000",
                "AL7075", "AL8000", "KR_303", "KR_304", "KR_309", "KR_310", "KR_316", "DERLIN", "KESTAMIT", "POLIETILEN", "POLIPROPILEN",
                "POLYAMID", "ULPOLEN1000", "FIBER", "TEFLON", "VULKOLON", "POLIURETAN", "RG05", "RG07", "RG10", "RG12", "RG14", "PIRINC",
                "GGG60", "GG30", "GGG50", "GGG40", "GG60", "GG25", "GG20", "ST37-2", "ST52", "C1040", "GS60", "PLEXIGLASS", "KAUCUK", "AL5083",
                "AL6061_O", "AL6061_T4", "AL6061_T6", "AL6063_T1", "AL6063_T4", "AL6063_T5", "AL6063_T6", "AL6063_T83", "AL6082_T6",
                "AL7075_T6", "ALUMINYUM_BRONZ", "GALVANIZLI SAC", "CK45_KROM KAPLI", "ST37_SOGUK CEKIM", "ST37_SICAK CEKIM",
                "ST52_SICAK CEKIM", "C4140_ISLAHLI", "ST44_SICAK CEKIM", "C1040_SICAK CEKIM", "C1040_SOGUK CEKIM", "ST44_SOGUK CEKIM",
                "HARDOX400", "PPRC", "BAKIR", "MDF", "ST52_SOGUK CEKIM", "ALUDUR PLUS", "MIKA", "SOLID", "16MNCR5",
                "CK45_INDUKSIYONLU KROM KAPLI", "AL2017", "YAY CELIGI", "55SI7", "NAYLON 6/10", "ALPOLEN1000", "ETIAL 160",
                "1050 H14", "1054 H14", "PA6", "ALUMINYUMKOMPOZIT", "CUZN25AL5", "45CR2", "34CRALNI7-10", "PPE", "DIN 17223", "AL5083 TASLANMIS", "HDPE", "PP", "PET",
                "ThornelVCB-20KarbonKumas"
            ].map(m => m.trim().toUpperCase());

            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const hammadde = getAttributeValue(conf, "Hammadde").trim().toUpperCase();
                const hammaddeOlcusu = getAttributeValue(conf, "Hammadde_Olcusu").trim().toUpperCase();
                const material = getAttributeValue(conf, "Malzeme").trim().toUpperCase();

                if ((hammadde === "STD" || hammaddeOlcusu === "STD") &&
                    (!material || !acceptedMaterials.includes(material))) {
                    result.push({ partCode, material });
                }
            });
            return result;
        }

        function kontrolLevhaLazerPlazma(xmlDoc) {
            const levhaAmaLazerPlazmaDegil = [];
            const levhaDegilAmaLazerPlazma = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").trim().toUpperCase();
                let ilkOp = "";
                for (let i = 1; i <= 8; i++) {
                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim().toUpperCase();
                    if (op) {
                        ilkOp = op;
                        break;
                    }
                }
                if (hammadde === "LEVHA") {
                    if (ilkOp !== "LAZER KESİM" && ilkOp !== "PLAZMA KESİM" && ilkOp !== "SU JETİ") {
                        levhaAmaLazerPlazmaDegil.push({ partCode, ilkOp: ilkOp || "(yok)" });
                    }
                } else {
                    if (ilkOp === "LAZER KESİM" || ilkOp === "PLAZMA KESİM" && ilkOp !== "SU JETİ") {
                        levhaDegilAmaLazerPlazma.push({ partCode, ilkOp });
                    }
                }
            });
            return { levhaAmaLazerPlazmaDegil, levhaDegilAmaLazerPlazma };
        }

        function findInvalidPartCodePairs(xmlDoc) {
            const result = [];
            const partCodes = new Set();
            const documents = xmlDoc.querySelectorAll("document");

            // Tüm parça kodlarını topla
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();

                // Eğer parça MNG ise hataya dahil etme
                if (imalatTipi === "MNG") return;

                partCodes.add(partCode);
            });

            // Parça kodlarını kontrol et
            partCodes.forEach(code => {
                if (!/-\d{4}$/.test(code)) { // Sadece sonunda `-` ve 4 haneli varyantı olmayanlar
                    const baseCode = code.replace(/-\d{4}$/, ""); // Sonunda `-` ve 4 hane varsa kaldır
                    const hasVariant = Array.from(partCodes).some(otherCode =>
                        otherCode.startsWith(baseCode) && /-\d{4}$/.test(otherCode)
                    );
                    if (hasVariant) {
                        result.push({
                            baseCode: code,
                            message: `Hata: ${code} ve aynı kökten gelen varyantlar aynı anda mevcut.`
                        });
                    }
                }
            });

            return result;
        }

        function renderInvalidPartCodePairs(xmlDoc) {
            const invalidPairs = findInvalidPartCodePairs(xmlDoc);

            if (invalidPairs.length > 0) {
                const div = document.createElement('div');
                div.className = 'mismatch-list';
                div.innerHTML = `<b>Hatalı Parça Kodları:</b>
<ul>
    ${invalidPairs.map((pair, i) => `
        <li>
            <input type="checkbox" class="strike-checkbox" id="invalidPairCheck_${i}">
            <b>${pair.baseCode}</b>: <span style="color:#c0392b;">${pair.message}</span>
        </li>
    `).join("")}
</ul>`;
                document.querySelector('main').insertBefore(div, document.getElementById('accordion'));
                setTimeout(() => {
                    div.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const li = this.closest('li');
                            if (li) li.classList.toggle('strikeout', this.checked);
                        });
                    });
                }, 0);
            }
        }

        function findImalatTipiIssues(xmlDoc) {
            const acceptedTypes = ["IML", "MNG", "MAK"];
            const emptyList = [];
            const anaImalatList = [];
            const multiTypeList = [];
            const wrongTypeList = [];

            const codeTypeMap = {};
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const imalatTipi = getAttributeValue(conf, "İmalat_Tipi").trim().toUpperCase();
                const description = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();

                // Bu türler hariç tutulacak:
                if (
                    description.includes("KESIM LISTESI") ||
                    description.includes("CUT-LIST-ITEM") ||
                    description.includes("SHEET") ||
                    name.includes("KESIM LISTESI") ||
                    name.includes("CUT-LIST-ITEM") ||
                    name.includes("SHEET")
                ) {
                    return;
                }

                if (
                    !imalatTipi &&
                    !/^[A-Z0-9]{6}$/.test(partCode)
                ) {
                    emptyList.push({ partCode });
                }

                if (partCode.endsWith("-0000") && imalatTipi === "IML") {
                    anaImalatList.push({ partCode });
                }

                if (name.toUpperCase().endsWith(".SLDASM") && imalatTipi === "IML") {
                    anaImalatList.push({ partCode });
                }

                if (!codeTypeMap[partCode]) codeTypeMap[partCode] = new Set();
                if (imalatTipi) codeTypeMap[partCode].add(imalatTipi);

                if (imalatTipi && !acceptedTypes.includes(imalatTipi)) {
                    wrongTypeList.push({ partCode, imalatTipi });
                }
            });

            Object.entries(codeTypeMap).forEach(([code, typeSet]) => {
                if (typeSet.has("IML") && typeSet.has("MNG")) {
                    multiTypeList.push({ partCode: code, types: Array.from(typeSet).join(", ") });
                }
            });

            return { emptyList, anaImalatList, multiTypeList, wrongTypeList };
        }

        function findInvalidMaterialERPCode(xmlDoc) {
            const result = [];
            const validCodes = ["01", "02", "03", "04", "05", "06", "07", "08"];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const name = getAttributeValue(conf, "Name");
                const imalatTipi = getAttributeValue(conf, "İmalat_Tipi").trim().toUpperCase();
                const erpCode = getAttributeValue(conf, "Malzeme_ERP_Code").trim();
                const partCode = getAttributeValue(conf, "Parca_Kodu") || name || "Belirsiz";
                const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();

                // Eğer Sipariş Dışı Bırak 1 ise kontrol etme
                if (siparisDisiBirak === "1") return;

                if (name && name.toUpperCase().endsWith(".SLDPRT") && imalatTipi === "IML") {
                    if (!erpCode) {
                        result.push({ partCode, erpCode: "(boş)" });
                    } else if (!validCodes.includes(erpCode)) {
                        result.push({ partCode, erpCode });
                    }
                }
            });
            return result;
        }

        function findPartsWithEmptyHamO2(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const name = getAttributeValue(conf, "Name") || "";
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").toUpperCase();
                const ham_o1 = getAttributeValue(conf, "Ham_o1") || "";
                const ham_o2 = getAttributeValue(conf, "Ham_o2") || "";

                // Hammadde adında BORU, LAMA, KARE, DOLU, NPU, KOSEBENT, IPE, ÇUBUK geçenler ve Ham_o2'si boş olanlar
                // VEYA hammadde "LEVHA" veya "LEVHA ÖZEL" ise ve Ham_o2 boşsa
                if (
                    name.toUpperCase().endsWith(".SLDPRT") &&
                    (
                        hammadde.includes("BORU") ||
                        hammadde.includes("LAMA") ||
                        hammadde.includes("KARE") ||
                        hammadde.includes("ÇUBUK") || // <-- EKLENDİ
                        hammadde.includes("DOLU") ||
                        hammadde.includes("NPU") ||
                        hammadde.includes("KOSEBENT") ||
                        hammadde.includes("LEVHA ÖZEL")
                    ) &&
                    ham_o1 &&
                    (!ham_o2 || ham_o2.trim() === "")
                ) {
                    result.push({ partCode, hammadde, ham_o1 });
                }
            });
            return result;
        }

        function findDocumentsWithMultipleConfigurations(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const configs = doc.querySelectorAll(":scope > configuration");
                if (configs.length > 1) {
                    // Hatalı document için kodları topla
                    const partCodes = Array.from(configs).map(conf =>
                        getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(conf, "Name") || "(Kodu Yok)"
                    );
                    result.push({
                        doc,
                        partCodes
                    });
                }
            });
            return result;
        }

        function findMNGMontajKaynakHatalari(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const imalatTipi = (getAttributeValue(conf, "İmalat_Tipi") || "").trim().toUpperCase();

                // Tüm operasyonları topla
                let mekanikMontajVar = false;
                let kaynakVar = false;
                for (let i = 1; i <= 8; i++) {
                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").toUpperCase();
                    if (op.includes("MEKANİK MONTAJ")) mekanikMontajVar = true;
                    if (op.includes("KAYNAK")) kaynakVar = true;
                }

                // MEKANİK MONTAJ kontrolü: SADECE IML için hata ver
                if (imalatTipi === "IML" && mekanikMontajVar) {
                    result.push({ partCode, message: "IML olmasına rağmen Mekanik Montaj girilen parça" });
                }

                // 1. Parça kodu -0000 ile biten ve imalat tipi MNG olanlar
                if (partCode.endsWith("-0000") && imalatTipi === "MNG") {
                    if (mekanikMontajVar) {
                        result.push({ partCode, message: "KAYNAK MONTAJINDA MEKANİK MONTAJ OLMAMALI!" });
                    }
                    if (!kaynakVar) {
                        result.push({ partCode, message: "Montajda KAYNAK yok!" });
                    }
                }

                // 2. Parça kodu -0000 ile bitmeyip, 000 ile bitip imalat tipi MNG olanlar
                // 2. Parça kodu -0000 ile bitmeyip, 000 ile bitiyor, imalat tipi MNG olanlar
                if (!partCode.endsWith("-0000") && partCode.endsWith("000") && imalatTipi === "MNG") {
                    // Varyantlı mı? (ör: -A000, -B000)
                    const match = partCode.match(/-(\w)000$/);
                    if (match) {
                        // Harf ile başlayan varyant (ör: -A000, -B000)
                        // Bu montajlarda KAYNAK olması NORMAL, MEKANİK MONTAJ olmaması da NORMAL!
                        // Yani hata eklemeyin!
                        // İsterseniz bilgi mesajı ekleyebilirsiniz:
                        // result.push({ partCode, message: "Varyantlı kaynak montajı: KAYNAK var ve MEKANİK MONTAJ yoksa hata değildir." });
                    } else {
                        // Normal 000 ile bitenler için eski kontrol
                        if (kaynakVar) {
                            result.push({ partCode, message: "Parça kodu -0000 ile bitmiyor, 000 ile bitiyor, imalat tipi MNG ve rotasında KAYNAK var! (Hatalı)" });
                        }
                        if (!mekanikMontajVar) {
                            result.push({ partCode, message: "Parça kodu -0000 ile bitmiyor, 000 ile bitiyor, imalat tipi MNG ve rotasında MEKANİK MONTAJ yok! (Hatalı)" });
                        }
                    }
                }
            });
            return result;
        }

        function findProfilesWithEmptyLength(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const parentConf = doc.querySelector("configuration");
                if (!parentConf) return;
                const parentName = (getAttributeValue(parentConf, "Name") || "").toUpperCase();
                // Sadece .SLDPRT ile biten üst montajlar
                if (!parentName.endsWith(".SLDPRT")) return;
                const parentCode = getAttributeValue(parentConf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";

                // FASON İŞLEM kontrolü
                let hasFason = false;
                for (let i = 1; i <= 8; i++) {
                    const op = getAttributeValue(parentConf, `OP${i}_Tanim`).toUpperCase();
                    if (op === "FASON İŞLEM") {
                        hasFason = true;
                        break;
                    }
                }

                // Sadece bir üst montajı göster
                const childConfs = doc.querySelectorAll("references > document > configuration");
                childConfs.forEach(childConf => {
                    const childName = (getAttributeValue(childConf, "Name") || "").toUpperCase();
                    const childDesc = (getAttributeValue(childConf, "Description") || "").toUpperCase();
                    const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childConf, "Name") || "Belirsiz";
                    const uzunluk = getAttributeValue(childConf, "Uzunluk");

                    // Sadece profil çocuklar ve uzunluk boşsa
                    if (
                        (
                            childDesc.includes("PROFIL/") ||
                            childDesc.includes("NPU/") ||
                            childDesc.includes("KOSEBENT/") ||
                            /\bIPE\b/.test(childDesc)
                        ) &&
                        (!uzunluk || uzunluk.trim() === "")
                    ) {
                        result.push({
                            partCode: childCode,
                            tip: `→ ${parentCode}${hasFason ? " (FASON İŞLEM)" : ""}`
                        });
                    }
                });
            });
            return result;
        }

        function yeniMalzemeListesi() {
            // Accordion'daki tüm parçaları oku
            const accordionItems = document.querySelectorAll('.accordion-item');
            let parcaListesi = [];

            accordionItems.forEach(item => {
                const title = item.querySelector('.accordion-title');
                if (!title) return;
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                let olcu = "", hammadde = "", malzeme = "", miktar = "", imalatTipi = "";
                let isProfilCocuk = false;
                let description = "";
                let uzunluk = "";
                let profilTipi = "";
                let operasyonlar = [];
                const content = item.querySelector('.accordion-content');
                if (content) {
                    const rows = content.querySelectorAll('tbody tr');
                    rows.forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Description") {
                            description = deger;
                            const descUp = (deger || "").toUpperCase();
                            // Sadece PROFIL/ (sonunda / olan), NPU/, KOSEBENT/, IPE geçenler profil çocuk kabul edilsin
                            if (
                                descUp.includes("PROFIL/") ||
                                descUp.includes("PROFİL/") ||
                                descUp.includes("NPU/") ||
                                descUp.includes("KOSEBENT/") ||
                                descUp.includes("IPE")
                            ) {
                                isProfilCocuk = true;
                            }
                        }
                        if (alan === "Uzunluk") uzunluk = deger;
                        if (alan === "Profil_Tipi") profilTipi = deger;
                        if (alan === "Hammadde") hammadde = deger;
                        // Operasyon alanlarını topla
                        if (alan.startsWith("OP") && alan.includes("Tanim") && deger && deger.trim()) {
                            operasyonlar.push(deger.trim());
                        }
                        // Ölçü bilgisi: Levha için Ham_o1, profil için Profil_Tanim_Boy kullan
                        if (!isProfilCocuk) {
                            if (alan === "Ham_o1") olcu = deger;
                            // Sadece levha değilse Profil_Tanim_Boy'u da kontrol et
                            if (alan === "Profil_Tanim_Boy" && (hammadde || "").toUpperCase() !== "LEVHA") {
                                olcu = deger;
                            }
                        }
                        if (alan === "Malzeme") malzeme = deger;
                        if (alan === "Ham_o2") miktar = deger;
                        if (alan === "İmalat_Tipi") imalatTipi = deger.toUpperCase();
                    });
                    // PROFİL çocuk parçası ise ve description'da profil anahtar kelimesi varsa, uzunluk ve profil tipi de doluysa ölçüyü description olarak yaz
                    if (
                        isProfilCocuk &&
                        description &&
                        uzunluk && uzunluk.trim() !== "" &&
                        profilTipi && profilTipi.trim() !== ""
                    ) {
                        olcu = description;
                        miktar = uzunluk; // PROFİL çocuk parçası ise miktar = uzunluk
                    }
                }

                // Filtreler...
                if (/^[A-Z0-9]{6}$/.test(partCode) && (malzeme || "").toUpperCase() === "STD") {
                    if (partCode.startsWith("GU-1028-110")) console.log(`${partCode} filtrelendi: STD parça`);
                    return;
                }
                if (imalatTipi === "MNG" || imalatTipi === "MAK") {
                    if (partCode.startsWith("GU-1028-110")) console.log(`${partCode} filtrelendi: MNG/MAK`);
                    return;
                }
                if (olcu && (/[- ]*L *=/i.test(olcu) || olcu.includes("@"))) {
                    if (partCode.startsWith("GU-1028-110")) console.log(`${partCode} filtrelendi: olcu=${olcu} (L= veya @ içeriyor)`);
                    return;
                }
                if ((!olcu || olcu.trim() === "") && (!hammadde || hammadde.trim() === "") && (!miktar || miktar.trim() === "")) {
                    if (partCode.startsWith("GU-1028-110")) console.log(`${partCode} filtrelendi: boş olcu/hammadde/miktar`);
                    return;
                }

                if (partCode && toplamAdet) {
                    parcaListesi.push({
                        partCode,
                        olcu,
                        toplamAdet,
                        hammadde,
                        malzeme,
                        miktar,
                        operasyonlar
                    });
                }
            });

            // --- Ana filtreyi oku ---
            let anaFiltre = "";
            const anaFiltreElem = document.getElementById('accAnaFiltre') || document.getElementById('anaFiltre');
            if (anaFiltreElem) anaFiltre = anaFiltreElem.value;

            // --- Ana filtreyi uygula ---
            if (anaFiltre === "levha") {
                parcaListesi = parcaListesi.filter(x => (x.hammadde || "").toUpperCase() === "LEVHA");
            } else if (anaFiltre === "profil") {
                parcaListesi = parcaListesi.filter(x => {
                    const desc = (x.olcu || "") + " " + (x.description || "");
                    return /(PROFIL|PROFİL|NPU|KOSEBENT|IPE)/i.test(desc);
                });
            } else if (anaFiltre === "std") {
                parcaListesi = parcaListesi.filter(x => {
                    return ((x.hammadde || "").toUpperCase() === "STD");
                });
            } else if (anaFiltre === "diger") {
                parcaListesi = parcaListesi.filter(x =>
                    (x.hammadde || "").toUpperCase() !== "LEVHA" &&
                    (x.hammadde || "").toUpperCase() !== "STD" &&
                    !/(PROFIL|PROFİL|NPU|KOSEBENT|IPE)/i.test((x.olcu || "") + " " + (x.description || ""))
                );
            }

            // --- Diğer filtreler için seçili değerleri oku ---
            let olcuFiltre = "", hammaddeFiltre = "", malzemeFiltre = "", operasyonFiltre = "";
            if (window.accOlcuFiltreVal !== undefined) olcuFiltre = window.accOlcuFiltreVal;
            if (window.accHammaddeFiltreVal !== undefined) hammaddeFiltre = window.accHammaddeFiltreVal;
            if (window.accMalzemeFiltreVal !== undefined) malzemeFiltre = window.accMalzemeFiltreVal;
            // Operasyon filtresi sadece levha seçiminde geçerli
            if (anaFiltre === "levha" && window.accOperasyonFiltreVal !== undefined) operasyonFiltre = window.accOperasyonFiltreVal;

            // --- Diğer filtreleri uygula ---
            let filteredList = parcaListesi.filter(x => {
                // Diğer filtreleri kontrol et
                const olcuMatch = !olcuFiltre || x.olcu === olcuFiltre;
                const hammaddeMatch = !hammaddeFiltre || x.hammadde === hammaddeFiltre;
                const malzemeMatch = !malzemeFiltre || x.malzeme === malzemeFiltre;
                
                // Operasyon filtresi için özel kontrol
                let operasyonMatch = true;
                if (operasyonFiltre) {
                    if (anaFiltre === "levha") {
                        // Levha için ilk operasyonu kontrol et
                        let ilkOp = "";
                        if (window.loadedXmlDoc) {
                            const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                                const conf = d.querySelector("configuration");
                                if (!conf) return false;
                                const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                                return code === x.partCode;
                            });
                            if (doc) {
                                const conf = doc.querySelector("configuration");
                                if (conf) {
                                    for (let i = 1; i <= 8; i++) {
                                        const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                        if (op) {
                                            ilkOp = op;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        operasyonMatch = ilkOp === operasyonFiltre;
                    } else {
                        // Diğer filtreler için eski mantık
                        operasyonMatch = x.operasyonlar && x.operasyonlar.includes(operasyonFiltre);
                    }
                }
                
                return olcuMatch && hammaddeMatch && malzemeMatch && operasyonMatch;
            });

            if (anaFiltre === "levha") {
                const grouped = {};
                filteredList.forEach(item => {
                    const key = [item.partCode, item.olcu, item.hammadde, item.malzeme].join("|");
                    if (!grouped[key]) {
                        grouped[key] = { ...item };
                    } else {
                        grouped[key].toplamAdet += item.toplamAdet;
                        // Eğer miktar sayısal ise topla
                        const miktar1 = parseFloat((grouped[key].miktar || "").toString().replace(",", "."));
                        const miktar2 = parseFloat((item.miktar || "").toString().replace(",", "."));
                        if (!isNaN(miktar1) && !isNaN(miktar2)) {
                            grouped[key].miktar = miktar1 + miktar2;
                        }
                    }
                });
                filteredList = Object.values(grouped);
            }

            // --- Filtre kutuları için veri toplama ---
            // Accordion verisinden direkt topla, getFilteredMalzemeList kullanma
            const olcuSet = new Set();
            const hammaddeSet = new Set();
            const malzemeSet = new Set();
            const operasyonSet = new Set();
            
            // Ana filtreye göre tüm accordion verilerini filtrele
            const allAccordionItems = document.querySelectorAll('.accordion-item');
            allAccordionItems.forEach(item => {
                const title = item.querySelector('.accordion-title');
                if (!title) return;
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";

                let olcu = "", hammadde = "", malzeme = "", imalatTipi = "";
                let isProfilCocuk = false;
                let description = "";
                let uzunluk = "";
                let profilTipi = "";
                
                const content = item.querySelector('.accordion-content');
                if (content) {
                    const rows = content.querySelectorAll('tbody tr');
                    rows.forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Description") {
                            description = deger;
                            const descUp = (deger || "").toUpperCase();
                            if (
                                descUp.includes("PROFIL/") ||
                                descUp.includes("PROFİL/") ||
                                descUp.includes("NPU/") ||
                                descUp.includes("KOSEBENT/") ||
                                descUp.includes("IPE")
                            ) {
                                isProfilCocuk = true;
                            }
                        }
                        if (alan === "Uzunluk") uzunluk = deger;
                        if (alan === "Profil_Tipi") profilTipi = deger;
                        if (alan === "Hammadde") hammadde = deger;
                        if (!isProfilCocuk) {
                            if (alan === "Ham_o1") olcu = deger;
                            if (alan === "Profil_Tanim_Boy" && (hammadde || "").toUpperCase() !== "LEVHA") {
                                olcu = deger;
                            }
                        }
                        if (alan === "Malzeme") malzeme = deger;
                        if (alan === "İmalat_Tipi") imalatTipi = deger.toUpperCase();
                    });
                    
                    // PROFİL çocuk parçası kontrolü
                    if (
                        isProfilCocuk &&
                        description &&
                        uzunluk && uzunluk.trim() !== "" &&
                        profilTipi && profilTipi.trim() !== ""
                    ) {
                        olcu = description;
                    }
                }

                // Filtreler (aynı mantık)
                if (/^[A-Z0-9]{6}$/.test(partCode) && (malzeme || "").toUpperCase() === "STD") return;
                if (imalatTipi === "MNG" || imalatTipi === "MAK") return;
                if (olcu && (/[- ]*L *=/i.test(olcu) || olcu.includes("@"))) return;
                if ((!olcu || olcu.trim() === "") && (!hammadde || hammadde.trim() === "") && (!malzeme || malzeme.trim() === "")) return;

                // Ana filtreye göre kontrol
                let dahilEt = false;
                if (anaFiltre === "levha") {
                    dahilEt = (hammadde || "").toUpperCase() === "LEVHA";
                } else if (anaFiltre === "profil") {
                    const desc = (olcu || "") + " " + (description || "");
                    dahilEt = /(PROFIL|PROFİL|NPU|KOSEBENT|IPE)/i.test(desc);
                } else if (anaFiltre === "std") {
                    dahilEt = (hammadde || "").toUpperCase() === "STD";
                } else if (anaFiltre === "diger") {
                    dahilEt = (hammadde || "").toUpperCase() !== "LEVHA" &&
                              (hammadde || "").toUpperCase() !== "STD" &&
                              !/(PROFIL|PROFİL|NPU|KOSEBENT|IPE)/i.test((olcu || "") + " " + (description || ""));
                } else {
                    dahilEt = true; // Tümü
                }

                if (dahilEt) {
                    if (olcu) olcuSet.add(olcu);
                    if (hammadde) hammaddeSet.add(hammadde);
                    if (malzeme) malzemeSet.add(malzeme);
                    
                    // Operasyon için levha filtresinde ilk operasyonu hesapla
                    if (anaFiltre === "levha" && window.loadedXmlDoc) {
                        const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                            const conf = d.querySelector("configuration");
                            if (!conf) return false;
                            const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                            return code === partCode;
                        });
                        if (doc) {
                            const conf = doc.querySelector("configuration");
                            if (conf) {
                                for (let i = 1; i <= 8; i++) {
                                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                    if (op) {
                                        operasyonSet.add(op);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // --- Ana filtre kutusu ---
            let anaFiltreHtml = `
<div style="margin-bottom:10px; display:flex; gap:12px; align-items:center;">
    <label>Ana Filtre:</label>
    <select id="accAnaFiltre" style="min-width:160px;">
        <option value="">Tümü</option>
        <option value="levha">Levha</option>
        <option value="profil">Profil</option>
        <option value="std">İşlenen Standart Parça</option>
        <option value="diger">Diğer</option>
    </select>
</div>
`;

            // --- Diğer filtre kutuları ---
            let operasyonFilterHtml = "";
            // Operasyon filtresi sadece levha seçiminde görünür
            if (anaFiltre === "levha") {
                operasyonFilterHtml = `
    <label>Operasyon:</label>
    <select id="accOperasyonFiltre" style="min-width:120px;">
        <option value="">Tümü</option>
        ${Array.from(operasyonSet).sort().map(o => `<option value="${o}">${o}</option>`).join("")}
    </select>`;
            }
            
            let filtreHtml = anaFiltreHtml + `
<div style="margin-bottom:10px; display:flex; gap:12px; align-items:center;">
    <label>Ölçü:</label>
    <select id="accOlcuFiltre" style="min-width:120px;">
        <option value="">Tümü</option>
        ${Array.from(olcuSet).sort().map(o => `<option value="${o}">${o}</option>`).join("")}
    </select>
    <label>Hammadde:</label>
    <select id="accHammaddeFiltre" style="min-width:120px;">
        <option value="">Tümü</option>
        ${Array.from(hammaddeSet).sort().map(h => `<option value="${h}">${h}</option>`).join("")}
    </select>
    <label>Malzeme:</label>
    <select id="accMalzemeFiltre" style="min-width:120px;">
        <option value="">Tümü</option>
        ${Array.from(malzemeSet).sort().map(m => `<option value="${m}">${m}</option>`).join("")}
    </select>${operasyonFilterHtml}
</div>
`;

            let parcaAramaHtml = `
<div style="margin-bottom:10px; display:flex; align-items:center; gap:8px;">
    <input type="text" id="yeniMalzemeTabloParcaArama" placeholder="Malzeme tablosunda parça kodu ara..." 
        style="padding:7px 12px; border-radius:4px; border:1px solid #bbb; width:220px; font-size:15px;">
    <button id="yeniMalzemeTabloParcaAramaClear" title="Temizle"
        style="background:none; border:none; color:#888; font-size:18px; cursor:pointer; display:none; padding:0;">&#10006;</button>
</div>
`;
            const toplamAdet = filteredList.reduce((sum, x) => sum + (parseFloat(x.toplamAdet) || 0), 0);
            const toplamMiktar = filteredList.reduce((sum, x) => {
                const miktarNum = parseFloat((x.miktar || "").toString().replace(",", "."));
                const adetNum = parseFloat((x.toplamAdet || "").toString().replace(",", "."));
                // Eğer miktar ve adet sayısal ise çarp, değilse 0 ekle
                return sum + (!isNaN(miktarNum) && !isNaN(adetNum) ? miktarNum * adetNum : 0);
            }, 0);

            let toplamSatiri = "";

            if (anaFiltre === "levha") {
                // 1:checkbox, 2:Parça Kodu, 3:Ölçü, 4:Hammadde, 5:Malzeme, 6:Toplam Adet, 7:Seçili
                toplamSatiri = `
      <tr style="font-weight:bold;background:#f3f3f3;">
        <td></td>
        <td colspan="4" style="text-align:right;">Toplam:</td>
        <td>${toplamAdet.toLocaleString("tr-TR")}</td>
        <td></td>
        <td></td>
      </tr>
    `;
            } else if (anaFiltre === "profil") {
                // 1:Parça Kodu, 2:Ölçü, 3:Hammadde, 4:Malzeme, 5:Miktar, 6:Toplam Adet, 7:Toplam Miktar
                toplamSatiri = `
      <tr style="font-weight:bold;background:#f3f3f3;">
        <td colspan="4" style="text-align:right;">Toplam:</td>
        <td></td>
        <td>${toplamAdet.toLocaleString("tr-TR")}</td>
        <td>${toplamMiktar.toLocaleString("tr-TR")}</td>
      </tr>
    `;
            } else if (anaFiltre === "std") {
                // 1:Parça Kodu, 2:Ölçü, 3:Hammadde, 4:Malzeme, 5:Miktar, 6:Toplam Adet, 7:Boş
                toplamSatiri = `
      <tr style="font-weight:bold;background:#f3f3f3;">
        <td colspan="4" style="text-align:right;">Toplam:</td>
        <td></td>
        <td>${toplamAdet.toLocaleString("tr-TR")}</td>
        <td></td>
      </tr>
    `;
            } else {
                // Tümü ve Diğer: 1:Parça Kodu, 2:Ölçü, 3:Hammadde, 4:Malzeme, 5:Miktar, 6:Toplam Adet, 7:Toplam Miktar
                toplamSatiri = `
      <tr style="font-weight:bold;background:#f3f3f3;">
        <td colspan="4" style="text-align:right;">Toplam:</td>
        <td></td>
        <td>${toplamAdet.toLocaleString("tr-TR")}</td>
        <td>${toplamMiktar.toLocaleString("tr-TR")}</td>
      </tr>
    `;
            }
            // --- Tablo HTML ---
            let toplamMiktarGenel = 0;
            let html = parcaAramaHtml + filtreHtml + `
<table style="margin-bottom:12px;" id="yeniMalzemeTable">
    <thead>
<tr>
  ${anaFiltre === "levha" ? '<th></th>' : ''}
  <th>Parça Kodu</th>
  <th>Ölçü</th>
  <th>Hammadde</th>
  <th>Malzeme</th>
  ${anaFiltre !== "levha" ? '<th>Miktar</th>' : ''}
  <th>Toplam Adet</th>
  ${anaFiltre !== "levha" ? '<th>Toplam Miktar</th>' : ''}
  ${anaFiltre === "levha" ? '<th>Seçili</th><th>İlk Operasyon</th>' : ''}
</tr>
</thead>
    <tbody>
        ${filteredList.map((x, i) => {
                let toplamMiktar = "";
                const miktarNum = parseFloat((x.miktar || "").toString().replace(",", "."));
                const adetNum = parseFloat((x.toplamAdet || "").toString().replace(",", "."));
                if (!isNaN(miktarNum) && !isNaN(adetNum)) {
                    toplamMiktar = miktarNum * adetNum;
                    toplamMiktarGenel += toplamMiktar;
                    toplamMiktar = toplamMiktar.toLocaleString("tr-TR");
                }
                // Checkbox için anahtar
                const key = [x.partCode, x.olcu, x.hammadde, x.malzeme].join("|");
                // Checkbox işaretli mi?
                const checked = window.levhaSecimSet && window.levhaSecimSet.has(key);
                // Satır arka planı ve üstü çizili mi?
                const trStyle = (anaFiltre === "levha" && checked) ? ' style="background:#ffe066;text-decoration:line-through;opacity:0.6;"' : '';

                // İlk Operasyon sütunu için
                let ilkOp = "";
                if (anaFiltre === "levha" && window.loadedXmlDoc) {
                    const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === x.partCode;
                    });
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf) {
                            for (let i = 1; i <= 8; i++) {
                                const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                if (op) {
                                    ilkOp = op;
                                    break;
                                }
                            }
                        }
                    }
                }

                return `
            <tr${trStyle}>
      ${anaFiltre === "levha" ? `<td><input type="checkbox" class="strike-checkbox" data-key="${key}" ${checked ? "checked" : ""}></td>` : ""}
      <td>${(x.partCode || "").replace(/-R\d{2}$/i, "")}</td>
      <td>${x.olcu || ""}</td>
      <td>${x.hammadde || ""}</td>
      <td>${x.malzeme || ""}</td>
      ${anaFiltre !== "levha" ? `<td>${x.miktar || ""}</td>` : ""}
      <td>${x.toplamAdet}</td>
      ${anaFiltre !== "levha" ? `<td>${toplamMiktar}</td>` : ""}
      ${anaFiltre === "levha" ? `<td class="secili-td">${checked ? "✔" : ""}</td><td>${ilkOp}</td>` : ""}
    </tr>
            `;
            }).join("")}
    </tbody>
    <tfoot>
    ${toplamSatiri}
  </tfoot>
</table>`;

            // --- Filtre eventleri ---
            setTimeout(() => {
                const anaSel = document.getElementById('accAnaFiltre');
                const olcuSel = document.getElementById('accOlcuFiltre');
                const hammaddeSel = document.getElementById('accHammaddeFiltre');
                const malzemeSel = document.getElementById('accMalzemeFiltre');
                const operasyonSel = document.getElementById('accOperasyonFiltre');
                if (anaSel) anaSel.value = anaFiltre;
                if (olcuSel) olcuSel.value = olcuFiltre;
                if (hammaddeSel) hammaddeSel.value = hammaddeFiltre;
                if (malzemeSel) malzemeSel.value = malzemeFiltre;
                if (operasyonSel) operasyonSel.value = operasyonFiltre;
                [anaSel, olcuSel, hammaddeSel, malzemeSel, operasyonSel].forEach(sel => {
                    if (sel) sel.onchange = function () {
                        if (sel === anaSel) {
                            window.document.getElementById('anaFiltre').value = anaSel.value;
                            // Ana filtre değiştiğinde operasyon filtresini temizle
                            window.accOperasyonFiltreVal = "";
                        }
                        window.accOlcuFiltreVal = olcuSel ? olcuSel.value : "";
                        window.accHammaddeFiltreVal = hammaddeSel ? hammaddeSel.value : "";
                        window.accMalzemeFiltreVal = malzemeSel ? malzemeSel.value : "";
                        window.accOperasyonFiltreVal = operasyonSel ? operasyonSel.value : "";
                        document.getElementById('extraListArea').innerHTML = `<div style="margin-top:28px;">${yeniMalzemeListesi()}</div>`;
                    };
                });

                // --- Arama kutusu sadece parça kodunda arama yapacak şekilde ---
                const aramaInput = document.getElementById('yeniMalzemeTabloParcaArama');
                const clearBtn = document.getElementById('yeniMalzemeTabloParcaAramaClear');
                if (aramaInput && clearBtn) {
                    aramaInput.addEventListener('input', function () {
                        const val = this.value.trim().toLowerCase();
                        clearBtn.style.display = val ? "" : "none";
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => {
                            const anaFiltreElem = document.getElementById('accAnaFiltre');
                            const anaFiltre = anaFiltreElem ? anaFiltreElem.value : "";
                            const isLevha = anaFiltre === "levha";
                            // Levha: 2. sütun (index 1), Diğer: 1. sütun (index 0)
                            const kodTd = tr.querySelectorAll('td')[isLevha ? 1 : 0];
                            const kod = (kodTd ? kodTd.innerText : "").toLowerCase();
                            tr.style.display = !val || kod.includes(val) ? "" : "none";
                        });
                    });
                    clearBtn.onclick = function () {
                        aramaInput.value = "";
                        clearBtn.style.display = "none";
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => tr.style.display = "");
                        aramaInput.focus();
                    };
                }

                // --- Levha filtresi açıkken checkbox işaretli satırları çizili ve sarı yap ---
                const anaFiltreElem = document.getElementById('accAnaFiltre');
                const anaFiltreVal = anaFiltreElem ? anaFiltreElem.value : "";
                const isLevha = anaFiltreVal === "levha";

                if (isLevha) {
                    // Tümünü seç/kaldır butonları
                    let secimPanel = document.getElementById('levhaSecimPanel');
                    if (!secimPanel) {
                        secimPanel = document.createElement('div');
                        secimPanel.id = 'levhaSecimPanel';
                        secimPanel.style = "margin-bottom:10px; display:flex; gap:10px; align-items:center;";
                        secimPanel.innerHTML = `
                <button id="btnLevhaTumunuSec">Tümünü Seç</button>
                <button id="btnLevhaTumunuKaldir">Tümünün Seçimini Kaldır</button>
                <button id="btnLevhaSeciliGoster">Sadece Seçili</button>
                <button id="btnLevhaSecilmemisGoster">Sadece Seçili Olmayan</button>
                <button id="btnLevhaTumunuGoster">Tümünü Göster</button>
            `;
                        const table = document.getElementById('yeniMalzemeTable');
                        if (table) table.parentElement.insertBefore(secimPanel, table);
                    }

                    // Tümünü Seç
                    document.getElementById('btnLevhaTumunuSec').onclick = function () {
                        if (!window.levhaSecimSet) {
                            window.levhaSecimSet = new Set();
                        }
                        document.querySelectorAll('#yeniMalzemeTable .strike-checkbox').forEach(cb => {
                            cb.checked = true;
                            const key = cb.getAttribute('data-key');
                            window.levhaSecimSet.add(key);
                            const tr = cb.closest('tr');
                            const seciliTd = tr.querySelector('.secili-td');
                            if (tr) {
                                tr.style.background = "#ffe066";
                                tr.style.textDecoration = "line-through";
                                tr.style.opacity = "0.6";
                            }
                            if (seciliTd) seciliTd.textContent = "✔";
                        });
                    };

                    // Tümünün Seçimini Kaldır
                    document.getElementById('btnLevhaTumunuKaldir').onclick = function () {
                        if (!window.levhaSecimSet) {
                            window.levhaSecimSet = new Set();
                        }
                        document.querySelectorAll('#yeniMalzemeTable .strike-checkbox').forEach(cb => {
                            cb.checked = false;
                            const key = cb.getAttribute('data-key');
                            window.levhaSecimSet.delete(key);
                            const tr = cb.closest('tr');
                            const seciliTd = tr.querySelector('.secili-td');
                            if (tr) {
                                tr.style.background = "";
                                tr.style.textDecoration = "";
                                tr.style.opacity = "";
                            }
                            if (seciliTd) seciliTd.textContent = "";
                        });
                    };

                    // Sadece Seçili Olanları Göster
                    document.getElementById('btnLevhaSeciliGoster').onclick = function () {
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => {
                            const cb = tr.querySelector('.strike-checkbox');
                            tr.style.display = (cb && cb.checked) ? "" : "none";
                        });
                    };

                    // Sadece Seçili Olmayanları Göster
                    document.getElementById('btnLevhaSecilmemisGoster').onclick = function () {
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => {
                            const cb = tr.querySelector('.strike-checkbox');
                            tr.style.display = (cb && !cb.checked) ? "" : "none";
                        });
                    };

                    // Tümünü Göster
                    document.getElementById('btnLevhaTumunuGoster').onclick = function () {
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => {
                            tr.style.display = "";
                        });
                    };

                    // Checkbox işaretleme/işareti kaldırma
                    document.querySelectorAll('#yeniMalzemeTable .strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function (e) {
                            e.stopPropagation(); // Event'in üst elementlere gitmesini engelle
                            
                            // levhaSecimSet'i başlat
                            if (!window.levhaSecimSet) {
                                window.levhaSecimSet = new Set();
                            }
                            
                            const key = this.getAttribute('data-key');
                            const tr = this.closest('tr');
                            const seciliTd = tr.querySelector('.secili-td');
                            
                            if (this.checked) {
                                window.levhaSecimSet.add(key);
                                if (tr) {
                                    tr.style.background = "#ffe066";
                                    tr.style.textDecoration = "line-through";
                                    tr.style.opacity = "0.6";
                                }
                                if (seciliTd) seciliTd.textContent = "✔";
                            } else {
                                window.levhaSecimSet.delete(key);
                                if (tr) {
                                    tr.style.background = "";
                                    tr.style.textDecoration = "";
                                    tr.style.opacity = "";
                                }
                                if (seciliTd) seciliTd.textContent = "";
                            }
                        });
                        // Sayfa yenilendiğinde işaretli olanları da tikli göster
                        if (cb.checked) {
                            const tr = cb.closest('tr');
                            const seciliTd = tr.querySelector('.secili-td');
                            if (seciliTd) seciliTd.textContent = "✔";
                        }
                    });
                } else {
                    // Levha filtresi dışında paneli gizle
                    const secimPanel = document.getElementById('levhaSecimPanel');
                    if (secimPanel) secimPanel.style.display = "none";
                }

                // --- Parça Kodu başlığına tıklama ile kopyalama özelliği ekle ---
                const parcaKoduTh = document.querySelector('#yeniMalzemeTable thead th:nth-child(' + (anaFiltre === "levha" ? '2' : '1') + ')');
                if (parcaKoduTh && parcaKoduTh.textContent.trim() === "Parça Kodu") {
                    parcaKoduTh.style.cursor = "pointer";
                    parcaKoduTh.title = "Tüm parça kodlarını alt alta kopyala";
                    parcaKoduTh.addEventListener('click', function() {
                        // Tablodaki tüm görünür parça kodlarını topla
                        const kodlar = [];
                        document.querySelectorAll('#yeniMalzemeTable tbody tr').forEach(tr => {
                            if (tr.style.display !== "none") {
                                const kodTd = tr.querySelector('td:nth-child(' + (anaFiltre === "levha" ? '2' : '1') + ')');
                                if (kodTd) {
                                    const kod = kodTd.textContent.trim();
                                    if (kod && !kodlar.includes(kod)) {
                                        kodlar.push(kod);
                                    }
                                }
                            }
                        });
                        
                        if (kodlar.length === 0) {
                            this.textContent = "Kopyalanacak kod yok!";
                            setTimeout(() => this.textContent = "Parça Kodu", 900);
                            return;
                        }
                        
                        // Alt alta kopyala
                        const text = kodlar.join('\n');
                        navigator.clipboard.writeText(text);
                        
                        // Görsel geri bildirim
                        const originalText = this.textContent;
                        this.style.background = "#ffe066";
                        this.textContent = "Kopyalandı!";
                        setTimeout(() => {
                            this.style.background = "";
                            this.textContent = originalText;
                        }, 900);
                    });
                }
            }, 0);

            // Tablo sıralama özelliğini etkinleştir
            setTimeout(() => {
                initTableSorting();
            }, 100);

            return html;
        }

        function exportYeniMalzemeListesiToExcel() {
            const area = document.getElementById('extraListArea');
            const table = area.querySelector("#yeniMalzemeTable");
            if (!table) return;

            // Ana filtreyi kontrol et
            const anaFiltreElem = document.getElementById('accAnaFiltre');
            const isLevha = anaFiltreElem && anaFiltreElem.value === "levha";

            let csv = [];
            let headers = [];
            table.querySelectorAll("thead th").forEach(th => {
                headers.push(th.innerText.trim());
            });
            if (isLevha) headers.push("Seçili mi?");
            csv.push(headers.join(";"));

            table.querySelectorAll("tbody tr").forEach(tr => {
                if (tr.style.display === "none") return;
                let row = [];
                let tds = tr.querySelectorAll("td");
                let tdOffset = isLevha ? 1 : 0;
                for (let i = tdOffset; i < tds.length; i++) {
                    // Checkbox sütununu atla
                    if (isLevha && i === 0) continue;
                    row.push(tds[i].innerText.trim());
                }
                if (isLevha) {
                    const cb = tr.querySelector('.strike-checkbox');
                    row.push(cb && cb.checked ? "Evet" : "Hayır");
                }
                csv.push(row.join(";"));
            });

            let csvContent = "\uFEFF" + csv.join("\r\n");
            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "malzeme_listesi.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateImalatMalzemeTablosu(xmlDoc, anaFiltre, olcuFiltre, hammaddeFiltre, malzemeFiltre, malzemeListesiOut) {
            // Seçim setini globalde tut
            window.levhaSecimSet = window.levhaSecimSet || new Set();
            window.levhaGorunumFiltre = window.levhaGorunumFiltre || "tum";

            const malzemeListesi = [];

            function gez(docNode, parentMultiplier) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu")
                    || getAttributeValue(docNode, "Parca_Kodu")
                    || getAttributeValue(docNode, "Name")
                    || "Belirsiz";
                const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();
                if (siparisDisiBirak === "1" || partCode.length < 7) return;

                const adet = parseInt(conf.getAttribute("quantity")) || 1;
                const toplamAdet = adet * parentMultiplier;
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").toUpperCase();

                // Çocuk dokümanlar (profil kontrolü için)
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                const childPartCodes = [], childDescriptions = [];
                childDocs.forEach(childDoc => {
                    const ch = childDoc.querySelector('configuration');
                    if (!ch) return;
                    childPartCodes.push(
                        getAttributeValue(ch, "Parca_Kodu")
                        || getAttributeValue(childDoc, "Parca_Kodu")
                        || getAttributeValue(childDoc, "Name")
                        || ""
                    );
                    childDescriptions.push(getAttributeValue(ch, "Description") || "");
                });

                const description = getAttributeValue(conf, "Description") || "";
                const olcuHam_o1 = getAttributeValue(conf, "Ham_o1") || "";
                const profilDegerleri = [
                    getAttributeValue(conf, "Profil_Tanim_Boy"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_1"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_2"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_3"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_4")
                ].filter(Boolean);

                const isProfil = isProfilePartObj({
                    partCode, hammadde, description,
                    olcu: profilDegerleri[0] || "",
                    childPartCodes, childDescriptions,
                    name: getAttributeValue(conf, "Name") || getAttributeValue(docNode, "Name") || ""
                });

                // Operasyon bilgilerini topla
                const operasyonlar = [];
                for (let i = 1; i <= 8; i++) {
                    const op = getAttributeValue(conf, `OP${i}_Tanim`);
                    if (op && op.trim()) {
                        operasyonlar.push(op.trim());
                    }
                }

                if (hammadde === "LEVHA") {
                    // Levha: Ham_o1 ve Ham_o2 miktar
                    const olcu = olcuHam_o1;
                    const hamO2 = (getAttributeValue(conf, "Ham_o2") || "0").replace(",", ".");
                    const miktar = (parseFloat(hamO2) || 0) * toplamAdet;
                    const tekilMiktar = getAttributeValue(conf, "Ham_o2") || "";
                    const up = partCode.toUpperCase();
                    if (
                        up.includes("SHEET") ||
                        up.includes("KESIM LISTESI") ||
                        up.includes("CUT-LIST-ITEM") ||
                        partCode.endsWith("-0000")
                    ) return;

                    malzemeListesi.push({
                        partCode,
                        olcu,
                        miktar,
                        hammadde,
                        hammadde_olcusu: getAttributeValue(conf, "Hammadde_Olcusu"),
                        malzeme: getAttributeValue(conf, "Malzeme"),
                        toplamAdet,
                        tekilMiktar,
                        description,
                        childPartCodes,
                        childDescriptions,
                        name: getAttributeValue(conf, "Name") || getAttributeValue(docNode, "Name") || "",
                        operasyonlar
                    });

                } else if (isProfil) {
                    profilDegerleri.forEach(pb => {
                        const m = pb.match(/^(.*?)-\s*L=\s*(\d+)/);
                        const olcu = m ? m[1].trim() : pb.trim();
                        let toplamUzunluk = 0;
                        let eslesenCocukVar = false;
                        childDocs.forEach(childDoc => {
                            const ch = childDoc.querySelector('configuration');
                            if (!ch) return;
                            const desc = (getAttributeValue(ch, "Description") || "").trim();
                            if (desc.startsWith(olcu)) {
                                eslesenCocukVar = true;
                                const cu = parseFloat((getAttributeValue(ch, "Uzunluk") || "0").replace(",", ".")) || 0;
                                const cad = parseInt(ch.getAttribute("quantity")) || 1;
                                toplamUzunluk += cu * cad * toplamAdet;
                            }
                        });
                        if (!eslesenCocukVar) toplamUzunluk = 0;
                        malzemeListesi.push({
                            partCode,
                            olcu,
                            miktar: toplamUzunluk,
                            hammadde,
                            malzeme: getAttributeValue(conf, "Malzeme"),
                            toplamAdet,
                            tekilMiktar: "",
                            description,
                            childPartCodes,
                            childDescriptions,
                            name: getAttributeValue(conf, "Name") || getAttributeValue(docNode, "Name") || "",
                            tip: "profil_ana",
                            operasyonlar
                        });
                    });
                } else {
                    // Diğer: Ham_o1 ve Ham_o2 miktar
                    const olcu = olcuHam_o1;
                    const hamO2 = (getAttributeValue(conf, "Ham_o2") || "0").replace(",", ".");
                    const miktar = (parseFloat(hamO2) || 0) * toplamAdet;
                    const tekilMiktar = getAttributeValue(conf, "Ham_o2") || "";

                    malzemeListesi.push({
                        partCode,
                        olcu,
                        miktar,
                        hammadde,
                        malzeme: getAttributeValue(conf, "Malzeme"),
                        toplamAdet,
                        tekilMiktar,
                        description,
                        childPartCodes,
                        childDescriptions,
                        name: getAttributeValue(conf, "Name") || getAttributeValue(docNode, "Name") || "",
                        operasyonlar
                    });
                }

                // Alt montajları dolaş
                childDocs.forEach(childDoc => gez(childDoc, toplamAdet));
            }

            // Kökten başlat, setAdedi kullanılarak
            const documents = xmlDoc.querySelectorAll("document");
            Array.from(documents)
                .filter(d => d.parentElement.tagName.toLowerCase() !== "references")
                .forEach(d => gez(d, setAdedi));

            // Dışa aktarım dizisi varsa doldur
            if (malzemeListesiOut && Array.isArray(malzemeListesiOut)) {
                malzemeListesiOut.length = 0;
                malzemeListesi.forEach(x => malzemeListesiOut.push(x));
            }

            // Gruplama: aynı partCode|olcu|hammadde|malzeme
            const grouped = {};
            malzemeListesi.forEach(item => {
                const key = [item.partCode, item.olcu, item.hammadde, item.malzeme].join("|");
                if (!grouped[key]) grouped[key] = { ...item };
                else {
                    grouped[key].miktar += item.miktar;
                    grouped[key].toplamAdet += item.toplamAdet;
                }
            });

            let finalList = Object.values(grouped);

            // Ana filtre
            if (anaFiltre === "levha") {
                finalList = finalList.filter(x => x.hammadde === "LEVHA");
            } else if (anaFiltre === "profil") {
                finalList = finalList.filter(x => isProfilePartObj(x));
            } else if (anaFiltre === "std") {
                finalList = finalList.filter(x => {
                    const isStd = x.hammadde === "STD" || x.hammadde_olcusu === "STD";
                    const hasProf = x.childDescriptions.some(d => /(PROFIL|PROFİL|NPU|KOSEBENT|IPE)/.test(d.toUpperCase()));
                    return isStd && !hasProf;
                });
            } else if (anaFiltre === "diger") {
                finalList = finalList.filter(x =>
                    x.hammadde !== "LEVHA" &&
                    x.hammadde !== "STD" &&
                    !isProfilePartObj(x)
                );
            }

            // Sütun filtreleri
            if (olcuFiltre) {
                finalList = finalList.filter(x => {
                    if (isProfilePartObj(x)) {
                        const idx = x.olcu.indexOf("L=");
                        const o = idx > 0 ? x.olcu.substring(0, idx).trim() : x.olcu.trim();
                        return o === olcuFiltre;
                    }
                    return x.olcu === olcuFiltre;
                });
            }
            if (hammaddeFiltre) finalList = finalList.filter(x => x.hammadde === hammaddeFiltre);
            if (malzemeFiltre) finalList = finalList.filter(x => x.malzeme === malzemeFiltre);

            // Sıralama
            finalList.sort((a, b) => {
                if (a.malzeme !== b.malzeme) return a.malzeme.localeCompare(b.malzeme);
                if (a.hammadde !== b.hammadde) return a.hammadde.localeCompare(b.hammadde);
                if (a.olcu !== b.olcu) return a.olcu.localeCompare(b.olcu);
                return a.partCode.localeCompare(b.partCode);
            });

            // Levha filtre butonları
            let filtreHtml = "";
            const isLevha = anaFiltre === "levha";
            if (isLevha) {
                filtreHtml = `
            <div id="levhaSecimFiltre" style="margin-bottom:8px;">
                <button data-filtre="tum" class="levha-filtre-btn${window.levhaGorunumFiltre === "tum" ? " active" : ""}">Tümü</button>
                <button data-filtre="secili" class="levha-filtre-btn${window.levhaGorunumFiltre === "secili" ? " active" : ""}">Sadece İşaretli</button>
                <button data-filtre="secsiz" class="levha-filtre-btn${window.levhaGorunumFiltre === "secsiz" ? " active" : ""}">Sadece İşaretsiz</button>
                <input type="text" id="levhaKodArama" placeholder="Parça kodu ara..." style="margin-left:18px; padding:6px 12px; border-radius:4px; border:1px solid #bbb; width:220px; font-size:14px;">
            </div>
            `;
            }

            // Filtre uygula
            let filteredList = finalList;
            if (isLevha) {
                filteredList = finalList.filter(item => {
                    const key = [item.partCode, item.olcu, item.hammadde, item.malzeme].join("|");
                    if (window.levhaGorunumFiltre === "secili") return window.levhaSecimSet.has(key);
                    if (window.levhaGorunumFiltre === "secsiz") return !window.levhaSecimSet.has(key);
                    return true;
                });
            }

            let operasyonSet = new Set();
            if (isLevha) {
                filteredList.forEach(item => {
                    // item.partCode ile eşleşen document'ı bul
                    const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        return code === item.partCode;
                    });
                    let ilkOp = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf) {
                            for (let i = 1; i <= 8; i++) {
                                const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                if (op) {
                                    ilkOp = op;
                                    break;
                                }
                            }
                        }
                    }
                    if (ilkOp) operasyonSet.add(ilkOp);
                });
            }

            // ...tablo html oluşturulmadan önce...
            let operasyonFiltreHtml = "";
            if (isLevha && operasyonSet.size > 0) {
                operasyonFiltreHtml = `
            <div style="margin-bottom:10px;">
                <label for="levhaOperasyonFiltre">Operasyon Filtre:</label>
                <select id="levhaOperasyonFiltre">
                    <option value="">Tümü</option>
                    ${Array.from(operasyonSet).sort().map(op => `<option value="${op}">${op}</option>`).join("")}
                </select>
            </div>
            `;
            }

            // Tablo oluşturma
            let html = filtreHtml + operasyonFiltreHtml + `
        <table id="imalatMalzemeTable">
          <thead>
            <tr>
              ${isLevha ? '<th><input type="checkbox" id="selectAllCheckbox"></th>' : ''}
              <th>#</th><th>Parça Kodu</th><th>Ölçü</th><th>Tekil Miktar</th><th>Toplam Adet</th><th>Toplam Miktar</th><th>Hammadde</th><th>Malzeme</th>${isLevha ? '<th>İşaretli</th>' : ''}
            </tr>
          </thead>
          <tbody>
        `;

            // ...tabloyu oluşturduktan sonra, setTimeout içinde filtre eventini ekle...
            setTimeout(() => {
                if (isLevha) {
                    // Filtre butonları
                    const filtreDiv = document.getElementById('levhaSecimFiltre');
                    if (filtreDiv) {
                        filtreDiv.querySelectorAll('.levha-filtre-btn').forEach(btn => {
                            btn.onclick = function () {
                                filtreDiv.querySelectorAll('.levha-filtre-btn').forEach(b => b.classList.remove('active'));
                                this.classList.add('active');
                                window.levhaGorunumFiltre = this.getAttribute('data-filtre');
                                tabloyuGuncelle();
                            };
                        });
                    }
                    // Checkboxlar
                    const selectAll = document.getElementById('selectAllCheckbox');
                    if (selectAll) {
                        selectAll.addEventListener('change', () => {
                            document.querySelectorAll('.strike-checkbox').forEach(cb => {
                                cb.checked = selectAll.checked;
                                const key = cb.getAttribute('data-key');
                                if (cb.checked) window.levhaSecimSet.add(key);
                                else window.levhaSecimSet.delete(key);
                                
                                // Satır stilini güncelle
                                const tr = cb.closest('tr');
                                const seciliTd = tr.querySelector('.secili-td');
                                if (cb.checked) {
                                    if (tr) {
                                        tr.style.background = "#ffe066";
                                        tr.style.textDecoration = "line-through";
                                        tr.style.opacity = "0.6";
                                    }
                                    if (seciliTd) seciliTd.textContent = "✔";
                                } else {
                                    if (tr) {
                                        tr.style.background = "";
                                        tr.style.textDecoration = "";
                                        tr.style.opacity = "";
                                    }
                                    if (seciliTd) seciliTd.textContent = "";
                                }
                            });
                            // tabloyuGuncelle() çağrısını kaldırdık
                        });
                    }
                    document.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const key = this.getAttribute('data-key');
                            if (this.checked) window.levhaSecimSet.add(key);
                            else window.levhaSecimSet.delete(key);
                            
                            // Satır stilini güncelle
                            const tr = this.closest('tr');
                            const seciliTd = tr.querySelector('.secili-td');
                            if (this.checked) {
                                if (tr) {
                                    tr.style.background = "#ffe066";
                                    tr.style.textDecoration = "line-through";
                                    tr.style.opacity = "0.6";
                                }
                                if (seciliTd) seciliTd.textContent = "✔";
                            } else {
                                if (tr) {
                                    tr.style.background = "";
                                    tr.style.textDecoration = "";
                                    tr.style.opacity = "";
                                }
                                if (seciliTd) seciliTd.textContent = "";
                            }
                            // tabloyuGuncelle() çağrısını kaldırdık
                        });
                    });

                    // Parça kodu arama kutusu
                    const kodArama = document.getElementById('levhaKodArama');
                    if (kodArama) {
                        kodArama.oninput = function () {
                            const val = this.value.trim().toLowerCase();
                            document.querySelectorAll('#imalatMalzemeTable tbody tr').forEach(tr => {
                                const kod = (tr.querySelector('td:nth-child(' + (isLevha ? 3 : 2) + ')')?.innerText || "").toLowerCase();
                                if (!val || kod.includes(val)) {
                                    tr.style.display = "";
                                } else {
                                    tr.style.display = "none";
                                }
                            });
                        };
                    }

                    // Operasyon filtre kutusu
                    const opFiltre = document.getElementById('levhaOperasyonFiltre');
                    if (opFiltre) {
                        opFiltre.onchange = function () {
                            const val = this.value;
                            document.querySelectorAll('#imalatMalzemeTable tbody tr').forEach(tr => {
                                // Tekil miktar hücresinde operasyon var
                                const op = (tr.querySelector('td:nth-child(' + (isLevha ? 5 : 4) + ')')?.innerText || "").trim();
                                if (!val || op === val) {
                                    tr.style.display = "";
                                } else {
                                    tr.style.display = "none";
                                }
                            });
                        };
                    }
                }
            }, 0);

            let docMap = null;
            if (isLevha) {
                docMap = new Map();
                Array.from(window.loadedXmlDoc.querySelectorAll("document")).forEach(d => {
                    const conf = d.querySelector("configuration");
                    if (!conf) return;
                    const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                    docMap.set(code, d);
                });
            }

            let rowIndex = 0;

            filteredList.forEach(item => {
                if (item.miktar === 0) return;
                if (item.partCode.toUpperCase().includes("CUT-LIST-ITEM") || item.partCode.endsWith("-0000")) return;
                if (
                    item.toplamAdet && item.olcu.trim() === "" &&
                    item.miktar === 0 && item.hammadde.trim() === "" && item.tekilMiktar.trim() === "" &&
                    item.hammadde.toUpperCase() !== "STD" &&
                    item.hammadde.toUpperCase() !== "LEVHA"
                ) return;

                // Hatalı ölçü kontrolü
                let hataliOlcu = false;
                let hataMesaji = "";
                if (
                    (
                        item.olcu.startsWith("KARE PROFIL/") ||
                        item.olcu.startsWith("DIKDORTGEN PROFIL/") ||
                        item.olcu.startsWith("NPU/") ||
                        item.olcu.startsWith("KOSEBENT/") ||
                        item.olcu.startsWith("IPE/")
                    ) &&
                    (
                        (item.olcu.includes("@") && item.olcu.split("x").length > 2) ||
                        item.olcu.includes('"')
                    )
                ) {
                    hataliOlcu = true;
                    hataMesaji = `<span style="color:#c0392b;font-weight:bold;">Ölçüde hata: Profil ölçüsü yanlış formatta!</span>`;
                }

                rowIndex++;
                const key = [item.partCode, item.olcu, item.hammadde, item.malzeme].join("|");
                const checked = window.levhaSecimSet.has(key);

                // Levha filtresinde ise tekil miktar yerine ilk operasyonu yaz
                let tekilMiktarGoster = item.tekilMiktar;
                if (isLevha && docMap) {
                    const doc = docMap.get(item.partCode);
                    let ilkOp = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        if (conf) {
                            for (let i = 1; i <= 8; i++) {
                                const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                if (op) {
                                    ilkOp = op;
                                    break;
                                }
                            }
                        }
                    }
                    tekilMiktarGoster = ilkOp || "";
                }

                html += `<tr${isLevha ? ` data-row="${rowIndex - 1}"${checked ? ' style="background:#ffe066;"' : ''}` : ''}>`;
                if (isLevha) html += `<td><input type="checkbox" class="strike-checkbox" data-key="${key}" ${checked ? "checked" : ""}></td>`;
                html += `
              <td>${rowIndex}.</td>
              <td>${item.partCode}</td>
              <td>${hataliOlcu ? hataMesaji : item.olcu}</td>
              <td>${tekilMiktarGoster}</td>
              <td>${item.toplamAdet}</td>
              <td>${item.miktar.toLocaleString("tr-TR")}</td>
              <td>${item.hammadde}</td>
              <td>${item.malzeme}</td>
              ${isLevha ? `<td>${checked ? "✔" : ""}</td>` : ""}
            </tr>`;
            });

            // Toplam satırı
            const toplamAdet = filteredList.reduce((sum, x) => sum + (parseFloat(x.toplamAdet) || 0), 0);
            const toplamMiktar = filteredList.reduce((sum, x) => sum + (parseFloat(x.miktar) || 0), 0);
            html += `
          </tbody>
          <tfoot>
            <tr style="font-weight:bold;background:#f3f3f3;">
              ${isLevha ? '<td></td>' : ''}
              <td>TOPLAM</td><td></td><td></td><td></td>
              <td>${toplamAdet.toLocaleString("tr-TR")}</td>
              <td>${toplamMiktar.toLocaleString("tr-TR")}</td><td></td><td></td>${isLevha ? '<td></td>' : ''}
            </tr>
          </tfoot>
        </table>`;

            // Checkbox eventleri ve filtre butonları
            setTimeout(() => {
                if (isLevha) {
                    // Filtre butonları
                    const filtreDiv = document.getElementById('levhaSecimFiltre');
                    if (filtreDiv) {
                        filtreDiv.querySelectorAll('.levha-filtre-btn').forEach(btn => {
                            btn.onclick = function () {
                                filtreDiv.querySelectorAll('.levha-filtre-btn').forEach(b => b.classList.remove('active'));
                                this.classList.add('active');
                                window.levhaGorunumFiltre = this.getAttribute('data-filtre');
                                tabloyuGuncelle();
                            };
                        });
                    }
                    // Checkboxlar
                    const selectAll = document.getElementById('selectAllCheckbox');
                    if (selectAll) {
                        selectAll.addEventListener('change', () => {
                            document.querySelectorAll('.strike-checkbox').forEach(cb => {
                                cb.checked = selectAll.checked;
                                const key = cb.getAttribute('data-key');
                                if (cb.checked) window.levhaSecimSet.add(key);
                                else window.levhaSecimSet.delete(key);
                                const tr = cb.closest('tr');
                                if (tr) tr.style.background = cb.checked ? "#ffe066" : "";
                            });
                        });
                    }
                    document.querySelectorAll('.strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const key = this.getAttribute('data-key');
                            if (this.checked) window.levhaSecimSet.add(key);
                            else window.levhaSecimSet.delete(key);
                            const tr = this.closest('tr');
                            if (tr) tr.style.background = this.checked ? "#ffe066" : "";
                            // SelectAll güncelle
                            if (selectAll) {
                                const all = Array.from(document.querySelectorAll('.strike-checkbox'));
                                selectAll.checked = all.length > 0 && all.every(x => x.checked);
                            }
                        });
                    });
                }
            }, 0);

            return html;
        }

        function findProfileChildrenWithEmptyProfilTipi(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");

            // PROFIL/NPU/KOSEBENT/IPE anahtar kelimesi için esnek kontrol
            function isProfileDesc(desc) {
                if (!desc) return false;
                desc = desc.toUpperCase();
                return (
                    desc.includes("PROFIL") ||
                    desc.includes("PROFİL") ||
                    desc.includes("NPU") ||
                    desc.includes("KOSEBENT") ||
                    /IPE\s*\d*/.test(desc) // IPE, IPE100, IPE 100, IPE/100 gibi
                );
            }

            documents.forEach(doc => {
                const parentConf = doc.querySelector('configuration');
                if (!parentConf) return;
                const parentCode = getAttributeValue(parentConf, "Parca_Kodu");
                if (!parentCode) return;
                if (parentCode.endsWith("-0000")) return;

                const childConfs = doc.querySelectorAll("references > document > configuration");
                childConfs.forEach(childConf => {
                    const desc = (getAttributeValue(childConf, "Description") || "");
                    const profilTipi = (getAttributeValue(childConf, "Profil_Tipi") || "").trim();
                    const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childConf, "Name") || "Belirsiz";

                    // SADECE -R00 ile biten çocuklar için hata ekle
                    if (
                        isProfileDesc(desc) &&
                        childCode === parentCode + "-R00" &&
                        profilTipi === ""
                    ) {
                        result.push({
                            child: childCode,
                            parent: parentCode
                        });
                    }
                });
            });
            return result;
        }


        function findProfileChildrenNotDisardaBirak(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            const addedChildren = new Set();

            // PROFIL/NPU/KOSEBENT/IPE anahtar kelimesi için esnek kontrol
            function isProfileDesc(desc) {
                if (!desc) return false;
                desc = desc.toUpperCase();
                return (
                    desc.includes("PROFIL") ||
                    desc.includes("PROFİL") ||
                    desc.includes("NPU") ||
                    desc.includes("KOSEBENT") ||
                    /IPE\s*\d*/.test(desc) // IPE, IPE100, IPE 100, IPE/100 gibi
                );
            }

            documents.forEach(doc => {
                const parentConf = doc.querySelector('configuration');
                if (!parentConf) return;
                const parentCode = getAttributeValue(parentConf, "Parca_Kodu");
                if (!parentCode) return;
                if (parentCode.endsWith("-0000")) return;

                const childConfs = doc.querySelectorAll("references > document > configuration");
                childConfs.forEach(childConf => {
                    const desc = (getAttributeValue(childConf, "Description") || "");
                    const profilDisardaBirak = (getAttributeValue(childConf, "Profil_Disarda_Birak") || "").toUpperCase();
                    const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childConf, "Name") || "Belirsiz";

                    // Sadece çocuk parça için hata ekle (ana parça ile aynı kodda olsa bile, ana parça için ekleme)
                    if (
                        isProfileDesc(desc) &&
                        (childCode === parentCode || childCode === parentCode + "-R00") &&
                        profilDisardaBirak !== "DIŞARDA BIRAK" &&
                        childCode !== "" &&
                        childCode !== parentCode // <-- ANA PARÇAYI HARİÇ TUT!
                    ) {
                        const key = childCode + "|" + parentCode;
                        if (!addedChildren.has(key)) {
                            result.push({
                                child: childCode,
                                parent: parentCode
                            });
                            addedChildren.add(key);
                        }
                    }
                });
            });
            return result;
        }

        function findProfileMainPartsWithInvalidDisardaBirakChild(xmlDoc) {
            const result = [];
            const hammaddeList = [
                "ALTIKÖŞE", "BORU", "TEMİZ ÖLÇÜLÜ BORU", "ÇUBUK", "KARE", "LAMA", "LEVHA", "VİDALI MİL",
                "TRAPEZ MİL", "LEVHA ÖZEL", "STD", "SIGMA PROFIL", "IPE120", "C RAY"
            ];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const ham_o1 = getAttributeValue(conf, "Ham_o1") || "";
                const hammadde = (getAttributeValue(conf, "Hammadde") || "").toUpperCase();

                // Hammadde listesinde ve ham_o1 dolu olmalı
                if (hammaddeList.some(h => hammadde.includes(h.toUpperCase())) && ham_o1.trim() !== "") {
                    // Çocuklarda kendi partCode + -R00 olan ve gerekli şartları sağlayan var mı?
                    const childConfs = doc.querySelectorAll("references > document > configuration");
                    const hasInvalidChild = Array.from(childConfs).some(childConf => {
                        const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childConf, "Name") || "";
                        if (childCode !== partCode + "-R00") return false;

                        const childDesc = (getAttributeValue(childConf, "Description") || "").toUpperCase();
                        const profilTipi = getAttributeValue(childConf, "Profil_Tipi") || "";
                        const profilDisardaBirak = (getAttributeValue(childConf, "Profil_Disarda_Birak") || "").toUpperCase();

                        // PROFIL/ KOSEBENT/ NPU/ veya IPExxx (arkasında sadece sayı varsa)
                        let isValidDesc = false;
                        if (/PROFIL\//.test(childDesc) || /KOSEBENT\//.test(childDesc) || /NPU\//.test(childDesc)) {
                            isValidDesc = true;
                        } else if (/IPE\d+$/.test(childDesc)) {
                            isValidDesc = true;
                        }

                        // Profil_Tipi dolu ve Profil_Disarda_Birak "DIŞARDA BIRAK" olmalı
                        return isValidDesc && profilTipi.trim() !== "" && profilDisardaBirak === "DIŞARDA BIRAK";
                    });

                    if (hasInvalidChild) {
                        result.push({
                            partCode,
                            hammadde,
                            ham_o1
                        });
                    }
                }
            });
            return result;
        }

        function temizleOlcu(olcu) {
            // NPU/260,00X90,00 → NPU/260X90
            return olcu.replace(/(\d+),00/g, "$1");
        }

        function findProfileLengthMismatch(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                if (partCode.endsWith("-0000")) return;

                // --- YENİ: Sadece kendi kodu ile aynı veya -R00 olan çocuk varsa kontrol et ---
                const childDocs = doc.querySelectorAll(':scope > configuration > references > document');
                let hasChild = false;
                childDocs.forEach(childDoc => {
                    const chConf = childDoc.querySelector('configuration');
                    if (!chConf) return;
                    const childCode = getAttributeValue(chConf, "Parca_Kodu") || getAttributeValue(chConf, "Name") || "";
                    if (childCode === partCode || childCode === partCode + "-R00") {
                        hasChild = true;
                    }
                });
                if (!hasChild) return; // Alt çocuk yoksa veya kodlar uymuyorsa hata verme

                // Profil tanım boylarını al
                const profilDegerleri = [
                    getAttributeValue(conf, "Profil_Tanim_Boy"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_1"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_2"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_3"),
                    getAttributeValue(conf, "Profil_Tanim_Boy_4")
                ].filter(Boolean);

                // Eşleşenleri ve eşleşmeyenleri ayır
                let eslesenler = [];
                let eslesmeyenler = [];

                profilDegerleri.forEach(pb => {
                    // Ölçü ve L= miktarını ayıkla
                    const m = pb.match(/^(.*?)-\s*L=\s*("?)([\d.]+)\2/);
                    if (!m) return;
                    let olcu = m[1].trim();
                    olcu = temizleOlcu(olcu); // ,00'ları temizle
                    const lMiktar = parseFloat(m[3].replace(",", "."));
                    if (isNaN(lMiktar)) return;

                    // Çocuklardan ölçü başı eşleşenlerin toplam uzunluğunu bul
                    let toplamUzunluk = 0;
                    childDocs.forEach(childDoc => {
                        const ch = childDoc.querySelector('configuration');
                        if (!ch) return;
                        let desc = (getAttributeValue(ch, "Description") || "").trim();
                        desc = temizleOlcu(desc); // Çocukta da ,00'ları temizle
                        if (desc.startsWith(olcu)) {
                            const cu = parseFloat((getAttributeValue(ch, "Uzunluk") || "0").replace(",", ".")) || 0;
                            const cad = parseInt(ch.getAttribute("quantity")) || 1;
                            toplamUzunluk += cu * cad;
                        }
                    });

                    // Karşılaştırma: tolerans 1 mm
                    if (Math.abs(toplamUzunluk - lMiktar) > 1) {
                        eslesmeyenler.push({ profilTanimBoy: pb, lMiktar, toplamUzunluk });
                    } else {
                        eslesenler.push({ profilTanimBoy: pb, lMiktar, toplamUzunluk });
                    }
                });

                // Sadece eşleşmeyen varsa, eşleşenleri parantez içinde göster
                if (eslesmeyenler.length > 0) {
                    result.push({
                        partCode,
                        eslesmeyenler,
                        eslesenler
                    });
                }
            });
            return result;
        }

        function findProfileChildrenWithInvalidDescription(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            const added = new Set();

            // Profil kontrol fonksiyonu
            function isProfile(conf) {
                const desc = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const profilTipi = (getAttributeValue(conf, "Profil_Tipi") || "").toUpperCase();
                const profilTanimBoy = (getAttributeValue(conf, "Profil_Tanim_Boy") || "").toUpperCase();
                return (
                    desc.includes("PROFIL") || desc.includes("PROFİL") ||
                    desc.includes("NPU") || desc.includes("KOSEBENT") || desc.includes("IPE") ||
                    profilTipi.includes("PROFIL") || profilTipi.includes("PROFİL") ||
                    profilTipi.includes("NPU") || profilTipi.includes("KOSEBENT") || profilTipi.includes("IPE") ||
                    profilTanimBoy.includes("PROFIL") || profilTanimBoy.includes("PROFİL") ||
                    profilTanimBoy.includes("NPU") || profilTanimBoy.includes("KOSEBENT") || profilTanimBoy.includes("IPE")
                );
            }

            documents.forEach(doc => {
                const parentConf = doc.querySelector('configuration');
                if (!parentConf) return;
                const parentCode = getAttributeValue(parentConf, "Parca_Kodu");
                if (!parentCode) return;

                // Sadece ana parça PROFIL ise çocukları kontrol et
                if (!isProfile(parentConf)) return;

                const childConfs = doc.querySelectorAll("references > document > configuration");
                childConfs.forEach(childConf => {
                    if (!isProfile(childConf)) return;
                    const desc = (getAttributeValue(childConf, "Description") || "");
                    const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childConf, "Name") || "Belirsiz";
                    // Sadece bir kez ekle (aynı çocuk için tekrar ekleme)
                    if (added.has(childCode)) return;
                    // Hatalı karakter kontrolü
                    if (
                        desc.includes("@") ||
                        desc.toUpperCase().includes("-R00") ||
                        desc.includes("&quot") ||
                        desc.toUpperCase().includes(".SLDPRT") ||
                        desc.toUpperCase().includes(".SLDASM")
                    ) {
                        result.push({
                            child: childCode,
                            parent: parentCode,
                            desc: desc
                        });
                        added.add(childCode);
                    }
                });
            });
            return result;
        }


        function findProfileMainPartsWithInvalidProfilTanimBoy(xmlDoc) {
            const result = [];
            const seen = new Set(); // Tekrarları önlemek için
            const documents = xmlDoc.querySelectorAll("document");

            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;

                const partCode =
                    getAttributeValue(conf, "Parca_Kodu") ||
                    getAttributeValue(doc, "Parca_Kodu") ||
                    getAttributeValue(doc, "Name") ||
                    "Belirsiz";

                const hammadde = (getAttributeValue(conf, "Hammadde") || "")
                    .trim()
                    .toUpperCase();

                // Ana parçanın hammaddesi C RAY ise bu kontrolü atla
                if (hammadde === "C RAY") return;

                // Tüm Profil_Tanim_Boy* alanlarını topla
                let profilTanimBoyList = [];
                for (let i = 0; i <= 4; i++) {
                    const key = i === 0 ? "Profil_Tanim_Boy" : `Profil_Tanim_Boy_${i}`;
                    const val = getAttributeValue(conf, key);
                    if (val && val.trim()) profilTanimBoyList.push(val.trim());
                }
                if (profilTanimBoyList.length === 0) return;

                // Çocuk parça kodlarını ve tanımlarını topla
                const childDocs = doc.querySelectorAll(":scope > configuration > references > document");
                const childInfos = Array.from(childDocs).map(childDoc => {
                    const childConf = childDoc.querySelector("configuration");
                    return childConf
                        ? {
                            code: getAttributeValue(childConf, "Parca_Kodu"),
                            desc: (getAttributeValue(childConf, "Description") || "")
                                .replace(/\s+/g, "")
                                .toUpperCase(),
                            uzunluk: parseFloat(
                                (getAttributeValue(childConf, "Uzunluk") || "0").replace(",", ".")
                            ),
                            quantity: parseFloat(
                                childConf.getAttribute("quantity") ||
                                getAttributeValue(childConf, "quantity") ||
                                "1"
                            ),
                        }
                        : null;
                }).filter(Boolean);

                // 👇 Yeni eklenen kontrol:
                // Eğer ana parça koduyla aynı temel koda (revizyon hariç) sahip hiçbir çocuk yoksa profil sayma.
                const baseCode = partCode.replace(/-R\d+$/i, "");
                const hasMatchingChild = childInfos.some(c => {
                    if (!c.code) return false;
                    return c.code.replace(/-R\d+$/i, "") === baseCode;
                });
                if (!hasMatchingChild) {
                    // Altında kendisiyle aynı kodda bir çocuk yok, profil sayma.
                    return;
                }

                // Profil_Tanim_Boy içindeki <N> değerlerini ayıkla ve gruplandır
                let profilGroups = {};
                profilTanimBoyList.forEach(boy => {
                    const match = boy.match(/<(\d+)>/);
                    const key = match ? boy.replace(/<\d+>/, "<*>") : boy;
                    if (!profilGroups[key]) profilGroups[key] = [];
                    profilGroups[key].push(boy);
                });

                Object.entries(profilGroups).forEach(([key, list]) => {
                    const hataliList = list.filter(boy => boy.includes("TOTAL LENGTH@@@"));
                    if (hataliList.length > 0) {
                        const uniqueKey = partCode + "|" + hataliList.join("||");
                        if (seen.has(uniqueKey)) return;
                        seen.add(uniqueKey);

                        let detaylar = "";
                        if (childInfos.length > 0) {
                            let grup = {};
                            childInfos.forEach(c => {
                                if (c.code && c.code.replace(/-R\d+$/i, "") === baseCode) {
                                    const profilOlcu = c.desc || "-";
                                    if (!grup[profilOlcu]) grup[profilOlcu] = 0;
                                    const adet =
                                        !isNaN(c.quantity) && c.quantity > 0 ? c.quantity : 1;
                                    grup[profilOlcu] +=
                                        (isNaN(c.uzunluk) ? 0 : c.uzunluk) * adet;
                                }
                            });
                            detaylar = Object.entries(grup)
                                .map(
                                    ([olcu, toplam]) =>
                                        `<span style="color:#e67e22; font-size:15px; font-weight:bold;">${olcu}: <b>${toplam.toLocaleString(
                                            "tr-TR"
                                        )} mm</b></span>`
                                )
                                .join("<br>");
                        }

                        let toplamUzunlukHtml = "";
                        if (detaylar) {
                            toplamUzunlukHtml = `<div style="margin: 6px 0 0 0; padding:0;">
<span style="color:#e67e22; font-size:15px; font-weight:bold; display:inline-block; margin-bottom:2px;">Ana parça kodu ile eşleşen çocuk profillerin toplam uzunlukları:</span><br>
${detaylar}
</div>`;
                        }

                        result.push({
                            partCode,
                            profilTanimBoy: hataliList.join("<br>"),
                            toplamUzunlukHtml,
                        });
                    }
                });
            });

            return result;
        }

        function findStdAltParcasiOlanlar(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const malzeme = (getAttributeValue(conf, "Malzeme") || "").trim().toUpperCase();

                // STD malzemeli ve alt parçası (references > document) olanlar
                if (malzeme === "STD") {
                    const childDocs = doc.querySelectorAll(":scope > configuration > references > document");
                    if (childDocs.length > 0) {
                        result.push({
                            partCode,
                            childCount: childDocs.length
                        });
                    }
                }
            });
            return result;
        }

        function findSameCodeWithDifferentMainInfos(xmlDoc) {
            const result = [];
            const documents = xmlDoc.querySelectorAll("document");
            const codeMap = {};
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "";
                const name = getAttributeValue(conf, "Name") || "";
                const desc = (getAttributeValue(conf, "Description") || "").toUpperCase();
                const nameUp = name.toUpperCase();

                // Sheet, Kesim Listesi, Cut-List-Item olanları atla
                if (
                    desc.includes("SHEET") ||
                    desc.includes("KESIM LISTESI") ||
                    desc.includes("CUT-LIST-ITEM") ||
                    nameUp.includes("SHEET") ||
                    nameUp.includes("KESIM LISTESI") ||
                    nameUp.includes("CUT-LIST-ITEM")
                ) return;

                // PROFIL/NPU/KOSEBENT/IPE içeren ve uzunluk dolu ve -R00 ile biten profil çocuklarını atla
                const uzunluk = getAttributeValue(conf, "Uzunluk") || "";
                if (
                    (desc.includes("PROFIL/") || desc.includes("PROFİL/") || desc.includes("NPU/") || desc.includes("KOSEBENT/") || desc.includes("IPE")) &&
                    uzunluk.trim() !== "" &&
                    partCode.endsWith("-R00")
                ) {
                    return;
                }

                const ham_o1 = getAttributeValue(conf, "Ham_o1") || "";
                const ham_o2 = getAttributeValue(conf, "Ham_o2") || "";
                const hammadde = getAttributeValue(conf, "Hammadde") || "";
                const malzeme = getAttributeValue(conf, "Malzeme") || "";
                if (!partCode) return;
                const infoKey = [ham_o1, ham_o2, hammadde, malzeme].join("|");
                if (!codeMap[partCode]) codeMap[partCode] = [];
                codeMap[partCode].push({ name, infoKey });
            });

            Object.entries(codeMap).forEach(([code, arr]) => {
                // Farklı bilgiye sahip kaç farklı unique anahtar var?
                const unique = [];
                arr.forEach(info => {
                    if (!unique.some(u => u.infoKey === info.infoKey)) {
                        unique.push(info);
                    }
                });
                if (unique.length > 1) {
                    result.push({
                        code,
                        names: unique.map(x => x.name)
                    });
                }
            });
            return result;
        }

        // Profil olup olmadığını nesne üzerinden kontrol et
        function isProfilePartObj(obj) {
            function hasProfileWord(val) {
                if (!val) return false;
                val = val.toUpperCase();
                // PROFIL, PROFİL, NPU, KOSEBENT kelimeleri için klasik includes
                if (
                    val.includes("PROFIL/") ||
                    val.includes("PROFİL/") ||
                    val.includes("NPU/") ||
                    val.includes("KOSEBENT/")
                ) return true;
                // IPE için sadece kelime olarak (önünde ve arkasında harf olmayan) kontrol
                if (/\bIPE\b/.test(val)) return true;
                return false;
            }
            // Hammadde LAMA ise asla profil değildir
            if ((obj.hammadde || "").toUpperCase() === "LAMA") return false;

            // Name attribute'ü SLDASM ile bitiyorsa asla profil değildir
            if ((obj.name || "").toUpperCase().endsWith(".SLDASM")) return false;

            // Sadece çocuk parça description'ında PROFIL/NPU/KOSEBENT varsa profil kabul et
            if (Array.isArray(obj.childPartCodes) && obj.childPartCodes.length > 0) {
                if (obj.childDescriptions && obj.childDescriptions.some(hasProfileWord)) {
                    return true;
                }
                return false;
            }
            // Eğer hiç çocuğu yoksa, kendisi için de description kontrolü yapılabilir (tekil parça ise)
            return hasProfileWord(obj.description || "");
        }

        let acikListe = ""; // "", "malzeme", "siparisDisi"

        document.getElementById('btnMalzemeIhtiyaci').onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "malzeme") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
            } else {
                document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
                if (!window.loadedXmlDoc) return;
                doldurFiltreKutular();
                // Sadece yeniMalzemeListesi'nu göster
                area.innerHTML = `<div style="margin-top:28px;">${yeniMalzemeListesi()}</div>`;
                acikListe = "malzeme";
                showExcelExport(true);
            }
        };

        document.getElementById('btnSiparisDisi').onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "siparisDisi") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            if (!window.loadedXmlDoc) return;

            // Accordion'dan sipariş dışı parçaları ve adetlerini al
            const siparisDisiList = [];
            document.querySelectorAll('.accordion-item').forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                if (!title || !content) return;

                // Parça kodunu bul
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";
                if (!partCode) return;

                // Sipariş dışı kontrolü
                let siparisDisiBirak = "";
                let olcu = "", hammadde = "", malzeme = "", miktar = "", aciklama = "", name = "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Siparis_Disi_Birak") siparisDisiBirak = (deger || "").trim();
                    if (alan === "Ham_o1" || alan === "Profil_Tanim_Boy") olcu = deger;
                    if (alan === "Hammadde") hammadde = deger;
                    if (alan === "Malzeme") malzeme = deger;
                    if (alan === "Ham_o2") miktar = deger;
                    if (alan === "Description") aciklama = deger;
                    if (alan === "Name") name = deger;
                });
                if (siparisDisiBirak !== "1") return;

                // Toplam adet
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const adet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                siparisDisiList.push({
                    partCode,
                    olcu,
                    hammadde,
                    malzeme,
                    miktar,
                    aciklama,
                    name,
                    adet
                });
            });

            if (siparisDisiList.length === 0) {
                area.innerHTML = "<b>Sipariş dışı parça bulunamadı.</b>";
            } else {
                area.innerHTML = `<b>Sipariş Dışı Parçalar (adetler accordiondan alınmıştır):</b>
<table id="siparisDisiTable">
    <thead>
        <tr>
            <th id="siparisDisiParcaKoduTh" style="cursor:pointer;" title="Tüm parça kodlarını alt alta kopyala">Parça Kodu</th>
            <th>Ölçü</th>
            <th>Hammadde</th>
            <th>Malzeme</th>
            <th>Miktar</th>
            <th>Adet</th>
            <th>Açıklama</th>
            <th>Name</th>
        </tr>
    </thead>
    <tbody>
        ${siparisDisiList.map(x => `
            <tr>
                <td>${x.partCode}</td>
                <td>${x.olcu}</td>
                <td>${x.hammadde}</td>
                <td>${x.malzeme}</td>
                <td>${x.miktar}</td>
                <td>${x.adet}</td>
                <td>${x.aciklama}</td>
                <td>${x.name}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;

                // --- Parça Kodu başlığına kopyalama özelliği ekle ---
                setTimeout(() => {
                    const th = document.getElementById('siparisDisiParcaKoduTh');
                    if (th) {
                        th.addEventListener('click', function() {
                            // Tablodaki tüm parça kodlarını topla
                            const kodlar = [];
                            document.querySelectorAll('#siparisDisiTable tbody tr td:first-child').forEach(td => {
                                const kod = td.textContent.trim();
                                if (kod && !kodlar.includes(kod)) {
                                    kodlar.push(kod);
                                }
                            });
                            
                            if (kodlar.length === 0) {
                                this.textContent = "Kopyalanacak kod yok!";
                                setTimeout(() => this.textContent = "Parça Kodu", 900);
                                return;
                            }
                            
                            // Alt alta kopyala
                            const text = kodlar.join('\n');
                            navigator.clipboard.writeText(text);
                            
                            // Görsel geri bildirim
                            const originalText = this.textContent;
                            this.style.background = "#ffe066";
                            this.textContent = "Kopyalandı!";
                            setTimeout(() => {
                                this.style.background = "";
                                this.textContent = originalText;
                            }, 900);
                        });
                    }
                }, 0);
            }
            acikListe = "siparisDisi";
            showExcelExport(true);
        };

        document.getElementById('btnStdParca').onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "stdparca") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            acikListe = "stdparca";
            if (!window.loadedXmlDoc) return;

            // --- Standart parça adetlerini accordion'dan al ---
            const stdListMap = {};
            document.querySelectorAll('.accordion-item').forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                if (!title || !content) return;

                // Parça kodunu bul
                const kodMatch = title.innerHTML.match(/<b[^>]*>([A-Z0-9]{6})<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : null;
                if (!partCode) return;

                // Malzeme STD mi?
                let malzeme = "", siparisDisiBirak = "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Malzeme") malzeme = (deger || "").toUpperCase();
                    if (alan === "Siparis_Disi_Birak") siparisDisiBirak = (deger || "").trim();
                });
                // Sipariş dışı olanları alma!
                if (siparisDisiBirak === "1" || malzeme !== "STD") return;

                // Toplam adet
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                // Diğer alanlar
                let description = "", configuration = "", name = "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Description") description = deger;
                    if (alan === "Configuration") configuration = deger;
                    if (alan === "Name") name = deger;
                });

                if (!stdListMap[partCode]) {
                    stdListMap[partCode] = {
                        partCode,
                        description,
                        configuration,
                        name,
                        toplamAdet: 0
                    };
                }
                stdListMap[partCode].toplamAdet += toplamAdet;
            });

            const stdList = Object.values(stdListMap);

            // --- Tabloyu oluştur ---
            if (stdList.length === 0) {
                area.innerHTML = "<b>Sipariş dışı olmayan 6 haneli ve malzemesi STD olan standart parça bulunamadı.</b>";
            } else {
                area.innerHTML = `<b>Sipariş Dışı Olmayan 6 Haneli Standart Parçalar:</b>
<table id="stdParcaTable">
    <thead>
        <tr>
            <th id="stdParcaKoduTh" style="cursor:pointer;">Kod</th>
            <th>Açıklama</th>
            <th>Configuration</th>
            <th>Name</th>
            <th>Adet</th>
        </tr>
    </thead>
    <tbody>
        ${stdList.map(x => `
            <tr>
                <td class="std-parca-kodu-td">${x.partCode}</td>
                <td>${x.description}</td>
                <td>${x.configuration}</td>
                <td>${x.name || ""}</td>
                <td>${x.toplamAdet}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;
            }
            showExcelExport(true);

            // --- Parça Kodu başlığına çift tıkla 12. ekle/kaldır ---
            setTimeout(() => {
                const th = document.getElementById('stdParcaKoduTh');
                let ekliMi = false;
                if (th) {
                    // Tek tıklama ile parça kodlarını kopyala
                    th.addEventListener('click', function(e) {
                        // Çift tıklama değilse (tek tıklama)
                        if (e.detail === 1) {
                            setTimeout(() => {
                                if (e.detail === 1) { // Hala tek tıklama ise
                                    // Tablodaki tüm parça kodlarını topla
                                    const kodlar = [];
                                    document.querySelectorAll('#stdParcaTable .std-parca-kodu-td').forEach(td => {
                                        const kod = td.innerText.trim().replace(/^12\./, ""); // 12. prefixini kaldır
                                        if (kod && !kodlar.includes(kod)) {
                                            kodlar.push(kod);
                                        }
                                    });
                                    
                                    if (kodlar.length === 0) {
                                        this.textContent = "Kopyalanacak kod yok!";
                                        setTimeout(() => this.textContent = "Kod", 900);
                                        return;
                                    }
                                    
                                    // Alt alta kopyala
                                    const text = kodlar.join('\n');
                                    navigator.clipboard.writeText(text);
                                    
                                    // Görsel geri bildirim
                                    const originalText = this.textContent;
                                    this.style.background = "#ffe066";
                                    this.textContent = "Kopyalandı!";
                                    setTimeout(() => {
                                        this.style.background = "";
                                        this.textContent = originalText;
                                    }, 900);
                                }
                            }, 250); // 250ms sonra kontrol et (çift tıklama bekleme süresi)
                        }
                    });

                    // Çift tıklama ile 12. ekleme/kaldırma
                    th.addEventListener('dblclick', function () {
                        document.querySelectorAll('#stdParcaTable .std-parca-kodu-td').forEach(td => {
                            let kod = td.getAttribute('data-orj-kod');
                            if (!kod) {
                                kod = td.innerText.replace(/^12\./, "");
                                td.setAttribute('data-orj-kod', kod);
                            }
                            if (!ekliMi) {
                                if (!td.innerText.startsWith("12.")) td.innerText = "12." + kod;
                            } else {
                                td.innerText = kod;
                            }
                        });
                        ekliMi = !ekliMi;
                    });

                    // Title'ı güncelle
                    th.title = "Tek tıkla: Tüm parça kodlarını kopyala | Çift tıkla: 12. ekle/kaldır";
                }
            }, 100);
        };

        // Levha Parça Fiyatlama butonu
        document.getElementById('btnLevhaParcaFiyat').onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "levhaParcaFiyat") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            acikListe = "levhaParcaFiyat";
            if (!window.loadedXmlDoc) return;

            // Kesim listesi filtresi için global Set
            window.levhaFiyatKesimKodlari = window.levhaFiyatKesimKodlari || new Set();
            const kesimKodlari = window.levhaFiyatKesimKodlari;
            const filtreAktif = kesimKodlari.size > 0;

            // Accordion'dan levha parçalarını çek (cut-list-item hariç)
            const levhaParcaList = [];
            document.querySelectorAll('.accordion-item').forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                if (!title || !content) return;

                // Parça kodunu bul
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";
                if (!partCode) return;

                // Kesim listesi filtresi aktifse, sadece kesim listesinde olan parçaları al
                if (filtreAktif) {
                    // Revizyon olmadan da kontrol et
                    const partCodeNoRev = partCode.replace(/-R\d{2}$/i, "");
                    if (!kesimKodlari.has(partCode) && !kesimKodlari.has(partCodeNoRev)) {
                        return; // Bu parça kesim listesinde yok, atla
                    }
                }

                // Toplam adet
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                let hammadde = "", agirlik = "", name = "", description = "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Hammadde") hammadde = (deger || "").toUpperCase();
                    if (alan === "Agirlik") agirlik = deger;
                    if (alan === "Name") name = (deger || "").toUpperCase();
                    if (alan === "Description") description = (deger || "").toUpperCase();
                });

                // Levha kontrolü
                if (hammadde !== "LEVHA") return;

                // Cut-list-item kontrolü (name veya description'da geçiyorsa hariç tut)
                if (
                    name.includes("SHEET") ||
                    name.includes("KESIM LISTESI") ||
                    name.includes("CUT-LIST-ITEM") ||
                    description.includes("SHEET") ||
                    description.includes("KESIM LISTESI") ||
                    description.includes("CUT-LIST-ITEM")
                ) return;

                levhaParcaList.push({
                    partCode,
                    toplamAdet,
                    agirlik: agirlik ? parseFloat(agirlik.replace(",", ".")) : 0
                });
            });

            if (levhaParcaList.length === 0) {
                area.innerHTML = `<b>Levha parçası bulunamadı.${filtreAktif ? ' (Kesim listesi filtresi aktif - ' + kesimKodlari.size + ' parça)' : ''}</b>`;
                return;
            }

            // Toplam ağırlık hesapla
            const toplamAgirlik = levhaParcaList.reduce((sum, x) => sum + (x.agirlik * x.toplamAdet), 0);

            area.innerHTML = `
<div style="margin-bottom:15px; padding:12px; background:#f0f8ff; border-radius:6px; border:1px solid #2563eb;">
    <div style="margin-bottom:10px;">
        <label style="font-weight:bold; font-size:15px; display:block; margin-bottom:8px;">Kesim Listesi Filtresi:</label>
        <textarea id="levhaKesimListesiInput" placeholder="Parça kodlarını buraya yapıştırın (her satıra bir kod veya virgülle/boşlukla ayrılmış)..." 
            style="width:100%; min-height:80px; padding:8px; border:1px solid #ccc; border-radius:4px; font-family:monospace; font-size:13px; resize:vertical;"></textarea>
        <div style="margin-top:8px;">
            <button id="btnLevhaKesimUygula" 
                style="background:#2563eb; color:#fff; border:none; border-radius:4px; padding:8px 16px; font-size:14px; font-weight:bold; cursor:pointer; margin-right:8px;">
                Filtreyi Uygula
            </button>
            ${filtreAktif ? `
            <button id="btnLevhaKesimTemizle" 
                style="background:#c0392b; color:#fff; border:none; border-radius:4px; padding:8px 16px; font-size:14px; font-weight:bold; cursor:pointer;">
                Filtreyi Temizle
            </button>` : ''}
            <span id="levhaKesimListesiDurum" style="margin-left:12px; font-size:14px; color:#666;">
                ${filtreAktif ? `✓ Filtre aktif: ${kesimKodlari.size} parça` : '✗ Filtre yok - Tüm parçalar gösteriliyor'}
            </span>
        </div>
    </div>
</div>
<div style="margin-bottom:20px;">
    <label style="font-weight:bold; font-size:16px; margin-right:10px;">Toplam Fiyat (TL):</label>
    <input type="number" id="levhaToplamFiyat" placeholder="0.00" step="0.01" min="0" 
        style="padding:8px 12px; border-radius:4px; border:1px solid #bbb; width:150px; font-size:15px;">
    <button id="btnFiyatDagit" 
        style="background:#27ae60; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer; margin-left:10px;">
        Fiyatı Dağıt
    </button>
    <button id="btnLevhaExcelAktar" 
        style="background:#16a085; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer; margin-left:10px;">
         Excel'e Aktar
    </button>
</div>
<div id="levhaParcaFiyatTable"></div>
`;

            // Başlangıç tablosu (fiyat dağıtılmadan önce)
            renderLevhaParcaTable(levhaParcaList, toplamAgirlik, null);

            // Event handler'ları ekle
            setTimeout(() => {
                // Filtre uygula butonu
                const btnUygula = document.getElementById('btnLevhaKesimUygula');
                const textArea = document.getElementById('levhaKesimListesiInput');
                
                if (btnUygula && textArea) {
                    btnUygula.onclick = function() {
                        const inputText = textArea.value.trim();
                        if (!inputText) {
                            alert("Lütfen parça kodlarını yapıştırın.");
                            return;
                        }

                        // Parça kodlarını ayıkla (satır, virgül, boşluk, tab ile ayrılmış)
                        const kodlar = inputText
                            .split(/[\r\n,;\s\t]+/)
                            .map(k => k.trim())
                            .filter(k => k.length > 0);

                        if (kodlar.length === 0) {
                            alert("Geçerli parça kodu bulunamadı.");
                            return;
                        }

                        // Global Set'e ekle
                        window.levhaFiyatKesimKodlari.clear();
                        kodlar.forEach(kod => window.levhaFiyatKesimKodlari.add(kod));

                        notifications.success("Filtre Uygulandı", `${kodlar.length} parça kodu eklendi.`, 3000);

                        // Sayfayı yenile
                        document.getElementById('btnLevhaParcaFiyat').click();
                    };
                }

                // Filtre temizle butonu
                const btnTemizle = document.getElementById('btnLevhaKesimTemizle');
                if (btnTemizle) {
                    btnTemizle.onclick = function() {
                        window.levhaFiyatKesimKodlari.clear();
                        notifications.info("Filtre Temizlendi", "Tüm levha parçaları gösteriliyor.", 3000);
                        document.getElementById('btnLevhaParcaFiyat').click();
                    };
                }

                // Fiyat dağıt butonu
                document.getElementById('btnFiyatDagit').onclick = function () {
                    const toplamFiyat = parseFloat(document.getElementById('levhaToplamFiyat').value) || 0;
                    if (toplamFiyat <= 0) {
                        alert("Lütfen geçerli bir fiyat giriniz.");
                        return;
                    }

                    // Fiyatı ağırlığa ve adede göre dağıt
                    const fiyatliList = levhaParcaList.map(x => {
                        const toplamParcaAgirlik = x.agirlik * x.toplamAdet;
                        const oran = toplamParcaAgirlik / toplamAgirlik;
                        const parcaFiyat = toplamFiyat * oran;
                        const birimFiyat = x.toplamAdet > 0 ? parcaFiyat / x.toplamAdet : 0;
                        
                        return {
                            ...x,
                            toplamParcaAgirlik,
                            oran: (oran * 100).toFixed(2),
                            parcaFiyat: parcaFiyat.toFixed(2),
                            birimFiyat: birimFiyat.toFixed(2)
                        };
                    });

                    renderLevhaParcaTable(fiyatliList, toplamAgirlik, toplamFiyat);
                };

                // Excel'e aktar butonu
                document.getElementById('btnLevhaExcelAktar').onclick = function() {
                    const toplamFiyat = parseFloat(document.getElementById('levhaToplamFiyat').value) || 0;
                    
                    // Fiyat dağıtılmış mı kontrol et
                    let exportData;
                    if (toplamFiyat > 0) {
                        // Fiyatlı veri
                        exportData = levhaParcaList.map(x => {
                            const toplamParcaAgirlik = x.agirlik * x.toplamAdet;
                            const oran = toplamParcaAgirlik / toplamAgirlik;
                            const parcaFiyat = toplamFiyat * oran;
                            const birimFiyat = x.toplamAdet > 0 ? parcaFiyat / x.toplamAdet : 0;
                            
                            return {
                                "Parça Kodu": x.partCode,
                                "Adet": x.toplamAdet,
                                "Birim Ağırlık (kg)": x.agirlik.toFixed(3),
                                "Toplam Ağırlık (kg)": toplamParcaAgirlik.toFixed(3),
                                "Oran (%)": (oran * 100).toFixed(2),
                                "Parça Fiyatı (TL)": parcaFiyat.toFixed(2),
                                "Birim Fiyat (TL)": birimFiyat.toFixed(2)
                            };
                        });
                    } else {
                        // Fiyatsız veri
                        exportData = levhaParcaList.map(x => ({
                            "Parça Kodu": x.partCode,
                            "Adet": x.toplamAdet,
                            "Birim Ağırlık (kg)": x.agirlik.toFixed(3),
                            "Toplam Ağırlık (kg)": (x.agirlik * x.toplamAdet).toFixed(3)
                        }));
                    }

                    // Excel formatına çevir
                    const headers = Object.keys(exportData[0]);
                    let csv = headers.join("\t") + "\n";
                    exportData.forEach(row => {
                        csv += headers.map(h => row[h]).join("\t") + "\n";
                    });

                    // Özet satırlar ekle
                    csv += "\n";
                    csv += `Toplam Ağırlık:\t${toplamAgirlik.toFixed(3)} kg\n`;
                    if (toplamFiyat > 0) {
                        csv += `Toplam Fiyat:\t${toplamFiyat.toFixed(2)} TL\n`;
                    }

                    // Clipboard'a kopyala
                    navigator.clipboard.writeText(csv).then(() => {
                        notifications.success("Excel'e Aktarıldı", "Tablo panoya kopyalandı. Excel'de Ctrl+V ile yapıştırabilirsiniz.", 4000);
                    }).catch(err => {
                        alert("Kopyalama başarısız: " + err.message);
                    });
                };
            }, 0);

            showExcelExport(false);
        };

        function renderLevhaParcaTable(parcaList, toplamAgirlik, toplamFiyat) {
            const container = document.getElementById('levhaParcaFiyatTable');
            if (!container) return;

            const fiyatDagitildi = toplamFiyat !== null && toplamFiyat > 0;

            let html = `
<table>
    <thead>
        <tr>
            <th>Parça Kodu</th>
            <th>Adet</th>
            <th>Ağırlık (kg)</th>
            <th>Toplam Ağırlık (kg)</th>
            ${fiyatDagitildi ? '<th>Oran (%)</th>' : ''}
            ${fiyatDagitildi ? '<th>Parça Fiyatı (TL)</th>' : ''}
            ${fiyatDagitildi ? '<th>Birim Fiyat (TL)</th>' : ''}
        </tr>
    </thead>
    <tbody>
`;

            parcaList.forEach(x => {
                const toplamParcaAgirlik = x.agirlik * x.toplamAdet;
                html += `
        <tr>
            <td>${x.partCode}</td>
            <td>${x.toplamAdet}</td>
            <td>${x.agirlik.toFixed(3)}</td>
            <td>${toplamParcaAgirlik.toFixed(3)}</td>
            ${fiyatDagitildi ? `<td>${x.oran}</td>` : ''}
            ${fiyatDagitildi ? `<td>${x.parcaFiyat}</td>` : ''}
            ${fiyatDagitildi ? `<td>${x.birimFiyat}</td>` : ''}
        </tr>
`;
            });

            html += `
    </tbody>
    <tfoot>
        <tr style="font-weight:bold;background:#f3f3f3;">
            <td colspan="3" style="text-align:right;">Toplam:</td>
            <td>${toplamAgirlik.toFixed(3)}</td>
            ${fiyatDagitildi ? '<td>100.00</td>' : ''}
            ${fiyatDagitildi ? `<td>${toplamFiyat.toFixed(2)}</td>` : ''}
            ${fiyatDagitildi ? '<td>-</td>' : ''}
        </tr>
    </tfoot>
</table>
`;

            container.innerHTML = html;
        }

        // Malzeme - Accordion Karşılaştırma fonksiyonu (UI ile)
        function malzemeAccordionKarsilastir() {
            const area = document.getElementById('extraListArea');
            if (acikListe === "karsilastir") {
                area.innerHTML = "";
                acikListe = "";
                // Buton yoksa active class kaldırma işlemi yapmaya gerek yok
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            acikListe = "karsilastir";
            
            // Veri analizini yap
            const sonuc = malzemeKarsilastirmaVeriAnalizi();
            
            if (sonuc.farkliBulunamadi) {
                area.innerHTML = ""; // Hiçbir şey gösterme
                showExcelExport(false);
                return { farkliBulunamadi: true, farkliKodlar: [] };
            } else {
                area.innerHTML = `<b>Accordionda olup malzeme listesinde olmayan parçalar (6 haneli, sipariş dışı, MNG, profil çocukları ve cut-list hariç):</b>
<table id="karsilastirTable">
    <thead>
        <tr>
            <th id="karsilastirParcaKoduTh" style="cursor:pointer;" title="Tüm parça kodlarını alt alta kopyala">Parça Kodu</th>
            <th>Accordion Toplam Adet</th>
        </tr>
    </thead>
    <tbody>
        ${sonuc.farkliKodlar.map(kod => `
            <tr>
                <td>${sonuc.accordionKodMap[kod].orijinalKod}</td>
                <td>${sonuc.accordionKodMap[kod].toplamAdet}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;

                // --- Parça Kodu başlığına kopyalama özelliği ekle ---
                setTimeout(() => {
                    const th = document.getElementById('karsilastirParcaKoduTh');
                    if (th) {
                        th.addEventListener('click', function() {
                            // Tablodaki tüm parça kodlarını topla
                            const kodlar = [];
                            document.querySelectorAll('#karsilastirTable tbody tr td:first-child').forEach(td => {
                                const kod = td.textContent.trim();
                                if (kod && !kodlar.includes(kod)) {
                                    kodlar.push(kod);
                                }
                            });
                            
                            if (kodlar.length === 0) {
                                this.textContent = "Kopyalanacak kod yok!";
                                setTimeout(() => this.textContent = "Parça Kodu", 900);
                                return;
                            }
                            
                            // Alt alta kopyala
                            const text = kodlar.join('\n');
                            navigator.clipboard.writeText(text);
                            
                            // Görsel geri bildirim
                            const originalText = this.textContent;
                            this.style.background = "#ffe066";
                            this.textContent = "Kopyalandı!";
                            setTimeout(() => {
                                this.style.background = "";
                                this.textContent = originalText;
                            }, 900);
                        });
                    }
                }, 0);
            }
            showExcelExport(true);
            return { farkliBulunamadi: false, farkliKodlar: sonuc.farkliKodlar };
        }

        // Otomatik Malzeme Karşılaştırma Fonksiyonu (bildirim için)
        function otomatikMalzemeKarsilastirma() {
            if (!window.loadedXmlDoc) return;
            
            try {
                // Sadece veri analizi yap, UI güncelleme
                const sonuc = malzemeKarsilastirmaVeriAnalizi();
                
                if (sonuc.farkliBulunamadi) {
                    // Fark yoksa kısa süreliğine bildirim göster
                    notifications.success(
                        "Malzeme Karşılaştırma", 
                        "Tüm parçalar malzeme listesinde mevcut.", 
                        3000
                    );
                } else {
                    // Fark varsa bildirim ekranda kalsın
                    notifications.warning(
                        "Malzeme Karşılaştırma Uyarısı", 
                        `${sonuc.farkliKodlar.length} parça accordionda var ama malzeme listesinde yok. Detaylar için ".karşılaştır" yazın.`,
                        0 // Süresiz, manuel kapanacak
                    );
                }
            } catch (error) {
                notifications.error(
                    "Karşılaştırma Hatası", 
                    "Malzeme karşılaştırma sırasında hata oluştu: " + error.message,
                    0
                );
            }
        }

        // Sadece veri analizi yapan fonksiyon (UI güncellemesi yok)
        function malzemeKarsilastirmaVeriAnalizi() {
            if (!window.loadedXmlDoc) return { farkliBulunamadi: true, farkliKodlar: [] };

            // Önce malzeme listesi tablosunu oluştur (geçici bir div'e)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = yeniMalzemeListesi();
            
            // Malzeme listesi tablosundan parça kodlarını al
            const malzemeKodlari = new Set();
            const malzemeTable = tempDiv.querySelector('table tbody');
            if (malzemeTable) {
                const rows = malzemeTable.querySelectorAll('tr');
                rows.forEach(row => {
                    // Toplam satırı değilse (font-weight:bold olmayan)
                    if (!row.style.fontWeight || row.style.fontWeight !== 'bold') {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > 1) {
                            // Eğer ilk hücre checkbox ise 2. sütun, değilse 1. sütun parça kodu
                            let partCodeIndex = 0;
                            const firstCellContent = cells[0].innerHTML.trim();
                            // İlk hücrede checkbox var mı kontrol et
                            if (firstCellContent.includes('checkbox')) {
                                partCodeIndex = 1; // Checkbox varsa 2. sütun
                            } else {
                                partCodeIndex = 0; // Checkbox yoksa 1. sütun
                            }
                            
                            let partCode = cells[partCodeIndex].innerText.trim();
                            if (partCode) {
                                // Revizyonu kaldır (tabloda zaten kaldırılmış ama yine de kontrol edelim)
                                partCode = partCode.replace(/-R\d{2}$/i, "");
                                malzemeKodlari.add(partCode);
                            }
                        }
                    }
                });
            }

            // Accordiondaki parça kodlarını al (adet bilgisi ile, revizyonsuz)
            const accordionKodMap = {}; // { partCode (revizyonsuz): { toplamAdet, orijinalKod } }
            const accordionItems = document.querySelectorAll('.accordion-item');
            
            accordionItems.forEach(item => {
                // Sadece ana parçaları al (çocuk parçaları hariç tut)
                // Eğer parent'ı accordion-content ise, bu bir çocuk parçadır
                if (item.parentElement && item.parentElement.classList.contains('accordion-content')) {
                    return;
                }
                
                const title = item.querySelector('.accordion-title');
                if (!title) return;
                
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const orijinalPartCode = kodMatch ? kodMatch[1].trim() : "";
                if (!orijinalPartCode) return;

                // Toplam adet
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                // 6 haneli kodları hariç tut
                if (/^[A-Z0-9]{6}$/.test(orijinalPartCode)) return;

                let siparisDisiBirak = "";
                let imalatTipi = "";
                let description = "";
                let name = "";
                
                const content = item.querySelector('.accordion-content');
                if (content) {
                    const rows = content.querySelectorAll('tbody tr');
                    rows.forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Siparis_Disi_Birak") siparisDisiBirak = (deger || "").trim();
                        if (alan === "İmalat_Tipi") imalatTipi = (deger || "").toUpperCase();
                        if (alan === "Description") description = (deger || "").toUpperCase();
                        if (alan === "Name") name = (deger || "").toUpperCase();
                    });
                }

                // Sipariş dışı olanları hariç tut
                if (siparisDisiBirak === "1") return;
                
                // İmalat tipi MNG veya MAK olanları ve parça kodu MNG/MAK ile başlayanları hariç tut
                if (imalatTipi === "MNG" || imalatTipi === "MAK" || orijinalPartCode.toUpperCase().startsWith("MNG") || orijinalPartCode.toUpperCase().startsWith("MAK")) return;

                // SHEET, KESIM LISTESI, CUT-LIST-ITEM geçenleri hariç tut
                if (
                    description.includes("SHEET") ||
                    description.includes("KESIM LISTESI") ||
                    description.includes("CUT-LIST-ITEM") ||
                    name.includes("SHEET") ||
                    name.includes("KESIM LISTESI") ||
                    name.includes("CUT-LIST-ITEM")
                ) return;

                // Profil parçalarda PROFIL/, PROFİL/, NPU/, KOSEBENT/, IPE geçenleri hariç tut
                if (
                    description.includes("PROFIL/") ||
                    description.includes("PROFİL/") ||
                    description.includes("NPU/") ||
                    description.includes("KOSEBENT/") ||
                    description.includes("IPE")
                ) return;

                // Revizyonu kaldır (karşılaştırma için)
                const partCodeRevizyonsuz = orijinalPartCode.replace(/-R\d{2}$/i, "");

                // Aynı parça kodlarını (revizyonsuz) grupla ve adetleri topla
                if (!accordionKodMap[partCodeRevizyonsuz]) {
                    accordionKodMap[partCodeRevizyonsuz] = {
                        toplamAdet: 0,
                        orijinalKod: orijinalPartCode // İlk bulunanı sakla
                    };
                }
                accordionKodMap[partCodeRevizyonsuz].toplamAdet += toplamAdet;
                // Eğer mevcut kod revizyonsuzsa, onu sakla
                if (!/-R\d{2}$/i.test(orijinalPartCode)) {
                    accordionKodMap[partCodeRevizyonsuz].orijinalKod = orijinalPartCode;
                }
            });

            // Accordionda olup malzeme listesinde olmayanlar
            const farkliKodlar = Object.keys(accordionKodMap).filter(kod => !malzemeKodlari.has(kod));

            return {
                farkliBulunamadi: farkliKodlar.length === 0,
                farkliKodlar: farkliKodlar,
                accordionKodMap: accordionKodMap
            };
        }

        function filtreAccordionListesi() {
            const arama = (document.getElementById('malzemeArama').value || "").toLowerCase();
            
            // . ile başlıyorsa arama yapma (kasmaması için)
            if (arama.startsWith(".")) {
                return;
            }
            
            const items = document.querySelectorAll('.accordion-item');
            items.forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                const text = (title?.innerText + " " + content?.innerText).toLowerCase();
                if (!arama || text.includes(arama)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });

            // --- Her grup için aranan parçanın üst montajlarını aç ---
            if (arama) {
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const title = item.querySelector('.accordion-title');
                    const content = item.querySelector('.accordion-content');
                    const text = (title?.innerText + " " + content?.innerText).toLowerCase();
                    if (text.includes(arama)) {
                        // Bu item ve tüm parent'larını aç
                        let current = item;
                        while (current) {
                            current.style.display = "";
                            current.classList.add('ac-open');
                            const arrow = current.querySelector('.accordion-arrow');
                            if (arrow) arrow.style.transform = "rotate(90deg)";
                            // Parent'ı bul
                            const yol = current.getAttribute('data-yol');
                            if (!yol || !yol.includes('.')) break;
                            const parentYol = yol.split('.').slice(0, -1).join('.');
                            current = document.querySelector(`.accordion-item[data-yol="${parentYol}"]`);
                        }
                    }
                });
            }
        }

        function tabloyuGuncelle() {
            const anaFiltre = document.getElementById('anaFiltre').value;
            const olcuFiltre = document.getElementById('olcuFiltre').value;
            const hammaddeFiltre = document.getElementById('hammaddeFiltre').value;
            const malzemeFiltre = document.getElementById('malzemeFiltre').value;
            document.getElementById('extraListArea').innerHTML = generateImalatMalzemeTablosu(
                window.loadedXmlDoc,
                anaFiltre,
                olcuFiltre,
                hammaddeFiltre,
                malzemeFiltre
            );
            if (acikListe === "malzeme") showExcelExport(true);
            else showExcelExport(false);
        }

        // Filtre kutularını doldur
        function doldurFiltreKutular() {
            const anaFiltre = document.getElementById('anaFiltre').value;
            const olcuFiltre = document.getElementById('olcuFiltre').value;
            const hammaddeFiltre = document.getElementById('hammaddeFiltre').value;
            const malzemeFiltre = document.getElementById('malzemeFiltre').value;
            const operasyonFiltre = document.getElementById('operasyonFiltre') ? document.getElementById('operasyonFiltre').value : "";

            // Tüm malzeme listesini çek
            const tumList = getFilteredMalzemeList(window.loadedXmlDoc, anaFiltre, "", "", "", "");

            // Malzeme filtresi için: tüm olası malzemeler
            const tumMalzemeSet = new Set();
            tumList.forEach(x => { if (x.malzeme) tumMalzemeSet.add(x.malzeme); });

            // Ölçü filtresi için: malzeme ve hammadde filtresine göre daralt
            const olcuList = getFilteredMalzemeList(window.loadedXmlDoc, anaFiltre, "", hammaddeFiltre, malzemeFiltre, "");
            const olcuSet = new Set();
            olcuList.forEach(x => {
                let olcu = x.olcu || "";
                if (isProfilePartObj(x)) {
                    const idx = olcu.indexOf("L=");
                    if (idx > 0) olcu = olcu.substring(0, idx).trim();
                }
                if (olcu) olcuSet.add(olcu);
            });

            // Hammadde filtresi için: malzeme ve ölçü filtresine göre daralt
            const hammaddeList = getFilteredMalzemeList(window.loadedXmlDoc, anaFiltre, olcuFiltre, "", malzemeFiltre, "");
            const hammaddeSet = new Set();
            hammaddeList.forEach(x => { if (x.hammadde) hammaddeSet.add(x.hammadde); });

            // Malzeme filtresi için: ölçü ve hammadde filtresine göre daralt
            const malzemeList = getFilteredMalzemeList(window.loadedXmlDoc, anaFiltre, olcuFiltre, hammaddeFiltre, "", "");
            const malzemeSet = new Set();
            malzemeList.forEach(x => { if (x.malzeme) malzemeSet.add(x.malzeme); });

            // Operasyon filtresi için: diğer filtrelere göre daralt
            const operasyonList = getFilteredMalzemeList(window.loadedXmlDoc, anaFiltre, olcuFiltre, hammaddeFiltre, malzemeFiltre, "");
            const operasyonSet = new Set();
            operasyonList.forEach(x => { 
                if (x.operasyonlar && Array.isArray(x.operasyonlar)) {
                    x.operasyonlar.forEach(op => {
                        if (op && op.trim()) operasyonSet.add(op.trim());
                    });
                }
            });

            // Doldur
            const olcuFiltreElem = document.getElementById('olcuFiltre');
            const hammaddeFiltreElem = document.getElementById('hammaddeFiltre');
            const malzemeFiltreElem = document.getElementById('malzemeFiltre');
            const operasyonFiltreElem = document.getElementById('operasyonFiltre');

            const prevOlcu = olcuFiltreElem.value;
            const prevHammadde = hammaddeFiltreElem.value;
            const prevMalzeme = malzemeFiltreElem.value;
            const prevOperasyon = operasyonFiltreElem ? operasyonFiltreElem.value : "";

            olcuFiltreElem.innerHTML = `<option value="">Ölçü: Tümü</option>` + Array.from(olcuSet).sort().map(o => `<option value="${o}">${o}</option>`).join("");
            hammaddeFiltreElem.innerHTML = `<option value="">Hammadde: Tümü</option>` + Array.from(hammaddeSet).sort().map(h => `<option value="${h}">${h}</option>`).join("");
            malzemeFiltreElem.innerHTML = `<option value="">Malzeme: Tümü</option>` + Array.from(malzemeSet).sort().map(m => `<option value="${m}">${m}</option>`).join("");
            
            if (operasyonFiltreElem) {
                operasyonFiltreElem.innerHTML = `<option value="">Operasyon: Tümü</option>` + Array.from(operasyonSet).sort().map(o => `<option value="${o}">${o}</option>`).join("");
            }

            // Seçili değerler hala seçeneklerde varsa koru, yoksa "Tümü" yap
            if ([...olcuFiltreElem.options].some(opt => opt.value === prevOlcu)) olcuFiltreElem.value = prevOlcu;
            else olcuFiltreElem.value = "";

            if ([...hammaddeFiltreElem.options].some(opt => opt.value === prevHammadde)) hammaddeFiltreElem.value = prevHammadde;
            else hammaddeFiltreElem.value = "";

            if ([...malzemeFiltreElem.options].some(opt => opt.value === prevMalzeme)) malzemeFiltreElem.value = prevMalzeme;
            else malzemeFiltreElem.value = "";

            if (operasyonFiltreElem && [...operasyonFiltreElem.options].some(opt => opt.value === prevOperasyon)) {
                operasyonFiltreElem.value = prevOperasyon;
            } else if (operasyonFiltreElem) {
                operasyonFiltreElem.value = "";
            }
        }

        function getFilteredMalzemeList(xmlDoc, anaFiltre, olcuFiltre, hammaddeFiltre, malzemeFiltre, operasyonFiltre) {
            const malzemeListesi = [];
            generateImalatMalzemeTablosu(xmlDoc, anaFiltre, olcuFiltre, hammaddeFiltre, malzemeFiltre, malzemeListesi);
            // Aynı parça kodu, ölçü, hammadde, malzeme olanları grupla
            const grouped = {};
            malzemeListesi.forEach(item => {
                const key = [item.partCode, item.olcu, item.hammadde, item.malzeme].join("|");
                if (!grouped[key]) {
                    grouped[key] = { ...item };
                } else {
                    grouped[key].miktar += item.miktar;
                    grouped[key].toplamAdet += item.toplamAdet;
                }
            });
            let finalList = Object.values(grouped);

            finalList = finalList.filter(x => x.miktar !== 0);

            // Ana filtre
            if (anaFiltre === "levha") {
                finalList = finalList.filter(x => (x.hammadde || "").toUpperCase() === "LEVHA");
            } else if (anaFiltre === "profil") {
                finalList = finalList.filter(x => isProfilePartObj(x));
            } else if (anaFiltre === "std") {
                finalList = finalList.filter(x => {
                    const isStd = (x.hammadde || "").toUpperCase() === "STD" || (x.hammadde_olcusu || "").toUpperCase() === "STD";
                    const hasProfileChild = Array.isArray(x.childDescriptions) && x.childDescriptions.some(desc => {
                        const d = (desc || "").toUpperCase();
                        return d.includes("PROFIL/") || d.includes("PROFİL/") || d.includes("NPU/") || d.includes("KOSEBENT/") || d.includes("IPE");
                    });
                    return isStd && !hasProfileChild;
                });
            } else if (anaFiltre === "diger") {
                finalList = finalList.filter(x =>
                    (x.hammadde || "").toUpperCase() !== "LEVHA" &&
                    (x.hammadde || "").toUpperCase() !== "STD" &&
                    !isProfilePartObj(x)
                );
            }

            // Sütun filtreleri
            if (olcuFiltre) {
                finalList = finalList.filter(x => {
                    let olcu = x.olcu || "";
                    if (isProfilePartObj(x)) {
                        const idx = olcu.indexOf("L=");
                        if (idx > 0) olcu = olcu.substring(0, idx).trim();
                    }
                    return olcu === olcuFiltre;
                });
            }
            if (hammaddeFiltre) {
                finalList = finalList.filter(x => (x.hammadde || "") === hammaddeFiltre);
            }
            if (malzemeFiltre) {
                finalList = finalList.filter(x => (x.malzeme || "") === malzemeFiltre);
            }
            if (operasyonFiltre) {
                finalList = finalList.filter(x => {
                    // Ana filtre levha ise, ilk operasyonu kontrol et
                    if (anaFiltre === "levha") {
                        // İlk operasyonu bul
                        let ilkOp = "";
                        if (window.loadedXmlDoc) {
                            const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                                const conf = d.querySelector("configuration");
                                if (!conf) return false;
                                const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                                return code === x.partCode;
                            });
                            if (doc) {
                                const conf = doc.querySelector("configuration");
                                if (conf) {
                                    for (let i = 1; i <= 8; i++) {
                                        const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                                        if (op) {
                                            ilkOp = op;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        return ilkOp === operasyonFiltre;
                    } else {
                        // Diğer filtreler için eski mantık
                        return x.operasyonlar && Array.isArray(x.operasyonlar) && x.operasyonlar.includes(operasyonFiltre);
                    }
                });
            }

            return finalList;
        }

        // Filtre kutularına event ekle
        ["anaFiltre", "olcuFiltre", "hammaddeFiltre", "malzemeFiltre", "operasyonFiltre"].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.onchange = function () {
                    doldurFiltreKutular();
                    tabloyuGuncelle();
                };
            }
        });

        // Excel'e Aktar butonunu göster/gizle fonksiyonu
        function showExcelExport(show) {
            document.getElementById('excelExportArea').style.display = show ? "" : "none";
        }

        // Excel'e Aktar fonksiyonu
        function exportTableToExcel(tableIdOrElem, filename = "liste.csv") {
            let table;
            if (typeof tableIdOrElem === "string") {
                table = document.getElementById(tableIdOrElem);
            } else {
                table = tableIdOrElem;
            }
            if (!table) return;

            // CSV için ayırıcıyı noktalı virgül yapıyoruz
            const delimiter = ";";
            let csv = [];
            for (let row of table.rows) {
                if (row.style.display === "none") continue;
                let rowData = [];
                for (let i = 0; i < row.cells.length; i++) {
                    let text = row.cells[i].innerText.replace(/\r?\n|\r/g, " ").trim();
                    // Parça Kodu sütunu ise başına ="" ekle
                    if (
                        i === 0 && // ilk sütun
                        table.rows[0].cells[i].innerText.trim().toLowerCase().includes("parça kodu")
                    ) {
                        text = '="' + text + '"';
                    }
                    rowData.push(text);
                }
                csv.push(rowData.join(delimiter));
            }
            let csvContent = "\uFEFF" + csv.join("\r\n"); // UTF-8 BOM

            // CSV'yi indir
            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Excel butonuna tıklama
        document.getElementById('btnExcelExport').onclick = function () {
            const area = document.getElementById('extraListArea');
            const table = area.querySelector("table");
            if (table) {
                let listeAdi = "liste";
                if (acikListe === "malzeme") listeAdi = "malzeme_listesi";
                else if (acikListe === "siparisDisi") listeAdi = "siparis_disi_listesi";
                else if (acikListe === "stdparca") listeAdi = "standart_parca_listesi";
                exportTableToExcel(table, `${currentXmlFileName}_${listeAdi}.csv`);
            }
        };


        // Sipariş Dışı Parçalar
        document.getElementById('btnSiparisDisi').onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "siparisDisi") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            if (!window.loadedXmlDoc) return;
            const siparisDisiList = [];
            const documents = window.loadedXmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const siparisDisiBirak = getAttributeValue(conf, "Siparis_Disi_Birak").trim();
                if (siparisDisiBirak === "1") {
                    const adet = (parseInt(conf.getAttribute("quantity")) || 1) * setAdedi;
                    siparisDisiList.push({
                        partCode: getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz",
                        olcu: getAttributeValue(conf, "Ham_o1") || getAttributeValue(conf, "Profil_Tanim_Boy") || "",
                        hammadde: getAttributeValue(conf, "Hammadde") || "",
                        malzeme: getAttributeValue(conf, "Malzeme") || "",
                        miktar: getAttributeValue(conf, "Ham_o2") || "",
                        aciklama: getAttributeValue(conf, "Description") || "",
                        name: getAttributeValue(conf, "Name") || "",
                        adet
                    });
                }
            });
            if (siparisDisiList.length === 0) {
                area.innerHTML = "<b>Sipariş dışı parça bulunamadı.</b>";
            } else {
                area.innerHTML = `<b>Sipariş Dışı Parçalar:</b>
<table id="siparisDisiTable">
    <thead>
        <tr>
            <th>Parça Kodu</th>
            <th>Ölçü</th>
            <th>Hammadde</th>
            <th>Malzeme</th>
            <th>Miktar</th>
            <th>Adet</th>
            <th>Açıklama</th>
            <th>Name</th>
        </tr>
    </thead>
    <tbody>
        ${siparisDisiList.map(x => `
            <tr>
                <td>${x.partCode}</td>
                <td>${x.olcu}</td>
                <td>${x.hammadde}</td>
                <td>${x.malzeme}</td>
                <td>${x.miktar}</td>
                <td>${x.adet}</td>
                <td>${x.aciklama}</td>
                <td>${x.name}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;
            }
            acikListe = "siparisDisi";
            showExcelExport(true);
        };


        let setAdedi = 1;

        // Set alanı değişince güncelle
        document.getElementById('setAdedi').addEventListener('input', function () {
            let val = parseInt(this.value, 10);
            if (!val || val < 1) val = 1;
            setAdedi = val;
        });

        // Uygula butonuna basınca tabloyu güncelle
        document.getElementById('setUygulaBtn').onclick = function () {
            let val = parseInt(document.getElementById('setAdedi').value, 10);
            if (!val || val < 1) val = 1;
            setAdedi = val;
            tabloyuGuncelle();

            // Malzeme listesi ve buton aktifliklerini kapat
            document.getElementById('extraListArea').innerHTML = "";
            acikListe = "";
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            showExcelExport(false);

            // Accordion'u yeniden oluşturmak için dosya yüklemedeki işlemleri tekrar çağır
            if (window.loadedXmlDoc) {
                // Hata listesi alanlarını temizle
                document.getElementById('accordion').innerHTML = "";
                document.getElementById('parentCommaDesc').innerHTML = "";
                document.getElementById('specialOps').innerHTML = "";
                document.getElementById('mismatch').innerHTML = "";
                document.getElementById('descMissing').innerHTML = "";
                document.getElementById('multiRev').innerHTML = "";
                document.getElementById('levhaLazerPlazmaKontrol').innerHTML = "";
                // Hata listesi divlerini sil (önceki eklenenleri kaldır)
                document.querySelectorAll('.mismatch-list').forEach(div => div.remove());
                // Sonra renderAll fonksiyonunu çağır
                renderAll(window.loadedXmlDoc);
            }
        };

        // ...accordion oluşturulduktan sonra, renderAll fonksiyonunun sonunda veya <script> içinde bir yere ekleyin:
        document.getElementById('btnTumunuAc').onclick = function () {
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.style.display = "";
                item.classList.add('ac-open');
                const arrow = item.querySelector('.accordion-arrow');
                if (arrow) arrow.style.transform = "rotate(90deg)";
            });
        };

        document.getElementById('btnTumunuKapat').onclick = function () {
            document.querySelectorAll('.accordion-item').forEach(item => {
                if (item.getAttribute('data-yol') && item.getAttribute('data-yol').indexOf('.') !== -1) {
                    item.style.display = "none";
                }
                item.classList.remove('ac-open');
                const arrow = item.querySelector('.accordion-arrow');
                if (arrow) arrow.style.transform = "rotate(0deg)";
            });
        };

        function showXmlComparePopup() {
            // Popup HTML
            let popup = document.createElement('div');
            popup.id = "xmlComparePopup";
            popup.style.position = "fixed";
            popup.style.top = "0";
            popup.style.left = "0";
            popup.style.width = "100vw";
            popup.style.height = "100vh";
            popup.style.background = "rgba(0,0,0,0.25)";
            popup.style.zIndex = "99999";
            popup.innerHTML = `
   <div style="background:#fff; max-width:1100px; min-width:800px; margin:60px auto; border-radius:8px; box-shadow:0 2px 16px #0003; padding:32px 28px 24px 28px; position:relative;">
    <button id="btnCloseXmlCompare" style="position:absolute; top:18px; right:18px; background:#c0392b; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:15px; cursor:pointer;">Kapat</button>
    <h3 style="margin-top:0;">XML Karşılaştır</h3>
    <div style="margin-bottom:16px;">
        <label style="font-weight:bold;">Eski XML Dosyasını Seçin:</label><br>
        <input type="file" id="xmlfileEskiPopup" accept=".xml">
    </div>
    <div id="xmlCompareResult" style="max-height:70vh; overflow:auto; font-size:15px;"></div>
</div>
`;
            document.body.appendChild(popup);

            document.getElementById('btnCloseXmlCompare').onclick = function () {
                popup.remove();
            };

            // Dosya input ile yükleme
            document.getElementById('xmlfileEskiPopup').onchange = function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const parser = new DOMParser();
                    const eskiXmlDoc = parser.parseFromString(evt.target.result, "text/xml");
                    const resultHtml = compareXmlDetailed(window.loadedXmlDoc, eskiXmlDoc, window.setAdedi || 1);
                    document.getElementById('xmlCompareResult').innerHTML = resultHtml;
                };
                reader.readAsText(file);
            };

            // Sürükle-bırak ile yükleme
            const dropArea = document.getElementById('xmlCompareResult');
            dropArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropArea.style.background = "#e3e3ff";
            });
            dropArea.addEventListener('dragleave', function (e) {
                dropArea.style.background = "";
            });
            dropArea.addEventListener('drop', function (e) {
                e.preventDefault();
                dropArea.style.background = "";
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        const parser = new DOMParser();
                        const eskiXmlDoc = parser.parseFromString(evt.target.result, "text/xml");
                        const resultHtml = compareXmlDetailed(window.loadedXmlDoc, eskiXmlDoc, window.setAdedi || 1);
                        document.getElementById('xmlCompareResult').innerHTML = resultHtml;
                    };
                    reader.readAsText(file);
                }
            });
        }

        function compareXmlDetailed(yeniXml, eskiXml) {
            // Her parça için kökten itibaren toplam adetleri hesaplar
            function getToplamAdetMap(xmlDoc) {
                const map = {};
                function gez(docNode, parentMultiplier, parentCode) {
                    const conf = docNode.querySelector('configuration');
                    if (!conf) return;
                    const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                    const adet = parseInt(conf.getAttribute("quantity")) || 1;
                    const toplamAdet = adet * parentMultiplier;
                    map[partCode] = (map[partCode] || 0) + toplamAdet;
                    map[partCode + "|" + (parentCode || "")] = (map[partCode + "|" + (parentCode || "")] || 0) + toplamAdet;
                    // Alt montajları gez
                    const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                    childDocs.forEach(childDoc => gez(childDoc, toplamAdet, partCode));
                }
                // Kökten başlat
                const documents = xmlDoc.querySelectorAll("document");
                const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                rootDocs.forEach(doc => gez(doc, setAdedi, null)); // setAdedi burada kullanılıyor
                return map;
            }

            // Diğer yardımcı fonksiyonlar aynı kalabilir
            function getPartMap(xmlDoc) {
                const map = {};
                function gez(docNode, parentCode) {
                    const conf = docNode.querySelector('configuration');
                    if (!conf) return;
                    const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                    const adet = parseInt(conf.getAttribute("quantity")) || 1;
                    const malzeme = getAttributeValue(conf, "Malzeme") || "";
                    const olcu = getAttributeValue(conf, "Ham_o1") || getAttributeValue(conf, "Profil_Tanim_Boy") || "";
                    const hammadde = getAttributeValue(conf, "Hammadde") || "";
                    const desc = getAttributeValue(conf, "Description") || "";
                    if (!map[partCode]) map[partCode] = [];
                    map[partCode].push({
                        adet,
                        malzeme,
                        olcu,
                        hammadde,
                        desc,
                        parent: parentCode
                    });
                    // Alt montajları gez
                    const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                    childDocs.forEach(childDoc => gez(childDoc, partCode));
                }
                // Kökten başlat
                const documents = xmlDoc.querySelectorAll("document");
                const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                rootDocs.forEach(doc => gez(doc, null));
                return map;
            }

            function getMontajMap(xmlDoc) {
                const map = {};
                function gez(docNode) {
                    const conf = docNode.querySelector('configuration');
                    if (!conf) return;
                    const parentCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                    if (!map[parentCode]) map[parentCode] = [];
                    const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                    childDocs.forEach(childDoc => {
                        const childConf = childDoc.querySelector('configuration');
                        if (!childConf) return;
                        const childCode = getAttributeValue(childConf, "Parca_Kodu") || getAttributeValue(childDoc, "Parca_Kodu") || getAttributeValue(childDoc, "Name") || "Belirsiz";
                        map[parentCode].push(childCode);
                        gez(childDoc);
                    });
                }
                // Kökten başlat
                const documents = xmlDoc.querySelectorAll("document");
                const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                rootDocs.forEach(doc => gez(doc));
                return map;
            }

            // --- Burada toplam adet haritalarını çıkarıyoruz ---
            const yeniToplamAdetMap = getToplamAdetMap(yeniXml);
            const eskiToplamAdetMap = getToplamAdetMap(eskiXml);

            const yeniMap = getPartMap(yeniXml);
            const eskiMap = getPartMap(eskiXml);

            // 1. Parça bazında farklar (eklenen/çıkarılan/güncellenen)
            let eklenenler = [];
            let cikarilanlar = [];
            let guncellenenler = [];
            const ziyaretEdildi = new Set();

            function ekleVeAltlariniDoldur(code, parent, eskiAdet, yeniAdet, yeniMap, eskiMap) {
                const key = code + "|" + (parent || "");
                if (ziyaretEdildi.has(key)) return;
                ziyaretEdildi.add(key);

                // Eğer eski veya yeni adet 0 ise ekleme (sadece iki tarafta da var olanlar gösterilsin)
                if (eskiAdet === 0 || yeniAdet === 0) return;

                // Parça bilgilerini yeni veya eski map'ten al
                let yeniBilgi = (yeniMap[code] || []).find(x => x.parent === parent) || {};
                let eskiBilgi = (eskiMap[code] || []).find(x => x.parent === parent) || {};

                guncellenenler.push({
                    code,
                    eskiAdet,
                    yeniAdet,
                    malzeme: yeniBilgi.malzeme || eskiBilgi.malzeme || "",
                    olcu: yeniBilgi.olcu || eskiBilgi.olcu || "",
                    hammadde: yeniBilgi.hammadde || eskiBilgi.hammadde || "",
                    desc: yeniBilgi.desc || eskiBilgi.desc || "",
                    parent: parent || ""
                });

                // Alt montajları yeni XML'den bul
                const yeniMontajlar = getMontajMap(yeniXml);
                const altlar = yeniMontajlar[code] || [];
                altlar.forEach(childCode => {
                    const eskiAltAdet = eskiToplamAdetMap[childCode + "|" + code] || 0;
                    const yeniAltAdet = yeniToplamAdetMap[childCode + "|" + code] || 0;
                    if (eskiAltAdet !== yeniAltAdet) {
                        ekleVeAltlariniDoldur(childCode, code, eskiAltAdet, yeniAltAdet, yeniMap, eskiMap);
                    }
                });
            }

            // Tüm parent|child yolları için karşılaştırma
            Object.keys({ ...yeniToplamAdetMap, ...eskiToplamAdetMap }).forEach(key => {
                const [code, parent] = key.split("|");
                const eskiAdet = eskiToplamAdetMap[key] || 0;
                const yeniAdet = yeniToplamAdetMap[key] || 0;
                if (eskiAdet !== yeniAdet) {
                    ekleVeAltlariniDoldur(code, parent, eskiAdet, yeniAdet, yeniMap, eskiMap);
                }
            });

            // compareXmlDetailed fonksiyonunda, eklenenler ve çıkarılanlar için:
            Object.keys(yeniMap).forEach(code => {
                const eskiList = eskiMap[code] || [];
                yeniMap[code].forEach(yeniX => {
                    // Hem parça kodu hem de parent (montaj) birlikte kontrol edilmeli
                    const match = eskiList.find(eskiX =>
                        eskiX.parent === yeniX.parent &&
                        eskiX.malzeme === yeniX.malzeme &&
                        eskiX.olcu === yeniX.olcu &&
                        eskiX.hammadde === yeniX.hammadde &&
                        eskiX.desc === yeniX.desc
                    );
                    if (!match) {
                        // Eski tarafta bu montajda bu parça yoksa, eklenenler'e ekle
                        const parentMatch = eskiList.find(eskiX => eskiX.parent === yeniX.parent);
                        if (!parentMatch) {
                            eklenenler.push({ code, ...yeniX });
                        } else {
                            // Sadece bilgileri değiştiyse güncellenenler'e ekle
                            guncellenenler.push({ code, ...yeniX });
                        }
                    }
                });
            });

            Object.keys(eskiMap).forEach(code => {
                const yeniList = yeniMap[code] || [];
                eskiMap[code].forEach(eskiX => {
                    const match = yeniList.find(yeniX =>
                        eskiX.parent === yeniX.parent &&
                        eskiX.malzeme === yeniX.malzeme &&
                        eskiX.olcu === yeniX.olcu &&
                        eskiX.hammadde === yeniX.hammadde &&
                        eskiX.desc === yeniX.desc
                    );
                    if (!match) {
                        const parentMatch = yeniList.find(yeniX => yeniX.parent === eskiX.parent);
                        if (!parentMatch) {
                            cikarilanlar.push({ code, ...eskiX });
                        } else {
                            // Sadece bilgileri değiştiyse güncellenenler'e ekle
                            guncellenenler.push({ code, ...parentMatch });
                        }
                    }
                });
            });

            // 2. Montaj şeması farkları
            const yeniMontaj = getMontajMap(yeniXml);
            const eskiMontaj = getMontajMap(eskiXml);

            let montajFarkList = [];
            Object.keys(yeniMontaj).forEach(parent => {
                const yeniCocuklar = yeniMontaj[parent] || [];
                const eskiCocuklar = eskiMontaj[parent] || [];
                yeniCocuklar.forEach(child => {
                    if (!eskiCocuklar.includes(child)) {
                        montajFarkList.push({ parent, child, tip: "Eklendi" });
                    }
                });
                eskiCocuklar.forEach(child => {
                    if (!yeniCocuklar.includes(child)) {
                        montajFarkList.push({ parent, child, tip: "Çıkarıldı" });
                    }
                });
            });
            Object.keys(eskiMontaj).forEach(parent => {
                if (!(parent in yeniMontaj)) {
                    (eskiMontaj[parent] || []).forEach(child => {
                        montajFarkList.push({ parent, child, tip: "Çıkarıldı" });
                    });
                }
            });

            const unwantedKeywords = ["SHEET", "KESIM LISTESI", "CUT-LIST-ITEM"];
            function isUnwanted(x) {
                const desc = (x.desc || "").toUpperCase();
                const name = (x.name || "").toUpperCase();
                return unwantedKeywords.some(k => desc.includes(k) || name.includes(k));
            }

            // Eklenenler ve çıkarılanlar için filtre uygula
            eklenenler = eklenenler.filter(x => !isUnwanted(x));
            cikarilanlar = cikarilanlar.filter(x => !isUnwanted(x));


            // --- RAPOR HTML ---
            let html = `
    <div style="overflow-x:auto">
    <b>1. Eklenen Parçalar</b>
    <table style="margin-bottom:18px;">
        <thead>
            <tr>
                <th>Parça Kodu</th>
                <th>Toplam Adet</th>
                <th>Malzeme</th>
                <th>Ölçü</th>
                <th>Hammadde</th>
                <th>Açıklama</th>
                <th>Montaj</th>
            </tr>
        </thead>
        <tbody>
    ${eklenenler.length === 0
                    ? `<tr><td colspan="7" style="text-align:center;">Yok</td></tr>`
                    : eklenenler.map(x => `
            <tr>
                <td>${x.code}</td>
                <td>${yeniToplamAdetMap[x.code + "|" + (x.parent || "")] || yeniToplamAdetMap[x.code] || x.adet}</td>
                <td>${x.malzeme}</td>
                <td>${x.olcu}</td>
                <td>${x.hammadde}</td>
                <td>${x.desc}</td>
                <td>${x.parent || ""}</td>
            </tr>
        `).join("")
                }
</tbody>
    </table>

    <b>2. Çıkarılan Parçalar</b>
    <table style="margin-bottom:18px;">
        <thead>
            <tr>
                <th>Parça Kodu</th>
                <th>Toplam Adet</th>
                <th>Malzeme</th>
                <th>Ölçü</th>
                <th>Hammadde</th>
                <th>Açıklama</th>
                <th>Montaj</th>
            </tr>
        </thead>
        <tbody>
    ${cikarilanlar.length === 0
                    ? `<tr><td colspan="7" style="text-align:center;">Yok</td></tr>`
                    : cikarilanlar.map(x => `
            <tr>
                <td>${x.code}</td>
                <td>${eskiToplamAdetMap[x.code + "|" + (x.parent || "")] || eskiToplamAdetMap[x.code] || x.adet}</td>
                <td>${x.malzeme}</td>
                <td>${x.olcu}</td>
                <td>${x.hammadde}</td>
                <td>${x.desc}</td>
                <td>${x.parent || ""}</td>
            </tr>
        `).join("")
                }
</tbody>
    </table>

    <b>3. Güncellenen Parçalar (adet/malzeme/ölçü/hammadde/açıklama değişmiş)</b>
    <table style="margin-bottom:18px;">
    <thead>
        <tr>
            <th>Parça Kodu</th>
            <th>Önceki Adet</th>
            <th>Yeni Adet</th>
            <th>Malzeme</th>
            <th>Ölçü</th>
            <th>Hammadde</th>
            <th>Açıklama</th>
            <th>Montaj</th>
        </tr>
    </thead>
    <tbody>
        ${guncellenenler.length === 0
                    ? `<tr><td colspan="8" style="text-align:center;">Yok</td></tr>`
                    : guncellenenler.map(x => `
                <tr>
                    <td>${x.code}</td>
                    <td>${x.eskiAdet !== undefined ? x.eskiAdet : ""}</td>
                    <td>${x.yeniAdet !== undefined ? x.yeniAdet : x.adet}</td>
                    <td>${x.malzeme}</td>
                    <td>${x.olcu}</td>
                    <td>${x.hammadde}</td>
                    <td>${x.desc}</td>
                    <td>${x.parent || ""}</td>
                </tr>
            `).join("")
                }
    </tbody>
</table>

    <b>4. Montaj Şeması Farkları</b>
    <table>
        <thead>
            <tr>
                <th>Montaj</th>
                <th>Parça</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody>
            ${montajFarkList.length === 0 ? `<tr><td colspan="3" style="text-align:center;">Yok</td></tr>` : montajFarkList.map(x => `
                <tr>
                    <td>${x.parent}</td>
                    <td>${x.child}</td>
                    <td style="color:${x.tip === "Eklendi" ? "#27ae60" : "#c0392b"}; font-weight:bold;">${x.tip}</td>
                </tr>
            `).join("")}
        </tbody>
    </table>
    </div>
    `;

            return html;
        }

        function getToplamAdetMap(xmlDoc) {
            const map = {};
            function gez(docNode, parentMultiplier, parentCode) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const adet = parseInt(conf.getAttribute("quantity")) || 1;
                const toplamAdet = adet * parentMultiplier;
                // Hem genel toplam hem de parent bazında anahtar tut
                map[partCode] = (map[partCode] || 0) + toplamAdet;
                map[partCode + "|" + (parentCode || "")] = (map[partCode + "|" + (parentCode || "")] || 0) + toplamAdet;
                // Alt montajları gez
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                childDocs.forEach(childDoc => gez(childDoc, toplamAdet, partCode));
            }
            // Kökten başlat
            const documents = xmlDoc.querySelectorAll("document");
            const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
            rootDocs.forEach(doc => gez(doc, 1, null));
            return map;
        }

        document.querySelector('main').addEventListener('change', function (e) {
            if (e.target.classList.contains('strike-checkbox')) {
                const label = e.target.closest('li').querySelector('label');
                if (label) {
                    label.classList.toggle('strikeout', e.target.checked);
                }
            }
        });

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('copy-hata-listesi')) {
                const ul = e.target.closest('div').querySelector('ul');
                if (!ul) return;
                // Sadece parça kodlarını kopyala
                const lines = Array.from(ul.querySelectorAll('li')).map(li => {
                    // Ana Parça: ... → Çocuk: ... formatında ise sadece çocuk parça kodunu al
                    const match = li.innerText.match(/Çocuk:\s*([A-Z0-9\-]+)/i);
                    if (match) return match[1];
                    // Yoksa tüm satırı al
                    return li.innerText.trim();
                });
                if (lines.length === 0) return;
                const text = lines.join('\n');
                navigator.clipboard.writeText(text);
                e.target.style.background = "#ffe066";
                setTimeout(() => { e.target.style.background = ""; }, 600);
            }
        });

        document.getElementById('malzemeArama').addEventListener('input', filtreAccordionListesi);

        document.getElementById('btnXmlKarsilastir').onclick = showXmlComparePopup;

        function normalizeKod(kod) {
            return (kod || "")
                .toString()
                .trim()
                .toUpperCase()
                .replace(/-R\d+$/i, "")
                .replace(/\s+/g, "");
        }

        function normalizeKalinlik(kalinlik) {
            if (!kalinlik) return "";
            return kalinlik.toString().replace(",", ".").trim();
        }



        window.kesimPdfFilesList = window.kesimPdfFilesList || [];
        window.kesimPdfSetAdedi = window.kesimPdfSetAdedi || 1;

        // Kesim Listesi Kontrol Popup Fonksiyonu
        document.getElementById('btnKesimKarsilastir').onclick = function () {
            let popup = document.createElement('div');
            popup.id = "kesimKarsilastirPopup";
            popup.style.position = "fixed";
            popup.style.top = "0";
            popup.style.left = "0";
            popup.style.width = "100vw";
            popup.style.height = "100vh";
            popup.style.background = "rgba(0,0,0,0.25)";
            popup.style.zIndex = "99999";
            popup.innerHTML = `
<div id="kesimPopup" style="
    background:#fff;
    max-width:1200px;
    min-width:800px;
    margin:30px auto;
    border-radius:8px;
    box-shadow:0 2px 16px #0003;
    padding:0; /* Şeritleri düzgün yerleştirmek için padding kaldırıldı */
    position:relative;
    max-height:92vh;
    display:flex;
    flex-direction:column;
    overflow:hidden; /* Şeritler içeride kalsın */
">

    <!-- Üst şerit (En Üste Git) -->
    <button id="scrollToTopPopup" style="
        background:#fff;
        color:black;
        border:none;
        border-top-left-radius:8px;
        border-top-right-radius:8px;
        height:20px;
        width:100%;
        font-size:16px;
        cursor:pointer;
        flex-shrink:0;
        transition:background 0.2s;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1); /* Altına gölge ekle */
        z-index:100000;
    ">↑</button>

    <!-- İçerik Alanı -->
    <div id="kesimPopupContent" style="
        padding:32px 28px 24px 28px;
        overflow:auto;
        flex:1;
    ">
        <!-- Üstteki butonlar -->
        <div style="position:absolute; top:50px; right:18px; display:flex; gap:12px; z-index:10;">
            <button id="btnCloseKesimPopup" style="background:#c0392b; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:15px; cursor:pointer;">Kapat</button>
            <button id="btnResetKesimPopup" style="background:#e67e22; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:15px; cursor:pointer;">Sıfırla</button>
        </div>

        <h3 style="margin-top:0;">Kesim Listesi Karşılaştırma</h3>
        
        <!-- Yükleme alanı -->
        <div id="pdfDropArea" style="flex:1; min-width:320px; border:2px dashed #2563eb; border-radius:8px; padding:28px 18px 18px 18px; background:#f8faff; margin-bottom:24px; text-align:center;">
            <label for="popupPdfInput" style="font-weight:bold; font-size:16px; color:#2563eb; cursor:pointer;">PDF Dosyaları Yükle veya Sürükleyin</label>
            <input type="file" id="popupPdfInput" accept=".pdf" multiple style="display:none;">
            <div id="popupPdfSetAdediDiv"></div>
            <div id="popupPdfFileNames" style="margin-top:12px;"></div>
        </div>
        
        <!-- PDF dosyaları tablosu -->
        <div style="margin-bottom:24px; border:1px solid #e0e0e0; border-radius:8px; background:#f8faff; padding:18px;">
            <h4 style="margin-top:0; color:#c0392b;">Yüklenen PDF Dosyaları ve Tanınan Parçalar</h4>
            <div id="popupPdfListesi"></div>
        </div>
        
        <div id="popupCompareResult" style="overflow:auto; font-size:15px; margin-top:28px;"></div>
    </div>

    <!-- Alt şerit (En Alta Git) -->
    <button id="scrollToBottomPopup" style="
        background:#fff;
        color:black;
        border:none;
        border-bottom-left-radius:8px;
        border-bottom-right-radius:8px;
        height:20px;
        width:100%;
        font-size:16px;
        cursor:pointer;
        flex-shrink:0;
        transition:background 0.2s;
        box-shadow: 0px -2px 5px rgba(0, 0, 0, 0.1); /* Üstüne gölge ekle */
    ">↓</button>
</div>
`;


            document.body.appendChild(popup);

            setTimeout(() => {
                const popup = document.getElementById('kesimKarsilastirPopup');
                if (!popup) return;
                const pdfBaslik = popup.querySelector('h4');
                if (pdfBaslik) {
                    pdfBaslik.style.cursor = "pointer";
                    pdfBaslik.title = "Tüm PDF parça kodlarını kopyala";
                    pdfBaslik.onclick = function () {
                        const kodlar = [];
                        popup.querySelectorAll('#popupPdfListesi table tbody tr td:first-child').forEach(td => {
                            td.querySelectorAll('div').forEach(div => {
                                const kod = div.innerText.trim();
                                if (kod && !kodlar.includes(kod)) kodlar.push(kod);
                            });
                        });
                        if (kodlar.length === 0) {
                            pdfBaslik.textContent = "Kopyalanacak kod yok!";
                            setTimeout(() => pdfBaslik.textContent = "Yüklenen PDF Dosyaları ve Tanınan Parçalar", 900);
                            return;
                        }
                        navigator.clipboard.writeText(kodlar.join('\n'));
                        pdfBaslik.textContent = "Kopyalandı!";
                        setTimeout(() => pdfBaslik.textContent = "Yüklenen PDF Dosyaları ve Tanınan Parçalar", 900);
                    };
                }
            }, 400);

            enableDrop('#popupPdfInput', '#pdfDropArea', "#f8faff", "#e3eaff", ".pdf");

            document.getElementById('btnCloseKesimPopup').onclick = () => {
                popup.remove();
                // Durum popup'ını da kaldır
                const durumPopup = document.getElementById('kesimDurumPopup');
                if (durumPopup) durumPopup.remove();
            };

            document.getElementById('btnResetKesimPopup').onclick = function () {
                // PDF dosya listesini ve blokları temizle
                window.kesimPdfFilesList = [];
                window.kesimPdfSetAdedi = 1;
                pdfFilesList.length = 0;
                blokList.length = 0;
                document.getElementById('popupPdfListesi').innerHTML = "";
                document.getElementById('popupPdfFileNames').innerHTML = "";
                document.getElementById('popupCompareResult').innerHTML = "";
                popup.querySelector('#popupPdfSetAdedi').value = 1;
                // PDF input'u da sıfırla!
                const pdfInput = popup.querySelector('#popupPdfInput');
                if (pdfInput) pdfInput.value = "";
                // Durum popup'ını da kaldır
                const durumPopup = document.getElementById('kesimDurumPopup');
                if (durumPopup) durumPopup.remove();
            };

            // En Üste Git
            const popupContent = document.getElementById("kesimPopupContent");
            document.getElementById("scrollToTopPopup").onclick = () => {
                popupContent.scrollTo({ top: 0, behavior: "smooth" });
            };
            document.getElementById("scrollToBottomPopup").onclick = () => {
                popupContent.scrollTo({ top: popupContent.scrollHeight, behavior: "smooth" });
            };

            let blokList = [];

            // ---------- Drag & Drop + Input Gizleme ----------
            function enableDrop(inputId, areaId, bgDefault, bgHover, ext) {
                const input = document.querySelector(inputId);
                const dropArea = document.querySelector(areaId);
                let dragCounter = 0; // 🔹 aktif sürükleme sayısını takip eder
                let previousBackgroundColor = bgDefault; // Mevcut arka plan rengini sakla

                // Alan tıklanınca input açılsın
                dropArea.addEventListener("click", e => {
                    input.value = ""; // Aynı dosya tekrar seçilebilsin
                    input.click();
                });

                // --- Sürükleme popup içine girince ---
                popup.addEventListener("dragenter", function (e) {
                    e.preventDefault();
                    dragCounter++;
                    previousBackgroundColor = popup.style.backgroundColor || bgDefault; // Mevcut rengi sakla
                    popup.style.transition = "background-color 0.3s ease";
                    popup.style.backgroundColor = bgHover; // sadece ilk girişte renk değişsin
                });

                // --- Sürükleme devam ederken ---
                popup.addEventListener("dragover", function (e) {
                    e.preventDefault(); // bırakılabilir hale getir
                });

                // --- Sürükleme popup dışına çıkınca ---
                popup.addEventListener("dragleave", function (e) {
                    e.preventDefault();
                    dragCounter--;
                    // Fare tamamen dışarı çıktığında sıfırla
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        popup.style.backgroundColor = previousBackgroundColor; // Önceki rengi geri yükle
                    }
                });

                // --- Dosya bırakıldığında ---
                popup.addEventListener("drop", function (e) {
                    e.preventDefault();
                    dragCounter = 0;
                    popup.style.backgroundColor = bgDefault;

                    const pdfFiles = Array.from(e.dataTransfer.files || []).filter(f =>
                        f.name.toLowerCase().endsWith(ext)
                    );
                    if (pdfFiles.length === 0) return;

                    const pdfInput = popup.querySelector("#popupPdfInput");
                    if (!pdfInput) return;

                    // Eski dosyalar + yeni dosyaları birleştir
                    const dt = new DataTransfer();
                    Array.from(pdfInput.files).forEach(f => dt.items.add(f));
                    pdfFiles.forEach(f => {
                        if (!Array.from(dt.files).some(existing => existing.name === f.name)) {
                            dt.items.add(f);
                        }
                    });

                    pdfInput.files = dt.files;
                    pdfInput.dispatchEvent(new Event("change"));
                });
            }

            function createFileList(files) {
                const dt = new DataTransfer();
                files.forEach(f => dt.items.add(f));
                return dt.files;
            }

            // ---------- PDF Kod / Adet / Kalınlık Yakalama ----------
            function satirdanKodCek(line) {
                const reList = [
                    // Tüm kodu yakala (varyant ve revizyon dahil)
                    /\b[A-Z]{2,5}-\d{4}-\d{6,}(?:-[A-Z0-9]{4,})?(?:-R\d{1,5})?\b/g,
                    /Parça\s*Ad[ıi]\s*[:\-]?\s*([A-Z0-9\-]+(?:-[A-Z0-9]+)*)/gi,
                    /RNO\s*[:\-]?\s*([A-Z0-9\-]+(?:-[A-Z0-9]+)*)/gi,
                    /Kod\s*[:\-]?\s*([A-Z0-9\-]+(?:-[A-Z0-9]+)*)/gi,
                    /Parça\s*Kodu\s*[:\-]?\s*([A-Z0-9\-]+(?:-[A-Z0-9]+)*)/gi
                ];
                let kodlar = [];
                reList.forEach(re => {
                    let match;
                    while ((match = re.exec(line)) !== null) {
                        kodlar.push((match[1] || match[0]).trim());
                    }
                });
                return kodlar.length ? kodlar : null;
            }

            function satirdanAdetCek(line) {
                const reList = [
                    /Adet\s*[:\-]?\s*([0-9]+)/i,
                    /ADET\s*[:\-]?\s*([0-9]+)/i,
                    /Miktar\s*[:\-]?\s*([0-9]+)/i
                ];
                for (const re of reList) {
                    const match = line.match(re);
                    if (match) return match[1].trim();
                }
                return null;
            }

            function satirdanKalinlikCek(line, nextLine = "") {
                const reList = [
                    /KALINLIK[:\s]*([0-9.,]+)\s*MM?/i,                     // KALINLIK: 2MM / KALINLIK: 2 MM
                    /Kalınlık[:\s]*([0-9.,]+)\s*MM?/i,
                    /Sac\s*Kalınlığı[:\s]*([0-9.,]+)\s*MM?/i,
                    /Levha\s*[-:\s]*([0-9.,]+)\s*MM?/i,
                    /Hammadde[_ ]?Olcusu[:\s]*(?:Levha\s*[-:\s]*)?([0-9.,]+)\s*MM?/i,
                    /\b([0-9]{1,4}(?:[.,][0-9]+)?)\s*MM\b/i                // “2MM”, “1.5MM” gibi
                ];

                // Önce bu satırda ara
                for (const re of reList) {
                    const match = line.match(re);
                    if (match) {
                        return match[1].replace(",", ".").trim();
                    }
                }

                // Eğer bu satırda bulunamadıysa, sonraki satırda da ara
                for (const re of reList) {
                    const match = nextLine.match(re);
                    if (match) {
                        return match[1].replace(",", ".").trim();
                    }
                }

                // Eğer satırda sadece sayı varsa ve sonraki satırda "MM" varsa (ör. "5" + "MM")
                if (/^\s*([0-9]{1,4}(?:[.,][0-9]+)?)\s*$/i.test(line) && /^\s*MM\s*$/i.test(nextLine)) {
                    return line.replace(",", ".").trim();
                }

                return null;
            }

            // ---------- PDF Bloklarını Tara ----------
            function pdfBloklariniTara(pdfText) {
                const lines = pdfText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                let bloklar = [];
                let i = 0;

                while (i < lines.length) {
                    if (/^(RNO:|Parça Ad[ıi]:)/i.test(lines[i])) {
                        let kodlar = satirdanKodCek(lines[i]) || [];
                        let adet = null;
                        let kalinlik = null;

                        let j = i + 1;
                        let kodToplamaModu = true;

                        while (
                            j < lines.length &&
                            !/^RNO:/i.test(lines[j]) &&
                            !/^Parça Ad[ıi]:/i.test(lines[j])
                        ) {
                            if (/KALINLIK|ADET/i.test(lines[j])) {
                                kodToplamaModu = false;
                            }

                            if (kodToplamaModu) {
                                let newKod = satirdanKodCek(lines[j]);
                                if (newKod) kodlar.push(...newKod);
                            }

                            if (!adet) {
                                let a = satirdanAdetCek(lines[j]);
                                if (a) adet = a;
                            }
                            if (!kalinlik) {
                                let k = satirdanKalinlikCek(lines[j], lines[j + 1] || "");
                                if (k) kalinlik = k;
                            }

                            j++;
                        }

                        // Revizyon (-R00, -R01 vs.) kısmını kaldır
                        kodlar = [...new Set(
                            kodlar.map(k =>
                                k.replace(/-R\d+$/i, "")
                            )
                        )];

                        bloklar.push({
                            kodlar,
                            adet,
                            kalinlik
                        });

                        i = j;
                        continue;
                    }

                    i++;
                }

                return bloklar;
            }

            // ---------- PDF Yükleme ve Listeleme ----------
            let pdfSetAdedi = window.kesimPdfSetAdedi;
            const pdfInputDiv = popup.querySelector('#popupPdfInput').parentElement;
            let pdfSetAdediDiv = document.createElement('div');
            pdfSetAdediDiv.id = 'popupPdfSetAdediDiv';
            pdfSetAdediDiv.style = "margin-bottom:8px; margin-top:4px;";
            // Set Adedi kutusunu label olmadan ekle
            pdfSetAdediDiv.innerHTML = `
    <span style="font-weight:bold; color:#c0392b; user-select:none;">Set Adedi:</span>
    <input type="number" id="popupPdfSetAdedi" min="1" value="1" style="width:60px; padding:4px 8px; border-radius:4px; border:1px solid #bbb; font-size:14px;">
`;
            // Dosya input divinin üstüne ekle
            pdfInputDiv.parentElement.insertBefore(pdfSetAdediDiv, pdfInputDiv);

            const popupPdfSetAdediInput = popup.querySelector('#popupPdfSetAdedi');
            popupPdfSetAdediInput.value = pdfSetAdedi;
            popupPdfSetAdediInput.oninput = function () {
                pdfSetAdedi = parseInt(this.value, 10) || 1;

                // PDF tablosunu ve blokları güncelle
                blokList.forEach(b => {
                    if (b.orjAdet === undefined) b.orjAdet = parseInt(b.adet, 10) || 0;
                    b.adet = b.orjAdet * pdfSetAdedi;
                });

                // PDF tablosunu yeniden oluştur
                document.getElementById('popupPdfListesi').innerHTML = "";
                // Eğer dosya adlarını saklıyorsan, tekrar yüklemeden tabloyu oluşturabilirsin
                // Burada blokList'ten tabloyu yeniden oluştur:
                let tabloHtml = `
        <table style="margin:10px 0; border-collapse:collapse; border:1px solid #ccc;">
            <thead><tr><th>Kod</th><th>Adet</th><th>Kalınlık</th></tr></thead>
            <tbody>
                ${blokList.map(b => {
                    let kodlarHtml = "";
                    if (b.kodlar && b.kodlar.length > 0) {
                        kodlarHtml = `<div>${b.kodlar[0]}</div>`;
                        for (let i = 1; i < b.kodlar.length; i++) {
                            kodlarHtml += `<div style="margin-top:2px;">${b.kodlar[i]}</div>`;
                        }
                    }
                    return `
        <tr>
            <td>${kodlarHtml}</td>
            <td>${b.adet || ""}</td>
            <td>${b.kalinlik || ""}</td>
        </tr>
    `;
                }).join("")}
            </tbody>
        </table>
    `;
                document.getElementById('popupPdfListesi').innerHTML = tabloHtml;

                // Karşılaştırmayı tekrar yap
                tryCompare();
            };

            let pdfFilesList = window.kesimPdfFilesList; // [{file, bloklar, orjAdetler}]

            // PDF yükleme fonksiyonunu güncelle
            async function pdfYukleVeListele(pdfFile) {
                if (pdfFilesList.some(x => x.file.name === pdfFile.name)) {
                    return;
                }
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc =
                    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const pdf = await pdfjsLib.getDocument(URL.createObjectURL(pdfFile)).promise;
                let pdfText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    pdfText += textContent.items.map(item => item.str).join("\n") + "\n";
                }

                const bloklar = pdfBloklariniTara(pdfText);
                // Orijinal adetleri sakla
                bloklar.forEach(b => {
                    b.orjAdet = parseInt(b.adet, 10) || 0;
                    b.adet = b.orjAdet * pdfSetAdedi;
                });

                pdfFilesList.push({ file: pdfFile, bloklar });
                renderPdfFileNames();   // yeni eklenen fonksiyon
                renderPdfTablolar();
                tryCompare();
            }

            let pdfFileNamesDiv;

            function initPdfFileNamesDiv() {
                if (!pdfFileNamesDiv) {
                    pdfFileNamesDiv = document.createElement('div');
                    pdfFileNamesDiv.id = "popupPdfFileNames";
                    pdfFileNamesDiv.style = "margin-bottom:8px; font-size:14px;";

                    // Set Adedi divinin üstüne yerleştir
                    let pdfSetAdediDiv = document.getElementById("popupPdfSetAdediDiv");
                    pdfSetAdediDiv.parentElement.insertBefore(pdfFileNamesDiv, pdfSetAdediDiv);
                }
            }

            function renderPdfFileNames() {
                if (!pdfFileNamesDiv) initPdfFileNamesDiv();

                let html = "";
                pdfFilesList.forEach((pdfObj, index) => {
                    html += `
            <div style="margin-bottom:4px; display:flex; align-items:center; justify-content:space-between; border:1px solid #ccc; border-radius:4px; padding:4px 8px; background:#fafafa;">
                <span>${pdfObj.file.name}</span>
                <button data-index="${index}" style="background:#fafafa; color:#fff; border:none; border-radius:4px; cursor:pointer; padding:2px 8px;">❌</button>
            </div>
        `;
                });
                pdfFileNamesDiv.innerHTML = html;

                // Silme butonlarını bağla
                pdfFileNamesDiv.querySelectorAll("button").forEach(btn => {
                    btn.onclick = function () {
                        const idx = parseInt(this.dataset.index, 10);
                        pdfFilesList.splice(idx, 1);   // listeden sil

                        // Dosya input'unu güncelle (sadece kalan dosyalar)
                        const pdfInput = popup.querySelector('#popupPdfInput');
                        if (pdfInput) {
                            const dt = new DataTransfer();
                            pdfFilesList.forEach(x => dt.items.add(x.file));
                            pdfInput.files = dt.files;
                        }

                        renderPdfFileNames();
                        renderPdfTablolar();
                        tryCompare();
                    };
                });

                let previewHideTimer = null;

                pdfFileNamesDiv.querySelectorAll("div").forEach((div, idx) => {
                    div.onclick = function (e) {
                        // Sadece silme butonuna tıklanmadıysa aç
                        if (e.target.tagName === "BUTTON") return;
                        const pdfObj = pdfFilesList[idx];
                        let preview = document.getElementById('pdfPreviewPopup');
                        if (!preview) {
                            preview = document.createElement('div');
                            preview.id = 'pdfPreviewPopup';
                            preview.style.position = 'fixed';
                            preview.style.zIndex = '1000000';
                            preview.style.background = '#fff';
                            preview.style.border = '2px solid #2563eb';
                            preview.style.borderRadius = '10px';
                            preview.style.boxShadow = '0 2px 16px #0003';
                            preview.style.padding = '0';
                            preview.style.width = '820px';
                            preview.style.height = '640px';
                            preview.style.display = 'none';
                            document.body.appendChild(preview);
                        }
                        const url = URL.createObjectURL(pdfObj.file);
                        preview.innerHTML = `
            <iframe src="${url}" width="100%" height="100%" style="border:none;"></iframe>
            <div style="position:absolute;top:8px;right:12px;">
                <button onclick="document.getElementById('pdfPreviewPopup').style.display='none';" style="background:#c0392b;color:#fff;border:none;border-radius:6px;padding:4px 12px;cursor:pointer; margin-top:60px;">Kapat</button>
            </div>
        `;
                        // Ortada açılması için ekranın ortasına konumlandır
                        preview.style.left = "calc(50vw - 360px)";
                        preview.style.top = "calc(50vh - 320px)";
                        preview.style.display = "block";
                    };
                });
            }

            // PDF tablolarını ayrı ayrı gösteren fonksiyon
            function renderPdfTablolar() {
                let html = "";
                pdfFilesList.forEach(pdfObj => {
                    html += `
        <b>PDF'den Tanınan Parçalar (${pdfObj.file.name}):</b>
        <table style="margin:10px 0; border-collapse:collapse; border:1px solid #ccc;">
            <thead><tr><th>Kod</th><th>Adet</th><th>Kalınlık</th></tr></thead>
            <tbody>
                ${pdfObj.bloklar.map(b => {
                        let kodlarHtml = "";
                        if (b.kodlar && b.kodlar.length > 0) {
                            kodlarHtml = `<div>${b.kodlar[0]}</div>`;
                            for (let i = 1; i < b.kodlar.length; i++) {
                                kodlarHtml += `<div style="margin-top:2px;">${b.kodlar[i]}</div>`;
                            }
                        }
                        // Kalınlık sonuna mm ekle (boş değilse)
                        let kalinlikGoster = b.kalinlik ? `${b.kalinlik} mm` : "";
                        // Adet veya kalınlık boşsa satırı kırmızıya boya
                        const trStyle = (!b.adet || !b.kalinlik) ? ' style="background:#ffeaea;"' : '';
                        return `
        <tr${trStyle}>
            <td>${kodlarHtml}</td>
            <td>${b.adet || ""}</td>
            <td>${kalinlikGoster}</td>
        </tr>
    `;
                    }).join("")}
            </tbody>
        </table>
        `;
                });
                document.getElementById('popupPdfListesi').innerHTML = html;

                // Tüm blokları birleştir (karşılaştırma için)
                blokList = pdfFilesList.flatMap(x => x.bloklar);
                setTimeout(() => {
                    // PDF tablosundaki başlığa tıklama olayı ekle
                    document.querySelectorAll('#popupPdfListesi table thead th:first-child').forEach(th => {
                        th.style.cursor = "pointer";
                        th.title = "Tüm parça kodlarını alt alta kopyala";
                        th.onclick = function () {
                            // Tablodaki tüm parça kodlarını topla
                            const table = th.closest('table');
                            const kodlar = Array.from(table.querySelectorAll('tbody tr td:first-child'))
                                .map(cell => cell.innerText.trim())
                                .filter(Boolean);
                            // Alt alta kopyala
                            const text = kodlar.join('\n');
                            navigator.clipboard.writeText(text);
                            // Görsel geri bildirim
                            th.style.background = "#ffe066";
                            th.innerText = "Kopyalandı!";
                            setTimeout(() => {
                                th.style.background = "";
                                th.innerText = "Kod";
                            }, 900);
                        };
                    });
                }, 0);

            }


            // PDF input değiştiğinde listeleri sıfırla
            document.getElementById('popupPdfInput').onchange = async function (e) {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                // Dosyaları yükle
                for (const file of files) {
                    await pdfYukleVeListele(file);
                }
                // Dosya input'unu güncelle (sadece kalan dosyalar)
                const dt = new DataTransfer();
                pdfFilesList.forEach(x => dt.items.add(x.file));
                e.target.files = dt.files;
                window.kesimPdfFilesList = pdfFilesList;
                window.kesimPdfSetAdedi = pdfSetAdedi;
                tryCompare();
            };

            // Set adedi değiştiğinde her PDF tablosunu ayrı ayrı güncelle
            popup.querySelector('#popupPdfSetAdedi').oninput = function () {
                pdfSetAdedi = parseInt(this.value, 10) || 1;
                window.kesimPdfSetAdedi = pdfSetAdedi;
                pdfFilesList.forEach(pdfObj => {
                    pdfObj.bloklar.forEach(b => {
                        b.adet = b.orjAdet * pdfSetAdedi;
                    });
                });
                renderPdfTablolar();
                tryCompare();
            };

            if (pdfFilesList.length > 0) {
                renderPdfFileNames();
                renderPdfTablolar();
                tryCompare();
                popup.querySelector('#popupPdfSetAdedi').value = pdfSetAdedi;
            }

            // ---------- Karşılaştırma Fonksiyonu ----------
            function tryCompare() {
                // Accordion'daki parça kodu, kalınlık ve adetleri topla
                let popupLevhaList = [];
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const title = item.querySelector('.accordion-title');
                    const content = item.querySelector('.accordion-content');
                    if (!title || !content) return;

                    // Parça kodunu bul
                    const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                    let partCode = kodMatch ? kodMatch[1].trim() : "";
                    partCode = partCode.replace(/-R\d+$/i, "");

                    // Hammaddeyi bul
                    let hammadde = "";
                    let siparisDisiBirak = "";
                    content.querySelectorAll('tbody tr').forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Hammadde") hammadde = deger;
                        if (alan === "Siparis_Disi_Birak") siparisDisiBirak = deger;
                    });

                    // Sadece LEVHA olanları al
                    if ((hammadde || "").toUpperCase() !== "LEVHA") return;

                    // Toplam adet
                    const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                    const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                    // Kalınlık
                    let kalinlik = "";
                    content.querySelectorAll('tbody tr').forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Kalınlık" || alan === "Sac Kalınlığı") kalinlik = deger;
                        if (!kalinlik && (alan === "Ham_o1" || alan === "Profil_Tanim_Boy")) {
                            let val = deger || "";
                            let mmMatch = val.match(/([0-9.,]+)\s*mm/i);
                            if (mmMatch) kalinlik = mmMatch[1].replace(",", ".");
                            else {
                                let xMatch = val.match(/x\s*([0-9.,]+)$/i);
                                if (xMatch) kalinlik = xMatch[1].replace(",", ".");
                            }
                        }
                    });

                    // Sipariş dışı ise adetini 0 olarak say, orjAdet ile gerçek adeti sakla
                    let siparisDisi = (siparisDisiBirak === "1");

                    popupLevhaList.push({
                        partCode,
                        toplamAdet: siparisDisi ? 0 : toplamAdet, // Sipariş dışı ise 0 say
                        kalinlik,
                        orjAdet: toplamAdet, // Gerçek adeti sakla
                        siparisDisi
                    });
                });

                // --- XML Kod+Kalınlık+Adet map ---
                const xmlKodKalinlikAdetMap = {};
                const xmlKodKalinlikMap = {};
                popupLevhaList.forEach(x => {
                    const kod = normalizeKod(x.partCode);
                    const kalinlik = (x.kalinlik || "").replace(",", ".").trim();
                    const key = kod + "|" + kalinlik;
                    xmlKodKalinlikAdetMap[key] = (xmlKodKalinlikAdetMap[key] || 0) + (parseInt(x.toplamAdet) || 0);
                    if (!xmlKodKalinlikMap[kod]) xmlKodKalinlikMap[kod] = new Set();
                    xmlKodKalinlikMap[kod].add(kalinlik);
                });

                // --- PDF Kod+Kalınlık+Adet map ---
                const pdfKodKalinlikAdetMap = {};
                const pdfKodKalinlikMap = {};
                blokList.forEach(blok => {
                    blok.kodlar.forEach(kod => {
                        const kodNorm = normalizeKod(kod);
                        const key = kodNorm + "|" + (blok.kalinlik || "");
                        pdfKodKalinlikAdetMap[key] = (pdfKodKalinlikAdetMap[key] || 0) + (parseInt(blok.adet) || 0);
                        if (!pdfKodKalinlikMap[kodNorm]) pdfKodKalinlikMap[kodNorm] = new Set();
                        pdfKodKalinlikMap[kodNorm].add(blok.kalinlik || "");
                    });
                });

                // --- Karşılaştırma ---
                let hataList = [];

                let kodDosyaMap = {};
                pdfFilesList.forEach(pdfObj => {
                    pdfObj.bloklar.forEach(blok => {
                        blok.kodlar.forEach(kod => {
                            const kodNorm = normalizeKod(kod);
                            if (!kodDosyaMap[kodNorm]) kodDosyaMap[kodNorm] = new Set();
                            kodDosyaMap[kodNorm].add(pdfObj.file.name);
                        });
                    });
                });
                Object.entries(kodDosyaMap).forEach(([kod, fileSet]) => {
                    if (fileSet.size > 1) {
                        hataList.push({
                            kodlar: [kod],
                            pdfAdet: "-",
                            xmlAdet: "-",
                            tip: `Bu parça kodları birden fazla PDF listesinde geçti: ${Array.from(fileSet).join(", ")}`
                        });
                    }
                });

                // 1. XML’de olup PDF’de olmayanlar
                Object.keys(xmlKodKalinlikMap).forEach(kod => {
                    if (!pdfKodKalinlikMap[kod]) {
                        // Accordion'dan toplam adeti bul
                        let xmlAdet = 0;
                        document.querySelectorAll('.accordion-item').forEach(item => {
                            const title = item.querySelector('.accordion-title');
                            if (!title) return;
                            const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                            let partCode = kodMatch ? kodMatch[1].trim() : "";
                            partCode = partCode.replace(/-R\d+$/i, "");
                            if (partCode === kod) {
                                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;
                                xmlAdet += toplamAdet;
                            }
                        });
                        hataList.push({ kodlar: [kod], pdfAdet: 0, xmlAdet: xmlAdet, tip: "PDF'de yok" });
                    }
                });

                // 2. PDF’de olup XML’de olmayanlar
                Object.keys(pdfKodKalinlikMap).forEach(kod => {
                    if (!xmlKodKalinlikMap[kod]) {
                        // PDF'deki toplam adeti bul
                        let pdfAdet = 0;
                        blokList.forEach(blok => {
                            blok.kodlar.forEach(bkod => {
                                const kodNorm = normalizeKod(bkod);
                                if (kodNorm === kod) {
                                    pdfAdet += parseInt(blok.adet) || 0;
                                }
                            });
                        });
                        hataList.push({ kodlar: [kod], pdfAdet: pdfAdet, xmlAdet: 0, tip: "XML'de yok" });
                    }
                });

                // 3. Kalınlık uyuşmazlığı
                Object.keys(xmlKodKalinlikMap).forEach(kod => {
                    if (pdfKodKalinlikMap[kod]) {
                        const xmlKalinliklar = Array.from(xmlKodKalinlikMap[kod]);
                        const pdfKalinliklar = Array.from(pdfKodKalinlikMap[kod]);
                        pdfKalinliklar.forEach(pdfKal => {
                            if (!xmlKalinliklar.includes(pdfKal)) {
                                // PDF ve XML toplam adetleri al
                                const xmlAdet = xmlKalinliklar.reduce((sum, k) => {
                                    const key = kod + "|" + k;
                                    return sum + (xmlKodKalinlikAdetMap[key] || 0);
                                }, 0);
                                const pdfAdet = pdfKodKalinlikAdetMap[kod + "|" + pdfKal] || 0;

                                hataList.push({
                                    kodlar: [kod],
                                    pdfAdet: pdfAdet,
                                    xmlAdet: xmlAdet,
                                    tip: "Kalınlık uyuşmazlığı",
                                    xmlKalinliklar,
                                    pdfKalinlik: pdfKal
                                });
                            }
                        });
                    }
                });

                // 4. Aynı PDF içinde tekrar eden kodlar
                let kodSayac = {};
                blokList.forEach(blok => {
                    blok.kodlar.forEach(kod => {
                        const kodNorm = normalizeKod(kod);
                        kodSayac[kodNorm] = (kodSayac[kodNorm] || 0) + 1;
                    });
                });
                Object.entries(kodSayac).forEach(([kod, sayi]) => {
                    if (sayi > 1) {
                        hataList.push({
                            kodlar: [kod],
                            pdfAdet: sayi,
                            xmlAdet: "-",
                            tip: "Aynı PDF içinde tekrar geçti"
                        });
                    }
                });


                blokList.forEach(blok => {
                    if (!blok.adet) return;
                    let xmlToplam = 0;
                    let siparisDisiUyari = false;
                    let orjAdet = 0;

                    blok.kodlar.forEach(kod => {
                        const kodNorm = normalizeKod(kod);
                        const kalinlikNorm = (blok.kalinlik || "").replace(",", ".").trim();
                        const key = kodNorm + "|" + kalinlikNorm;
                        xmlToplam += xmlKodKalinlikAdetMap[key] || 0;

                        // Sipariş dışı mı?
                        const levha = popupLevhaList.find(x => normalizeKod(x.partCode) === kodNorm && (x.kalinlik || "") === kalinlikNorm);
                        if (levha && levha.siparisDisi) {
                            siparisDisiUyari = true;
                            orjAdet = levha.orjAdet;
                        }
                    });

                    // PDF adeti ile XML adeti farklıysa ve XML adeti 0 ise (sipariş dışıysa) hata göster
                    if (parseInt(blok.adet) !== xmlToplam && (xmlToplam > 0 || siparisDisiUyari)) {
                        hataList.push({
                            tip: "Adet uyuşmazlığı",
                            kodlar: blok.kodlar,
                            pdfAdet: blok.adet,
                            xmlAdet: siparisDisiUyari ? `${orjAdet} <span style="color:#c0392b;">(Sipariş Dışı)</span>` : xmlToplam,
                            siparisDisi: siparisDisiUyari
                        });
                    }
                });

                // --- Hata kontrolü için durumlar ---
                let hataDurumlari = {
                    tumBilgilerGeldi: true,
                    tumParcalarPdfteVar: true,
                    tumParcalarXmldeVar: true,
                    tumKalinliklarEslesiyor: true,
                    tumAdetlerEslesiyor: true,
                    ayniPdfteTekrarlanmiyor: true,
                    farkliPdfteTekrarlanmiyor: true
                };

                // PDF'teki tüm blokların kalınlık ve adetlerini kontrol et
                // Eğer hiç blok yoksa veya hiç parça kodu bulunamadıysa hata ver
                if (blokList.length === 0) {
                    hataDurumlari.tumBilgilerGeldi = false;
                } else {
                    let toplamParcaSayisi = 0;
                    blokList.forEach(blok => {
                        if (blok.kodlar && blok.kodlar.length > 0) {
                            toplamParcaSayisi += blok.kodlar.length;
                        }
                        if (!blok.kalinlik || !blok.adet) {
                            hataDurumlari.tumBilgilerGeldi = false;
                        }
                    });
                    // Hiç parça kodu bulunamadıysa hata ver
                    if (toplamParcaSayisi === 0) {
                        hataDurumlari.tumBilgilerGeldi = false;
                    }
                }

                // Hataları tipine göre kontrol et
                hataList.forEach(hata => {
                    if (hata.tip === "PDF'de yok") hataDurumlari.tumParcalarPdfteVar = false;
                    if (hata.tip === "XML'de yok") hataDurumlari.tumParcalarXmldeVar = false;
                    if (hata.tip === "Kalınlık uyuşmazlığı") hataDurumlari.tumKalinliklarEslesiyor = false;
                    if (hata.tip === "Adet uyuşmazlığı") hataDurumlari.tumAdetlerEslesiyor = false;
                    if (hata.tip === "Aynı PDF içinde tekrar geçti") hataDurumlari.ayniPdfteTekrarlanmiyor = false;
                    if (hata.tip && hata.tip.includes("birden fazla PDF listesinde geçti")) hataDurumlari.farkliPdfteTekrarlanmiyor = false;
                });

                // Küçük durum popup'ını oluştur
                let durumPopupHtml = `
<div id="kesimDurumPopup" style="
    position:fixed;
    left:20px;
    top:30px;
    background:#fff;
    border-radius:8px;
    box-shadow:0 4px 16px rgba(0,0,0,0.2);
    padding:16px 18px;
    z-index:100000;
    min-width:260px;
    max-width:280px;
">
    <h4 style="margin:0 0 12px 0; color:#2563eb; font-size:15px; font-weight:bold;">Kontrol Durumu</h4>
    <div style="font-size:12px; line-height:1.9;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Tüm bilgiler geldi</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.tumBilgilerGeldi ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.tumBilgilerGeldi ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Tüm parçalar PDF'te var</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.tumParcalarPdfteVar ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.tumParcalarPdfteVar ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Tüm parçalar XML'de var</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.tumParcalarXmldeVar ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.tumParcalarXmldeVar ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Tüm kalınlıklar eşleşiyor</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.tumKalinliklarEslesiyor ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.tumKalinliklarEslesiyor ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Tüm adetler eşleşiyor</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.tumAdetlerEslesiyor ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.tumAdetlerEslesiyor ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Aynı PDF'te tekrarlanmıyor</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.ayniPdfteTekrarlanmiyor ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.ayniPdfteTekrarlanmiyor ? '✓' : '×'}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:5px; height:5px; border-radius:50%; background:#000; flex-shrink:0;"></span>
            <span style="color:#000; font-weight:600; flex:1;">Farklı PDF'te tekrarlanmıyor</span>
            <span style="font-size:14px; flex-shrink:0; color:${hataDurumlari.farkliPdfteTekrarlanmiyor ? '#27ae60' : '#e74c3c'}; font-weight:bold;">${hataDurumlari.farkliPdfteTekrarlanmiyor ? '✓' : '×'}</span>
        </div>
    </div>
</div>
`;

                // Eski durum popup'ını kaldır
                const eskiDurumPopup = document.getElementById('kesimDurumPopup');
                if (eskiDurumPopup) eskiDurumPopup.remove();

                // Yeni durum popup'ını ekle
                document.body.insertAdjacentHTML('beforeend', durumPopupHtml);

                // --- Sonuçları yazdır ---
                let compareHtml = "";
                if (hataList.length) {
                    // Hataları tipine göre grupla
                    const tipGruplar = {};
                    hataList.forEach(hata => {
                        if (!tipGruplar[hata.tip]) tipGruplar[hata.tip] = [];
                        tipGruplar[hata.tip].push(hata);
                    });

                    compareHtml += `<div class="mismatch-list"><b>PDF ve XML Karşılaştırma Sonuçları:</b></div>`;

                    Object.entries(tipGruplar).forEach(([tip, hatalar]) => {
                        if (tip === "Kalınlık uyuşmazlığı") {
                            compareHtml += `
<div style="background:#fffbe6; border-left:6px solid #e67e22; margin-bottom:18px; padding:12px 18px; border-radius:8px;">
    <div style="font-weight:bold; color:#c0392b; margin-bottom:6px;">Kalınlık uyuşmazlığı</div>
    <table style="width:100%; border-collapse:collapse; margin-bottom:6px;">
        <thead>
    <tr style="background:#f3f3f3;">
        <th style="width:28px;"></th>
        <th>Parça Kodu</th>
        <th>PDF Kalınlık</th>
        <th>XML Kalınlık</th>
    </tr>
</thead>
<tbody>
    ${hatalar.map((hata, idx) => `
        <tr>
            <td style="width:28px;"><input type="checkbox" class="strike-checkbox" id="kesimCompareCheck_${tip}_${idx}"></td>
            <td style="font-weight:bold; color:black;">${hata.kodlar.join(", ")}</td>
            <td>${hata.pdfKalinlik}mm</td>
            <td>${(hata.xmlKalinliklar || []).join(", ")}mm</td>
        </tr>
    `).join("")}
</tbody>
    </table>
</div>
`;
                        } else {
                            // Diğer hata tipleri için ortak tablo
                            compareHtml += `
<div style="background:#fffbe6; border-left:6px solid #e67e22; margin-bottom:18px; padding:12px 18px; border-radius:8px;">
    <div style="font-weight:bold; color:#c0392b; margin-bottom:6px;">${tip}</div>
    <table style="width:100%; border-collapse:collapse; margin-bottom:6px;">
        <thead>
            <tr style="background:#f3f3f3;">
                <th style="width:28px;"></th>
                <th>Parça Kodu</th>
                <th>PDF Adet</th>
                <th>XML Adet</th>
            </tr>
        </thead>
        <tbody>
            ${hatalar.map((hata, idx) => `
                <tr>
                    <td style="width:28px;"><input type="checkbox" class="strike-checkbox" id="kesimCompareCheck_${tip}_${idx}"></td>
                    <td style="font-weight:bold; color:${hata.siparisDisi ? "#c0392b" : "black"};">
                        ${hata.kodlar.join(", ")}
                        ${hata.siparisDisi ? '<span style="color:#c0392b; font-weight:bold; margin-left:8px;">(Sipariş Dışı)</span>' : ""}
                    </td>
                    <td>${hata.pdfAdet}</td>
                    <td>${hata.xmlAdet}</td>
                </tr>
            `).join("")}
        </tbody>
    </table>
</div>
`;
                        }
                    });
                } else {
                    // Hata yok ama PDF yüklendiyse başarı mesajı göster
                    if (blokList.length > 0) {
                        compareHtml = `<div style="color:#27ae60; font-weight:bold; font-size:16px; padding:20px; text-align:center;">Tüm PDF blokları XML levha malzeme listesi ile uyumlu ✅</div>`;
                    }
                }

                document.getElementById('popupCompareResult').innerHTML = compareHtml;

                const kesimPopup = document.getElementById("kesimKarsilastirPopup");
                if (kesimPopup) {
                    kesimPopup.style.transition = "background-color 0.6s ease";
                    // Tüm hata durumlarını kontrol et - herhangi biri false ise kırmızı
                    const tumKontrollerBasarili = Object.values(hataDurumlari).every(durum => durum === true);
                    if (!tumKontrollerBasarili) {
                        // Herhangi bir hata varsa kırmızımsı arka plan
                        kesimPopup.style.backgroundColor = "rgba(231, 76, 60, 0.3)";
                    } else {
                        // Tüm kontroller başarılıysa yeşilimsi arka plan
                        kesimPopup.style.backgroundColor = "rgba(39, 174, 96, 0.4)";
                    }
                }

                // Checkbox ile satır üstü çiz
                setTimeout(() => {
                    document.querySelectorAll('#popupCompareResult .strike-checkbox').forEach(cb => {
                        cb.addEventListener('change', function () {
                            const tr = cb.closest('tr');
                            if (tr) tr.classList.toggle('strikeout', cb.checked);
                        });
                    });
                }, 0);
            }

            // tryCompare fonksiyonunu global olarak erişilebilir yap
            window.tryCompareKesim = tryCompare;

            // Kod normalize fonksiyonu
            function normalizeKod(kod) {
                return (kod || "")
                    .toString()
                    .trim()
                    .toUpperCase()
                    .replace(/-R\d+$/i, "")
                    .replace(/\s+/g, "");
            }

            const excelBtn = document.createElement("button");
            excelBtn.id = "btnKesimExcelExport";
            excelBtn.textContent = "Excel'e Aktar";
            excelBtn.style = `
    background:#27ae60;
    color:#fff;
    border:none;
    border-radius:4px;
    padding:8px 18px;
    font-size:15px;
    font-weight:bold;
    cursor:pointer;
    margin-left:12px;
    margin-bottom:10px;
    position:static;
`;
            // Başlığın hemen sonrasına ekle
            const h3 = popup.querySelector("h3");
            h3.parentNode.insertBefore(excelBtn, h3.nextSibling);

            // Excel'e Aktar fonksiyonu
            excelBtn.onclick = function () {
                // PDF dosyaları ve bloklar
                let pdfTable = [
                    ["PDF Dosyası", "Parça Kodu", "Adet", "Kalınlık"]
                ];
                const pdfListesiDiv = document.getElementById('popupPdfListesi');
                // PDF dosya adlarını ve blokları topla
                Array.from(pdfListesiDiv.querySelectorAll("b")).forEach(b => {
                    const pdfName = b.innerText.replace(/PDF'den Tanınan Parçalar \((.*?)\):/, "$1");
                    const table = b.nextElementSibling;
                    if (table && table.tagName === "TABLE") {
                        Array.from(table.querySelectorAll("tbody tr")).forEach(tr => {
                            const kod = tr.children[0]?.innerText.trim();
                            const adet = tr.children[1]?.innerText.trim();
                            const kalinlik = tr.children[2]?.innerText.trim();
                            pdfTable.push([pdfName, kod, adet, kalinlik]);
                        });
                    }
                });

                // Hatalar tablosu
                let hataTable = [
                    [" "]
                ];
                const compareResultDiv = document.getElementById('popupCompareResult');
                Array.from(compareResultDiv.querySelectorAll("li")).forEach(li => {
                    const kodlar = li.querySelector("b")?.innerText || "";
                    const pdfAdet = li.innerHTML.match(/PDF Adet:.*?<span.*?>(.*?)<\/span>/)?.[1] || "";
                    const xmlAdet = li.innerHTML.match(/XML Adet:.*?<span.*?>(.*?)<\/span>/)?.[1] || "";
                    const tip = li.innerHTML.match(/\((.*?)\)/)?.[1] || "";
                    hataTable.push([kodlar, pdfAdet, xmlAdet, tip]);
                });

                // CSV oluştur
                function toCSV(arr) {
                    return arr.map(row => row.map(cell => `"${cell}"`).join(";")).join("\r\n");
                }
                let csvContent = "\uFEFF" + toCSV(pdfTable) + "\r\n\r\n" + toCSV(hataTable);

                // İndir
                let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "kesim_listesi_karsilastirma.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        };

        // 1. Buton ekle
        const operasyonBtn = document.createElement("button");
        operasyonBtn.id = "btnOperasyonCesitleri";
        operasyonBtn.textContent = "Operasyon Çeşitleri";
        operasyonBtn.style = "background:#e67e22; color:#fff; border:none; border-radius:4px; padding:9px 18px; font-size:15px; font-weight:bold; cursor:pointer;";
        document.querySelector(".buton-grup").appendChild(operasyonBtn);

        // ...önceki kodlar...
        operasyonBtn.onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "operasyon") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            acikListe = "operasyon";
            if (!window.loadedXmlDoc) return;

            // Operasyonları topla
            const operasyonMap = {};
            const operasyonSet = new Set();
            const documents = window.loadedXmlDoc.querySelectorAll("document");
            documents.forEach(doc => {
                const conf = doc.querySelector("configuration");
                if (!conf) return;
                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(doc, "Parca_Kodu") || getAttributeValue(doc, "Name") || "Belirsiz";
                const desc = getAttributeValue(conf, "Description") || "";
                for (let i = 1; i <= 8; i++) {
                    const op = (getAttributeValue(conf, `OP${i}_Tanim`) || "").trim();
                    if (op) {
                        if (!operasyonMap[op]) operasyonMap[op] = [];
                        operasyonMap[op].push({ partCode, desc, rota: op });
                        operasyonSet.add(op);
                    }
                }
            });

            // Filtre kutusu HTML'i
            let filtreHtml = `
<div style="margin-bottom:10px;">
    <label for="operasyonFiltre">Operasyon Filtre:</label>
    <select id="operasyonFiltre">
        <option value="">Tümü</option>
        ${Array.from(operasyonSet).sort().map(op => `<option value="${op}">${op}</option>`).join("")}
    </select>
</div>
`;

            // Tablo oluştur
            let html = filtreHtml + `<b>Operasyon Çeşitlerine Göre Parça Kodları:</b>
<table style="margin-bottom:12px;" id="operasyonTable">
    <thead>
        <tr>
            <th>Parça Kodu</th>
            <th>Description</th>
            <th>Rota</th>
            <th>Kaplama / Statik Boya / Isıl İşlem</th>
        </tr>
    </thead>
    <tbody>
        ${Object.entries(operasyonMap).map(([op, kodlar]) =>
                kodlar.map((k) => {
                    // İlgili document'ı bul
                    const doc = Array.from(window.loadedXmlDoc.querySelectorAll("document")).find(d => {
                        const conf = d.querySelector("configuration");
                        if (!conf) return false;
                        const code = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "Belirsiz";
                        return code === k.partCode;
                    });
                    let kaplama = "", statikBoya = "", isilIslem = "";
                    if (doc) {
                        const conf = doc.querySelector("configuration");
                        kaplama = getAttributeValue(conf, "Kaplama") || "";
                        statikBoya = getAttributeValue(conf, "Boya_Parca_Tanimi") || "";
                        isilIslem = getAttributeValue(conf, "Isil_Islem") || "";
                    }
                    let diger = [];
                    // Sadece ilgili rotada göster
                    if (op.toUpperCase().includes("KAPLAMA") && kaplama) diger.push("Kaplama: " + kaplama);
                    if ((op.toUpperCase().includes("BOYA") || op.toUpperCase().includes("STATIK")) && statikBoya) diger.push("Statik Boya: " + statikBoya);
                    if (op.toUpperCase().includes("ISIL") && isilIslem) diger.push("Isıl İşlem: " + isilIslem);
                    return `
                <tr data-op="${op}">
                    <td>${k.partCode}</td>
                    <td>${k.desc}</td>
                    <td>${k.rota}</td>
                    <td>${diger.join("<br>")}</td>
                </tr>
                `;
                }).join("")
            ).join("")}
    </tbody>
</table>`;
            area.innerHTML = html;
            showExcelExport(true);

            const opFiltre = document.getElementById('operasyonFiltre');
            if (opFiltre) {
                opFiltre.onchange = function () {
                    const val = this.value;
                    document.querySelectorAll('#operasyonTable tbody tr').forEach(tr => {
                        if (!val || tr.getAttribute('data-op') === val) {
                            tr.style.display = "";
                        } else {
                            tr.style.display = "none";
                        }
                    });
                };
            }
        };



        // 3. Excel butonunu operasyon tablosu için de aktif et
        document.getElementById('btnExcelExport').onclick = function () {
            const area = document.getElementById('extraListArea');
            let table = area.querySelector("table");
            if (table) {
                let listeAdi = "liste";
                if (acikListe === "malzeme") listeAdi = "malzeme_listesi";
                else if (acikListe === "siparisDisi") listeAdi = "siparis_disi_listesi";
                else if (acikListe === "stdparca") listeAdi = "standart_parca_listesi";
                else if (acikListe === "operasyon") listeAdi = "operasyon_cesitleri";
                exportTableToExcel(table, `${currentXmlFileName}_${listeAdi}.csv`);
            }
        };

        const boyMalzemeBtn = document.createElement("button");
        boyMalzemeBtn.id = "btnBoyMalzeme";
        boyMalzemeBtn.textContent = "Boy Malzeme Hesapla";
        boyMalzemeBtn.style = "background:#2563eb; color:#fff; border:none; border-radius:4px; padding:9px 18px; font-size:15px; font-weight:bold; cursor:pointer;";
        document.querySelector(".buton-grup").appendChild(boyMalzemeBtn);

        // Boy Malzeme Hesapla butonu fonksiyonu (tam hali)
        boyMalzemeBtn.onclick = function () {
            // Popup aç
            let popup = document.createElement('div');
            popup.id = "boyMalzemePopup";
            popup.style.position = "fixed";
            popup.style.top = "0";
            popup.style.left = "0";
            popup.style.width = "100vw";
            popup.style.height = "100vh";
            popup.style.background = "rgba(0,0,0,0.25)";
            popup.style.zIndex = "99999";
            popup.innerHTML = `
    <div style="background:#fff; max-width:1100px; min-width:700px; margin:60px auto; border-radius:8px; box-shadow:0 2px 16px #0003; padding:32px 28px 24px 28px; position:relative; max-height:85vh; overflow:auto;">
        <button id="btnCloseBoyMalzeme" style="position:absolute; top:18px; right:18px; background:#c0392b; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:15px; cursor:pointer;">Kapat</button>
        <h3 style="margin-top:0;">Boy Malzeme Hesaplama</h3>
        <div id="boyMalzemeListArea"></div>
    </div>
    `;
            document.body.appendChild(popup);


            document.getElementById('btnCloseBoyMalzeme').onclick = function () {
                popup.remove();
            };

            // Accordion'daki tüm parçaları topla
            const accordionItems = document.querySelectorAll('.accordion-item');
            const profilCocukList = [];
            const digerList = [];
            accordionItems.forEach(item => {
                const title = item.querySelector('.accordion-title');
                if (!title) return;
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";
                if (partCode.endsWith("-0000")) return;

                const content = item.querySelector('.accordion-content');
                let description = "", uzunluk = "", adet = 0, malzeme = "", hammadde = "", ham_o1 = "", ham_o2 = "", isProfilCocuk = false;
                if (content) {
                    const rows = content.querySelectorAll('tbody tr');
                    rows.forEach(tr => {
                        const alan = tr.querySelector('td:first-child')?.innerText.trim();
                        const deger = tr.querySelector('td:last-child')?.innerText.trim();
                        if (alan === "Description") {
                            description = deger;
                            const descUp = (deger || "").toUpperCase();
                            if (
                                descUp.includes("PROFIL") ||
                                descUp.includes("NPU") ||
                                descUp.includes("KOSEBENT") ||
                                descUp.includes("IPE")
                            ) {
                                isProfilCocuk = true;
                            }
                        }
                        if (alan === "Uzunluk") uzunluk = deger;
                        if (alan === "Malzeme") malzeme = deger;
                        if (alan === "Hammadde") hammadde = deger;
                        if (alan === "Ham_o1") ham_o1 = deger;
                        if (alan === "Ham_o2") ham_o2 = deger;
                    });
                }
                const adetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                adet = adetMatch ? parseInt(adetMatch[1], 10) : 0;

                // Description'da @ geçenleri atla
                if (description.includes("@")) return;

                if (isProfilCocuk && uzunluk.trim() !== "") {
                    profilCocukList.push({
                        partCode,
                        description,
                        uzunluk,
                        adet
                    });
                } else {
                    if (malzeme && hammadde && ham_o1 && hammadde.trim().toUpperCase() !== "LEVHA") {
                        digerList.push({
                            partCode,
                            malzeme,
                            hammadde,
                            ham_o1,
                            uzunluk: ham_o2,
                            adet,
                            description
                        });
                    }
                }
            });

            // Profil çocuklarını description'a göre grupla
            const profilGroups = {};
            profilCocukList.forEach(item => {
                const key = item.description;
                if (!profilGroups[key]) profilGroups[key] = [];
                profilGroups[key].push(item);
            });

            // Diğer parçaları malzeme+hammadde+ham_o1'e göre grupla
            const digerGroups = {};
            digerList.forEach(item => {
                const key = item.malzeme + "|" + item.hammadde + "|" + item.ham_o1;
                if (!digerGroups[key]) digerGroups[key] = [];
                digerGroups[key].push(item);
            });

            // Listeyi oluştur
            let html = `<div style="margin-bottom:12px;"><b>Profiller:</b></div>`;
            Object.entries(profilGroups).forEach(([desc, list], idx) => {
                html += `
    <div class="boy-group" style="margin-bottom:10px;">
        <div class="boy-group-title" style="cursor:pointer; font-weight:bold; background:#f3f6ff; padding:8px; border-radius:6px;">
            ${desc} <span style="color:#888;">(${list.length} parça)</span>
        </div>
        <div class="boy-group-list" style="display:none; padding:8px 18px;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th>Parça Kodu</th>
                        <th>Uzunluk</th>
                        <th>Adet</th>
                    </tr>
                </thead>
                <tbody>
                    ${list.map(item => `
                        <tr>
                            <td>${item.partCode}</td>
                            <td>${item.uzunluk}</td>
                            <td>${item.adet}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        </div>
    </div>
    `;
            });

            // Diğer parçalar için
            if (Object.keys(digerGroups).length > 0) {
                html += `<div style="margin-bottom:12px;"><b>İmalat Parçaları:</b></div>`;
                Object.entries(digerGroups).forEach(([key, list], idx) => {
                    const [malzeme, hammadde, ham_o1] = key.split("|");
                    html += `
        <div class="boy-group" style="margin-bottom:10px;">
            <div class="boy-group-title" style="cursor:pointer; font-weight:bold; background:#f6f3ff; padding:8px; border-radius:6px;">
                ${malzeme} | ${hammadde} | ${ham_o1} <span style="color:#888;">(${list.length} parça)</span>
            </div>
            <div class="boy-group-list" style="display:none; padding:8px 18px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Parça Kodu</th>
                            <th>Uzunluk</th>
                            <th>Adet</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${list.map(item => `
                            <tr>
                                <td>${item.partCode}</td>
                                <td>${item.uzunluk}</td>
                                <td>${item.adet}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            </div>
        </div>
        `;
                });
            }

            document.getElementById('boyMalzemeListArea').innerHTML = html;

            // Açılır/kapanır mantığı
            document.querySelectorAll('.boy-group-title').forEach((title, i) => {
                title.onclick = function () {
                    const listDiv = title.nextElementSibling;
                    listDiv.style.display = listDiv.style.display === "none" ? "block" : "none";

                    // Eğer daha önce eklenmediyse, boy uzunluğu inputunu ve hesaplama butonunu ekle
                    if (!listDiv.querySelector('.boy-uzunluk-area')) {
                        const uzunlukDiv = document.createElement('div');
                        uzunlukDiv.className = 'boy-uzunluk-area';
                        uzunlukDiv.style = "margin-bottom:12px; margin-top:6px; display:flex; align-items:center; gap:12px;";
                        uzunlukDiv.innerHTML = `
        <label>Boy Uzunluğu (mm):</label>
        <input type="number" min="1000" max="12000" value="6000" style="width:90px; padding:6px 8px; border-radius:4px; border:1px solid #bbb; font-size:14px;">
        <button class="boyHesaplaBtn" style="padding:7px 14px; border-radius:4px; border:1px solid #bbb; background:#2563eb; color:#fff; font-size:14px; cursor:pointer;">Hesapla</button>
        <button class="boyGorselBtn" style="padding:7px 14px; border-radius:4px; border:1px solid #bbb; background:#27ae60; color:#fff; font-size:14px; cursor:pointer;">Boy Kesim Görselleştir</button>
        <span class="boyHesapSonuc" style="margin-left:18px; font-weight:bold;"></span>
    `;
                        listDiv.prepend(uzunlukDiv);

                        // Hesaplama fonksiyonu
                        uzunlukDiv.querySelector('.boyHesaplaBtn').onclick = function () {
                            const boyUzunluk = parseInt(uzunlukDiv.querySelector('input').value, 10) || 6000;
                            // Tablo satırlarını al
                            const rows = Array.from(listDiv.querySelectorAll('tbody tr'));
                            // Her satırdaki uzunluk ve adetleri topla
                            let parcalar = [];
                            let buyukler = []; // Boydan çıkamayanlar
                            rows.forEach(tr => {
                                const uzunluk = parseFloat(tr.children[1].innerText.replace(",", "."));
                                const adet = parseInt(tr.children[2].innerText, 10) || 0;
                                const kod = tr.children[0].innerText.trim();
                                if (uzunluk > boyUzunluk) {
                                    buyukler.push({ kod, uzunluk });
                                    return; // Bu parça boydan çıkamayacağı için ekleme!
                                }
                                if (uzunluk > 0 && adet > 0) {
                                    for (let i = 0; i < adet; i++) parcalar.push(uzunluk);
                                }
                            });
                            // Boylara yerleştirme algoritması (First Fit Decreasing)
                            parcalar.sort((a, b) => b - a);
                            let boylar = [];
                            parcalar.forEach(uz => {
                                let yerlesti = false;
                                for (let i = 0; i < boylar.length; i++) {
                                    if (boylar[i] + uz <= boyUzunluk) {
                                        boylar[i] += uz;
                                        yerlesti = true;
                                        break;
                                    }
                                }
                                if (!yerlesti) boylar.push(uz);
                            });
                            // Sonuçları göster
                            const toplamBoy = boylar.length;
                            const toplamOluAlan = boylar.reduce((sum, b) => sum + (boyUzunluk - b), 0);
                            let sonucHtml =
                                `Toplam Boy: <span style="color:#2563eb;">${toplamBoy}</span> &nbsp; | &nbsp; Toplam Ölü Alan: <span style="color:#c0392b;">${toplamOluAlan.toLocaleString("tr-TR")}</span> mm`;
                            if (buyukler.length > 0) {
                                sonucHtml += `<br><span style="color:#c0392b; font-weight:bold;">Boydan çıkamayan parçalar:</span><ul style="margin:6px 0 0 0; color:#c0392b;">${buyukler.map(x => `<li><b>${x.kod}</b> &rarr; ${x.uzunluk} mm</li>`).join("")
                                    }</ul>`;
                            }
                            uzunlukDiv.querySelector('.boyHesapSonuc').innerHTML = sonucHtml;
                        };

                        // Görselleştirme fonksiyonu
                        uzunlukDiv.querySelector('.boyGorselBtn').onclick = function () {
                            const boyUzunluk = parseInt(uzunlukDiv.querySelector('input').value, 10) || 6000;
                            const rows = Array.from(listDiv.querySelectorAll('tbody tr'));
                            let parcalar = [];
                            let renkMap = {};
                            let kodlar = [];
                            let buyukler = []; // Boydan çıkamayanlar
                            rows.forEach(tr => {
                                const kod = tr.children[0].innerText.trim();
                                const uzunluk = parseFloat(tr.children[1].innerText.replace(",", "."));
                                const adet = parseInt(tr.children[2].innerText, 10) || 0;
                                if (uzunluk > boyUzunluk) {
                                    buyukler.push({ kod, uzunluk });
                                    return; // Bu parça boydan çıkamayacağı için ekleme!
                                }
                                if (uzunluk > 0 && adet > 0) {
                                    if (!kodlar.includes(kod)) kodlar.push(kod);
                                    for (let i = 0; i < adet; i++) parcalar.push({ kod, uzunluk });
                                }
                            });

                            // Site temasına uygun renk paleti
                            const modernRenkler = [
                                '#2563eb', '#27ae60', '#e67e22', '#8e44ad', '#3498db',
                                '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e74c3c',
                                '#34495e', '#16a085', '#f1c40f', '#d35400', '#7f8c8d',
                                '#2c3e50', '#18bc9c', '#f39800', '#663399', '#95a5a6'
                            ];

                            kodlar.forEach((kod, i) => {
                                if (i < modernRenkler.length) {
                                    renkMap[kod] = modernRenkler[i];
                                } else {
                                    // Fazla parça varsa HSL ile dinamik renk üret
                                    let hue = ((i - modernRenkler.length) * 137.5) % 360; // Golden angle
                                    renkMap[kod] = `hsl(${hue}, 70%, 75%)`;
                                }
                            });

                            // First Fit Decreasing algoritması ile boylara yerleştir
                            parcalar.sort((a, b) => b.uzunluk - a.uzunluk);
                            let boylar = [];
                            parcalar.forEach(p => {
                                let yerlesti = false;
                                for (let i = 0; i < boylar.length; i++) {
                                    if (boylar[i].kalan + p.uzunluk <= boyUzunluk) {
                                        boylar[i].parcalar.push(p);
                                        boylar[i].kalan += p.uzunluk;
                                        yerlesti = true;
                                        break;
                                    }
                                }
                                if (!yerlesti) boylar.push({ parcalar: [p], kalan: p.uzunluk });
                            });

                            // Popup oluştur
                            let popup = document.createElement('div');
                            popup.id = "boyKesimGorselPopup";
                            popup.style.position = "fixed";
                            popup.style.top = "0";
                            popup.style.left = "0";
                            popup.style.width = "100vw";
                            popup.style.height = "100vh";
                            popup.style.background = "rgba(0,0,0,0.35)";
                            popup.style.zIndex = "999999";
                            popup.innerHTML = `
    <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        max-width: 1400px; 
        min-width: 900px; 
        margin: 40px auto; 
        border-radius: 20px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        padding: 0; 
        position: relative; 
        max-height: 90vh; 
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
    ">
        <div style="
            background: rgba(255,255,255,0.95);
            margin: 3px;
            border-radius: 17px;
            padding: 32px;
            max-height: calc(90vh - 6px);
            overflow: auto;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
                <h1 style="margin: 0; color: #2563eb; font-size: 24px; font-weight: 700;">Boy Kesim Optimizasyonu</h1>
                <div style="display: flex; gap: 12px;">
                <button id="btnPrintBoyKesim" style="
                    background: #27ae60;
                    color: #fff; 
                    border: none; 
                    border-radius: 6px; 
                    padding: 10px 20px; 
                    font-size: 14px; 
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#229954';" onmouseout="this.style.background='#27ae60';">Yazdır</button>
                
                <button id="btnCloseBoyKesimGorsel" style="
                    background: #c0392b;
                    color: #fff; 
                    border: none; 
                    border-radius: 6px; 
                    padding: 10px 20px; 
                    font-size: 14px; 
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#a93226';" onmouseout="this.style.background='#c0392b';">Kapat</button>
                </div>
            </div>

            <div id="boyKesimKodRenkler" style="
                margin-bottom: 24px; 
                display: flex; 
                flex-wrap: wrap; 
                gap: 12px; 
                justify-content: flex-start;
                background: #f6f6f6;
                padding: 16px;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
            ">
                <h3 style="width: 100%; text-align: left; margin: 0 0 12px 0; color: #2563eb; font-size: 16px; font-weight: 600;">Parça Renk Kodları</h3>
                ${kodlar.map(kod => `
                    <div style="
                        display: flex; 
                        align-items: center; 
                        gap: 10px; 
                        background: #fff;
                        padding: 8px 16px;
                        border-radius: 25px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border: 1px solid #e9ecef;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                        <div style="
                            width: 16px; 
                            height: 16px; 
                            border-radius: 3px; 
                            background: ${renkMap[kod]}; 
                            border: 1px solid #ccc;
                        "></div>
                        <span style="font-weight: 500; color: #333; font-size: 13px;">${kod}</span>
                    </div>
                `).join("")}
            </div>
            <div id="boyKesimCanvasArea"></div>
        </div>
    </div>
    `;
                            document.body.appendChild(popup);

                            document.getElementById('btnCloseBoyKesimGorsel').onclick = function () {
                                popup.remove();
                            };

                            // Yazdır butonu fonksiyonu
                            document.getElementById('btnPrintBoyKesim').onclick = function () {
                                const printContent = createPrintableKesimLayout(boylar, boyUzunluk, renkMap, kodlar, buyukler);

                                const printWindow = window.open('', '_blank');
                                printWindow.document.write(printContent);
                                printWindow.document.close();
                                printWindow.focus();
                                printWindow.print();
                            };

                            // Her boy için modern SVG görselleştirme
                            let visualHtml = "";
                            boylar.forEach((boy, idx) => {
                                visualHtml += `<div class="boy-kesim-container" style="margin-bottom:24px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px; border:1px solid #e0e0e0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0; color:#2563eb; font-size:18px; font-weight:600;">Boy Malzeme ${idx + 1}</h3>
                <div style="display:flex; gap:24px; font-size:14px;">
                    <span style="background:#e8f5e8; color:#27ae60; padding:6px 12px; border-radius:20px; font-weight:600;">
                        Kullanılan: ${boy.kalan.toFixed(2)} mm
                    </span>
                    ${(boyUzunluk - boy.kalan) > 1 ? `<span style="background:#ffe8e8; color:#e74c3c; padding:6px 12px; border-radius:20px; font-weight:600;">
                        Fire: ${(boyUzunluk - boy.kalan).toFixed(2)} mm
                    </span>` : ''}
                    <span style="background:#e8f4ff; color:#2563eb; padding:6px 12px; border-radius:20px; font-weight:600;">
                        Verimlilik: ${((boy.kalan / boyUzunluk) * 100).toFixed(1)}%
                    </span>
                </div>
            </div>
            <div class="boy-kesim-visual" style="position:relative; background:linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%); border-radius:8px; padding:16px; min-height:80px; border:2px solid #dee2e6;">
                <div class="kesim-bar" style="display:flex; height:48px; border-radius:6px; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.1); background:#ffffff; border:1px solid #ced4da;" id="kesimBar_${idx}"></div>
            </div>
        </div>`;
                            });
                            popup.querySelector('#boyKesimCanvasArea').innerHTML = visualHtml;

                            let sonucHtml = "";
                            if (buyukler.length > 0) {
                                sonucHtml += `<br><span style="color:#c0392b; font-weight:bold;">Boydan çıkamayan parçalar:</span><ul style="margin:6px 0 0 0; color:#c0392b;">${buyukler.map(x => `<li><b>${x.kod}</b> &rarr; ${x.uzunluk} mm</li>`).join("")
                                    }</ul>`;
                            }
                            uzunlukDiv.querySelector('.boyHesapSonuc').innerHTML = sonucHtml;

                            // Modern görselleştirme oluştur
                            boylar.forEach((boy, idx) => {
                                const kesimBar = document.getElementById(`kesimBar_${idx}`);
                                let barHtml = '';
                                let usedWidth = 0;

                                boy.parcalar.forEach((p, i) => {
                                    const percentage = (p.uzunluk / boyUzunluk) * 100;
                                    const segmentColor = renkMap[p.kod];
                                    // Minimum genişlik 30px (yaklaşık %2.7) olsun ki küçük parçalar okunabilir olsun
                                    const minWidth = Math.max(percentage, 2.7);

                                    barHtml += `
                                        <div class="kesim-segment" 
                                             style="
                                                 flex: none; 
                                                 width: ${minWidth}%; 
                                                 min-width: 30px;
                                                 background: linear-gradient(145deg, ${segmentColor}, ${segmentColor}dd);
                                                 border-right: 2px solid #fff;
                                                 position: relative;
                                                 display: flex;
                                                 align-items: center;
                                                 justify-content: center;
                                                 transition: all 0.3s ease;
                                                 cursor: pointer;
                                                 min-height: 48px;
                                                 overflow: visible;
                                                 z-index: 1;
                                             "
                                             title="Parça: ${p.kod} | Uzunluk: ${p.uzunluk} mm"
                                             onmouseover="this.style.transform='scaleY(1.1)'; this.style.zIndex='100'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                                             onmouseout="this.style.transform='scaleY(1)'; this.style.zIndex='1'; this.style.boxShadow='none';">
                                            <div style="
                                                color: #2c3e50; 
                                                font-weight: 700; 
                                                font-size: ${percentage < 3 ? '9px' : '11px'}; 
                                                text-align: center;
                                                text-shadow: 0 1px 2px rgba(255,255,255,0.8);
                                                writing-mode: ${percentage > 5 ? 'horizontal-tb' : 'vertical-lr'};
                                                text-orientation: mixed;
                                                line-height: 1.1;
                                                padding: 2px;
                                                white-space: ${percentage < 3 ? 'nowrap' : 'normal'};
                                            ">${percentage < 3 ? p.uzunluk : p.uzunluk + 'mm'}</div>
                                        </div>`;

                                    usedWidth += percentage;
                                });

                                // Fire alanı - sadece fire miktarı 1mm'den büyükse göster
                                const fireAmount = boyUzunluk - boy.kalan;
                                if (fireAmount > 1) {
                                    const firePercentage = (fireAmount / boyUzunluk) * 100;
                                    barHtml += `
                                        <div class="fire-segment" 
                                             style="
                                                 flex: none; 
                                                 width: ${firePercentage}%; 
                                                 min-width: 20px;
                                                 background: repeating-linear-gradient(
                                                     45deg,
                                                     #ffebee,
                                                     #ffebee 8px,
                                                     #ffcdd2 8px,
                                                     #ffcdd2 16px
                                                 );
                                                 border-left: 2px solid #f44336;
                                                 display: flex;
                                                 align-items: center;
                                                 justify-content: center;
                                                 position: relative;
                                                 min-height: 48px;
                                             "
                                             title="Fire Alanı: ${fireAmount.toFixed(2)} mm">
                                            <div style="
                                                color: #c62828; 
                                                font-weight: 700; 
                                                font-size: ${firePercentage > 5 ? '10px' : '8px'}; 
                                                text-align: center;
                                                background: rgba(255,255,255,0.9);
                                                padding: 2px 4px;
                                                border-radius: 3px;
                                                border: 1px solid #f44336;
                                            ">FİRE<br>${fireAmount.toFixed(0)}mm</div>
                                        </div>`;
                                }

                                kesimBar.innerHTML = barHtml;
                            });
                        };

                        // Yazdırmaya optimize edilmiş layout oluşturma fonksiyonu
                        function createPrintableKesimLayout(boylar, boyUzunluk, renkMap, kodlar, buyukler) {
                            const now = new Date();
                            const today = now.toLocaleDateString('tr-TR');
                            const time = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                            let toplamBoy = boylar.length;
                            let toplamKullanim = boylar.reduce((sum, boy) => sum + boy.kalan, 0);
                            let toplamFire = (toplamBoy * boyUzunluk) - toplamKullanim;
                            let verimlilik = ((toplamKullanim / (toplamBoy * boyUzunluk)) * 100).toFixed(1);

                            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kesim Planı - ${today}</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 15mm;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #2c3e50;
        }
        .company-info {
            flex: 1;
        }
        .company-info h1 {
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .company-info p {
            margin: 2px 0;
            font-size: 10px;
            color: #7f8c8d;
        }
        .document-info {
            text-align: right;
            flex: 1;
        }
        .document-info h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #e74c3c;
            font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0 25px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            text-align: center;
        }
        .stat-card.success { border-left-color: #27ae60; }
        .stat-card.warning { border-left-color: #f39c12; }
        .stat-card.danger { border-left-color: #e74c3c; }
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        .stat-label {
            font-size: 9px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 500;
        }
        .material-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        .material-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .material-bar {
            background: white;
            border: 2px solid #34495e;
            border-top: none;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
            position: relative;
        }
        .cut-visual {
            display: flex;
            height: 40px;
            position: relative;
        }
        .cut-piece {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #2c3e50;
            border-right: 2px solid white;
            position: relative;
            text-shadow: 0 1px 1px rgba(255,255,255,0.8);
            transition: all 0.2s;
        }
        .cut-piece:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }
        .waste-piece {
            background: repeating-linear-gradient(
                45deg,
                #ecf0f1,
                #ecf0f1 8px,
                #bdc3c7 8px,
                #bdc3c7 16px
            );
            color: #7f8c8d;
            font-style: italic;
        }
        .pieces-info {
            background: #f8f9fa;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-top: none;
            font-size: 11px;
            display: flex;
            justify-content: center;
        }
        .efficiency-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 8px;
        }
        .efficiency-high { background: #d4edda; color: #155724; }
        .efficiency-medium { background: #fff3cd; color: #856404; }
        .efficiency-low { background: #f8d7da; color: #721c24; }
        .legend-section {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        .oversized-parts {
            margin-top: 20px;
            padding: 15px;
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
            border-radius: 0 8px 8px 0;
        }
        .oversized-title {
            color: #c53030;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .oversized-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .oversized-item {
            padding: 4px 0;
            border-bottom: 1px solid #fed7d7;
            font-size: 10px;
        }
        @media print {
            body { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .material-section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <div class="company-info">
            <h1>MALZEME KESİM PLANI</h1>
            <p>Optimizasyon Raporu</p>
            <p>Tarih: ${today} ${time}</p>
        </div>
        <div class="document-info">
            <h2>KESİM LİSTESİ</h2>
            <p>Boy Uzunluğu: <strong>${boyUzunluk}mm</strong></p>
            <p>Toplam Boy: <strong>${toplamBoy} adet</strong></p>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card success">
            <div class="stat-value">${toplamKullanim.toFixed(0)}mm</div>
            <div class="stat-label">Toplam Kullanım</div>
        </div>
        <div class="stat-card ${toplamFire > (toplamKullanim * 0.1) ? 'danger' : 'warning'}">
            <div class="stat-value">${toplamFire.toFixed(0)}mm</div>
            <div class="stat-label">Toplam Fire</div>
        </div>
        <div class="stat-card ${verimlilik > 80 ? 'success' : verimlilik > 60 ? 'warning' : 'danger'}">
            <div class="stat-value">%${verimlilik}</div>
            <div class="stat-label">Verimlilik</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${kodlar.length}</div>
            <div class="stat-label">Farklı Parça</div>
        </div>
    </div>

    ${boylar.map((boy, idx) => {
                                const efficiency = ((boy.kalan / boyUzunluk) * 100);
                                const efficiencyClass = efficiency > 85 ? 'efficiency-high' : efficiency > 70 ? 'efficiency-medium' : 'efficiency-low';
                                const fireAmount = boyUzunluk - boy.kalan;

                                return `
        <div class="material-section">
            <div class="material-header">
                <span>🔧 Malzeme ${idx + 1}</span>
                <span class="efficiency-badge ${efficiencyClass}">Verimlilik: %${efficiency.toFixed(1)}</span>
            </div>
            <div class="material-bar">
                <div class="cut-visual">
                    ${boy.parcalar.map(p => {
                                    const percentage = (p.uzunluk / boyUzunluk) * 100;
                                    const color = renkMap[p.kod] || '#bdc3c7';
                                    return `<div class="cut-piece" style="width: ${percentage}%; background: ${color};">${p.uzunluk}</div>`;
                                }).join('')}
                    ${fireAmount > 1 ? `<div class="cut-piece waste-piece" style="width: ${(fireAmount / boyUzunluk) * 100}%;">Fire</div>` : ''}
                </div>
            </div>
            <div class="pieces-info">
                <div style="flex: 1; display: flex; justify-content: center; align-items: center; gap: 20px;">
                    <span style="color: #27ae60; font-weight: 600;"><strong>✓ Kullanılan: ${boy.kalan.toFixed(0)}mm</strong></span>
                    ${fireAmount > 1 ? `<span style="color: #e74c3c; font-weight: 600;"><strong>✗ Fire: ${fireAmount.toFixed(0)}mm</strong></span>` : ''}
                    <span style="color: #2563eb; font-weight: 600;"><strong>📊 Verimlilik: %${efficiency.toFixed(1)}</strong></span>
                </div>
            </div>
        </div>`
                            }).join('')}

    <div class="legend-section">
        <div class="legend-title">📋 PARÇA RENK KODLARI</div>
        <div class="legend-grid">
            ${kodlar.map(kod => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${renkMap[kod]};"></div>
                    <span><strong>${kod}</strong></span>
                </div>
            `).join('')}
        </div>
    </div>

    ${buyukler.length > 0 ? `
    <div class="oversized-parts">
        <div class="oversized-title">⚠️ BOYDAN ÇIKAMAYAN PARÇALAR</div>
        <ul class="oversized-list">
            ${buyukler.map(x => `
                <li class="oversized-item">
                    <strong>${x.kod}:</strong> ${x.uzunluk}mm 
                    <span style="color: #718096;">(${boyUzunluk}mm boydan ${(x.uzunluk - boyUzunluk)}mm fazla)</span>
                </li>
            `).join('')}
        </ul>
    </div>` : ''}
</body>
</html>`;
                        }
                    }
                };
            });
        };

        const btnTumParcaAdetleri = document.createElement("button");
        btnTumParcaAdetleri.id = "btnTumParcaAdetleri";
        btnTumParcaAdetleri.textContent = "Tüm Parça Adetleri";
        btnTumParcaAdetleri.style = "background:#e67e22; color:#fff; border:none; border-radius:4px; padding:8px 22px; font-size:15px; font-weight:bold; cursor:pointer; ";
        document.querySelector(".buton-grup").appendChild(btnTumParcaAdetleri);

        btnTumParcaAdetleri.onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "tumParcaAdetleri") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            // Accordion'daki tüm parçaları oku
            const accordionItems = document.querySelectorAll('.accordion-item');
            const parcaAdetMap = {};
            accordionItems.forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                if (!title || !content) return;

                // Parça kodunu bul
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                const partCode = kodMatch ? kodMatch[1].trim() : "";
                if (!partCode) return;

                // Sheet ve cut-list-item içerenleri hariç tut
                const titleText = title.innerText.toUpperCase();
                if (
                    titleText.includes("SHEET") ||
                    titleText.includes("KESIM LISTESI") ||
                    titleText.includes("CUT-LIST-ITEM")
                ) return;

                // Sipariş dışı ve profil dışarda bırak kontrolü
                let siparisDisiBirak = "", profilDisardaBirak = "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Siparis_Disi_Birak") siparisDisiBirak = (deger || "").trim();
                    if (alan === "Profil_Disarda_Birak") profilDisardaBirak = (deger || "").trim().toUpperCase();
                });
                if (siparisDisiBirak === "1" || profilDisardaBirak === "DIŞARDA BIRAK") return;

                // Toplam adet
                const toplamAdetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                const toplamAdet = toplamAdetMatch ? parseInt(toplamAdetMatch[1], 10) : 0;

                if (!parcaAdetMap[partCode]) parcaAdetMap[partCode] = 0;
                parcaAdetMap[partCode] += toplamAdet;
            });

            // Tabloyu oluştur
            const parcaList = Object.entries(parcaAdetMap)
                .filter(([code, adet]) => adet > 0)
                .sort((a, b) => a[0].localeCompare(b[0]));

            if (parcaList.length === 0) {
                area.innerHTML = "<b>Sipariş dışı olmayan ve profil dışarda bırakılmamış parça bulunamadı.</b>";
            } else {
                area.innerHTML = `<b>Tüm Montaj ve Parçalar:</b>
<table style="margin-bottom:12px;" id="tumParcaAdetTable">
    <thead>
        <tr>
            <th>Parça Kodu</th>
            <th>Toplam Adet</th>
        </tr>
    </thead>
    <tbody>
        ${parcaList.map(([code, adet]) => `
            <tr>
                <td>${code}</td>
                <td>${adet}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;
            }
            acikListe = "tumParcaAdetleri";
            showExcelExport(true);
        };

        // Excel butonuna tıklayınca bu tabloyu da aktarabilsin
        document.getElementById('btnExcelExport').onclick = function () {
            const area = document.getElementById('extraListArea');
            let table = area.querySelector("table");
            if (table) {
                let listeAdi = "liste";
                if (acikListe === "malzeme") listeAdi = "malzeme_listesi";
                else if (acikListe === "siparisDisi") listeAdi = "siparis_disi_listesi";
                else if (acikListe === "stdparca") listeAdi = "standart_parca_listesi";
                else if (acikListe === "operasyon") listeAdi = "operasyon_cesitleri";
                else if (acikListe === "multiXmlList") listeAdi = "tum_xml_parcalari";
                else if (acikListe === "tumParcaAdetleri") listeAdi = "tum_parca_adetleri";
                exportTableToExcel(table, `${currentXmlFileName}_${listeAdi}.csv`);
            }
        };

        // Hata türleri ve açıklamaları popup fonksiyonu
        function showHataTurleriPopup() {
            let popup = document.createElement('div');
            popup.id = "hataTurleriPopup";
            popup.style.position = "fixed";
            popup.style.top = "0";
            popup.style.left = "0";
            popup.style.width = "100vw";
            popup.style.height = "100vh";
            popup.style.background = "rgba(0,0,0,0.25)";
            popup.style.zIndex = "99999";
            popup.style.overflow = "auto";
            popup.innerHTML = `
<div style="background:#fff; max-width:900px; min-width:400px; margin:60px auto; border-radius:8px; box-shadow:0 2px 16px #0003; padding:32px 28px 24px 28px; position:relative; max-height:85vh; overflow:auto;">
    <button id="btnCloseHataTurleri" style="position:absolute; top:18px; right:18px; background:#c0392b; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:15px; cursor:pointer;">Kapat</button>
    <h2 style="margin-top:0;">Hata Türleri ve Açıklamaları</h2>
    <div style="font-size:15px; color:#333;">
        <ol style="padding-left:18px;">
            <li>
                <b>Profil ana parça için hatalı dışarda bırakılmış çocuk profil</b>
                <div class="hata-aciklama">Profil ana parçasına ait olması gereken çocuk profil, dışarıda bırakılmış veya tanımı hatalı olabilir.<br>
                <em>Örnek: Ana parça SCS-0001-0000001 için çocuk profil eksik veya yanlış tanımlanmış.</em></div>
            </li>
            <li>
                <b>Malzeme ERP Kodu boş veya hatalı olan parçalar</b>
                <div class="hata-aciklama">Malzeme ERP kodu eksik veya yanlış girilmiş. ERP entegrasyonu için bu alanın doğru olması gerekir.<br>
                <em>Örnek: Parça kodu SCS-0001-0000002 için ERP kodu boş veya 99 gibi geçersiz bir değer.</em></div>
            </li>
            <li>
                <b>Hatalı MNG Parça Kodları</b>
                <div class="hata-aciklama">İmalat tipi MNG olan parçalarda kod formatı hatalı. Son üç hanesi 000 olmalı.<br>
                <em>Örnek: SCS-0001-0000003 kodlu parça MNG ama sonu 123 ile bitiyor.</em></div>
            </li>
            <li>
                <b>Hatalı Parça Kodları (Varyant ve kök kod çakışmaları)</b>
                <div class="hata-aciklama">Aynı kökten gelen varyantlı ve varyantsız parça kodları aynı anda mevcut.<br>
                <em>Örnek: SCS-0001-0000004 ve SCS-0001-0000004-0001 birlikte var.</em></div>
            </li>
            <li>
                <b>İmalat Tipi boş olan parçalar</b>
                <div class="hata-aciklama">Parçanın imalat tipi belirtilmemiş. Üretim sürecinde bu bilgi gereklidir. Sipariş dışı olanlar ayrıca belirtilir.<br>
                <em>Örnek: SCS-0001-0000005 kodlu parçada İmalat Tipi alanı boş.</em></div>
            </li>
            <li>
                <b>Parça kodu -0000 ile bitip İmalat Tipi IML olan parçalar</b>
                <div class="hata-aciklama">Ana montaj kodu -0000 ile bitiyorsa İmalat Tipi IML olmamalı.<br>
                <em>Örnek: SCS-0001-0000000 kodlu parça IML olarak işaretlenmiş.</em></div>
            </li>
            <li>
                <b>Aynı parça kodu ile iki farklı imalat tipi ile düşen parçalar</b>
                <div class="hata-aciklama">Aynı parça kodu hem IML hem MNG gibi birden fazla imalat tipiyle kullanılmış.<br>
                <em>Örnek: SCS-0001-0000006 hem IML hem MNG olarak var.</em></div>
            </li>
            <li>
                <b>İmalat tipi yanlış olan parçalar</b>
                <div class="hata-aciklama">İmalat tipi tanımlı olmayan veya geçersiz bir değer.<br>
                <em>Örnek: SCS-0001-0000007 kodlu parçada İmalat Tipi "XYZ" gibi geçersiz.</em></div>
            </li>
            <li>
                <b>Profil çocuk parçalarda Description bilgisinde hatalı karakter/kod bulunanlar</b>
                <div class="hata-aciklama">Profil çocuk parça açıklamasında @, -R00 gibi hatalı karakterler veya uzantılar var.<br>
                <em>Örnek: Description alanında "NPU/100x50@2" veya "IPE-100-R00".</em></div>
            </li>
            <li>
                <b>Profil çocuk parçalarda "Profil_Disarda_Birak" alanı "DIŞARDA BIRAK" olmayanlar</b>
                <div class="hata-aciklama">Profil çocuk parçada "Profil_Disarda_Birak" alanı eksik veya yanlış.<br>
                <em>Örnek: SCS-0001-0000008 kodlu profil çocukta bu alan boş veya farklı bir değer.</em></div>
            </li>
            <li>
                <b>Dışarda bırakılmış imalatlık parça (reçetede çıkabilir)</b>
                <div class="hata-aciklama">Sipariş dışı bırakılmış ve hammadde bilgisi STD olan parça, üst montajlardan en az biri sipariş dışı değilse reçetede çıkabilir.<br>
                <em>Örnek: SCS-0001-0000009 kodlu parça ve üst montaj zinciri.</em></div>
            </li>
            <li>
                <b>Profil ölçüsü ,00 içeren parçalar</b>
                <div class="hata-aciklama">Profil ölçüsünde ondalık kısmı ,00 olan tanımlar var. Ölçüde gereksiz ondalık kullanılmamalı.<br>
                <em>Örnek: "NPU/260,00x90,00" gibi.</em></div>
            </li>
            <li>
                <b>Birden fazla configuration içeren document etiketleri (hatalı)</b>
                <div class="hata-aciklama">Aynı document etiketi içinde birden fazla configuration var. Her document için tek configuration olmalı.<br>
                <em>Örnek: SCS-0001-0000010 document etiketi içinde iki configuration.</em></div>
            </li>
            <li>
                <b>Profil tanım boyunda PROFIL/KOSEBENT/NPU geçmeyen profil benzeri parçalar</b>
                <div class="hata-aciklama">Profil tanım boyunda profil tipi anahtar kelimeleri eksik.<br>
                <em>Örnek: "260x90 L=6000" gibi, "NPU" veya "PROFIL" yok.</em></div>
            </li>
            <li>
                <b>Sipariş dışı bırakılmış montajlar</b>
                <div class="hata-aciklama">İmalat tipi MNG olan ve sipariş dışı bırakılmış montajlar.<br>
                <em>Örnek: SCS-0001-0000011 kodlu montaj sipariş dışı.</em></div>
            </li>
            <li>
                <b>DÖKÜM, KALİTE, BOYA, BÜKÜM veya TESVİYE rotası girilmiş parçalar</b>
                <div class="hata-aciklama">Operasyon rotasında özel işlem (döküm, kalite, boya, büküm, tesviye) tanımlanmış.<br>
                <em>Örnek: SCS-0001-0000012 için OP3_Tanim = "BÜKÜM".</em></div>
            </li>
            <li>
                <b>Parça kodu formatı hatalı olanlar</b>
                <div class="hata-aciklama">Parça kodunda özel karakter, yanlış uzunluk veya yanlış başlangıç var.<br>
                <em>Örnek: "SCS_0001-0000013" veya "123456A".</em></div>
            </li>
            <li>
                <b>Uzunluk alanı boş olan profiller</b>
                <div class="hata-aciklama">Profil çocuk parçada uzunluk alanı boş bırakılmış.<br>
                <em>Örnek: SCS-0001-0000014 kodlu profilin uzunluğu girilmemiş.</em></div>
            </li>
            <li>
                <b>Ana parça kodu ile çocuk parça kodları farklı düşen parçalar</b>
                <div class="hata-aciklama">Ana parça ile çocuk parça kodu arasında tutarsızlık var.<br>
                <em>Örnek: Ana parça SCS-0001-0000015, çocuk parça SCS-0001-0000016.</em></div>
            </li>
            <li>
                <b>Revizyonu boş, "-" veya REV00 olan 6 haneli olmayan parçalar</b>
                <div class="hata-aciklama">6 haneden uzun parça kodlarında revizyon alanı boş, "-" veya yanlış formatta.<br>
                <em>Örnek: SCS-0001-0000017 revizyonu boş.</em></div>
            </li>
            <li>
                <b>Ham_o2 (uzunluk/miktar) alanı boş olan ve miktarı hesaplanamayan parçalar</b>
                <div class="hata-aciklama">Profil veya levha parçalarda Ham_o2 alanı boş bırakılmış, miktar hesaplanamıyor.<br>
                <em>Örnek: SCS-0001-0000018 kodlu parçada Ham_o2 yok.</em></div>
            </li>
            <li>
                <b>Ölçüsü dolu olup hammadde bilgisi boş olan parçalar</b>
                <div class="hata-aciklama">Parçada ölçü girilmiş ama hammadde alanı boş.<br>
                <em>Örnek: SCS-0001-0000019 ölçü var, hammadde yok.</em></div>
            </li>
            <li>
                <b>Parça kodu, Name alanında geçmeyen ana parçalar veya montajlar</b>
                <div class="hata-aciklama">Parça kodu, dosya adında (Name) geçmiyorsa, bu parça ile dosya adı arasında tutarsızlık olabilir. Sipariş dışı olanlar ayrıca belirtilir.<br>
                <em>Örnek: SCS-0001-0000020 kodlu parça, Name alanında yok.</em></div>
            </li>
            <li>
                <b>Rotasında KAPLAMA olup Kaplama değeri boş olan parçalar</b>
                <div class="hata-aciklama">Operasyon rotasında KAPLAMA işlemi var fakat Kaplama alanı boş bırakılmış.<br>
                <em>Örnek: SCS-0001-0000021 için OP2_Tanim = "KAPLAMA", Kaplama alanı boş.</em></div>
            </li>
            <li>
                <b>Profil dışarıda bırakıldığı için dışarıda kalmış ve montaj reçetesine çekilmiş (profil olmayanlar)</b>
                <div class="hata-aciklama">Profil dışarıda bırakılmış ama profil olmayan bir parça montaj reçetesine eklenmiş.<br>
                <em>Örnek: SCS-0001-0000022 kodlu parça, profil dışı olarak işaretlenmiş.</em></div>
            </li>
            <li>
                <b>Malzeme bilgisi yanlış olan parçalar</b>
                <div class="hata-aciklama">Malzeme alanı boş, yanlış veya standart dışı bir değer girilmiş.<br>
                <em>Örnek: SCS-0001-0000023 kodlu parçada malzeme "ABC123".</em></div>
            </li>
            <li>
                <b>Standart parçalarda malzeme hatası (işlenen STD)</b>
                <div class="hata-aciklama">İşlenen standart parçalarda malzeme alanı boş veya yanlış.<br>
                <em>Örnek: SCS-0001-0000024 kodlu STD parçada malzeme eksik.</em></div>
            </li>
            <li>
                <b>Profil tanım boyunda hatalı karakter olup çocuk parça ile eşleşmeyenler</b>
                <div class="hata-aciklama">Profil tanım boyunda @, <, >, ", &quot; gibi hatalı karakterler var.<br>
                <em>Örnek: "NPU/260,00x90,00@2" gibi bir tanım.</em></div>
            </li>
            <li>
                <b>Profil tanımında L= miktarı ile çocukların toplam uzunluğu uyuşmayanlar</b>
                <div class="hata-aciklama">Profil tanımında belirtilen L= miktarı ile çocukların toplam uzunluğu birbirini tutmuyor.<br>
                <em>Örnek: L=6000 yazılmış ama çocukların toplamı 5900 mm.</em></div>
            </li>
            <li>
                <b>Bilgileri doğru olmayan profil ana parçaları</b>
                <div class="hata-aciklama">Profil ana parçasında zorunlu alanlar eksik veya yanlış doldurulmuş.<br>
                <em>Örnek: Profil_Tanim_Boy ve Profil_Aci_1 dolu ama Ham_o1, Ham_o2, Hammadde boş.</em></div>
            </li>
            <li>
                <b>Birden fazla revizyon kodu ile düşen parçalar</b>
                <div class="hata-aciklama">Aynı parça kodu için birden fazla revizyon kodu kullanılmış.<br>
                <em>Örnek: SCS-0001-0000025 için R01 ve R02 revizyonları var.</em></div>
            </li>
            <li>
                <b>LEVHA olup ilk operasyonu LAZER KESİM/PLAZMA KESİM OLMAYANLAR</b>
                <div class="hata-aciklama">Hammadde LEVHA olan parçalarda ilk operasyon LAZER KESİM, PLAZMA KESİM veya SU JETİ değil.<br>
                <em>Örnek: SCS-0001-0000026 için ilk operasyon "BÜKÜM".</em></div>
            </li>
            <li>
                <b>LEVHA OLMAYIP ilk operasyonu LAZER KESİM/PLAZMA KESİM OLANLAR</b>
                <div class="hata-aciklama">Hammadde LEVHA olmayan parçalarda ilk operasyon LAZER KESİM veya PLAZMA KESİM.<br>
                <em>Örnek: SCS-0001-0000027 hammadde "STD", ilk operasyon "LAZER KESİM".</em></div>
            </li>
            <li>
                <b>Çoklu XML karşılaştırma ve PDF karşılaştırma hataları</b>
                <div class="hata-aciklama">Birden fazla XML veya PDF dosyası karşılaştırıldığında kod, adet veya kalınlık uyumsuzlukları.<br>
                <em>Örnek: PDF'de 10 adet, XML'de 8 adet aynı koddan var.</em></div>
            </li>
            <li>
                <b>Operasyon Çeşitleri (filtrelenebilir tablo, doğrudan hata değil)</b>
                <div class="hata-aciklama">Tüm operasyon çeşitleri ve ilgili parça kodları listelenir. Burada doğrudan hata yoktur, kontrol amaçlıdır.<br>
                <em>Örnek: OP1_Tanim = "BÜKÜM" olan tüm parçalar listelenir.</em></div>
            </li>
        </ol>
    </div>
</div>
`;
            document.body.appendChild(popup);
            document.getElementById('btnCloseHataTurleri').onclick = function () {
                popup.remove();
            };
        }

        // Buton ekle (sayfanın üstüne veya istediğin yere ekleyebilirsin)
        const hataTurleriBtn = document.createElement("button");
        hataTurleriBtn.textContent = "Hata Türlerini Göster";
        hataTurleriBtn.style = "background:#e67e22; display:none; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer; margin-left:12px;";
        document.querySelector(".buton-grup").appendChild(hataTurleriBtn);
        hataTurleriBtn.onclick = showHataTurleriPopup;

        const aramaInput = document.getElementById('malzemeArama');
        const clearBtn = document.getElementById('malzemeAramaClearBtn');
        const gotoBtn = document.getElementById('malzemeAramaGotoBtn');

        function guncelleAramaButonlari() {
            const val = aramaInput.value.trim();
            if (val) {
                clearBtn.style.display = "";
                gotoBtn.style.display = "";
            } else {
                clearBtn.style.display = "none";
                gotoBtn.style.display = "none";
            }
        }

        if (aramaInput && clearBtn && gotoBtn) {
            aramaInput.addEventListener('input', guncelleAramaButonlari);
            clearBtn.onclick = function () {
                aramaInput.value = "";
                guncelleAramaButonlari();
                if (typeof filtreAccordionListesi === "function") filtreAccordionListesi();
                aramaInput.focus();
            };
            gotoBtn.onclick = function () {
                const kod = aramaInput.value.trim();
                if (!kod) return;
                let found = false;
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const title = item.querySelector('.accordion-title');
                    if (title && title.innerText.includes(kod) && !found) {
                        item.classList.add('active', 'highlighted');
                        item.scrollIntoView({ behavior: "smooth", block: "center" });
                        setTimeout(() => item.classList.remove('highlighted'), 1200);
                        found = true;
                    }
                });
                if (!found) {
                    gotoBtn.style.color = "#c0392b";
                    setTimeout(() => gotoBtn.style.color = "#2563eb", 600);
                }
            };
            // İlk yüklemede de kontrol et
            guncelleAramaButonlari();
        }

        // Çift tıkla veya başka bir şekilde JS ile aramaInput.value değişirse çarpı butonunu güncelle
        function guncelleAramaClearBtn() {
            if (aramaInput && clearBtn) {
                clearBtn.style.display = aramaInput.value ? "" : "none";
            }
        }

        // Çoklu XML karşılaştırma butonu ekle
        const multiXmlListBtn = document.createElement("button");
        multiXmlListBtn.id = "btnMultiXmlList";
        multiXmlListBtn.textContent = "Tüm XML Parçalarını Listele";
        multiXmlListBtn.style = "background:#27ae60; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer; margin-left:12px; display:none;";
        document.querySelector(".buton-grup").appendChild(multiXmlListBtn);

        let multiXmlFiles = []; // Çoklu xml dosyası yüklendiğinde burada tutulacak

        // handleMultipleXmlFiles fonksiyonunda xmlList'i globalde sakla:
        const _orjHandleMultipleXmlFiles = handleMultipleXmlFiles;
        handleMultipleXmlFiles = function (files) {
            // Sıfırla sadece "reset" modunda çalışsın!
            const yuklemeModu = document.querySelector('input[name="xmlYuklemeModu"]:checked').value;
            if (yuklemeModu === "reset") {
                multiXmlFiles = [];
            }
            _orjHandleMultipleXmlFiles.call(this, files);
            multiXmlListBtn.style.display = "";
            guncelleXmlDosyaListesiPaneli();
        };

        // Çoklu XML parçalarını listele butonu
        multiXmlListBtn.onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "multiXmlList") {
                area.innerHTML = "";
                acikListe = "";
                this.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            acikListe = "multiXmlList";
            if (!multiXmlFiles.length) {
                alert("Çoklu XML dosyası yüklenmedi.");
                return;
            }
            // Her xml dosyasındaki parçaları ve adetlerini topla
            const xmlParcaMapList = [];
            multiXmlFiles.forEach(item => {
                const parcaMap = {};
                const docs = item.xmlDoc.querySelectorAll("document");
                function gez(docNode, parentMultiplier) {
                    const conf = docNode.querySelector('configuration');
                    if (!conf) return;
                    const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                    const adet = parseInt(conf.getAttribute("quantity")) || 1;
                    const toplamAdet = adet * parentMultiplier;
                    parcaMap[partCode] = (parcaMap[partCode] || 0) + toplamAdet;
                    // Alt montajları gez
                    const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                    childDocs.forEach(childDoc => gez(childDoc, toplamAdet));
                }
                // Kökten başlat
                const rootDocs = Array.from(docs).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                rootDocs.forEach(doc => gez(doc, item.setAdet || 1));
                xmlParcaMapList.push(parcaMap);
            });

            // Tüm parça kodlarını topla
            const allCodes = new Set();
            xmlParcaMapList.forEach(map => Object.keys(map).forEach(code => allCodes.add(code)));

            // Ortak olanları ve toplamları bul
            const ortaklar = [];
            allCodes.forEach(code => {
                // Montaj ve sheet/kesim/cut-list-item gibi kodları atla
                if (
                    code.endsWith("-0000") ||
                    code.toUpperCase().includes("SHEET") ||
                    code.toUpperCase().includes("KESIM LISTESI") ||
                    code.toUpperCase().includes("CUT-LIST-ITEM")
                ) return;

                // PROFİL çocuk parçası ise (uzunluk ve profil tipi dolu ise) hariç tut
                let profilCocukMu = false;
                for (let i = 0; i < multiXmlFiles.length; i++) {
                    const doc = multiXmlFiles[i].xmlDoc.querySelectorAll("document");
                    for (let d of doc) {
                        const conf = d.querySelector('configuration');
                        if (!conf) continue;
                        const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(d, "Parca_Kodu") || getAttributeValue(d, "Name") || "";
                        if (partCode !== code) continue;
                        const uzunluk = getAttributeValue(conf, "Uzunluk") || "";
                        const profilTipi = getAttributeValue(conf, "Profil_Tipi") || "";
                        if (uzunluk.trim() !== "" && profilTipi.trim() !== "") {
                            profilCocukMu = true;
                            break;
                        }
                    }
                    if (profilCocukMu) break;
                }
                if (profilCocukMu) return;

                const adetler = xmlParcaMapList.map(map => map[code] || 0);
                const toplam = adetler.reduce((a, b) => a + b, 0);
                const detay = adetler
                    .map((adet, i) => adet > 0 ? `${multiXmlFiles[i].file.name}: ${adet}` : null)
                    .filter(Boolean)
                    .join(", ");
                ortaklar.push({ code, toplam, detay });
            });

            // Tabloyu oluştur
            let html = `<b>XML Dosyaları İçerisinde Bulunan Ortak Paraçalar:</b>
<table id="multiXmlTable" style="margin:10px 0; border-collapse:collapse;">
    <thead>
        <tr>
            <th style="border:1px solid #bbb; padding:4px 10px;">Parça Kodu</th>
            <th style="border:1px solid #bbb; padding:4px 10px;">Toplam Adet</th>
            <th style="border:1px solid #bbb; padding:4px 10px;">XML Dosyası / Adet</th>
        </tr>
    </thead>
    <tbody>
        ${ortaklar.map(x => `
            <tr>
                <td style="border:1px solid #bbb; padding:4px 10px;">${x.code}</td>
                <td style="border:1px solid #bbb; padding:4px 10px;">${x.toplam}</td>
                <td style="border:1px solid #bbb; padding:4px 10px;">${x.detay}</td>
            </tr>
        `).join("")}
    </tbody>
</table>`;
            area.innerHTML = html;
            showExcelExport(true);
        };

        document.getElementById('btnExcelExport').onclick = function () {
            const area = document.getElementById('extraListArea');
            let table = area.querySelector("table");
            if (table) {
                let listeAdi = "liste";
                if (acikListe === "malzeme") listeAdi = "malzeme_listesi";
                else if (acikListe === "siparisDisi") listeAdi = "siparis_disi_listesi";
                else if (acikListe === "stdparca") listeAdi = "standart_parca_listesi";
                else if (acikListe === "operasyon") listeAdi = "operasyon_cesitleri";
                else if (acikListe === "multiXmlList") listeAdi = "tum_xml_parcalari";
                exportTableToExcel(table, `${currentXmlFileName}_${listeAdi}.csv`);
            }
        };

        // Accordion'daki hammaddeye göre ağırlık hesaplama butonu ekle
        const btnAgirlikHesapla = document.createElement("button");
        btnAgirlikHesapla.id = "btnAgirlikHesapla";
        btnAgirlikHesapla.textContent = "Ağırlık Hesaplama Tablosu";
        btnAgirlikHesapla.style = "background:#2563eb; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;";
        document.querySelector(".buton-grup").appendChild(btnAgirlikHesapla);

        // Yoğunluklar örnek tablo
        const yogunluklar = {
            "C1010": 7.85, "C1040": 7.85, "C1050": 7.85, "C1060": 7.85, "C2083": 7.85, "C2316": 7.85, "C2344": 7.85, "C2379": 7.85, "C8620": 7.85, "CK45": 7.85, "CK75": 7.85, "ST37": 7.85, "ST44": 7.85, "ST52": 7.85,
            "C4140": 7.85, "C5140": 7.85, "ST37_C": 7.85, "ST44_C": 7.85, "ST52_C": 7.85, "ST37_H": 7.85, "ST44_H": 7.85, "ST52_H": 7.85, "HRP": 7.85, "DKP": 7.85, "CK45_KR_KP": 7.85, "TRANSMISYON": 7.85,
            "C1040_H": 7.85, "C1040_C": 7.85, "AL2007": 2.7, "AL2024": 2.7, "AL5083": 2.7, "AL5083 TASLANMIS": 2.7, "AL5754": 2.7, "AL6013": 2.7, "AL6061": 2.7, "AL6063": 2.7, "AL6082": 2.7, "AL6083": 2.7, "AL7000": 2.7,
            "AL7075": 2.7, "AL8000": 2.7, "KR_303": 7.9, "KR_304": 7.9, "KR_309": 7.9, "KR_310": 7.9, "KR_316": 7.9, "DERLIN": 1.4, "KESTAMIT": 1.2, "HDPE": 1.2, "POLIETILEN": 1.2, "POLIPROPILEN": 0.9,
            "POLYAMID": 1.15, "ULPOLEN1000": 0.95, "FIBER": 1.8, "TEFLON": 2.2, "VULKOLON": 1.2, "POLIURETAN": 1.2, "RG05": 1.2, "RG07": 1.2, "RG10": 1.2, "RG12": 1.2, "RG14": 1.2, "PIRINC": 8.5,
            "GGG60": 7.1, "GG30": 7.1, "GGG50": 7.1, "GGG40": 7.1, "GG60": 7.1, "GG25": 7.1, "GG20": 7.1, "ST37-2": 7.85, "GS60": 7.1, "PLEXIGLASS": 1.2, "KAUCUK": 1.2, "AL6061_O": 2.7, "AL6061_T4": 2.7, "AL6061_T6": 2.7,
            "AL6063_T1": 2.7, "AL6063_T4": 2.7, "AL6063_T5": 2.7, "AL6063_T6": 2.7, "AL6063_T83": 2.7, "AL6082_T6": 2.7, "AL7075_T6": 2.7, "ALUMINYUM_BRONZ": 7.8, "GALVANIZLI SAC": 7.85, "CK45_KROM KAPLI": 7.85,
            "ST37_SOGUK CEKIM": 7.85, "ST37_SICAK CEKIM": 7.85, "ST52_SICAK CEKIM": 7.85, "C4140_ISLAHLI": 7.85, "ST44_SICAK CEKIM": 7.85, "C1040_SICAK CEKIM": 7.85, "C1040_SOGUK CEKIM": 7.85, "ST44_SOGUK CEKIM": 7.85,
            "HARDOX400": 7.85, "PPRC": 0.9, "BAKIR": 8.96, "MDF": 0.7, "ST52_SOGUK CEKIM": 7.85, "ALUDUR PLUS": 2.7, "MIKA": 2.2, "SOLID": 1.2, "16MNCR5": 7.85,
            "CK45_INDUKSIYONLU KROM KAPLI": 7.85, "AL2017": 2.7, "YAY CELIGI": 7.85, "55SI7": 7.85, "NAYLON 6/10": 1.15, "ALPOLEN1000": 0.95, "ETIAL 160": 2.7,
            "1050 H14": 2.7, "1054 H14": 2.7, "PA6": 1.15, "ALUMINYUMKOMPOZIT": 2.7, "CUZN25AL5": 8.5, "45CR2": 7.85, "34CRALNI7-10": 7.85, "PPE": 1.2, "DIN 17223": 7.85, "PP": 1.2, "PET": 1.2, "ThornelVCB-20KarbonKumas": 1.88
        };

        // Hesaplama fonksiyonu
        function hesaplaBirimAgirlik(tur, olcu, malzeme) {
            let d = yogunluklar[(malzeme || "").toUpperCase()] || 7.85;
            olcu = (olcu || "").replace(/[, ]/g, ".").replace(/Ø/gi, "").replace(/—|–/g, "x").replace(/-/g, "x");
            if (tur === "ALTIKÖŞE") {
                let cap = Number(olcu.split("x")[0]);
                if (cap) {
                    let alan = (3 * Math.sqrt(3) / 2) * Math.pow(cap, 2);
                    return alan * d / 1_000_000;
                }
            }
            if (tur === "BORU" || tur === "TEMİZ ÖLÇÜLÜ BORU") {
                let [disCap, icCap] = olcu.split("x").map(Number);
                if (disCap && icCap) {
                    let alan = Math.PI / 4 * (Math.pow(disCap, 2) - Math.pow(icCap, 2));
                    return alan * d / 1_000_000;
                }
            }
            if (tur === "ÇUBUK") {
                let vals = olcu.split("x").map(Number);
                if (vals.length === 2 && vals[0] && vals[1]) {
                    return vals[0] * vals[1] * d / 1_000_000;
                } else if (vals.length === 1 && vals[0]) {
                    return Math.PI / 4 * Math.pow(vals[0], 2) * d / 1_000_000;
                }
            }
            if (tur === "KARE") {
                let kenar = Number(olcu.split("x")[0]);
                if (kenar) return kenar * kenar * d / 1_000_000;
            }
            if (tur === "LAMA") {
                let [en, t] = olcu.split("x").map(Number);
                if (en && t) return en * t * d / 1_000_000;
            }
            if (tur === "LEVHA ÖZEL") {
                let [en, boy] = olcu.split("x").map(Number);
                if (en && boy) return en * boy * d / 1_000_000;
            }
            return 0;
        }

        // Butona tıklayınca tabloyu oluştur
        btnAgirlikHesapla.onclick = function () {
            const area = document.getElementById('extraListArea');
            if (acikListe === "agirlik") {
                area.innerHTML = "";
                acikListe = "";
                btnAgirlikHesapla.classList.remove("active");
                showExcelExport(false);
                return;
            }
            document.querySelectorAll('.buton-grup button').forEach(btn => btn.classList.remove("active"));
            btnAgirlikHesapla.classList.add("active");
            acikListe = "agirlik";
            showExcelExport(false);

            const accordionItems = document.querySelectorAll('.accordion-item');
            const turler = ["ALTIKÖŞE", "BORU", "TEMİZ ÖLÇÜLÜ BORU", "ÇUBUK", "KARE", "LAMA", "LEVHA ÖZEL"];
            let tabloList = [];
            accordionItems.forEach(item => {
                const title = item.querySelector('.accordion-title');
                const content = item.querySelector('.accordion-content');
                if (!title || !content) return;
                let hammadde = "", olcu = "", malzeme = "", uzunluk = "", adet = 1, parcaKodu = "";
                const kodMatch = title.innerHTML.match(/<b[^>]*>(.*?)<\/b>/);
                parcaKodu = kodMatch ? kodMatch[1].trim() : "";
                content.querySelectorAll('tbody tr').forEach(tr => {
                    const alan = tr.querySelector('td:first-child')?.innerText.trim();
                    const deger = tr.querySelector('td:last-child')?.innerText.trim();
                    if (alan === "Hammadde") hammadde = deger;
                    if (alan === "Ham_o1") olcu = deger;
                    if (alan === "Malzeme") malzeme = deger;
                    if (alan === "Ham_o2") uzunluk = deger;
                });
                const adetMatch = title.innerHTML.match(/Toplam:\s*<b[^>]*>(\d+)<\/b>/);
                if (adetMatch) adet = parseInt(adetMatch[1], 10);

                // Hammaddeyi normalize et
                const hammaddeNorm = (hammadde || "").toUpperCase().replace(/[^A-ZÇĞİÖŞÜ0-9 ]/g, "").trim();
                const tur = turler.find(t => (" " + hammaddeNorm + " ").includes(" " + t + " "));
                if (!tur) return;

                // Ölçü ve uzunlukları düzelt
                olcu = (olcu || "").replace(/[,]/g, ".").replace(/[ ]/g, "").replace(/Ø/gi, "").replace(/—|–/g, "x").replace(/-/g, "x");
                const birimAgirlikKgM = hesaplaBirimAgirlik(tur, olcu, malzeme); // kg/m
                const uzunlukNum = parseFloat((uzunluk || "").replace(",", ".")) || 0;
                const adetNum = parseInt(adet, 10) || 1;

                // Birim ağırlık: bir adet için toplam ağırlık (kg)
                const birimAgirlik = birimAgirlikKgM * uzunlukNum;
                // Toplam ağırlık: birim ağırlık x adet
                const toplamAgirlik = birimAgirlik * adetNum;

                tabloList.push({
                    parcaKodu,
                    tur,
                    olcu,
                    malzeme,
                    uzunluk,
                    adet: adetNum,
                    birimAgirlik: birimAgirlik ? birimAgirlik.toFixed(3) : "",
                    toplamAgirlik: toplamAgirlik ? toplamAgirlik.toFixed(3) : ""
                });
            });

            // Tablo HTML
            let html = `<h3>Ağırlık Hesaplama Tablosu</h3>
    <div id="agirlikExcelExportArea" style="margin-bottom:10px;">
        <button id="btnAgirlikExcelExport"
            style="background:#27ae60; color:#fff; border:none; border-radius:4px; padding:8px 18px; font-size:15px; font-weight:bold; cursor:pointer;">
            Excel'e Aktar
        </button>
    </div>
    <table id="agirlikHesaplamaTable" style="margin-top:12px; margin-bottom:12px; border-collapse:collapse; width:100%; max-width:900px;">
        <thead>
            <tr>
                <th>Parça Kodu</th>
                <th>Tür</th>
                <th>Ölçü</th>
                <th>Malzeme</th>
                <th>Uzunluk</th>
                <th>Adet</th>
                <th>Birim Ağırlık (g)</th>
                <th>Toplam Ağırlık (g)</th>
            </tr>
        </thead>
        <tbody>
            ${tabloList.map(x => `
                <tr>
                    <td>${x.parcaKodu}</td>
                    <td>${x.tur}</td>
                    <td>${x.olcu}</td>
                    <td>${x.malzeme}</td>
                    <td>${x.uzunluk}</td>
                    <td>${x.adet}</td>
                    <td>${x.birimAgirlik}</td>
                    <td>${x.toplamAgirlik}</td>
                </tr>
            `).join("")}
        </tbody>
    </table>`;
            area.innerHTML = html;

            document.getElementById('btnAgirlikExcelExport').onclick = function () {
                const table = document.getElementById('agirlikHesaplamaTable');
                if (!table) return;
                let csv = [];
                let headers = [];
                table.querySelectorAll("thead th").forEach(th => {
                    headers.push(th.innerText.trim());
                });
                csv.push(headers.join(";"));
                table.querySelectorAll("tbody tr").forEach(tr => {
                    let row = [];
                    tr.querySelectorAll("td").forEach(td => {
                        row.push(td.innerText.trim());
                    });
                    csv.push(row.join(";"));
                });
                let csvContent = "\uFEFF" + csv.join("\r\n");
                let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "agirlik_hesaplama_tablosu.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        };

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('strike-checkbox')) {
                const li = e.target.closest('li');
                if (li) {
                    li.classList.toggle('strikeout', e.target.checked);
                }
            }
        });

        // Çoklu XML dosyası yüklendiğinde paneli göster
        function guncelleXmlDosyaListesiPaneli() {
            const panel = document.getElementById('xmlDosyaListesiPaneli');
            if (multiXmlFiles && multiXmlFiles.length > 1) {
                panel.style.display = "";
                guncelleXmlDosyaListesi();
            } else {
                panel.style.display = "none";
                document.getElementById('xmlDosyaListesi').style.display = "none";
            }
        }

        // Listeyi güncelle
        function guncelleXmlDosyaListesi() {
            const listeDiv = document.getElementById('xmlDosyaListesi');
            if (!multiXmlFiles || multiXmlFiles.length === 0) {
                listeDiv.innerHTML = "<i>Yüklenen dosya yok.</i>";
                return;
            }
            listeDiv.innerHTML = `
    <ul>
        ${multiXmlFiles.map((item, i) => `
            <li>
                <span class="xml-dosya-ad">${item.file.name}</span>
                <button data-idx="${i}" class="xml-dosya-sil-btn">Sil</button>
            </li>
        `).join("")}
    </ul>
`;
            // Sil butonlarına event ekle
            listeDiv.querySelectorAll('.xml-dosya-sil-btn').forEach(btn => {
                btn.onclick = function () {
                    const idx = parseInt(this.getAttribute('data-idx'), 10);
                    if (!isNaN(idx)) {
                        multiXmlFiles.splice(idx, 1);

                        // Hiç dosya kalmadıysa her yeri temizle
                        if (multiXmlFiles.length === 0) {
                            document.getElementById('xmlDosyaListesiPaneli').style.display = "none";
                            document.getElementById('xmlDosyaListesi').style.display = "none";
                            document.getElementById('accordion').innerHTML = "";
                            document.getElementById('extraListArea').innerHTML = "";
                            ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol', 'hataYokDiv'].forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.innerHTML = "";
                            });
                            document.querySelectorAll('.mismatch-list').forEach(div => div.remove());
                            // Hata paneli varsa kaldır
                            const hataPanel = document.getElementById('multiXmlHataPanel');
                            if (hataPanel) hataPanel.remove();
                            return;
                        }

                        // 1 dosya kaldıysa tekli XML davranışına dön
                        if (multiXmlFiles.length === 1) {
                            const tekXml = multiXmlFiles[0];
                            window.loadedXmlDoc = tekXml.xmlDoc;
                            document.getElementById('filename').textContent = tekXml.file.name;
                            document.getElementById('xmlDosyaListesiPaneli').style.display = "none";
                            document.getElementById('xmlDosyaListesi').style.display = "none";
                            // Hata paneli varsa kaldır
                            const hataPanel = document.getElementById('multiXmlHataPanel');
                            if (hataPanel) hataPanel.remove();
                            doldurFiltreKutular();
                            renderAll(tekXml.xmlDoc);
                            return;
                        }

                        // Birden fazla dosya varsa kalanları birleştirip accordion ve hata panelini güncelle
                        const mergedXmlDoc = document.implementation.createDocument("", "", null);
                        const root = mergedXmlDoc.createElement("merged");
                        mergedXmlDoc.appendChild(root);
                        multiXmlFiles.forEach(item => {
                            Array.from(item.xmlDoc.querySelectorAll("document")).forEach(docNode => {
                                root.appendChild(mergedXmlDoc.importNode(docNode, true));
                            });
                        });
                        window.loadedXmlDoc = mergedXmlDoc;

                        // Accordion ve hata panelini yeniden oluştur
                        // Hata paneli varsa kaldır
                        const hataPanel = document.getElementById('multiXmlHataPanel');
                        if (hataPanel) hataPanel.remove();

                        // Accordion ve hata listelerini temizle
                        document.getElementById('accordion').innerHTML = "";
                        document.getElementById('extraListArea').innerHTML = "";
                        ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol', 'hataYokDiv'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = "";
                        });
                        document.querySelectorAll('.mismatch-list').forEach(div => div.remove());

                        // Accordionları tekrar oluştur (çoklu dosya için)
                        const accordion = document.getElementById('accordion');
                        accordion.innerHTML = "";
                        multiXmlFiles.forEach((item, idx) => {
                            // Her dosya için bir grup div oluştur
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'accordion-group';
                            groupDiv.setAttribute('data-group', 'group_' + idx);

                            // Başlık ekle
                            const baslik = document.createElement('div');
                            baslik.className = 'accordion-title';
                            baslik.style = "background:#ecf0f1; font-size:17px; font-weight:bold; margin-top:18px; border-radius:6px;";
                            baslik.textContent = `XML Dosyası: ${item.file.name} (Set Adedi: ${item.setAdet})`;
                            groupDiv.appendChild(baslik);

                            // Her dosya için hiyerarşik accordion ekle
                            const documents = item.xmlDoc.querySelectorAll("document");
                            const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                            rootDocs.forEach((doc, docIdx) => {
                                listPartsRecursiveMulti(doc, (docIdx + 1).toString(), 0, item.setAdet, groupDiv);
                            });

                            accordion.appendChild(groupDiv);
                        });

                        // Hata panelini tekrar ekle
                        if (multiXmlFiles.length > 1) {
                            let hataPanel = document.getElementById('multiXmlHataPanel');
                            if (!hataPanel) {
                                hataPanel = document.createElement('div');
                                hataPanel.id = 'multiXmlHataPanel';
                                hataPanel.style = "margin-bottom:18px; display:none; gap:14px; align-items:center;";
                                hataPanel.innerHTML = `
<label for="multiXmlHataSelect" style="font-weight:bold; color:#2563eb;">Hata Listesi Görünümü:</label>
<select id="multiXmlHataSelect" style="padding:7px 12px; border-radius:6px; border:1.5px solid #b3b3b3; font-size:15px;">
    <option value="tum">Tümü (hata listesi gizli)</option>
    ${multiXmlFiles.map((item, idx) => `<option value="${idx}">${item.file.name}</option>`).join("")}
</select>
`;
                                document.querySelector('main').insertBefore(hataPanel, document.getElementById('accordion'));
                            }
                            // Seçim değiştiğinde hata listelerini güncelle
                            const hataSelect = document.getElementById('multiXmlHataSelect');
                            hataSelect.value = "tum";
                            hataSelect.onchange = function () {
                                if (this.value === "tum") {
                                    document.querySelectorAll('.mismatch-list, #parentCommaDesc, #specialOps, #mismatch, #descMissing, #multiRev, #levhaLazerPlazmaKontrol').forEach(el => {
                                        el.style.display = "none";
                                    });
                                    // Accordionları tekrar oluştur
                                    const accordion = document.getElementById('accordion');
                                    accordion.innerHTML = "";
                                    multiXmlFiles.forEach((item, idx) => {
                                        const groupDiv = document.createElement('div');
                                        groupDiv.className = 'accordion-group';
                                        groupDiv.setAttribute('data-group', 'group_' + idx);

                                        const baslik = document.createElement('div');
                                        baslik.className = 'accordion-title';
                                        baslik.style = "background:#ecf0f1; font-size:17px; font-weight:bold; margin-top:18px; border-radius:6px;";
                                        baslik.textContent = `XML Dosyası: ${item.file.name} (Set Adedi: ${item.setAdet})`;
                                        groupDiv.appendChild(baslik);

                                        const documents = item.xmlDoc.querySelectorAll("document");
                                        const rootDocs = Array.from(documents).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
                                        rootDocs.forEach((doc, docIdx) => {
                                            listPartsRecursiveMulti(doc, (docIdx + 1).toString(), 0, item.setAdet, groupDiv);
                                        });

                                        accordion.appendChild(groupDiv);
                                    });
                                } else {
                                    document.querySelectorAll('.mismatch-list, #parentCommaDesc, #specialOps, #mismatch, #descMissing, #multiRev, #levhaLazerPlazmaKontrol').forEach(el => {
                                        el.style.display = "none";
                                    });
                                    // Sadece seçilen dosyanın hata listelerini render et
                                    const idx = parseInt(this.value, 10);
                                    if (!isNaN(idx) && multiXmlFiles[idx]) {
                                        document.querySelectorAll('.mismatch-list').forEach(div => div.remove());
                                        ['parentCommaDesc', 'specialOps', 'mismatch', 'descMissing', 'multiRev', 'levhaLazerPlazmaKontrol'].forEach(id => {
                                            const el = document.getElementById(id);
                                            if (el) el.innerHTML = "";
                                        });
                                        renderAll(multiXmlFiles[idx].xmlDoc);
                                    }
                                }
                            };
                            hataSelect.dispatchEvent(new Event('change'));
                        }

                        guncelleXmlDosyaListesiPaneli();
                    }
                };
            });
        }

        // Butona tıklayınca listeyi aç/kapat
        document.getElementById('btnXmlDosyaListesi').onclick = function () {
            const listeDiv = document.getElementById('xmlDosyaListesi');
            listeDiv.style.display = (listeDiv.style.display === "none" || !listeDiv.style.display) ? "block" : "none";
        };

        function closeAllPopups() {
            document.querySelectorAll('#boyMalzemePopup, #yeniliklerPopup').forEach(popup => {
                popup.style.display = "none";
                // Eğer DOM'dan kaldırmak istiyorsanız:
                if (popup.parentNode) popup.parentNode.removeChild(popup);
            });
        }

        // Popup dışına tıklayınca kapat
        document.addEventListener('mousedown', function (e) {
            const popups = document.querySelectorAll('#boyMalzemePopup, #yeniliklerPopup');
            popups.forEach(popup => {
                if (popup.style.display === "none") return;
                // Sadece popup'ın dışına tıklanırsa
                if (e.target === popup) {
                    closeAllPopups();
                }
            });
        });

        // XML dosyası sürüklenince popup açıksa kapat
        window.addEventListener('dragstart', function (e) {
            closeAllPopups();
        });
        window.addEventListener('dragover', function (e) {
            // Sürükleme başladığında popup açıksa kapat
            closeAllPopups();
        });

        (function () {
            let kesimPopup = null;
            let lastLoadedPdfNames = [];

            window.addEventListener('drop', async function (e) {
                // Sadece PDF dosyası sürüklenip bırakıldıysa ve popup kapalıysa aç
                const pdfFiles = Array.from(e.dataTransfer.files || []).filter(f => f.name.toLowerCase().endsWith('.pdf'));
                if (pdfFiles.length === 0) return;

                // Popup açık mı kontrol et
                kesimPopup = document.getElementById('kesimKarsilastirPopup');
                if (kesimPopup && kesimPopup.style.display !== "none") {
                    // Popup açıkken tekrar yükleme yapma
                    return;
                }

                // Popup kapalıysa aç ve dosyaları yükle
                document.getElementById('btnKesimKarsilastir').click();

                // Yükleme için biraz bekle (popup render olsun)
                setTimeout(async () => {
                    const popup = document.getElementById('kesimKarsilastirPopup');
                    if (!popup) return;
                    const pdfInput = popup.querySelector('#popupPdfInput');
                    if (!pdfInput) return;

                    // Aynı dosyalar tekrar yüklenmesin
                    const newNames = pdfFiles.map(f => f.name).sort().join(",");
                    if (lastLoadedPdfNames === newNames) return;
                    lastLoadedPdfNames = newNames;

                    // PDF input'un dosya listesini güncelle
                    const dt = new DataTransfer();
                    pdfFiles.forEach(f => dt.items.add(f));
                    pdfInput.files = dt.files;

                    // Change event tetikle
                    pdfInput.dispatchEvent(new Event("change"));
                }, 350);
            });
        })();

        document.addEventListener('mousedown', function (e) {
            const preview = document.getElementById('pdfPreviewPopup');
            if (preview && preview.style.display === "block") {
                // Eğer tıklanan yer popup'ın içi değilse kapat
                if (!preview.contains(e.target)) {
                    preview.style.display = "none";
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const baslik = document.getElementById("ozelliklerBaslik");
            const icerik = document.getElementById("ozelliklerIcerik");
            const arrow = document.getElementById("ozelliklerArrow");
            if (baslik && icerik && arrow) {
                baslik.onclick = function () {
                    const acik = icerik.style.display === "block";
                    icerik.style.display = acik ? "none" : "block";
                    arrow.style.transform = acik ? "rotate(0deg)" : "rotate(180deg)";
                    // Özellikler açıldığında popup'ta overflow:auto aktif olsun
                    const yeniliklerPopup = document.getElementById("yeniliklerPopup");
                    if (icerik.style.display === "block" && yeniliklerPopup) {
                        yeniliklerPopup.style.overflow = "auto";
                    }
                };
            }
            const specialOpsDiv = document.getElementById('specialOps');
            if (specialOpsDiv) specialOpsDiv.style.display = "none";
        });

        function showXmlBirlestiriciPopup() {
            // Eğer popup zaten açıksa tekrar açma
            if (document.getElementById('xmlBirlestiriciPopup')) return;

            let popup = document.createElement('div');
            popup.id = "xmlBirlestiriciPopup";
            popup.style.position = "fixed";
            popup.style.top = "0";
            popup.style.left = "0";
            popup.style.width = "100vw";
            popup.style.height = "100vh";
            popup.style.background = "rgba(0,0,0,0.18)";
            popup.style.zIndex = "99999";
            popup.style.overflow = "auto";
            popup.innerHTML = `
    <div id="xmlBirlestiriciPanel" style="
        background:#fff;
        max-width:520px;
        margin:60px auto;
        border-radius:20px;
        box-shadow:0 8px 40px #0003;
        padding:44px 38px 32px 38px;
        position:relative;
        animation: popupFadeIn 0.35s cubic-bezier(.4,2,.6,1);
        border: 1.5px solid #2563eb22;
    ">
        <button id="btnCloseXmlBirlestirici" style="
            position:absolute; top:18px; right:18px;
            background:#c0392b; color:#fff; border:none;
            border-radius:8px; padding:8px 22px; font-size:17px; cursor:pointer;
            box-shadow:0 2px 8px #0002;
            transition:background 0.18s;
        ">Kapat</button>
        <h2 style="color:#2563eb; margin-bottom:24px; font-size:2.1rem; letter-spacing:1px; text-align:center;">XML Birleştirici</h2>
        <div id="xmlBirlestiriciDropzone" style="
            border:2.5px dashed #2563eb;
            border-radius:18px;
            padding:54px 38px 44px 38px;
            text-align:center;
            color:#2563eb;
            font-size:1.25rem;
            font-weight:500;
            margin-bottom:24px;
            cursor:pointer;
            background:linear-gradient(135deg,#f8faff 60%,#e0e7ff 100%);
            transition:background 0.2s,border-color 0.2s;
            box-shadow:0 2px 16px #2563eb11;
        ">
            <span style="font-size:3.2rem;display:inline-block;margin-bottom:12px;">📄</span><br>
            <span style="font-size:1.1rem; color:#1746a2;">XML dosyalarınızı buraya sürükleyin<br>veya tıklayarak seçin</span>
            <input type="file" id="xmlBirlestiriciInput" multiple accept=".xml" style="display:none;">
        </div>
        <div id="xmlBirlestiriciMain" style="display:none;">
            <div id="xmlBirlestiriciFileList" style="margin-bottom:18px;"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <button id="xmlBirlestiriciUpdateBtn" style="display:none;">Adetleri Güncelle</button>
                <button id="xmlBirlestiriciMergeBtn" style="display:none;">Birleştir</button>
                <button id="xmlBirlestiriciResetBtn" style="display:none; background:#e67e22;">Sıfırla</button>
            </div>
            <div id="xmlBirlestiriciOutput"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button id="xmlBirlestiriciEscapeBtn" style="display:none;">Özniteliklerde &lt; ve &gt; Dönüştür</button>
                <button id="xmlBirlestiriciDownloadBtn" style="display:none;">COKLUXML-R00 İndir</button>
            </div>
        </div>
    </div>
    <style>
    @keyframes popupFadeIn {
        from { opacity:0; transform:scale(0.98) translateY(40px);}
        to   { opacity:1; transform:scale(1) translateY(0);}
    }
    #xmlBirlestiriciPanel button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 0;
        transition: background 0.2s, box-shadow 0.18s;
        box-shadow: 0 2px 8px #0001;
    }
    #xmlBirlestiriciPanel button:disabled {
        background: #b6c3e6;
        cursor: not-allowed;
    }
    #xmlBirlestiriciPanel button:hover:not(:disabled) {
        background: #1746a2;
    }
    #xmlBirlestiriciDropzone:hover, #xmlBirlestiriciDropzone.active {
        background: #e0e7ff;
        border-color: #1746a2;
    }
    #xmlBirlestiriciFileList .file-row {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f3f6ff;
        border-radius: 8px;
        padding: 8px 14px;
        box-shadow: 0 1px 4px #2563eb11;
    }
    #xmlBirlestiriciFileList label {
        font-size: 1rem;
        color: #2563eb;
        font-weight: 500;
        flex: 1;
        word-break: break-all;
    }
    #xmlBirlestiriciFileList input[type="number"] {
        width: 70px;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
        background: #f3f4f6;
    }
    #xmlBirlestiriciOutput textarea {
        width: 100%;
        height: 320px;
        margin-top: 12px;
        font-family: 'Fira Mono', 'Consolas', monospace;
        font-size: 1rem;
        border-radius: 10px;
        border: 1.5px solid #2563eb33;
        background: #f8faff;
        padding: 14px;
        resize: vertical;
        box-sizing: border-box;
        color: #222;
    }
    </style>
`;
            document.body.appendChild(popup);


            // Kapatma sadece butonla, popup dışına tıklayınca kapanmaz
            document.getElementById('btnCloseXmlBirlestirici').onclick = function () {
                if (popup && popup.parentNode) popup.parentNode.removeChild(popup);
            };

            // --- Değişkenler ---
            let xmlFiles = [];
            let xmlTexts = [];
            let quantities = [];

            // --- Dropzone ve input eventleri ---
            const dropzone = document.getElementById('xmlBirlestiriciDropzone');
            const xmlInput = document.getElementById('xmlBirlestiriciInput');
            dropzone.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropzone.style.background = "#2563eb22";
            });
            dropzone.addEventListener('dragleave', function (e) {
                dropzone.style.background = "";
            });
            dropzone.addEventListener('drop', function (e) {
                e.preventDefault();
                dropzone.style.background = "";
                let files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.xml'));
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
            dropzone.addEventListener('click', function () {
                xmlInput.click();
            });
            xmlInput.addEventListener('change', function (e) {
                handleFiles(Array.from(e.target.files));
            });

            function handleFiles(files) {
                xmlFiles = files;
                xmlTexts = [];
                quantities = [];
                dropzone.style.display = "none";
                document.getElementById('xmlBirlestiriciMain').style.display = "block";
                document.getElementById('xmlBirlestiriciOutput').innerHTML = "";
                document.getElementById('xmlBirlestiriciEscapeBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciDownloadBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciMergeBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciResetBtn').style.display = files.length > 0 ? "inline-block" : "none";
                document.getElementById('xmlBirlestiriciUpdateBtn').style.display = files.length > 0 ? "inline-block" : "none";
                // Dosya listesi ve quantity girişleri
                let fileListHtml = "";
                xmlFiles.forEach((file, idx) => {
                    fileListHtml += `<div class="file-row" style="margin-bottom:12px; display:flex; align-items:center; gap:12px;">
                <label style="font-size:1rem; color:#2563eb; font-weight:500;">${file.name}</label>
                <input type="number" min="1" value="1" id="xmlBirlestiriciQuantity_${idx}" style="width:70px; padding:6px 10px; border-radius:6px; border:1px solid #d1d5db; font-size:1rem; background:#f3f4f6;">
            </div>`;
                });
                document.getElementById('xmlBirlestiriciFileList').innerHTML = fileListHtml;
                // Dosyaları oku
                let promises = xmlFiles.map(file => {
                    return new Promise(resolve => {
                        let reader = new FileReader();
                        reader.onload = function (evt) {
                            resolve(evt.target.result);
                        };
                        reader.readAsText(file);
                    });
                });
                Promise.all(promises).then(texts => {
                    xmlTexts = texts;
                });
            }

            function ilkDocumentBlokunuAl(xmlText) {
                const start = xmlText.indexOf('<document');
                const end = xmlText.lastIndexOf('</document>');
                if (start === -1 || end === -1) return '';
                return xmlText.substring(start, end + 11).trim();
            }

            function configurationQuantityGuncelle(documentBlock, newQuantity) {
                return documentBlock.replace(/(<configuration\b[^>]*\bquantity=")(\d+)(")/i, `$1${newQuantity}$3`);
            }

            const sabitXmlBas = `<xml>
    <transactions>
        <transaction date="1753855247" type="wf_export_document_attributes" vaultname="GMM">
            <document aliasset="" pdmweid="">
                <configuration name="Default" quantity="1">
                    <attribute name="Agirlik" value="" />
                    <attribute name="Revision" value="R00" />
                    <attribute name="Description" value="COKLU XML" />
                    <attribute name="Date" value="29.07.2025" />
                    <attribute name="Ham_o1" value="" />
                    <attribute name="Ham_o2" value="" />
                    <attribute name="Ham_o3" value="" />
                    <attribute name="Hammadde" value="" />
                    <attribute name="Hammadde_Olcusu" value="" />
                    <attribute name="Isil_Islem" value="" />
                    <attribute name="Kalite" value="" />
                    <attribute name="Kaplama" value="" />
                    <attribute name="Mak_Boyut" value="" />
                    <attribute name="Mak_Cinsi" value="" />
                    <attribute name="Mak_Grubu" value="" />
                    <attribute name="Mak_Kodu" value="" />
                    <attribute name="Mak_Tipi" value="" />
                    <attribute name="Malzeme" value="" />
                    <attribute name="Parca_Kodu" value="COKLUXML" />
                    <attribute name="Proje_no" value="" />
                    <attribute name="Ral_Kodu" value="" />
                    <attribute name="Son_Islem" value="" />
                    <attribute name="Temin_sekli" value="İmal Edilen" />
                    <attribute name="İmalat_Tipi" value="MNG" />
                    <attribute name="Description2" value="" />
                    <attribute name="Boya_Parca_Tanimi" value="" />
                    <attribute name="Malzeme_ERP_Code" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Genisligi" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Uzunlugu" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Kalinligi" value="" />
                    <attribute name="Siparis_Notu" value="" />
                    <attribute name="OP1_Tanim" value="" />
                    <attribute name="OP2_Tanim" value="" />
                    <attribute name="OP3_Tanim" value="" />
                    <attribute name="OP4_Tanim" value="" />
                    <attribute name="OP5_Tanim" value="" />
                    <attribute name="OP6_Tanim" value="" />
                    <attribute name="OP7_Tanim" value="" />
                    <attribute name="OP8_Tanim" value="" />
                    <attribute name="Uzunluk" value="" />
                    <attribute name="Profil_Tanim_Boy" value="" />
                    <attribute name="Profil_Tanim_Boy_1" value="" />
                    <attribute name="Profil_Tanim_Boy_2" value="" />
                    <attribute name="Profil_Tanim_Boy_3" value="" />
                    <attribute name="Profil_Tanim_Boy_4" value="" />
                    <attribute name="Imalat_tipi" value="" />
                    <attribute name="Disarda_Birak" value="" />
                    <attribute name="Profil_Tipi" value="" />
                    <attribute name="Profil_Disarda_Birak" value="" />
                    <attribute name="Partili_takip" value="" />
                    <attribute name="Saci_Disarida_Birak" value="" />
                    <attribute name="Disarda_Birakma" value="" />
                    <attribute name="Boya_Par_Tan_Oz" value="" />
                    <attribute name="Siparis_Disi_Birak" value="" />
                    <attribute name="Profil_Aci_1" value="" />
                    <attribute name="Profil_Aci_2" value="" />
                    <attribute name="Mak_Parca_Kodu" value="" />
                    <attribute name="Fason" value="" />
                    <attribute name="Name" value="" />
                    <attribute name="Date Modified" value="29.07.2025" />
                    <attribute name="State" value="Onay Bekliyor" />
                    <attribute name="Reference Count" value="1.0" />
                    <attribute name="Configuration" value="Default" />
                    <references>
`;
            const sabitXmlSon = `
                    </references>
                </configuration>
            </document>
        </transaction>
    </transactions>
</xml>`;


            function attributeEscape(xmlBlock) {
                xmlBlock = xmlBlock.replace(/(<attribute\b[^>]*\svalue=")([\s\S]*?)(")(\s*\/?>)/g, function (match, p1, p2, p3, p4) {
                    let newVal = p2.replace(/"/g, '&quot;');
                    return p1 + newVal + p3 + p4;
                });
                xmlBlock = xmlBlock.replace(/(name=")([\s\S]*?)(")/g, function (match, p1, p2, p3) {
                    let newVal = p2.replace(/"/g, '&quot;');
                    return p1 + newVal + p3;
                });
                xmlBlock = xmlBlock.replace(/value="\$PRP:\s*"?\s*([^"]+)"{1,2}/g, 'value="$PRP:$1"');
                xmlBlock = xmlBlock.replace(/(\s\w+="[^"]*)</g, '$1&lt;')
                    .replace(/(\s\w+="[^"]*)>/g, '$1&gt;');
                return xmlBlock;
            }

            document.getElementById('xmlBirlestiriciUpdateBtn').onclick = function () {
                quantities = [];
                for (let i = 0; i < xmlFiles.length; i++) {
                    let val = parseInt(document.getElementById('xmlBirlestiriciQuantity_' + i).value, 10);
                    quantities.push(isNaN(val) ? 1 : val);
                }
                document.getElementById('xmlBirlestiriciMergeBtn').style.display = "inline-block";
            };

            document.getElementById('xmlBirlestiriciMergeBtn').onclick = function () {
                if (xmlFiles.length === 0) {
                    document.getElementById('xmlBirlestiriciOutput').innerHTML = "<b>Lütfen en az bir XML dosyası seçin.</b>";
                    document.getElementById('xmlBirlestiriciEscapeBtn').style.display = "none";
                    document.getElementById('xmlBirlestiriciDownloadBtn').style.display = "none";
                    return;
                }
                let documentBloklari = [];
                let ilkPdmweid = "";
                for (let i = 0; i < xmlTexts.length; i++) {
                    let blok = ilkDocumentBlokunuAl(xmlTexts[i]);
                    if (blok) {
                        // pdmweid değerini ilk bulduğunda al
                        if (!ilkPdmweid) {
                            const match = blok.match(/pdmweid="([^"]*)"/i);
                            if (match) ilkPdmweid = match[1];
                        }
                        blok = configurationQuantityGuncelle(blok, quantities[i] || 1);
                        blok = blok.replace(/^\s*$(?:\r\n?|\n)/gm, ""); // Tüm boş satırları sil
                        documentBloklari.push(blok);
                    }
                }
                // pdmweid değerini COKLUFASON montajına ata
                let birlesikXml = sabitXmlBas.replace(/pdmweid=""/, `pdmweid="${ilkPdmweid}"`) + documentBloklari.join('\n') + sabitXmlSon;
                // ...devamı aynı...
                let selectHtml = `<label>İndirmek için dosya adı seçin:</label>
        <select id="xmlBirlestiriciFilenameSelect" style="padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; font-size:1rem;">` +
                    xmlFiles.map((file, idx) => `<option value="${file.name}">${file.name}</option>`).join("") +
                    `</select>
        <span style="color:#2563eb; font-weight:500;">-COKLUXML[REV].xml</span>`;
                document.getElementById('xmlBirlestiriciOutput').innerHTML =
                    selectHtml +
                    `<label style="margin-top:18px;display:block;">Birleştirilmiş XML:</label>
        <textarea id="xmlBirlestiriciResultArea" readonly style="width:100%;height:400px;margin-top:18px;font-family:'Fira Mono','Consolas',monospace;font-size:1rem;border-radius:10px;border:1px solid #d1d5db;background:#f3f4f6;padding:16px;resize:vertical;box-sizing:border-box;"></textarea>`;
                document.getElementById('xmlBirlestiriciResultArea').value = birlesikXml;
                document.getElementById('xmlBirlestiriciEscapeBtn').style.display = "inline-block";
                document.getElementById('xmlBirlestiriciDownloadBtn').style.display = "inline-block";
            };

            document.getElementById('xmlBirlestiriciDownloadBtn').onclick = function () {
                let xmlText = document.getElementById('xmlBirlestiriciResultArea').value;
                let select = document.getElementById('xmlBirlestiriciFilenameSelect');
                let originalName = select ? select.value : "SD-0940-R00.xml";
                let newName = originalName.replace(/(-R\d+)/i, '-COKLUXML$1');
                if (newName === originalName) {
                    newName = originalName.replace(/(\.xml)$/i, '-COKLUXML-R00$1');
                }
                let blob = new Blob([xmlText], { type: "application/xml" });
                let link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = newName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            document.getElementById('xmlBirlestiriciEscapeBtn').onclick = function () {
                let xmlText = document.getElementById('xmlBirlestiriciResultArea').value;
                let escapedXml = attributeEscape(xmlText);
                document.getElementById('xmlBirlestiriciResultArea').value = escapedXml;
            };

            // Sıfırla butonu: popup'ı kapatma, sadece alanları temizle ve başa dön
            document.getElementById('xmlBirlestiriciResetBtn').onclick = function () {
                xmlFiles = [];
                xmlTexts = [];
                quantities = [];
                document.getElementById('xmlBirlestiriciMain').style.display = "none";
                document.getElementById('xmlBirlestiriciDropzone').style.display = "";
                document.getElementById('xmlBirlestiriciDropzone').style.background = "";
                document.getElementById('xmlBirlestiriciDropzone').value = "";
                document.getElementById('xmlBirlestiriciOutput').innerHTML = "";
                document.getElementById('xmlBirlestiriciEscapeBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciDownloadBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciMergeBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciUpdateBtn').style.display = "none";
                document.getElementById('xmlBirlestiriciFileList').innerHTML = "";
            };
        }

        // Butona tıklayınca popup aç
        document.getElementById('xmlBirleştirBtn').onclick = showXmlBirlestiriciPopup;


        document.addEventListener("click", (e) => {
            // Sadece <b> veya .parca-kodu-span içindeyse çalış
            const target = e.target.closest("b, .parca-kodu-span");
            if (!target) return;

            // 3 tıklamayı yakala
            if (e.detail === 2) {
                e.preventDefault();
                e.stopPropagation();

                // Parça kodu metnini al
                let text = target.textContent.trim();

                // Revizyon (örneğin -R00, -R03, -R12) varsa kaldır
                text = text.replace(/-R\d{2,}$/i, "").trim();

                // Sadece bu metni seç
                const range = document.createRange();
                const node = target.firstChild || target;
                range.selectNodeContents(node);

                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                // Eğer tüm satır değil de sadece kodun seçilmesi isteniyorsa:
                // geçici olarak kodu bir <span> içine sararak çalıştırabiliriz
                // ama burada doğrudan text node üzerinden çalışıyoruz.
            }
        });

        document.getElementById("malzemeArama").addEventListener("input", function () {
            const searchValue = this.value.trim().toLowerCase();
            if (searchValue === ".ozi") {
                // Aynı klasördeki standartteklif.html dosyasını yeni bir sekmede aç
                window.open("standartteklif.html", "_blank");
            }
        });

        // Revizyon Karşılaştırma İşlevleri
        let eskiXmlData = null;
        let yeniXmlData = null;

        document.getElementById('btnRevizyonKarsilastir').onclick = function () {
            document.getElementById('revizyonKarsilastirPopup').style.display = 'block';
        };

        document.getElementById('btnCloseRevizyonPopup').onclick = function () {
            document.getElementById('revizyonKarsilastirPopup').style.display = 'none';
        };

        document.getElementById('eskiXmlFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const parser = new DOMParser();
                    eskiXmlData = parser.parseFromString(evt.target.result, "text/xml");
                    checkKarsilastirButton();
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('yeniXmlFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const parser = new DOMParser();
                    yeniXmlData = parser.parseFromString(evt.target.result, "text/xml");
                    checkKarsilastirButton();
                };
                reader.readAsText(file);
            }
        });

        function checkKarsilastirButton() {
            const btn = document.getElementById('btnKarsilastir');
            btn.disabled = !(eskiXmlData && yeniXmlData);
        }

        document.getElementById('btnKarsilastir').onclick = function () {
            if (eskiXmlData && yeniXmlData) {
                compareRevisions();
            }
        };

        document.getElementById('btnResetRevizyon').onclick = function () {
            eskiXmlData = null;
            yeniXmlData = null;
            document.getElementById('eskiXmlFile').value = '';
            document.getElementById('yeniXmlFile').value = '';
            document.getElementById('revizyonSonuclar').innerHTML = '<p style="color:#666;">İki XML dosyası seçin ve karşılaştır butonuna tıklayın.</p>';
            checkKarsilastirButton();
        };

        function extractPartsFromXml(xmlDoc) {
            const parts = new Map(); // partCode -> { adet: number, yol: string }

            function processDocument(docNode, yol, parentMultiplier = 1) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();

                // Sheet, Kesim Listesi, Cut-List-Item geçenleri atla
                if (name.includes("SHEET") || name.includes("KESIM LISTESI") || name.includes("CUT-LIST-ITEM")) {
                    return;
                }

                const adet = parseInt(conf.getAttribute("quantity")) || 1;
                const toplamAdet = adet * parentMultiplier;

                // Parça kodunu parts map'ine ekle veya güncelle
                if (parts.has(partCode)) {
                    const existing = parts.get(partCode);
                    existing.adet += toplamAdet;
                    if (!existing.yol.includes(yol)) {
                        existing.yol += `, ${yol}`;
                    }
                } else {
                    parts.set(partCode, { adet: toplamAdet, yol: yol });
                }

                // Alt montajları işle
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                childDocs.forEach((childDoc, idx) => {
                    processDocument(childDoc, yol + '.' + (idx + 1), toplamAdet);
                });
            }

            // Kök montajları işle
            const rootDocs = Array.from(xmlDoc.querySelectorAll("document")).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
            rootDocs.forEach((doc, idx) => {
                processDocument(doc, (idx + 1).toString(), 1);
            });

            return parts;
        }

        function buildMontajTree(xmlDoc) {
            const tree = [];

            function processDocument(docNode, yol, depth = 0, parentMultiplier = 1) {
                const conf = docNode.querySelector('configuration');
                if (!conf) return null;

                const partCode = getAttributeValue(conf, "Parca_Kodu") || getAttributeValue(docNode, "Parca_Kodu") || getAttributeValue(docNode, "Name") || "Belirsiz";
                const name = (getAttributeValue(conf, "Name") || "").toUpperCase();

                // Sheet, Kesim Listesi, Cut-List-Item geçenleri atla
                if (name.includes("SHEET") || name.includes("KESIM LISTESI") || name.includes("CUT-LIST-ITEM")) {
                    return null;
                }

                const adet = parseInt(conf.getAttribute("quantity")) || 1;
                const toplamAdet = adet * parentMultiplier;

                const node = {
                    partCode: partCode,
                    adet: adet,
                    toplamAdet: toplamAdet,
                    yol: yol,
                    depth: depth,
                    children: []
                };

                // Alt montajları işle
                const childDocs = docNode.querySelectorAll(':scope > configuration > references > document');
                childDocs.forEach((childDoc, idx) => {
                    const childNode = processDocument(childDoc, yol + '.' + (idx + 1), depth + 1, toplamAdet);
                    if (childNode) {
                        node.children.push(childNode);
                    }
                });

                return node;
            }

            // Kök montajları işle
            const rootDocs = Array.from(xmlDoc.querySelectorAll("document")).filter(doc => doc.parentElement.tagName.toLowerCase() !== "references");
            rootDocs.forEach((doc, idx) => {
                const rootNode = processDocument(doc, (idx + 1).toString(), 0, 1);
                if (rootNode) {
                    tree.push(rootNode);
                }
            });

            return tree;
        }

        function renderMontajTree(tree, containerSelector, comparisonData = null) {
            console.log('renderMontajTree called with:', { tree, containerSelector, comparisonData });
            const container = document.querySelector(containerSelector);
            if (!container) {
                console.error('Container not found:', containerSelector);
                return;
            }
            console.log('Container found:', container);
            container.innerHTML = '';

            function createTreeNode(node, isRoot = false) {
                const hasChildren = node.children && node.children.length > 0;

                // Karşılaştırma durumu belirleme
                let statusClass = '';
                let statusText = '';
                let bgColor = '';

                if (comparisonData) {
                    if (node.status === 'added') {
                        statusClass = 'revision-added';
                        statusText = ' (EKLENEN)';
                        bgColor = '#d4edda';
                    } else if (node.status === 'deleted') {
                        statusClass = 'revision-deleted';
                        statusText = ' (SİLİNEN)';
                        bgColor = '#f8d7da';
                    } else if (node.status === 'changed') {
                        statusClass = 'revision-changed';
                        statusText = ` (${node.eskiAdet} → ${node.adet})`;
                        bgColor = '#cce7ff';
                    }
                }

                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                nodeDiv.style.marginLeft = (node.depth * 20) + 'px';
                nodeDiv.style.backgroundColor = bgColor;
                nodeDiv.style.padding = '4px 8px';
                nodeDiv.style.borderRadius = '4px';
                nodeDiv.style.marginBottom = '2px';

                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.style.cursor = hasChildren ? 'pointer' : 'default';
                headerDiv.style.fontWeight = isRoot ? 'bold' : 'normal';
                headerDiv.style.fontSize = isRoot ? '16px' : '14px';

                const arrow = hasChildren ? '<span class="tree-arrow" style="margin-right:8px; font-size:12px; transition:transform 0.2s;">▶</span>' : '<span style="margin-right:20px;"></span>';

                headerDiv.innerHTML = `
                    ${arrow}
                    <span style="flex:1;">
                        <strong>${node.partCode}</strong>
                        <span style="color:#666; margin-left:10px;">Adet: ${node.adet} | Toplam: ${node.toplamAdet}</span>
                        <span style="color:#e67e22; font-weight:bold;">${statusText}</span>
                    </span>
                `;

                nodeDiv.appendChild(headerDiv);

                if (hasChildren) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    childrenDiv.style.display = 'none';

                    node.children.forEach(child => {
                        const childElement = createTreeNode(child);
                        childrenDiv.appendChild(childElement);
                    });

                    nodeDiv.appendChild(childrenDiv);

                    headerDiv.addEventListener('click', function () {
                        const arrow = this.querySelector('.tree-arrow');
                        const children = nodeDiv.querySelector('.tree-children');

                        if (children.style.display === 'none') {
                            children.style.display = 'block';
                            if (arrow) arrow.style.transform = 'rotate(90deg)';
                        } else {
                            children.style.display = 'none';
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        }
                    });
                }

                return nodeDiv;
            }

            tree.forEach(rootNode => {
                const rootElement = createTreeNode(rootNode, true);
                container.appendChild(rootElement);
            });
        }

        function compareRevisions() {
            // İlk XML'in montaj ağacını oluştur
            const eskiTree = buildMontajTree(eskiXmlData);

            // İlk olarak sadece eski XML'i göster
            let html = '<div style="margin-bottom:20px;">';
            html += '<h3 style="color:#2c3e50; margin:0 0 15px 0;">Eski XML Montaj Şeması:</h3>';
            html += '<div id="eskiMontajTree" style="border:1px solid #ddd; padding:15px; border-radius:6px; background:#f9f9f9; max-height:300px; overflow-y:auto;"></div>';
            html += '</div>';

            html += '<div style="margin-bottom:20px; display:flex; gap:10px; align-items:center;">';
            html += '<button id="btnKarsilastirmaYap" style="background:#3498db; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">Karşılaştırmayı Göster</button>';
            html += '<button id="btnEskiTumunuAc" style="background:#27ae60; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">Tümünü Aç</button>';
            html += '<button id="btnEskiTumunuKapat" style="background:#c0392b; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">Tümünü Kapat</button>';
            html += '</div>';

            html += '<div id="karsilastirmaSonucu" style="display:none;">';
            html += '<h3 style="color:#2c3e50; margin:0 0 15px 0;">Karşılaştırma Sonucu:</h3>';
            html += '<div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">';
            html += '<div>';
            html += '<span style="background:#d4edda; padding:4px 8px; border-radius:3px; margin-right:10px; font-size:12px;">EKLENEN</span>';
            html += '<span style="background:#f8d7da; padding:4px 8px; border-radius:3px; margin-right:10px; font-size:12px;">SİLİNEN</span>';
            html += '<span style="background:#cce7ff; padding:4px 8px; border-radius:3px; font-size:12px;">ADET DEĞİŞEN</span>';
            html += '</div>';
            html += '<div>';
            html += '<button id="btnKarsilastirmaTumunuAc" style="background:#27ae60; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:5px;">Tümünü Aç</button>';
            html += '<button id="btnKarsilastirmaTumunuKapat" style="background:#c0392b; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">Tümünü Kapat</button>';
            html += '</div>';
            html += '</div>';
            html += '<div id="karsilastirmaMontajTree" style="border:1px solid #ddd; padding:15px; border-radius:6px; background:#f9f9f9; max-height:400px; overflow-y:auto;"></div>';
            html += '</div>';

            document.getElementById('revizyonSonuclar').innerHTML = html;

            // Eski montaj ağacını render et
            renderMontajTree(eskiTree, '#eskiMontajTree');

            // Eski XML için tümünü aç/kapat butonları
            document.getElementById('btnEskiTumunuAc').onclick = function () {
                toggleAllNodes('#eskiMontajTree', true);
            };

            document.getElementById('btnEskiTumunuKapat').onclick = function () {
                toggleAllNodes('#eskiMontajTree', false);
            };

            // Karşılaştırma butonuna event listener ekle
            document.getElementById('btnKarsilastirmaYap').onclick = function () {
                try {
                    const yeniTree = buildMontajTree(yeniXmlData);
                    console.log('Eski Tree:', eskiTree);
                    console.log('Yeni Tree:', yeniTree);

                    // Hem eski hem yeni ağacı birleştiren hibrit ağaç oluştur
                    const mergedTree = createMergedTree(eskiTree, yeniTree);
                    console.log('Merged Tree:', mergedTree);

                    // Karşılaştırmalı ağacı render et
                    renderMontajTree(mergedTree.tree, '#karsilastirmaMontajTree', mergedTree.comparisonData);
                } catch (error) {
                    console.error('Karşılaştırma hatası:', error);
                    document.getElementById('karsilastirmaMontajTree').innerHTML = '<p style="color:red;">Hata: ' + error.message + '</p>';
                }

                console.log('Showing karsilastirmaSonucu div');
                const karsilastirmaSonucuDiv = document.getElementById('karsilastirmaSonucu');
                console.log('karsilastirmaSonucu div:', karsilastirmaSonucuDiv);
                karsilastirmaSonucuDiv.style.display = 'block';
                this.style.display = 'none';

                // Karşılaştırma sonucu için tümünü aç/kapat butonları
                document.getElementById('btnKarsilastirmaTumunuAc').onclick = function () {
                    toggleAllNodes('#karsilastirmaMontajTree', true);
                };

                document.getElementById('btnKarsilastirmaTumunuKapat').onclick = function () {
                    toggleAllNodes('#karsilastirmaMontajTree', false);
                };
            };
        }

        function createMergedTree(eskiTree, yeniTree) {
            // Basit yaklaşım: Önce yeni ağacı göster, sonra eski ağaçtan eksik olanları ekle

            // Tüm parçaları topla
            const eskiParcalar = new Map(); // partCode -> toplam adet
            const yeniParcalar = new Map(); // partCode -> toplam adet

            function collectAllParts(tree, map) {
                function traverse(node) {
                    const currentCount = map.get(node.partCode) || 0;
                    map.set(node.partCode, currentCount + node.toplamAdet);

                    if (node.children) {
                        node.children.forEach(traverse);
                    }
                }
                tree.forEach(traverse);
            }

            collectAllParts(eskiTree, eskiParcalar);
            collectAllParts(yeniTree, yeniParcalar);

            // Karşılaştırma verilerini oluştur
            const eklenen = new Set();
            const silinen = new Set();
            const degisen = new Map();

            // Eklenen ve değişenler
            yeniParcalar.forEach((yeniAdet, partCode) => {
                const eskiAdet = eskiParcalar.get(partCode) || 0;
                if (eskiAdet === 0) {
                    eklenen.add(partCode);
                } else if (eskiAdet !== yeniAdet) {
                    degisen.set(partCode, { eskiAdet, yeniAdet });
                }
            });

            // Silinenler
            eskiParcalar.forEach((eskiAdet, partCode) => {
                if (!yeniParcalar.has(partCode)) {
                    silinen.add(partCode);
                }
            });

            // Yeni ağaca status bilgilerini ekle
            function addStatusToTree(tree) {
                return tree.map(node => {
                    const newNode = { ...node };

                    if (eklenen.has(node.partCode)) {
                        newNode.status = 'added';
                    } else if (silinen.has(node.partCode)) {
                        newNode.status = 'deleted';
                    } else if (degisen.has(node.partCode)) {
                        const change = degisen.get(node.partCode);
                        newNode.status = 'changed';
                        newNode.eskiAdet = change.eskiAdet;
                    } else {
                        newNode.status = 'same';
                    }

                    if (node.children && node.children.length > 0) {
                        newNode.children = addStatusToTree(node.children);
                    }

                    return newNode;
                });
            }

            // Silinen parçaları ekle (sadece kök seviyesinde)
            function addDeletedParts(tree) {
                const result = [...tree];

                // Eski ağaçtan silinen kök parçaları bul
                eskiTree.forEach(eskiNode => {
                    if (silinen.has(eskiNode.partCode)) {
                        // Bu parça yeni ağaçta hiç yok mu kontrol et
                        const existsInNew = yeniTree.some(yeniNode => yeniNode.partCode === eskiNode.partCode);
                        if (!existsInNew) {
                            const deletedNode = {
                                ...eskiNode,
                                status: 'deleted',
                                children: eskiNode.children ? addStatusToDeletedChildren(eskiNode.children) : []
                            };
                            result.push(deletedNode);
                        }
                    }
                });

                return result;
            }

            function addStatusToDeletedChildren(children) {
                return children.map(child => ({
                    ...child,
                    status: 'deleted',
                    children: child.children ? addStatusToDeletedChildren(child.children) : []
                }));
            }

            let finalTree = addStatusToTree(yeniTree);
            finalTree = addDeletedParts(finalTree);

            return {
                tree: finalTree,
                comparisonData: { eklenen, silinen, degisen }
            };
        }

        function toggleAllNodes(containerSelector, expand) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            const treeNodes = container.querySelectorAll('.tree-node');

            treeNodes.forEach(node => {
                const arrow = node.querySelector('.tree-arrow');
                const children = node.querySelector('.tree-children');

                if (arrow && children) {
                    if (expand) {
                        children.style.display = 'block';
                        arrow.style.transform = 'rotate(90deg)';
                    } else {
                        children.style.display = 'none';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                }
            });
        }

        // Fallback kopyalama fonksiyonu
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('Fallback kopyalama başarılı:', text);
            } catch (err) {
                console.error('Fallback kopyalama hatası:', err);
            }
            document.body.removeChild(textArea);
        }

        // Tablo sıralama fonksiyonu
        function initTableSorting() {
            document.querySelectorAll('table').forEach(table => {
                // Tablo başlıklarına sıralama özelliği ekle
                const headers = table.querySelectorAll('thead th');
                headers.forEach((header, index) => {
                    // Zaten sortable sınıfı varsa, bu tabloya dokunma
                    if (header.classList.contains('sortable')) return;
                    
                    header.classList.add('sortable');
                    header.setAttribute('data-sort-direction', 'none'); // none, asc, desc
                    header.setAttribute('data-original-order', ''); // Orijinal sıralama için
                    
                    // Ok butonunu ekle
                    const arrow = document.createElement('span');
                    arrow.className = 'sort-arrow';
                    arrow.innerHTML = ' ↕';
                    arrow.style.cssText = 'cursor: pointer; margin-left: 5px; user-select: none; float: right;';
                    header.appendChild(arrow);
                    
                    // Parça Kodu başlığı için özel stil ve kopyalama eventi
                    const headerText = header.innerText.replace(' ↕', '').replace(' ↑', '').replace(' ↓', '').trim();
                    if (headerText.toLowerCase().includes('parça kodu') || headerText.toLowerCase().includes('parca kodu')) {
                        header.style.cursor = 'copy';
                        header.title = '📋 Tıkla: Tüm parça kodlarını kopyala';
                        
                        // SADECE Parça Kodu başlığına kopyalama eventi ekle
                        header.addEventListener('click', function(e) {
                            // Eğer ok butonuna tıklandıysa, hiçbir şey yapma
                            if (e.target === arrow) return;
                            
                            const tbody = table.querySelector('tbody');
                            if (tbody) {
                                const rows = tbody.querySelectorAll('tr');
                                const parcaKodlari = [];
                                
                                rows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells.length > 0) {
                                        // Parça kodu sütununu bul (ana filtreye göre değişir)
                                        const anaFiltreElem = document.getElementById('accAnaFiltre');
                                        const anaFiltre = anaFiltreElem ? anaFiltreElem.value : "";
                                        const isLevha = anaFiltre === "levha";
                                        
                                        // Levha: 2. sütun (index 1), Diğer: 1. sütun (index 0)
                                        const kodIndex = isLevha ? 1 : 0;
                                        const parcaKodu = cells[kodIndex] ? cells[kodIndex].innerText.trim() : "";
                                        
                                        if (parcaKodu && !parcaKodlari.includes(parcaKodu)) {
                                            parcaKodlari.push(parcaKodu);
                                        }
                                    }
                                });
                                
                                const copyText = parcaKodlari.join('\n');
                                
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(copyText).then(() => {
                                        console.log('Parça kodları kopyalandı:', parcaKodlari.length + ' adet');
                                        // Kısa süre için başlığı vurgula
                                        const originalBg = this.style.backgroundColor;
                                        this.style.backgroundColor = '#90EE90';
                                        setTimeout(() => {
                                            this.style.backgroundColor = originalBg;
                                        }, 200);
                                    }).catch(err => {
                                        console.error('Kopyalama hatası:', err);
                                        fallbackCopyText(copyText);
                                    });
                                } else {
                                    fallbackCopyText(copyText);
                                }
                            }
                        });
                    }
                    // DİĞER BAŞLIKLARA HİÇBİR EVENT EKLEMİYORUZ
                    
                    // Ok butonuna tıklama eventi
                    arrow.addEventListener('click', function(e) {
                        e.stopPropagation(); // Başlık click eventini engelle
                        
                        const tbody = table.querySelector('tbody');
                        if (!tbody) return;
                        
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        const currentDirection = header.getAttribute('data-sort-direction');
                        
                        // Orijinal sıralamayı sakla
                        if (currentDirection === 'none') {
                            header.setAttribute('data-original-order', rows.map(row => row.outerHTML).join(''));
                        }
                        
                        // Diğer başlıkların sınıflarını temizle
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                            if (h !== header) {
                                h.setAttribute('data-sort-direction', 'none');
                                const otherArrow = h.querySelector('.sort-arrow');
                                if (otherArrow) otherArrow.innerHTML = ' ↕';
                            }
                        });
                        
                        let newDirection = 'asc';
                        if (currentDirection === 'none') newDirection = 'asc';
                        else if (currentDirection === 'asc') newDirection = 'desc';
                        else if (currentDirection === 'desc') newDirection = 'none';
                        
                        header.setAttribute('data-sort-direction', newDirection);
                        
                        if (newDirection === 'none') {
                            // Orijinal sıralamaya dön
                            const originalOrder = header.getAttribute('data-original-order');
                            if (originalOrder) {
                                tbody.innerHTML = originalOrder;
                            }
                            header.classList.remove('sort-asc', 'sort-desc');
                            arrow.innerHTML = ' ↕';
                        } else {
                            // Sırala
                            const sortedRows = rows.sort((a, b) => {
                                const cellA = a.querySelectorAll('td')[index];
                                const cellB = b.querySelectorAll('td')[index];
                                
                                if (!cellA || !cellB) return 0;
                                
                                const valueA = cellA.innerText.trim();
                                const valueB = cellB.innerText.trim();
                                
                                // Sayı kontrolü
                                const numA = parseFloat(valueA.replace(/[^\d.,\-]/g, '').replace(',', '.'));
                                const numB = parseFloat(valueB.replace(/[^\d.,\-]/g, '').replace(',', '.'));
                                
                                if (!isNaN(numA) && !isNaN(numB)) {
                                    return newDirection === 'asc' ? numA - numB : numB - numA;
                                }
                                
                                // String karşılaştırması
                                if (newDirection === 'asc') {
                                    return valueA.localeCompare(valueB, 'tr');
                                } else {
                                    return valueB.localeCompare(valueA, 'tr');
                                }
                            });
                            
                            // Sıralanmış satırları tabloya yerleştir
                            tbody.innerHTML = '';
                            sortedRows.forEach(row => tbody.appendChild(row));
                            
                            // Görsel gösterge
                            header.classList.add(newDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                            arrow.innerHTML = newDirection === 'asc' ? ' ↑' : ' ↓';
                        }
                    });
                });
            });
        }

        // Sayfa yüklendiğinde ve yeni tablolar oluşturulduğunda çalıştır
        document.addEventListener('DOMContentLoaded', initTableSorting);
        
        // MutationObserver ile dinamik olarak eklenen tabloları da yakalayalım
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'TABLE') {
                                setTimeout(initTableSorting, 100);
                            } else if (node.querySelector && node.querySelector('table')) {
                                setTimeout(initTableSorting, 100);
                            }
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

    </script>
</body>

<!--
XML YAPISI ÖRNEĞİ - BU YAPIDAN DEĞİŞKEN DEĞERLERİ OKUNUR:
<document aliasset="" pdmweid="">
    <configuration name="Varsayılan" quantity="">
        <attribute name="Agirlik" value="" />
        <attribute name="Revision" value="" />
        <attribute name="Description" value="" />
        <attribute name="Date" value="" />
        <attribute name="Ham_o1" value="" />
        <attribute name="Ham_o2" value="" />
        <attribute name="Ham_o3" value="" />
        <attribute name="Hammadde" value="" />
        <attribute name="Hammadde_Olcusu" value="" />
        <attribute name="Isil_Islem" value="" />
        <attribute name="Kalite" value="" />
        <attribute name="Kaplama" value="" />
        <attribute name="Mak_Boyut" value="" />
        <attribute name="Mak_Cinsi" value="" />
        <attribute name="Mak_Grubu" value="" />
        <attribute name="Mak_Kodu" value="" />
        <attribute name="Mak_Tipi" value="" />
        <attribute name="Malzeme" value="" />
        <attribute name="Parca_Kodu" value="" />
        <attribute name="Proje_no" value="" />
        <attribute name="Ral_Kodu" value="" />
        <attribute name="Son_Islem" value="" />
        <attribute name="Temin_sekli" value="" />
        <attribute name="İmalat_Tipi" value="" />
        <attribute name="Description2" value="" />
        <attribute name="Boya_Parca_Tanimi" value="" />
        <attribute name="Malzeme_ERP_Code" value="" />
        <attribute name="Toplam_Sinirlandirici_Kutu_Genisligi" value="" />
        <attribute name="Toplam_Sinirlandirici_Kutu_Uzunlugu" value="" />
        <attribute name="Toplam_Sinirlandirici_Kutu_Kalinligi" value="" />
        <attribute name="Siparis_Notu" value="" />
        <attribute name="OP1_Tanim" value="" />
        <attribute name="OP2_Tanim" value="" />
        <attribute name="OP3_Tanim" value="" />
        <attribute name="OP4_Tanim" value="" />
        <attribute name="OP5_Tanim" value="" />
        <attribute name="OP6_Tanim" value="" />
        <attribute name="OP7_Tanim" value="" />
        <attribute name="OP8_Tanim" value="" />
        <attribute name="Uzunluk" value="" />
        <attribute name="Profil_Tanim_Boy" value="" />
        <attribute name="Profil_Tanim_Boy_1" value="" />
        <attribute name="Profil_Tanim_Boy_2" value="" />
        <attribute name="Profil_Tanim_Boy_3" value="" />
        <attribute name="Profil_Tanim_Boy_4" value="" />
        <attribute name="Imalat_tipi" value="" />
        <attribute name="Disarda_Birak" value="" />
        <attribute name="Profil_Tipi" value="" />
        <attribute name="Profil_Disarda_Birak" value="" />
        <attribute name="Partili_takip" value="" />
        <attribute name="Saci_Disarida_Birak" value="" />
        <attribute name="Disarda_Birakma" value="" />
        <attribute name="Boya_Par_Tan_Oz" value="" />
        <attribute name="Siparis_Disi_Birak" value="" />
        <attribute name="Profil_Aci_1" value="" />
        <attribute name="Profil_Aci_2" value="" />
        <attribute name="Mak_Parca_Kodu" value="" />
        <attribute name="Fason" value="" />
        <attribute name="Name" value="" />
        <attribute name="Date Modified" value="" />
        <attribute name="State" value="" />
        <attribute name="Reference Count" value="" />
        <attribute name="Configuration" value="" />
        <references>
            <document aliasset="" pdmweid="">
                <configuration name="Varsayılan" quantity="">
                 Alt parçalar burada yer alır
                    <attribute name="Agirlik" value="" />
                    <attribute name="Revision" value="" />
                    <attribute name="Description" value="" />
                    <attribute name="Date" value="" />
                    <attribute name="Ham_o1" value="" />
                    <attribute name="Ham_o2" value="" />
                    <attribute name="Ham_o3" value="" />
                    <attribute name="Hammadde" value="" />
                    <attribute name="Hammadde_Olcusu" value="" />
                    <attribute name="Isil_Islem" value="" />
                    <attribute name="Kalite" value="" />
                    <attribute name="Kaplama" value="" />
                    <attribute name="Mak_Boyut" value="" />
                    <attribute name="Mak_Cinsi" value="" />
                    <attribute name="Mak_Grubu" value="" />
                    <attribute name="Mak_Kodu" value="" />
                    <attribute name="Mak_Tipi" value="" />
                    <attribute name="Malzeme" value="" />
                    <attribute name="Parca_Kodu" value="" />
                    <attribute name="Proje_no" value="" />
                    <attribute name="Ral_Kodu" value="" />
                    <attribute name="Son_Islem" value="" />
                    <attribute name="Temin_sekli" value="" />
                    <attribute name="İmalat_Tipi" value="" />
                    <attribute name="Description2" value="" />
                    <attribute name="Boya_Parca_Tanimi" value="" />
                    <attribute name="Malzeme_ERP_Code" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Genisligi" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Uzunlugu" value="" />
                    <attribute name="Toplam_Sinirlandirici_Kutu_Kalinligi" value="" />
                    <attribute name="Siparis_Notu" value="" />
                    <attribute name="OP1_Tanim" value="" />
                    <attribute name="OP2_Tanim" value="" />
                    <attribute name="OP3_Tanim" value="" />
                    <attribute name="OP4_Tanim" value="" />
                    <attribute name="OP5_Tanim" value="" />
                    <attribute name="OP6_Tanim" value="" />
                    <attribute name="OP7_Tanim" value="" />
                    <attribute name="OP8_Tanim" value="" />
                    <attribute name="Uzunluk" value="" />
                    <attribute name="Profil_Tanim_Boy" value="" />
                    <attribute name="Profil_Tanim_Boy_1" value="" />
                    <attribute name="Profil_Tanim_Boy_2" value="" />
                    <attribute name="Profil_Tanim_Boy_3" value="" />
                    <attribute name="Profil_Tanim_Boy_4" value="" />
                    <attribute name="Imalat_tipi" value="" />
                    <attribute name="Disarda_Birak" value="" />
                    <attribute name="Profil_Tipi" value="" />
                    <attribute name="Profil_Disarda_Birak" value="" />
                    <attribute name="Partili_takip" value="" />
                    <attribute name="Saci_Disarida_Birak" value="" />
                    <attribute name="Disarda_Birakma" value="" />
                    <attribute name="Boya_Par_Tan_Oz" value="" />
                    <attribute name="Siparis_Disi_Birak" value="" />
                    <attribute name="Profil_Aci_1" value="" />
                    <attribute name="Profil_Aci_2" value="" />
                    <attribute name="Mak_Parca_Kodu" value="" />
                    <attribute name="Fason" value="" />
                    <attribute name="Name" value="" />
                    <attribute name="Date Modified" value="" />
                    <attribute name="State" value="" />
                    <attribute name="Reference Count" value="" />
                    <attribute name="Configuration" value="" />
                </configuration>
            </document>
        </references>
    </configuration>
</document>
-->


</html>
